<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadre de Compétences SFIA (Complet)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ajouter le script serverStorage.js -->
    <script src="/static/js/serverStorage.js"></script>
    <style>
        /* --- STYLES GÉNÉRAUX --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            line-height: 1.2;
            background-color: #f8fafc;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- MODE SOMBRE --- */
        body.dark-mode {
            background-color: #1a202c;
            color: #f1f5f9;
        }
        .dark-mode .mx-auto { background-color: #1a202c; }
        .dark-mode .category-container { background-color: #2d3748; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25); }
        .dark-mode .category-header { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
        .dark-mode .skill-name { color: #e2e8f0; }
        .dark-mode .skill-code { color: #a0aec0; }
        .dark-mode .skill-row { border-color: #4a5568; background-color: #2d3748; }
        .dark-mode .skill-row:nth-child(odd) { background-color: #283141; }
        .dark-mode .skill-row:hover { background-color: #374151; }
        .dark-mode .level-box { background-color: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); }
        .dark-mode nav.bg-gray-800 { background-color: #111827; }
        .dark-mode .text-gray-900 { color: #f1f5f9; }
        .dark-mode header.bg-white { background-color: #1f2937; }
        .dark-mode header h1 { color: #f1f5f9; }
        .dark-mode #header-job-number { color: #cbd5e1; }
        .dark-mode #header-job-number-value { color: #60a5fa; }
        .dark-mode #opm-ids-container { background-color: #2d3748; border-color: #4a5568; }
        #darkModeToggle { transition: all 0.2s ease-in-out; }
        #darkModeToggle:hover { transform: scale(1.05); }

        /* --- GRILLE & CONTENEURS --- */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
        }
        .category-container {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            height: fit-content;
        }
        .category-container:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        /* --- EN-TÊTES --- */
        .category-header {
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .level-header {
            display: flex;
            padding: 8px 10px;
            font-weight: bold;
            border-bottom-width: 1px;
        }
        .subcategory-header {
            padding: 8px 10px;
            font-weight: 600;
            border-bottom-width: 1px;
            font-size: 12px;
        }

        /* --- LIGNES DE COMPÉTENCES --- */
        .skill-row {
            display: flex;
            align-items: center;
            padding: 4px 10px;
            border-bottom: 1px solid #eee;
            font-size: 11px;
        }
        .skill-row:last-child { border-bottom: none; }
        .skill-name { flex: 3; padding-right: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .skill-code { flex: 1; font-weight: bold; color: #666; }
        .level-boxes { display: flex; justify-content: flex-end; }
        .level-number, .level-box {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1px;
            font-size: 11px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        .level-box:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .level-box.filled { color: white; border: none; }

        /* --- OPM IDs --- */
        #opm-ids-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: white;
        }
        .opm-id-badge {
            display: inline-block;
            padding: 5px 10px;
            margin: 3px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
            background-color: #3b82f6;
        }

        /* --- THÈMES DE COULEURS PAR CATÉGORIE --- */
        :root {
            --cat-strategy-architecture-main: #e11d48; --cat-strategy-architecture-dark: #be123c; --cat-strategy-architecture-text: #881337; --cat-strategy-architecture-light-bg: rgba(254, 205, 211, 0.4);
            --cat-dev-implementation-main: #facc15; --cat-dev-implementation-dark: #eab308; --cat-dev-implementation-text: #854d0e; --cat-dev-implementation-light-bg: rgba(254, 249, 195, 0.6);
            --cat-delivery-operation-main: #ea580c; --cat-delivery-operation-dark: #c2410c; --cat-delivery-operation-text: #9a3412; --cat-delivery-operation-light-bg: rgba(255, 237, 213, 0.6);
            --cat-change-transformation-main: #db2777; --cat-change-transformation-dark: #be185d; --cat-change-transformation-text: #9d174d; --cat-change-transformation-light-bg: rgba(252, 231, 243, 0.6);
            --cat-people-skills-main: #0891b2; --cat-people-skills-dark: #0e7490; --cat-people-skills-text: #0c4a6e; --cat-people-skills-light-bg: rgba(224, 242, 254, 0.6);
            --cat-relationships-engagement-main: #16a34a; --cat-relationships-engagement-dark: #15803d; --cat-relationships-engagement-text: #166534; --cat-relationships-engagement-light-bg: rgba(220, 252, 231, 0.6);
        }
        .category-container { --cat-main: #666; --cat-dark: #555; --cat-text: #444; --cat-light-bg: #f0f0f0; }
        .strategy-architecture { --cat-main: var(--cat-strategy-architecture-main); --cat-dark: var(--cat-strategy-architecture-dark); --cat-text: var(--cat-strategy-architecture-text); --cat-light-bg: var(--cat-strategy-architecture-light-bg); }
        .dev-implementation { --cat-main: var(--cat-dev-implementation-main); --cat-dark: var(--cat-dev-implementation-dark); --cat-text: var(--cat-dev-implementation-text); --cat-light-bg: var(--cat-dev-implementation-light-bg); }
        .delivery-operation { --cat-main: var(--cat-delivery-operation-main); --cat-dark: var(--cat-delivery-operation-dark); --cat-text: var(--cat-delivery-operation-text); --cat-light-bg: var(--cat-delivery-operation-light-bg); }
        .change-transformation { --cat-main: var(--cat-change-transformation-main); --cat-dark: var(--cat-change-transformation-dark); --cat-text: var(--cat-change-transformation-text); --cat-light-bg: var(--cat-change-transformation-light-bg); }
        .people-skills { --cat-main: var(--cat-people-skills-main); --cat-dark: var(--cat-people-skills-dark); --cat-text: var(--cat-people-skills-text); --cat-light-bg: var(--cat-people-skills-light-bg); }
        .relationships-engagement { --cat-main: var(--cat-relationships-engagement-main); --cat-dark: var(--cat-relationships-engagement-dark); --cat-text: var(--cat-relationships-engagement-text); --cat-light-bg: var(--cat-relationships-engagement-light-bg); }
        
        .category-header { background: linear-gradient(135deg, var(--cat-main), var(--cat-dark)); box-shadow: 0 2px 4px color-mix(in srgb, var(--cat-dark) 30%, transparent); }
        .level-header { background: color-mix(in srgb, var(--cat-main) 8%, transparent); border-color: color-mix(in srgb, var(--cat-dark) 15%, transparent); }
        .level-number { background-color: color-mix(in srgb, var(--cat-main) 15%, transparent); color: var(--cat-text); }
        .subcategory-header { background: color-mix(in srgb, var(--cat-main) 20%, transparent); border-color: color-mix(in srgb, var(--cat-dark) 25%, transparent); color: var(--cat-text); }
        .skill-row { border-color: color-mix(in srgb, var(--cat-dark) 15%, transparent); }
        .skill-row:nth-child(even) { background-color: var(--cat-light-bg); }
        .skill-row:hover { background-color: color-mix(in srgb, var(--cat-light-bg) 80%, var(--cat-main) 10%); }
        .level-box { background-color: color-mix(in srgb, var(--cat-main) 5%, transparent); border: 1px solid color-mix(in srgb, var(--cat-main) 15%, transparent); }
        .level-box.filled { background: linear-gradient(135deg, var(--cat-main), var(--cat-dark)); box-shadow: 0 2px 4px color-mix(in srgb, var(--cat-dark) 30%, transparent); }
        
        .dark-mode .level-box.filled { background: linear-gradient(135deg, color-mix(in srgb, var(--cat-main) 50%, #000), color-mix(in srgb, var(--cat-dark) 50%, #000)); }
        .dark-mode .category-header { background: linear-gradient(135deg, color-mix(in srgb, var(--cat-main) 60%, #000), color-mix(in srgb, var(--cat-dark) 60%, #000)); }
        .dark-mode .level-header { background: rgba(255, 255, 255, 0.03); border-color: rgba(255, 255, 255, 0.1); }
        .dark-mode .subcategory-header { background: rgba(255, 255, 255, 0.05); color: var(--cat-main); border-color: rgba(255, 255, 255, 0.1); }
        
        /* --- MODAL --- */
        #modal-backdrop { transition: opacity 0.3s ease-in-out; }
        #modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }

        /* --- TOOLTIP PERSONNALISÉ --- */
        #custom-tooltip {
            position: absolute;
            z-index: 100;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            max-width: 250px;
            opacity: 0;
            transition: opacity 0.2s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        #custom-tooltip.visible {
            opacity: 1;
        }
        .dark-mode #custom-tooltip {
            background-color: rgba(30, 41, 59, 0.95);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }
        .tooltip-title {
            font-weight: bold;
            margin-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 4px;
        }
        .tooltip-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 5px;
        }
        .tooltip-info {
            margin-top: 4px;
        }

        /* Styles pour le tooltip */
        .tooltip {
            position: absolute;
            z-index: 1000;
            background-color: #333;
            color: white;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            padding: 12px;
            max-width: 320px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
        
        .tooltip.visible {
            opacity: 1;
        }
        
        .tooltip-title {
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 1px solid #555;
            padding-bottom: 6px;
            color: white;
        }
        
        .tooltip-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .tooltip-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
            background-color: #666;
        }
        
        .tooltip-info {
            font-size: 0.9em;
            margin-top: 4px;
            color: #fff;
        }
        
        .tooltip-info strong {
            font-weight: 600;
            color: #fff;
        }
        
        /* Animation de clignotement */
        @keyframes blink-animation {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.15); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes holographic {
            0% { 
                opacity: 0.85; 
                transform: scale(1) perspective(500px) rotateY(-3deg);
                text-shadow: 0 0 6px #00ffff, 0 0 10px #00ffff, 0 0 14px rgba(183, 0, 255, 0.6);
                box-shadow: 0 0 10px rgba(0, 255, 255, 0.6), inset 0 0 5px rgba(0, 255, 255, 0.4);
                filter: brightness(0.9) contrast(1.1);
            }
            33% {
                opacity: 0.95;
                transform: scale(1.03) perspective(500px) rotateY(-1deg);
                text-shadow: 0 0 8px #00ffff, 0 0 12px #00ffff, 0 0 16px rgba(183, 0, 255, 0.7);
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.7), inset 0 0 8px rgba(0, 255, 255, 0.5);
                filter: brightness(1.1) contrast(1.2);
            }
            66% { 
                opacity: 1; 
                transform: scale(1.05) perspective(500px) rotateY(1deg);
                text-shadow: 0 0 10px #00ffff, 0 0 15px #00ffff, 0 0 20px rgba(183, 0, 255, 0.8);
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.8), inset 0 0 12px rgba(0, 255, 255, 0.6);
                filter: brightness(1.2) contrast(1.3);
            }
            100% { 
                opacity: 0.9; 
                transform: scale(1) perspective(500px) rotateY(3deg);
                text-shadow: 0 0 8px #00ffff, 0 0 12px #00ffff, 0 0 16px rgba(183, 0, 255, 0.7);
                box-shadow: 0 0 12px rgba(0, 255, 255, 0.7), inset 0 0 7px rgba(0, 255, 255, 0.5);
                filter: brightness(1) contrast(1.2);
            }
        }
    </style>
</head>
<body class="bg-slate-50 p-6">
    <!-- Barre de navigation -->
    <nav class="bg-gray-800 mb-6 -mx-6 -mt-6 px-4">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center">
                    <div class="shrink-0 flex items-center">
                        <span class="mr-2 px-2 py-1 text-sm font-bold text-white rounded" style="border: 1px solid rgba(255, 255, 255, 0.5); text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.6), inset 0 0 10px rgba(0, 255, 255, 0.3); animation: holographic 3s infinite alternate; background: linear-gradient(-45deg, rgba(0, 255, 255, 0.1), rgba(0, 150, 255, 0.2), rgba(183, 0, 255, 0.1));">BETA</span>
                        <span class="text-2xl font-bold text-white">DCWF</span>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="{% url 'main' %}" class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Home</a>
                            <a href="#" class="rounded-md px-3 py-2 text-sm font-medium bg-gray-900 text-white flex items-center">
                                Tableau des compétences
                            </a>
                        </div>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-4 flex items-center md:ml-6">
                        <button type="button" id="darkModeToggle" class="relative rounded-full bg-gray-700 p-1.5 text-gray-300 hover:bg-gray-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-gray-800 mr-3">
                            <span class="sr-only">Basculer en mode sombre</span>
                            <svg id="moonIcon" class="size-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                            <svg id="sunIcon" class="hidden size-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                        </button>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="mobile-menu-button" class="relative inline-flex items-center justify-center rounded-md bg-gray-800 p-2 text-gray-400 hover:bg-gray-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-gray-800" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <svg class="block size-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                        <svg class="hidden size-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
        </div>
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="space-y-1 px-2 pb-3 pt-2 sm:px-3">
                <a href="{% url 'main' %}" class="block rounded-md px-3 py-2 text-base font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Home</a>
                <a href="#" class="block rounded-md px-3 py-2 text-base font-medium bg-gray-900 text-white flex items-center">
                    Tableau des compétences
                </a>
            </div>
        </div>
    </nav>

    <div class="mx-auto max-w-full px-4">
        <!-- Conteneur pour afficher les OPM IDs -->
        <div id="opm-ids-container" class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
            <h2 class="text-lg font-semibold mb-2">OPM IDs de la sauvegarde</h2>
            <div id="opm-ids-list" class="flex flex-wrap gap-2">
                <span class="text-gray-500">Chargement des OPM IDs...</span>
            </div>
        </div>

        <!-- Le conteneur de la grille sera rempli par JavaScript -->
        <div id="sfia-grid" class="categories-grid"></div>

        <!-- Bouton pour terminer l'étape -->
        <div class="flex justify-center my-8">
            <button id="complete-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">
                Terminer l'étape et ajouter un nouveau poste
            </button>
        </div>
    </div>

    <!-- Fenêtre Modale de Confirmation -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="modal-backdrop" class="absolute inset-0 bg-black opacity-50"></div>
        <div id="modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 m-4 max-w-sm w-full z-10 scale-95 opacity-0">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Confirmation requise</h3>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">Voulez-vous vraiment terminer cette étape et démarrer un nouveau poste ?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">Annuler</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
    // --- STRUCTURE DE DONNÉES SFIA ---
    const sfiaData = [
        {
            name: "Strategy and architecture",
            cssClass: "strategy-architecture",
            subcategories: [
                {
                    name: "Strategy and planning",
                    skills: [
                        { name: "Strategic planning", code: "ITSP", levels: [4, 5, 6, 7] },
                        { name: "Information systems coordination", code: "ISCO", levels: [5, 6, 7] },
                        { name: "Information management", code: "IRMG", levels: [3, 4, 5, 6, 7] },
                        { name: "Enterprise and business architecture", code: "STPL", levels: [5, 6, 7] },
                        { name: "Solution architecture", code: "ARCH", levels: [4, 5, 6, 7] },
                        { name: "Innovation management", code: "INOV", levels: [5, 6, 7] },
                        { name: "Emerging technology monitoring", code: "EMRG", levels: [4, 5, 6] },
                        { name: "Formal research", code: "RSCH", levels: [2, 3, 4, 5, 6] },
                        { name: "Sustainability", code: "SUST", levels: [4, 5, 6] }
                    ]
                },
                {
                    name: "Financial and value management",
                    skills: [
                        { name: "Financial management", code: "FMIT", levels: [4, 5, 6] },
                        { name: "Investment appraisal", code: "INVA", levels: [4, 5, 6] },
                        { name: "Benefits management", code: "BENM", levels: [3, 4, 5, 6] },
                        { name: "Budgeting and forecasting", code: "BUDF", levels: [2, 3, 4, 5, 6] },
                        { name: "Financial analysis", code: "FIAN", levels: [2, 3, 4, 5, 6] },
                        { name: "Cost management", code: "COMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Demand management", code: "DEMM", levels: [4, 5, 6] },
                        { name: "Measurement", code: "MEAS", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Security and privacy",
                    skills: [
                        { name: "Information security", code: "SCTY", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Information assurance", code: "INAS", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Information and data compliance", code: "PEDP", levels: [4, 5, 6] },
                        { name: "Vulnerability research", code: "VURE", levels: [2, 3, 4, 5, 6] },
                        { name: "Threat intelligence", code: "THIN", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Governance, risk and compliance",
                    skills: [
                        { name: "Governance", code: "GOVN", levels: [5, 6, 7] },
                        { name: "Risk management", code: "BURM", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Artificial intelligence (AI) and data ethics", code: "AIDE", levels: [3, 4, 5, 6] },
                        { name: "Audit", code: "AUDT", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Quality management", code: "QUMG", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Quality assurance", code: "QUAS", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Advice and guidance",
                    skills: [
                        { name: "Consultancy", code: "CNSL", levels: [4, 5, 6, 7] },
                        { name: "Specialist advice", code: "TECH", levels: [4, 5, 6] },
                        { name: "Methods and tools", code: "METL", levels: [2, 3, 4, 5, 6] }
                    ]
                }
            ]
        },
        {
            name: "Development and implementation",
            cssClass: "dev-implementation",
            subcategories: [
                {
                    name: "Systems development",
                    skills: [
                        { name: "Product management", code: "PROD", levels: [3, 4, 5, 6] },
                        { name: "Systems development management", code: "DLMG", levels: [4, 5, 6, 7] },
                        { name: "Systems and software lifecycle engineering", code: "SLEN", levels: [3, 4, 5, 6, 7] },
                        { name: "Systems design", code: "DESN", levels: [2, 3, 4, 5, 6] },
                        { name: "Software design", code: "SWDN", levels: [2, 3, 4, 5, 6] },
                        { name: "Network design", code: "NTDS", levels: [2, 3, 4, 5, 6] },
                        { name: "Infrastructure design", code: "IFDN", levels: [2, 3, 4, 5, 6] },
                        { name: "Hardware design", code: "HWDE", levels: [2, 3, 4, 5, 6] },
                        { name: "Programming/software development", code: "PROG", levels: [2, 3, 4, 5, 6] },
                        { name: "Systems integration and build", code: "SINT", levels: [2, 3, 4, 5, 6] },
                        { name: "Functional testing", code: "TEST", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Non-functional testing", code: "NFTS", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Process testing", code: "PRTS", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Software configuration", code: "PORT", levels: [2, 3, 4, 5, 6] },
                        { name: "Real-time/embedded systems development", code: "RESD", levels: [2, 3, 4, 5, 6] },
                        { name: "Safety engineering", code: "SFEN", levels: [2, 3, 4, 5, 6] },
                        { name: "Safety assessment", code: "SFAS", levels: [4, 5, 6] },
                        { name: "Radio frequency engineering", code: "RFEN", levels: [2, 3, 4, 5, 6] },
                        { name: "Animation development", code: "ADEV", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Data and analytics",
                    skills: [
                        { name: "Data management", code: "DATM", levels: [2, 3, 4, 5, 6] },
                        { name: "Data modelling and design", code: "DTAN", levels: [2, 3, 4, 5] },
                        { name: "Database design", code: "DBDS", levels: [2, 3, 4, 5] },
                        { name: "Data analytics", code: "DNAN", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Data science", code: "DATS", levels: [2, 3, 4, 5, 6] },
                        { name: "Machine learning", code: "MLNG", levels: [2, 3, 4, 5, 6] },
                        { name: "Business intelligence", code: "BINT", levels: [2, 3, 4, 5] },
                        { name: "Data engineering", code: "DENG", levels: [2, 3, 4, 5, 6] },
                        { name: "Data visualisation", code: "VISL", levels: [2, 3, 4, 5] }
                    ]
                },
                {
                    name: "User centred design",
                    skills: [
                        { name: "User research", code: "URCH", levels: [3, 4, 5, 6] },
                        { name: "Customer experience", code: "CEXP", levels: [2, 3, 4, 5, 6] },
                        { name: "Accessibility and inclusion", code: "ACIN", levels: [2, 3, 4, 5, 6] },
                        { name: "User experience analysis", code: "UNAN", levels: [2, 3, 4, 5] },
                        { name: "User experience design", code: "HCEV", levels: [2, 3, 4, 5, 6] },
                        { name: "User experience evaluation", code: "USEV", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Content management",
                    skills: [
                        { name: "Content design and authoring", code: "INCA", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Content publishing", code: "ICPM", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Knowledge management", code: "KNOW", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Graphic design", code: "GRON", levels: [1, 2, 3, 4, 5] }
                    ]
                },
                {
                    name: "Computational science",
                    skills: [
                        { name: "Scientific modelling", code: "SCMO", levels: [4, 5, 6, 7] },
                        { name: "Numerical analysis", code: "NUAN", levels: [4, 5, 6, 7] },
                        { name: "High-performance computing", code: "HPCC", levels: [4, 5, 6, 7] }
                    ]
                }
            ]
        },
        {
            name: "Delivery and operation",
            cssClass: "delivery-operation",
            subcategories: [
                 {
                    name: "Technology management",
                    skills: [
                        { name: "Technology service management", code: "ITMG", levels: [5, 6, 7] },
                        { name: "Application support", code: "ASUP", levels: [2, 3, 4, 5] },
                        { name: "Infrastructure operations", code: "ITOP", levels: [1, 2, 3, 4, 5] },
                        { name: "System software administration", code: "SYSP", levels: [1, 2, 3, 4, 5] },
                        { name: "Network support", code: "NTAS", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Systems installation and removal", code: "HSIN", levels: [1, 2, 3, 4] },
                        { name: "Configuration management", code: "CFMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Release management", code: "RELM", levels: [2, 3, 4, 5, 6] },
                        { name: "Deployment", code: "DEPL", levels: [2, 3, 4, 5, 6] },
                        { name: "Storage management", code: "STMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Facilities management", code: "DCMA", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Service management",
                    skills: [
                        { name: "Service level management", code: "SLMO", levels: [3, 4, 5, 6, 7] },
                        { name: "Service catalogue management", code: "SCMG", levels: [2, 3, 4, 5] },
                        { name: "Availability management", code: "AVMT", levels: [3, 4, 5, 6] },
                        { name: "Continuity management", code: "COPL", levels: [2, 3, 4, 5, 6] },
                        { name: "Capacity management", code: "CPMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Incident management", code: "USUP", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Problem management", code: "PBMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Change control", code: "CHMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Asset management", code: "ASMG", levels: [2, 3, 4, 5] },
                        { name: "Service acceptance", code: "SEAC", levels: [3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Security services",
                    skills: [
                        { name: "Security operations", code: "SCAD", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Identity and access management", code: "IAMT", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Vulnerability assessment", code: "VUAS", levels: [2, 3, 4, 5] },
                        { name: "Digital forensics", code: "DGFS", levels: [2, 3, 4, 5, 6] },
                        { name: "Cybercrime investigation", code: "CRIM", levels: [2, 3, 4, 5, 6] },
                        { name: "Offensive cyber operations", code: "OCOP", levels: [2, 3, 4, 5, 6] },
                        { name: "Penetration testing", code: "PENT", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Data and records operations",
                    skills: [
                        { name: "Records management", code: "RMGT", levels: [1, 2, 3, 4, 5] },
                        { name: "Analytical classification and coding", code: "ANCC", levels: [2, 3, 4, 5, 6] },
                        { name: "Database administration", code: "DBAD", levels: [2, 3, 4, 5] }
                    ]
                }
            ]
        },
        {
            name: "Change and transformation",
            cssClass: "change-transformation",
            subcategories: [
                {
                    name: "Change implementation",
                    skills: [
                        { name: "Portfolio management", code: "POMG", levels: [5, 6, 7] },
                        { name: "Programme management", code: "PGMG", levels: [6, 7] },
                        { name: "Project management", code: "PRMG", levels: [4, 5, 6, 7] },
                        { name: "Portfolio, programme and project support", code: "PROF", levels: [2, 3, 4, 5, 6] },
                        { name: "Delivery management", code: "DLMG", levels: [3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Change analysis",
                    skills: [
                        { name: "Business situation analysis", code: "BUSA", levels: [2, 3, 4, 5, 6] },
                        { name: "Feasibility assessment", code: "FEAS", levels: [2, 3, 4, 5, 6] },
                        { name: "Requirements definition and management", code: "REQM", levels: [2, 3, 4, 5, 6] },
                        { name: "Business modelling", code: "BSMO", levels: [2, 3, 4, 5, 6] },
                        { name: "Business process testing", code: "BPTS", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Change planning",
                    skills: [
                        { name: "Business process improvement", code: "BPRE", levels: [1, 2, 3, 4, 5, 6, 7] },
                        { name: "Organisational capability development", code: "OCDV", levels: [5, 6, 7] },
                        { name: "Job analysis and design", code: "JADN", levels: [3, 4, 5] },
                        { name: "Organisation design and implementation", code: "ORDI", levels: [3, 4, 5, 6, 7] },
                        { name: "Organisational change management", code: "CIPM", levels: [2, 3, 4, 5, 6] },
                        { name: "Organisational change enablement", code: "OCEN", levels: [4, 5, 6] }
                    ]
                }
            ]
        },
        {
            name: "People and skills",
            cssClass: "people-skills",
            subcategories: [
                {
                    name: "People management",
                    skills: [
                        { name: "Performance management", code: "PEMT", levels: [4, 5, 6] },
                        { name: "Employee experience", code: "EEXP", levels: [4, 5, 6] },
                        { name: "Organisational facilitation", code: "OFCL", levels: [4, 5, 6] },
                        { name: "Professional development", code: "PDSV", levels: [4, 5, 6] },
                        { name: "Workforce planning", code: "WFPL", levels: [4, 5, 6] },
                        { name: "Resourcing", code: "RESC", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Skills management",
                    skills: [
                        { name: "Learning and development management", code: "ETMG", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Learning design and development", code: "TMCR", levels: [2, 3, 4, 5] },
                        { name: "Learning delivery", code: "ETDL", levels: [2, 3, 4, 5] },
                        { name: "Competency assessment", code: "LEDA", levels: [2, 3, 4, 5, 6] },
                        { name: "Certification scheme operation", code: "CSOP", levels: [2, 3, 4, 5, 6] },
                        { name: "Teaching", code: "TEAC", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Subject formation", code: "SUBF", levels: [4, 5, 6, 7] }
                    ]
                }
            ]
        },
        {
            name: "Relationships and engagement",
            cssClass: "relationships-engagement",
            subcategories: [
                {
                    name: "Stakeholder management",
                    skills: [
                        { name: "Sourcing", code: "SORC", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Supplier management", code: "SUPP", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Contract management", code: "ITCM", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Stakeholder relationship management", code: "RLMT", levels: [4, 5, 6, 7] },
                        { name: "Customer service support", code: "CSMG", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Business administration", code: "ADMN", levels: [1, 2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Sales and bid management",
                    skills: [
                        { name: "Bid/proposal management", code: "BIDM", levels: [3, 4, 5, 6] },
                        { name: "Selling", code: "SALE", levels: [3, 4, 5, 6] },
                        { name: "Sales support", code: "SSUP", levels: [1, 2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Marketing",
                    skills: [
                        { name: "Marketing management", code: "MKTG", levels: [4, 5, 6, 7] },
                        { name: "Market research", code: "MRCH", levels: [3, 4, 5, 6] },
                        { name: "Brand management", code: "BRMG", levels: [4, 5, 6] },
                        { name: "Customer engagement and loyalty", code: "CELO", levels: [3, 4, 5, 6] },
                        { name: "Marketing campaign management", code: "MKCM", levels: [3, 4, 5] },
                        { name: "Digital marketing", code: "DIGM", levels: [2, 3, 4, 5] }
                    ]
                }
            ]
        }
    ];

    document.addEventListener('DOMContentLoaded', function() {
        // Récupérer les OPM IDs de la sauvegarde
        async function loadOpmIdsFromSavedSelection() {
            try {
                // Afficher un indicateur de chargement
                const opmIdsList = document.getElementById('opm-ids-list');
                opmIdsList.innerHTML = `
                    <div class="flex items-center justify-center p-4">
                        <svg class="animate-spin h-6 w-6 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Chargement des données...</span>
                    </div>
                `;
                
                // Initialiser serverStorage
                if (typeof initServerStorage === 'function') {
                    initServerStorage();
                    console.log('serverStorage initialisé');
                } else {
                    console.warn('La fonction initServerStorage n\'est pas disponible');
                }
                
                // Vérifier si nous avons une sélection active pour l'étape 3
                const activateStep3 = localStorage.getItem('activateStep3');
                console.log('Activation étape 3:', activateStep3);
                
                // Essayer d'abord de récupérer les données depuis serverStorage
                let currentSelection;
                let dataSource = 'serverStorage';
                
                try {
                    console.log('Tentative de récupération depuis serverStorage...');
                    const serverData = await serverStorage.getItem('currentKsatSelection');
                    if (serverData) {
                        currentSelection = JSON.parse(serverData);
                        console.log('Sélection récupérée depuis serverStorage');
                    } else {
                        // Fallback à localStorage si serverStorage ne contient pas les données
                        console.log('Aucune donnée dans serverStorage, tentative avec localStorage');
                        currentSelection = JSON.parse(localStorage.getItem('currentKsatSelection') || '{}');
                        dataSource = 'localStorage';
                        console.log('Sélection récupérée depuis localStorage (fallback)');
                    }
                } catch (error) {
                    // En cas d'erreur avec serverStorage, utiliser localStorage
                    console.error('Erreur avec serverStorage, utilisation de localStorage:', error);
                    currentSelection = JSON.parse(localStorage.getItem('currentKsatSelection') || '{}');
                    dataSource = 'localStorage';
                }
                
                console.log('Source des données:', dataSource);
                console.log('Sélection courante:', currentSelection);
                
                if (activateStep3 === 'true' && currentSelection && currentSelection.roles) {
                    // Filtrer les rôles qui ont un opm_id
                    const rolesWithOpmIds = currentSelection.roles.filter(role => role.opmId);
                    
                    if (rolesWithOpmIds.length > 0) {
                        // Effacer le message de chargement
                        opmIdsList.innerHTML = '';
                        
                        // Mapping spécifique des OPM IDs aux couleurs des colonnes dans compare_ksat.html
                        // Ces couleurs sont basées sur les catégories des rôles
                        const opmIdColors = {
                            // IT (Cyberspace) - Bleu
                            '411': '2, 125, 184',
                            '421': '2, 125, 184',
                            '431': '2, 125, 184',
                            '441': '2, 125, 184',
                            '451': '2, 125, 184',
                            '632': '2, 125, 184',
                            '641': '2, 125, 184',
                            '651': '2, 125, 184',
                            '661': '2, 125, 184',
                            '671': '2, 125, 184',
                            
                            // Cybersecurity - Vert
                            '212': '94, 151, 49',
                            '462': '94, 151, 49',
                            '511': '94, 151, 49',
                            '521': '94, 151, 49',
                            '531': '94, 151, 49',
                            '541': '94, 151, 49',
                            '611': '94, 151, 49',
                            '612': '94, 151, 49',
                            '622': '94, 151, 49',
                            '631': '94, 151, 49',
                            '652': '94, 151, 49',
                            '722': '94, 151, 49',
                            '723': '94, 151, 49',
                            
                            // Cyberspace Effects - Orange
                            '121': '255, 145, 3',
                            '122': '255, 145, 3',
                            '131': '255, 145, 3',
                            '132': '255, 145, 3',
                            '133': '255, 145, 3',
                            '322': '255, 145, 3',
                            '332': '255, 145, 3',
                            '341': '255, 145, 3',
                            '442': '255, 145, 3',
                            '443': '255, 145, 3',
                            '463': '255, 145, 3',
                            
                            // Intelligence (Cyberspace) - Jaune
                            '111': '255, 204, 2',
                            '112': '255, 204, 2',
                            '141': '255, 204, 2',
                            '151': '255, 204, 2',
                            '311': '255, 204, 2',
                            '312': '255, 204, 2',
                            '331': '255, 204, 2',
                            '333': '255, 204, 2',
                            
                            // Cyberspace Enablers - Mauve
                            '211': '153, 86, 206',
                            '221': '153, 86, 206',
                            '711': '153, 86, 206',
                            '712': '153, 86, 206',
                            '731': '153, 86, 206',
                            '732': '153, 86, 206',
                            '751': '153, 86, 206',
                            '752': '153, 86, 206',
                            '801': '153, 86, 206',
                            '802': '153, 86, 206',
                            '803': '153, 86, 206',
                            '804': '153, 86, 206',
                            '805': '153, 86, 206',
                            '901': '153, 86, 206',
                            
                            // Software Engineering - Rouge
                            '461': '214, 39, 40',
                            '621': '214, 39, 40',
                            '625': '214, 39, 40',
                            '626': '214, 39, 40',
                            '627': '214, 39, 40',
                            '628': '214, 39, 40',
                            '673': '214, 39, 40',
                            '806': '214, 39, 40',
                            
                            // Data/AI - Turquoise
                            '422': '23, 190, 207',
                            '423': '23, 190, 207',
                            '424': '23, 190, 207',
                            '623': '23, 190, 207',
                            '624': '23, 190, 207',
                            '653': '23, 190, 207',
                            '672': '23, 190, 207',
                            '733': '23, 190, 207',
                            '753': '23, 190, 207',
                            '902': '23, 190, 207',
                            '903': '23, 190, 207'
                        };
                        
                        // Créer un mapping des OPM IDs aux rôles (prendre le premier rôle trouvé pour chaque OPM ID)
                        const opmIdToRole = {};
                        
                        // Associer les rôles aux OPM IDs (prendre le premier rôle trouvé pour chaque OPM ID)
                        rolesWithOpmIds.forEach(role => {
                            const opmId = role.opmId.toString().match(/\d+/)?.[0] || role.opmId;
                            
                            // Si nous n'avons pas encore de rôle pour cet OPM ID
                            if (!opmIdToRole[opmId]) {
                                opmIdToRole[opmId] = role;
                            }
                        });
                        
                        // Extraire uniquement les numéros d'OPM ID et éliminer les doublons
                        const uniqueOpmIds = [...new Set(
                            rolesWithOpmIds.map(role => {
                                // Extraire uniquement les chiffres de l'OPM ID
                                const numericMatch = role.opmId.toString().match(/\d+/);
                                return numericMatch ? numericMatch[0] : role.opmId;
                            })
                        )];
                        
                        // Trier les OPM IDs numériquement
                        uniqueOpmIds.sort((a, b) => parseInt(a) - parseInt(b));
                        
                        // Ajouter une information sur la source des données
                        const dataSourceInfo = document.createElement('div');
                        dataSourceInfo.className = 'text-sm text-gray-500 mb-2';
                        dataSourceInfo.innerHTML = `<span class="font-medium">Source des données:</span> ${dataSource} | <span class="font-medium">Nombre de rôles:</span> ${rolesWithOpmIds.length}`;
                        opmIdsList.appendChild(dataSourceInfo);
                        
                        // Créer un tableau pour afficher les OPM IDs avec leurs graduations
                        const table = document.createElement('table');
                        table.className = 'w-full border-collapse mt-4';
                        
                        // Créer le corps du tableau
                        const tbody = document.createElement('tbody');
                        
                        // Ajouter une ligne pour chaque OPM ID
                        uniqueOpmIds.forEach(opmId => {
                            const role = opmIdToRole[opmId];
                            
                            // Utiliser la couleur spécifique de compare_ksat.html si disponible
                            // Sinon, utiliser la couleur du rôle ou une couleur par défaut
                            const color = opmIdColors[opmId] || 
                                         (role && role.category_color ? role.category_color : '59, 130, 246');
                            
                            // Créer une ligne pour cet OPM ID
                            const row = document.createElement('tr');
                            
                            // Cellule pour l'OPM ID avec sa couleur
                            const opmIdCell = document.createElement('td');
                            opmIdCell.className = 'border px-2 py-1';
                            opmIdCell.style.minWidth = '80px';
                            
                            // Conteneur pour l'OPM ID et son titre
                            const opmIdContainer = document.createElement('div');
                            opmIdContainer.className = 'flex flex-col';
                            
                            // Afficher l'OPM ID avec sa couleur
                            const opmIdText = document.createElement('span');
                            opmIdText.className = 'font-semibold';
                            opmIdText.style.color = `rgba(${color}, 1)`;
                            opmIdText.textContent = opmId;
                            opmIdContainer.appendChild(opmIdText);
                            
                            // Afficher le titre du rôle si disponible (en option, plus petit)
                            if (role && role.title) {
                                const titleText = document.createElement('span');
                                titleText.className = 'text-xs text-gray-600 truncate';
                                titleText.style.maxWidth = '100px';
                                titleText.textContent = role.title;
                                opmIdContainer.appendChild(titleText);
                            }
                            
                            opmIdCell.appendChild(opmIdContainer);
                            row.appendChild(opmIdCell);
                            
                            // Cellule contenant les niveaux de graduation (1-7)
                            const graduationCell = document.createElement('td');
                            graduationCell.className = 'border px-2 py-1';
                            
                            // Créer un conteneur flex pour les niveaux
                            const levelContainer = document.createElement('div');
                            levelContainer.className = 'flex flex-row items-center space-x-1';
                            
                            // Ajouter les 7 niveaux de graduation
                            for (let i = 1; i <= 7; i++) {
                                // Créer un conteneur pour chaque niveau
                                const levelBox = document.createElement('div');
                                levelBox.className = 'flex flex-col items-center justify-center';
                                
                                // Créer le cercle de niveau
                                const circle = document.createElement('div');
                                circle.className = 'w-5 h-5 rounded-full flex items-center justify-center';
                                circle.style.backgroundColor = `rgba(${color}, 0.15)`;
                                circle.style.border = `1px solid rgba(${color}, 0.5)`;
                                
                                // Ajouter le numéro dans le cercle
                                const levelNumber = document.createElement('span');
                                levelNumber.className = 'text-xs font-medium';
                                levelNumber.style.color = `rgba(${color}, 1)`;
                                levelNumber.textContent = i;
                                circle.appendChild(levelNumber);
                                
                                levelBox.appendChild(circle);
                                levelContainer.appendChild(levelBox);
                            }
                            
                            graduationCell.appendChild(levelContainer);
                            row.appendChild(graduationCell);
                            
                            tbody.appendChild(row);
                        });
                        
                        table.appendChild(tbody);
                        opmIdsList.appendChild(table);
                    } else {
                        opmIdsList.innerHTML = `
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">
                                            Aucun OPM ID trouvé dans la sélection.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    opmIdsList.innerHTML = `
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">
                                        Veuillez d'abord sélectionner une sauvegarde à l'étape 2.
                                        <a href="{% url 'etape2_first_step' %}" class="font-medium underline text-blue-700 hover:text-blue-600">
                                            Aller à l'étape 2
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des OPM IDs:', error);
                document.getElementById('opm-ids-list').innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700">
                                    Erreur lors du chargement des OPM IDs: ${error.message}
                                </p>
                                <p class="text-xs text-red-600 mt-1">
                                    Essayez de rafraîchir la page ou de retourner à l'étape 2.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // --- GÉNÉRATEUR DYNAMIQUE DE GRILLE ---
        const gridContainer = document.getElementById('sfia-grid');

        function createSkillRow(skill) {
            let levelBoxesHtml = '';
            for (let i = 1; i <= 7; i++) {
                const isFilled = skill.levels.includes(i) ? 'filled' : '';
                levelBoxesHtml += `<div class="level-box ${isFilled}">${i}</div>`;
            }

            return `
                <div class="skill-row">
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-code">${skill.code}</div>
                    <div class="level-boxes">${levelBoxesHtml}</div>
                </div>
            `;
        }
        
        function createLevelHeader() {
            let levelNumbersHtml = '';
            for (let i = 1; i <= 7; i++) {
                levelNumbersHtml += `<div class="level-number">${i}</div>`;
            }
            return `
                 <div class="level-header">
                    <div class="flex-grow"></div>
                    ${levelNumbersHtml}
                </div>
            `;
        }

        sfiaData.forEach(category => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = `category-container ${category.cssClass}`;

            let subcategoriesHtml = '';
            category.subcategories.forEach(subcategory => {
                const skillsHtml = subcategory.skills.map(createSkillRow).join('');
                subcategoriesHtml += `
                    <div class="subcategory">
                        <div class="subcategory-header">${subcategory.name}</div>
                        ${skillsHtml}
                    </div>
                `;
            });

            categoryDiv.innerHTML = `
                <div class="category-header">${category.name}</div>
                ${createLevelHeader()}
                ${subcategoriesHtml}
            `;
            gridContainer.appendChild(categoryDiv);
        });
        
        // --- LOGIQUE DE LA PAGE ---

        // Mobile menu
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

        // Dark Mode
        const darkModeToggle = document.getElementById('darkModeToggle');
        const moonIcon = document.getElementById('moonIcon');
        const sunIcon = document.getElementById('sunIcon');
        const isDarkMode = () => localStorage.getItem('darkMode') === 'true';

        const updateDarkMode = () => {
            if (isDarkMode()) {
                document.body.classList.add('dark-mode');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark-mode');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
        };

        darkModeToggle.addEventListener('click', () => {
            localStorage.setItem('darkMode', !isDarkMode());
            updateDarkMode();
        });

        // Initialiser le mode sombre en fonction de la préférence stockée
        updateDarkMode();

        // --- MODAL HANDLERS ---
        const completeButton = document.getElementById('complete-button');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');

        completeButton.addEventListener('click', () => {
            confirmationModal.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.add('opacity-50');
                modalContent.classList.add('opacity-100', 'scale-100');
                modalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);
        });

        function closeModal() {
            modalBackdrop.classList.remove('opacity-50');
            modalContent.classList.remove('opacity-100', 'scale-100');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                confirmationModal.classList.add('hidden');
            }, 300);
        }

        modalBackdrop.addEventListener('click', closeModal);
        modalCancel.addEventListener('click', closeModal);
        modalConfirm.addEventListener('click', () => {
            window.location.href = "/ksat/step2/"; // Retourner à l'étape 2
        });
        
        // --- HANDLE OPM ID 901 SPECIAL BEHAVIOR ---
        function handleSpecialOpmBehavior() {
            // Vérifier si l'OPM ID 901 ou 722 est présent
            const opmIdsList = document.getElementById('opm-ids-list');
            const has901 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('901');
            const has722 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('722');
            const has723 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('723');
            const has752 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('752');
            const has661 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('661');
            const has622 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('622');
            const has631 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('631');
            const has461 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('461');
            const has511 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('511');
            const has521 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('521');
                            const has531 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('531');
                const has541 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('541');
                const has141 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('141');
                const has121 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('121');
                const has111 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('111');
                const has112 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('112');
                const has443 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('443');
                const has151 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('151');
                const has331 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('331');
                const has332 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('332');
                const has132 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('132');
                const has333 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('333');
                const has334 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('334');
                const has131 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('131');
                const has321 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('321');
                const has221 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('221');
                const has211 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('211');
                const has212 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('212');
                const has651 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('651');
                const has652 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('652');
                const has621 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('621');
                const has641 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('641');
                const has671 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('671');
                const has632 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('632');
                const has411 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('411');
                const has451 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('451');
                const has441 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('441');
                const has803 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('803');
                const has801 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('801');
                const has802 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('802');
                const has804 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('804');
                const has312 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('312');
                const has421 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('421');
                const has422 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('422');
                const has612 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('612');
                const has805 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('805');
                const has731 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('731');
                const has732 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('732');
                const has751 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('751');
                const has711 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('711');
                const has712 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('712');
                const has311 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('311');
                const has431 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('431');
                const has611 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('611');
            
            // Configuration des OPM IDs spéciaux et leurs comportements
            const specialOpmConfigs = [
                {
                    opmId: '901',
                    color: '153, 86, 206', // Mauve
                    isPresent: has901,
                    competences: [
                        { code: 'SCTY', levels: [7], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'BURM', levels: [7], description: 'Identification, évaluation et contrôle des risques au sein de l\'organisation.' },
                        { code: 'INAS', levels: [7], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' }
                    ]
                },
                {
                    opmId: '722',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: has722,
                    competences: [
                        { code: 'SCTY', levels: [5, 6], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [5, 6], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' }
                    ]
                },
                {
                    opmId: '723',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: has723,
                    competences: [
                        { code: 'INAS', levels: [5, 6], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' },
                        { code: 'VUAS', levels: [5, 6], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'SCAD', levels: [5, 6], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' }
                    ]
                },
                {
                    opmId: '752',
                    color: '153, 86, 206', // Mauve (couleur des cyberspace enablers)
                    isPresent: has752,
                    competences: [
                        { code: 'INAS', levels: [6], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' },
                        { code: 'SCTY', levels: [6], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'OCDV', levels: [6], description: 'Développement et amélioration des capacités organisationnelles pour répondre aux besoins actuels et futurs.' },
                        { code: 'WFPL', levels: [6], description: 'Planification stratégique de la main-d\'œuvre pour répondre aux besoins organisationnels.' }
                    ]
                },
                {
                    opmId: '661',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has661,
                    competences: [
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vulnérabilités pour améliorer la sécurité des systèmes.' },
                        { code: 'RSCH', levels: [3, 4, 5], description: 'Conduite de recherche formelle pour développer de nouvelles connaissances et technologies.' },
                        { code: 'EMRG', levels: [4, 5], description: 'Suivi des technologies émergentes pour identifier les opportunités et les risques futurs.' },
                        { code: 'TECH', levels: [4, 5], description: 'Fourniture de conseils techniques spécialisés pour soutenir les décisions stratégiques.' }
                    ]
                },
                {
                    opmId: '622',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: has622,
                    competences: [
                        { code: 'VUAS', levels: [3, 4, 5], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' }
                    ]
                },
                {
                    opmId: '631',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: has631,
                    competences: [
                        { code: 'SCTY', levels: [3, 4, 5], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'VUAS', levels: [3, 4, 5], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'COPL', levels: [3, 4, 5], description: 'Planification et gestion de la continuité des services informatiques face aux incidents.' },
                        { code: 'ARCH', levels: [4, 5], description: 'Conception de solutions techniques répondant aux exigences métier et techniques.' },
                        { code: 'DESN', levels: [3, 4, 5], description: 'Conception de systèmes conformes aux spécifications et adaptés aux besoins des utilisateurs.' },
                        { code: 'TEST', levels: [3, 4, 5], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' }
                    ]
                },
                {
                    opmId: '461',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: has461,
                    competences: [
                        { code: 'SCTY', levels: [3, 4, 5], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [3, 4, 5], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' },
                        { code: 'VUAS', levels: [3, 4, 5], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'TEST', levels: [3, 4, 5], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' }
                    ]
                },
                {
                    opmId: '511',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: has511,
                    competences: [
                        { code: 'THIN', levels: [2, 3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' }
                    ]
                },
                {
                    opmId: '521',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: has521,
                    competences: [
                        { code: 'SCAD', levels: [1, 2, 3, 4, 5], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' },
                        { code: 'ITOP', levels: [1, 2, 3, 4, 5], description: 'Gestion et exploitation des infrastructures informatiques, assurant leur disponibilité et leur performance.' },
                        { code: 'HSIN', levels: [1, 2, 3, 4], description: 'Installation, migration et désinstallation des systèmes matériels et logiciels.' },
                        { code: 'NTAS', levels: [2, 3, 4, 5], description: 'Support et maintenance des infrastructures réseau pour assurer leur disponibilité et leur performance.' }
                    ]
                },
                {
                    opmId: '531',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: has531,
                    competences: [
                        { code: 'USUP', levels: [2, 3, 4, 5], description: 'Gestion des incidents pour minimiser les perturbations et restaurer les services rapidement.' },
                        { code: 'SCAD', levels: [2, 3, 4, 5], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' },
                        { code: 'COPL', levels: [2, 3, 4, 5], description: 'Planification et gestion de la continuité des services informatiques face aux incidents.' }
                    ]
                },
                {
                    opmId: '541',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: has541,
                    competences: [
                        { code: 'VUAS', levels: [2, 3, 4, 5], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' },
                        { code: 'MEAS', levels: [3, 4, 5], description: 'Définition et utilisation de métriques pour mesurer et améliorer la performance des systèmes.' }
                    ]
                },
                {
                    opmId: '141',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has141,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'VISL', levels: [3, 4, 5], description: 'Création de représentations graphiques des données pour faciliter leur interprétation et leur analyse.' },
                        { code: 'SCAD', levels: [3, 4, 5], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' }
                    ]
                },
                {
                    opmId: '121',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has121,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' },
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vulnérabilités pour améliorer la sécurité des systèmes.' }
                    ]
                },
                {
                    opmId: '111',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has111,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'SCAD', levels: [3, 4, 5], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' },
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vulnérabilités pour améliorer la sécurité des systèmes.' }
                    ]
                },
                {
                    opmId: '112',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has112,
                    competences: [
                        { code: 'MEAS', levels: [4, 5], description: 'Définition et utilisation de métriques pour mesurer et améliorer la performance des systèmes.' },
                        { code: 'SCTY', levels: [4, 5], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [4, 5], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' },
                        { code: 'THIN', levels: [4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' }
                    ]
                },
                {
                    opmId: '443',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has443,
                    competences: [
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'DATS', levels: [3, 4, 5], description: 'Application de méthodes scientifiques et mathématiques pour extraire des connaissances des données.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' }
                    ]
                },
                {
                    opmId: '151',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has151,
                    competences: [
                        { code: 'TECH', levels: [4, 5], description: 'Fourniture de conseils techniques spécialisés pour soutenir les décisions stratégiques.' },
                        { code: 'KNOW', levels: [4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'VUAS', levels: [4, 5], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'THIN', levels: [4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' }
                    ]
                },
                {
                    opmId: '331',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has331,
                    competences: [
                        { code: 'THIN', levels: [5, 6], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'DEMM', levels: [5, 6], description: 'Gestion de la demande pour optimiser l\'allocation des ressources informatiques.' },
                        { code: 'ITSP', levels: [5, 6], description: 'Planification stratégique des technologies de l\'information pour soutenir les objectifs organisationnels.' }
                    ]
                },
                {
                    opmId: '332',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has332,
                    competences: [
                        { code: 'SCAD', levels: [5, 6], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' },
                        { code: 'THIN', levels: [5, 6], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'SUPP', levels: [5, 6], description: 'Gestion des relations avec les fournisseurs pour assurer la qualité des services et produits.' }
                    ]
                },
                {
                    opmId: '132',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has132,
                    competences: [
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'DATS', levels: [3, 4, 5], description: 'Application de méthodes scientifiques et mathématiques pour extraire des connaissances des données.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' }
                    ]
                },
                {
                    opmId: '333',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has333,
                    competences: [
                        { code: 'RLMT', levels: [5, 6], description: 'Gestion des relations avec les parties prenantes pour assurer leur engagement et satisfaction.' },
                        { code: 'SCTY', levels: [5, 6], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'KNOW', levels: [5, 6], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' }
                    ]
                },
                {
                    opmId: '334',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has334,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique numérique pour l\'investigation et la collecte de preuves électroniques.' }
                    ]
                },
                {
                    opmId: '131',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has131,
                    competences: [
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vulnérabilités pour améliorer la sécurité des systèmes.' },
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' }
                    ]
                },
                {
                    opmId: '321',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has321,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vulnérabilités pour améliorer la sécurité des systèmes.' }
                    ]
                },
                {
                    opmId: '221',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has221,
                    competences: [
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique numérique pour l\'investigation et la collecte de preuves électroniques.' }
                    ]
                },
                {
                    opmId: '211',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has211,
                    competences: [
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique numérique pour l\'investigation et la collecte de preuves électroniques.' }
                    ]
                },
                {
                    opmId: '212',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has212,
                    competences: [
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique numérique pour l\'investigation et la collecte de preuves électroniques.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' },
                        { code: 'VUAS', levels: [3, 4, 5], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' }
                    ]
                },
                {
                    opmId: '651',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has651,
                    competences: [
                        { code: 'STPL', levels: [5, 6], description: 'Planification stratégique pour définir les orientations futures et les objectifs à long terme.' },
                        { code: 'REQM', levels: [5, 6], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '652',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has652,
                    competences: [
                        { code: 'SCTY', levels: [4, 5, 6], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'STPL', levels: [5, 6], description: 'Planification stratégique pour définir les orientations futures et les objectifs à long terme.' },
                        { code: 'ARCH', levels: [4, 5, 6], description: 'Conception de solutions techniques répondant aux exigences métier et techniques.' },
                        { code: 'REQM', levels: [4, 5, 6], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '621',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: has621,
                    competences: [
                        { code: 'PROG', levels: [2, 3, 4, 5], description: 'Développement de logiciels à l\'aide de langages de programmation et d\'outils appropriés.' },
                        { code: 'TEST', levels: [2, 3, 4, 5], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' },
                        { code: 'PORT', levels: [3, 4, 5], description: 'Configuration logicielle pour adapter les applications aux environnements spécifiques.' },
                        { code: 'RESD', levels: [2, 3, 4, 5], description: 'Développement de systèmes embarqués et temps réel avec des contraintes matérielles.' },
                        { code: 'SINT', levels: [2, 3, 4, 5], description: 'Intégration de composants système pour créer des solutions fonctionnelles complètes.' }
                    ]
                },
                {
                    opmId: '641',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has641,
                    competences: [
                        { code: 'REQM', levels: [3, 4, 5], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' },
                        { code: 'UNAN', levels: [3, 4, 5], description: 'Analyse de l\'expérience utilisateur pour comprendre les besoins et les comportements des utilisateurs.' },
                        { code: 'ARCH', levels: [4, 5], description: 'Conception de solutions techniques répondant aux exigences métier et techniques.' }
                    ]
                },
                {
                    opmId: '671',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has671,
                    competences: [
                        { code: 'TEST', levels: [3, 4], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' },
                        { code: 'QUAS', levels: [3, 4], description: 'Assurance qualité pour garantir que les produits et services répondent aux normes définies.' },
                        { code: 'PENT', levels: [3, 4], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' },
                        { code: 'USEV', levels: [3, 4], description: 'Évaluation de l\'expérience utilisateur pour mesurer la satisfaction et l\'efficacité des interfaces.' }
                    ]
                },
                {
                    opmId: '632',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has632,
                    competences: [
                        { code: 'ARCH', levels: [4, 5], description: 'Conception de solutions techniques répondant aux exigences métier et techniques.' },
                        { code: 'RESD', levels: [3, 4, 5], description: 'Développement de systèmes informatiques selon les spécifications de conception.' },
                        { code: 'DESN', levels: [3, 4, 5], description: 'Conception de systèmes conformes aux spécifications et adaptés aux besoins des utilisateurs.' },
                        { code: 'HWDE', levels: [3, 4, 5], description: 'Conception de matériel informatique répondant aux exigences métier et techniques.' },
                        { code: 'NTDS', levels: [3, 4, 5], description: 'Conception de réseaux informatiques répondant aux exigences métier et techniques.' },
                        { code: 'SWDN', levels: [3, 4, 5], description: 'Conception de logiciels informatiques répondant aux exigences métier et techniques.' },
                        { code: 'TEST', levels: [3, 4, 5], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' }
                    ]
                },
                {
                    opmId: '411',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has411,
                    competences: [
                        { code: 'PBMG', levels: [3, 4], description: 'Gestion des problèmes pour minimiser les perturbations et restaurer les services rapidement.' },
                        { code: 'SCAD', levels: [2, 3, 4], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' },
                        { code: 'VUAS', levels: [2, 3, 4], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'SYSP', levels: [3, 4], description: 'Programmation système pour développer et maintenir des composants logiciels de bas niveau.' },
                        { code: 'ITOP', levels: [2, 3, 4], description: 'Gestion et exploitation des infrastructures informatiques, assurant leur disponibilité et leur performance.' },
                        { code: 'HSIN', levels: [2, 3, 4], description: 'Installation, migration et désinstallation des systèmes matériels et logiciels.' },
                        { code: 'NTAS', levels: [2, 3, 4], description: 'Support et maintenance des infrastructures réseau pour assurer leur disponibilité et leur performance.' }
                    ]
                },
                {
                    opmId: '451',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has451,
                    competences: [
                        { code: 'SCAD', levels: [1, 2, 3, 4], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' },
                        { code: 'ITOP', levels: [1, 2, 3, 4], description: 'Gestion et exploitation des infrastructures informatiques, assurant leur disponibilité et leur performance.' },
                        { code: 'HSIN', levels: [1, 2, 3, 4], description: 'Installation, migration et désinstallation des systèmes matériels et logiciels.' },
                        { code: 'SYSP', levels: [3, 4], description: 'Programmation système pour développer et maintenir des composants logiciels de bas niveau.' },
                        { code: 'TEST', levels: [1, 2, 3, 4], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' },
                        { code: 'PBMG', levels: [3, 4], description: 'Gestion des problèmes pour minimiser les perturbations et restaurer les services rapidement.' }
                    ]
                },
                {
                    opmId: '441',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has441,
                    competences: [
                        { code: 'SYSP', levels: [3, 4], description: 'Programmation système pour développer et maintenir des composants logiciels de bas niveau.' },
                        { code: 'NTAS', levels: [2, 3, 4], description: 'Support et maintenance des infrastructures réseau pour assurer leur disponibilité et leur performance.' },
                        { code: 'HSIN', levels: [2, 3, 4], description: 'Installation, migration et désinstallation des systèmes matériels et logiciels.' },
                        { code: 'TEST', levels: [2, 3, 4], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' }
                    ]
                },
                {
                    opmId: '803',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has803,
                    competences: [
                        { code: 'SLMO', levels: [3, 4, 5], description: 'Gestion des niveaux de service pour optimiser la disponibilité et la performance des services.' },
                        { code: 'BUSA', levels: [3, 4, 5], description: 'Analyse des situations d\'affaires pour identifier les opportunités et les menaces.' },
                        { code: 'FEAS', levels: [3, 4, 5], description: 'Amélioration des processus métier pour répondre aux besoins organisationnels.' },
                        { code: 'REQM', levels: [3, 4, 5], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '801',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has801,
                    competences: [
                        { code: 'PGMG', levels: [6], description: 'Gestion de programme pour coordonner et superviser un ensemble de projets liés.' },
                        { code: 'QUMG', levels: [6], description: 'Gestion de la qualité pour garantir que les produits et services répondent aux normes définies.' },
                        { code: 'RLMT', levels: [6], description: 'Gestion des relations pour maintenir des partenariats efficaces avec les parties prenantes.' },
                        { code: 'BENM', levels: [6], description: 'Gestion des bénéfices pour maximiser la valeur des investissements.' },
                        { code: 'CIPM', levels: [6], description: 'Gestion de l\'amélioration continue pour optimiser les processus et les performances.' },
                        { code: 'SUPP', levels: [6], description: 'Gestion des fournisseurs pour optimiser la valeur des relations avec les prestataires externes.' }
                    ]
                },
                {
                    opmId: '802',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has802,
                    competences: [
                        { code: 'PRMG', levels: [4, 5, 6], description: 'Gestion de programme pour coordonner et superviser un ensemble de projets liés.' },
                        { code: 'SLMO', levels: [4, 5, 6], description: 'Gestion des niveaux de service pour optimiser la disponibilité et la performance des services.' },
                        { code: 'REQM', levels: [4, 5, 6], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' },
                        { code: 'QUMG', levels: [4, 5, 6], description: 'Gestion de la qualité pour garantir que les produits et services répondent aux normes définies.' }
                    ]
                },
                {
                    opmId: '804',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has804,
                    competences: [
                        { code: 'POMG', levels: [5, 6], description: 'Gestion de portefeuille pour optimiser les investissements et les performances.' },
                        { code: 'INVA', levels: [5, 6], description: 'Évaluation et sélection des investissements pour maximiser la valeur.' },
                        { code: 'RLMT', levels: [5, 6], description: 'Gestion des relations pour maintenir des partenariats efficaces avec les parties prenantes.' }
                    ]
                },
                {
                    opmId: '312',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has312,
                    competences: [
                        { code: 'DEMM', levels: [5, 6], description: 'Suivi des technologies émergentes pour identifier les opportunités et les risques futurs.' },
                        { code: 'REQM', levels: [5, 6], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '421',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has421,
                    competences: [
                        { code: 'DBAD', levels: [2, 3, 4, 5], description: 'Gestion des bases de données pour assurer la sécurité et la conformité.' },
                        { code: 'STMG', levels: [3, 4, 5], description: 'Gestion du stockage pour optimiser l\'utilisation des ressources et assurer la disponibilité des données.' }
                    ]
                },
                {
                    opmId: '422',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has422,
                    competences: [
                        { code: 'DENG', levels: [2, 3, 4, 5], description: 'Ingénierie des données pour concevoir et développer des architectures de traitement de données.' },
                        { code: 'DTAN', levels: [2, 3, 4, 5], description: 'Analyse de données pour extraire des informations utiles et soutenir la prise de décision.' },
                        { code: 'REQM', levels: [2, 3, 4, 5], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' },
                        { code: 'DATS', levels: [2, 3, 4, 5], description: 'Science des données pour appliquer des méthodes scientifiques et statistiques avancées aux données.' },
                        { code: 'BINT', levels: [2, 3, 4, 5], description: 'Intelligence d\'affaires pour transformer les données en informations stratégiques pour l\'organisation.' }
                    ]
                },
                {
                    opmId: '612',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has612,
                    competences: [
                        { code: 'SCTY', levels: [3, 4, 5], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [3, 4, 5], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' },
                        { code: 'AUDT', levels: [3, 4, 5], description: 'Gestion des processus d\'audit pour assurer la conformité aux normes et réglementations.' },
                        { code: 'BURM', levels: [3, 4, 5], description: 'Gestion des risques d\'affaires pour identifier et gérer les menaces potentielles.' }
                    ]
                },
                {
                    opmId: '805',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has805,
                    competences: [
                        { code: 'AUDT', levels: [3, 4, 5], description: 'Gestion des processus d\'audit pour assurer la conformité aux normes et réglementations.' },
                        { code: 'INAS', levels: [3, 4, 5], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' },
                        { code: 'BURM', levels: [3, 4, 5], description: 'Identification, évaluation et contrôle des risques au sein de l\'organisation.' },
                        { code: 'QUAS', levels: [3, 4, 5], description: 'Assurance qualité pour garantir que les produits et services répondent aux normes définies.' }
                    ]
                },
                {
                    opmId: '731',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: has731,
                    competences: [
                        { code: 'TECH', levels: [4, 5], description: 'Fourniture de conseils techniques spécialisés pour soutenir les décisions stratégiques.' },
                        { code: 'SCTY', levels: [4, 5], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [4, 5], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' }
                    ]
                },
                {
                    opmId: '732',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has732,
                    competences: [
                        { code: 'PEDP', levels: [5, 6], description: 'Développement des personnes pour améliorer les compétences et les performances de l\'équipe.' }
                    ]
                },
                {
                    opmId: '751',
                    color: '153, 86, 206', // Mauve (couleur des cyberspace enablers)
                    isPresent: has751,
                    competences: [
                        { code: 'WFPL', levels: [4, 5, 6], description: 'Planification stratégique de la main-d\'œuvre pour répondre aux besoins organisationnels.' },
                        { code: 'PDSV', levels: [4, 5, 6], description: 'Conception de services pour créer des solutions adaptées aux besoins des utilisateurs.' },
                        { code: 'ETMG', levels: [4, 5, 6], description: 'Architecture d\'entreprise pour aligner les systèmes d\'information sur la stratégie organisationnelle.' },
                        { code: 'ORDI', levels: [4, 5, 6], description: 'Conception et implémentation organisationnelle pour optimiser la structure et les processus.' }
                    ]
                },
                {
                    opmId: '711',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has711,
                    competences: [
                        { code: 'TMCR', levels: [4, 5], description: 'Création d\'équipes efficaces pour atteindre les objectifs organisationnels.' },
                        { code: 'SUBF', levels: [4, 5], description: 'Gestion des fournisseurs pour optimiser la valeur des relations avec les prestataires externes.' },
                        { code: 'INCA', levels: [4, 5], description: 'Création et promotion de l\'innovation pour développer de nouvelles solutions et approches.' }
                    ]
                },
                {
                    opmId: '712',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has712,
                    competences: [
                        { code: 'ETDL', levels: [3, 4, 5], description: 'Formation et développement des équipes pour assurer la qualité et la cohérence des services.' },
                        { code: 'TEAC', levels: [3, 4, 5], description: 'Enseignement et formation des équipes pour améliorer les compétences et les performances.' },
                        { code: 'TMCR', levels: [3, 4, 5], description: 'Gestion des ressources humaines pour optimiser les compétences et les performances.' },
                        { code: 'INCA', levels: [3, 4, 5], description: 'Création et promotion de l\'innovation pour développer de nouvelles solutions et approches.' }
                    ]
                },
                {
                    opmId: '311',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: has311,
                    competences: [
                        { code: 'KNOW', levels: [5, 6], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'OCDV', levels: [5, 6], description: 'Développement et amélioration des capacités organisationnelles pour répondre aux besoins actuels et futurs.' },
                        { code: 'BPRE', levels: [5, 6], description: 'Amélioration des processus d\'affaires pour optimiser l\'allocation des ressources et les performances.' }
                    ]
                },
                {
                    opmId: '431',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has431,
                    competences: [
                        { code: 'KNOW', levels: [2, 3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'ICPM', levels: [2, 3, 4, 5], description: 'Gestion des contenus informatifs pour assurer la qualité et la cohérence des informations.' }
                    ]
                },
                {
                    opmId: '611',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has611,
                    competences: [
                        { code: 'IRMG', levels: [6, 7], description: 'Gestion des risques liés à l\'information pour protéger les actifs informationnels critiques.' },
                        { code: 'BURM', levels: [6, 7], description: 'Gestion des risques d\'affaires au niveau stratégique pour assurer la résilience organisationnelle.' },
                        { code: 'SCTY', levels: [6, 7], description: 'Sécurisation des systèmes d\'information et des données au niveau de direction et de gouvernance.' }
                    ]
                }
            ];
            
            // Créer l'élément tooltip s'il n'existe pas
            let tooltip = document.getElementById('custom-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'custom-tooltip';
                document.body.appendChild(tooltip);
                
                // Ajouter un gestionnaire pour le défilement
                window.addEventListener('scroll', () => {
                    if (tooltip.classList.contains('visible') && tooltip.currentElement) {
                        const rect = tooltip.currentElement.getBoundingClientRect();
                        const left = rect.right + 15;
                        const top = rect.top + window.scrollY - 5;
                        
                        tooltip.style.left = left + 'px';
                        tooltip.style.top = top + 'px';
                    }
                });
            }
            
            // Fonction pour positionner le tooltip à côté d'un élément
            function showTooltipNextToElement(element, tooltipContent) {
                // Créer le contenu du tooltip
                tooltip.innerHTML = tooltipContent;
                
                // Stocker une référence à l'élément actuel
                tooltip.currentElement = element;
                
                // Obtenir les coordonnées de l'élément
                const rect = element.getBoundingClientRect();
                
                // Afficher le tooltip pour obtenir ses dimensions
                tooltip.style.visibility = 'hidden';
                tooltip.classList.add('visible');
                
                // Décalage par rapport à la cellule
                const offsetX = 15;
                const offsetY = -5;
                
                // Utiliser setTimeout pour s'assurer que le tooltip est rendu avant de mesurer ses dimensions
                setTimeout(() => {
                    const tooltipRect = tooltip.getBoundingClientRect();
                    
                    // Déterminer la position (à droite par défaut, à gauche si ça dépasse)
                    let left = rect.right + offsetX;
                    let top = rect.top + window.scrollY + offsetY;
                    
                    // Si le tooltip dépasse à droite
                    if (left + tooltipRect.width > window.innerWidth) {
                        left = rect.left - tooltipRect.width - offsetX;
                    }
                    
                    // Si le tooltip dépasse en bas
                    if (top + tooltipRect.height > window.innerHeight + window.scrollY) {
                        top = (rect.bottom + window.scrollY) - tooltipRect.height;
                    }
                    
                    // Si le tooltip est trop haut (hors écran)
                    if (top < window.scrollY) {
                        top = window.scrollY + 10;
                    }
                    
                    // Appliquer les positions
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                    tooltip.style.visibility = 'visible';
                }, 10);
            }
            
            // Fonction pour masquer le tooltip
            function hideTooltip() {
                tooltip.classList.remove('visible');
                tooltip.currentElement = null;
            }
            
            // Traiter chaque configuration d'OPM ID spéciale
            specialOpmConfigs.forEach(config => {
                if (config.isPresent) {
                    console.log(`OPM ID ${config.opmId} detected, applying special behavior`);
                    
                    // Sélectionner automatiquement les cellules pour cet OPM ID dans la table des OPM IDs
                    const opmRows = document.querySelectorAll('#opm-ids-list table tr');
                    opmRows.forEach(row => {
                        const opmIdText = row.querySelector('td:first-child span');
                        if (opmIdText && opmIdText.textContent === config.opmId) {
                            // Accéder aux cercles de niveau dans la cellule des niveaux
                            const levelCircles = row.querySelectorAll('td:last-child .flex-row > div');
                            
                            // Mettre en évidence les niveaux spécifiques à chaque OPM ID
                            // Pour 901: niveau 7, pour 722: niveaux 5 et 6, pour 661/622/631/461: niveaux 3, 4, 5
                            // Pour 511/531/541: niveaux 2, 3, 4, 5, pour 521: niveaux 1, 2, 3, 4, 5
                            const levelsToHighlight = 
                                config.opmId === '901' ? [7] : 
                                config.opmId === '752' ? [6] :
                                config.opmId === '661' ? [3, 4, 5] :
                                config.opmId === '622' ? [3, 4, 5] :
                                config.opmId === '631' ? [3, 4, 5] :
                                config.opmId === '461' ? [3, 4, 5] :
                                config.opmId === '511' ? [2, 3, 4, 5] :
                                config.opmId === '521' ? [1, 2, 3, 4, 5] :
                                config.opmId === '531' ? [2, 3, 4, 5] :
                                config.opmId === '541' ? [2, 3, 4, 5] :
                                config.opmId === '121' ? [3, 4, 5] :
                                config.opmId === '141' ? [3, 4, 5] :
                                config.opmId === '111' ? [3, 4, 5] :
                                config.opmId === '112' ? [4, 5] :
                                config.opmId === '443' ? [3, 4, 5] :
                                config.opmId === '151' ? [4, 5] :
                                config.opmId === '331' ? [5, 6] :
                                config.opmId === '332' ? [5, 6] :
                                config.opmId === '132' ? [3, 4, 5] :
                                config.opmId === '333' ? [5, 6] :
                                config.opmId === '334' ? [3, 4, 5] :
                                config.opmId === '131' ? [3, 4, 5] :
                                config.opmId === '321' ? [3, 4, 5] :
                                config.opmId === '221' ? [3, 4, 5] :
                                config.opmId === '211' ? [3, 4, 5] :
                                config.opmId === '212' ? [3, 4, 5] :
                                config.opmId === '651' ? [5, 6] :
                                config.opmId === '652' ? [4, 5, 6] :
                                config.opmId === '621' ? [2, 3, 4, 5] :
                                config.opmId === '641' ? [3, 4, 5] :
                                config.opmId === '671' ? [3, 4] :
                                config.opmId === '632' ? [3, 4, 5] :
                                config.opmId === '411' ? [2, 3, 4] :
                                config.opmId === '451' ? [1, 2, 3, 4] :
                                config.opmId === '441' ? [2, 3, 4] :
                                config.opmId === '803' ? [3, 4, 5] :
                                config.opmId === '801' ? [6] :
                                config.opmId === '802' ? [4, 5, 6] :
                                config.opmId === '804' ? [5, 6] :
                                config.opmId === '312' ? [5, 6] :
                                config.opmId === '421' ? [2, 3, 4, 5] :
                                config.opmId === '422' ? [2, 3, 4, 5] :
                                config.opmId === '612' ? [3, 4, 5] :
                                config.opmId === '805' ? [3, 4, 5] :
                                config.opmId === '731' ? [4, 5] :
                                config.opmId === '732' ? [4, 5, 6] :
                                config.opmId === '751' ? [4, 5, 6] :
                                config.opmId === '711' ? [4, 5] :
                                config.opmId === '712' ? [3, 4, 5] :
                                config.opmId === '311' ? [5, 6] :
                                config.opmId === '431' ? [2, 3, 4, 5] :
                                config.opmId === '611' ? [6, 7] :
                                [5, 6]; // Pour 722 et 723
                            
                            levelsToHighlight.forEach(level => {
                                const levelIndex = level - 1; // Convertir niveau à index 0-based
                                if (levelIndex >= 0 && levelIndex < levelCircles.length) {
                                    const levelCircle = levelCircles[levelIndex];
                                    const circle = levelCircle.querySelector('div');
                                    if (circle) {
                                        circle.style.backgroundColor = `rgba(${config.color}, 0.8)`;
                                        circle.style.transform = 'scale(1.2)';
                                        circle.style.boxShadow = `0 0 5px rgba(${config.color.split(',')[0]}, ${config.color.split(',')[1]}, ${config.color.split(',')[2]}, 0.7)`;
                                        circle.style.transition = 'all 0.3s ease';
                                    }
                                }
                            });
                        }
                    });
                    
                    // Faire clignoter les cellules des compétences spécifiques
                    const targetSkillRows = document.querySelectorAll('.skill-row');
                    
                    targetSkillRows.forEach(row => {
                        const codeElement = row.querySelector('.skill-code');
                        
                        // Stocker les configurations d'OPM qui correspondent à cette compétence
                        const matchingConfigs = [];
                        
                        // Vérifier si cette compétence est dans la liste des compétences spéciales pour chaque OPM ID
                        specialOpmConfigs.forEach(config => {
                            if (config.isPresent) {
                                const competenceConfig = config.competences.find(comp => 
                                    codeElement && comp.code === codeElement.textContent.trim()
                                );
                                
                                if (competenceConfig) {
                                    matchingConfigs.push({
                                        opmId: config.opmId,
                                        color: config.color,
                                        levels: competenceConfig.levels,
                                        description: competenceConfig.description
                                    });
                                }
                            }
                        });
                        
                        if (matchingConfigs.length > 0) {
                            const skillCode = codeElement.textContent.trim();
                            const skillName = row.querySelector('.skill-name').textContent.trim();
                            console.log(`Found target skill: ${skillCode} for ${matchingConfigs.length} OPM IDs`);
                            
                            // Obtenir les level-box pour ce skill
                            const levelBoxes = row.querySelectorAll('.level-boxes .level-box');
                            
                            // Créer un mapping des niveaux aux configurations d'OPM
                            const levelToConfigs = {};
                            
                            // Pour chaque configuration d'OPM correspondante
                            matchingConfigs.forEach(config => {
                                // Pour chaque niveau spécifié dans la configuration
                                config.levels.forEach(level => {
                                    if (!levelToConfigs[level]) {
                                        levelToConfigs[level] = [];
                                    }
                                    levelToConfigs[level].push(config);
                                });
                            });
                            
                            // Maintenant, parcourir chaque niveau et appliquer les styles
                            Object.keys(levelToConfigs).forEach(level => {
                                const levelIndex = parseInt(level) - 1; // Convertir niveau à index 0-based
                                const configs = levelToConfigs[level];
                                
                                if (levelIndex >= 0 && levelIndex < levelBoxes.length) {
                                    const levelBox = levelBoxes[levelIndex];
                                    
                                    // Vérifier si ce level-box a la classe 'filled'
                                    if (levelBox.classList.contains('filled')) {
                                        // Ajouter une animation de clignotement
                                        levelBox.style.animation = 'blink-animation 1.5s infinite';
                                        
                                        // Si plusieurs OPM IDs partagent cette cellule, créer un dégradé
                                        if (configs.length > 1) {
                                            const gradientColors = configs.map(c => `rgb(${c.color})`).join(', ');
                                            levelBox.style.background = `linear-gradient(135deg, ${gradientColors})`;
                                            
                                            // Créer une ombre combinée
                                            const boxShadows = configs.map(c => `0 0 8px rgba(${c.color}, 0.7)`).join(', ');
                                            levelBox.style.boxShadow = boxShadows;
                                        } else {
                                            // Style pour un seul OPM ID
                                            const config = configs[0];
                                            levelBox.style.boxShadow = `0 0 8px rgba(${config.color}, 0.9)`;
                                            levelBox.style.background = `linear-gradient(135deg, rgb(${config.color}), rgba(${config.color}, 0.8))`;
                                        }
                                        
                                        // S'assurer que le curseur reste inchangé au survol
                                        levelBox.style.cursor = 'default';
                                        
                                        // Ajouter le tooltip au survol
                                        levelBox.addEventListener('mouseenter', () => {
                                            // Construire le contenu du tooltip avec tous les OPM IDs concernés
                                            let tooltipContent = `
                                                <div class="tooltip-title">${skillName} (${skillCode})</div>
                                                <div class="tooltip-badges">
                                            `;
                                            
                                            // Ajouter un badge pour chaque OPM ID
                                            configs.forEach(config => {
                                                tooltipContent += `
                                                    <span class="tooltip-badge" style="background-color: rgba(${config.color}, 0.8);">OPM ID: ${config.opmId}</span>
                                                `;
                                            });
                                            
                                            tooltipContent += `
                                                    <span class="tooltip-badge">Niveau: ${level}</span>
                                                </div>
                                            `;
                                            
                                            // Ajouter une description pour chaque OPM ID
                                            configs.forEach(config => {
                                                tooltipContent += `
                                                    <div class="tooltip-info">
                                                        <strong>OPM ${config.opmId}:</strong> ${config.description}
                                                    </div>
                                                `;
                                            });
                                            
                                            // Ajouter un message si plusieurs OPM IDs partagent cette compétence
                                            if (configs.length > 1) {
                                                tooltipContent += `
                                                    <div class="tooltip-info" style="margin-top: 8px; font-style: italic;">
                                                        Cette compétence est requise par ${configs.length} rôles OPM différents au niveau ${level}.
                                                    </div>
                                                `;
                                            } else {
                                                tooltipContent += `
                                                    <div class="tooltip-info">
                                                        Cette compétence est requise au niveau ${parseInt(level) === 7 ? 'expert' : parseInt(level) === 6 ? 'avancé' : 'intermédiaire'} pour le rôle OPM ${configs[0].opmId}.
                                                    </div>
                                                `;
                                            }
                                            
                                            // Afficher le tooltip à côté de la cellule
                                            showTooltipNextToElement(levelBox, tooltipContent);
                                        });
                                        
                                        // Masquer le tooltip quand la souris quitte la cellule
                                        levelBox.addEventListener('mouseleave', () => {
                                            hideTooltip();
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            });
        }
        
        // Ajouter une animation de clignotement
        const styleElement = document.createElement('style');
        styleElement.textContent = `
            @keyframes blink-animation {
                0% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.6; transform: scale(1.15); }
                100% { opacity: 1; transform: scale(1); }
            }
        `;
        document.head.appendChild(styleElement);
        
        // Exécuter une fois que les OPM IDs ont été chargés
        // On utilise un MutationObserver pour détecter quand le contenu du opm-ids-list est modifié
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' && mutation.target.id === 'opm-ids-list') {
                    handleSpecialOpmBehavior();
                }
            });
        });
        
        // Observer les changements dans l'élément opm-ids-list
        const opmIdsList = document.getElementById('opm-ids-list');
        if (opmIdsList) {
            observer.observe(opmIdsList, { childList: true });
            
            // Exécuter également immédiatement au cas où le contenu est déjà chargé
            setTimeout(handleSpecialOpmBehavior, 1000);
        }

        // Charger les OPM IDs au chargement de la page
        loadOpmIdsFromSavedSelection();
    });
    </script>
</body>
</html>
