{% extends "web_app/template/base.html" %}

{% block content %}
    <main class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">

    <!-- Sélecteur de modèles -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8 border border-gray-200">
        <h3 class="text-xl font-bold text-gray-800 mb-6 text-center">Sélectionner les modèles à afficher</h3>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Section DCWF -->
            <div class="space-y-4">
                <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                    <span class="w-3 h-3 bg-blue-500 rounded-full mr-3"></span>
                    DCWF (Defense Cyberspace Workforce Framework)
                </h4>
                <div class="grid grid-cols-2 gap-3">
                    <!-- DCWF 2025 -->
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 shadow-md hover:shadow-lg transition-all duration-200">
                        <label class="flex items-center cursor-pointer" onclick="event.stopPropagation()">
                            <input type="checkbox" 
                                   class="model-toggle mr-3 h-5 w-5 text-purple-700 bg-white border-2 border-purple-300 rounded" 
                                   data-model="dcwf-2025"
                                   checked>
                            <span class="text-white font-semibold text-sm">DCWF 2025</span>
                        </label>
                    </div>
                    
                    <!-- DCWF 2017 -->
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 shadow-md hover:shadow-lg transition-all duration-200">
                        <label class="flex items-center cursor-pointer" onclick="event.stopPropagation()">
                            <input type="checkbox" 
                                   class="model-toggle mr-3 h-5 w-5 text-blue-700 bg-white border-2 border-blue-300 rounded" 
                                   data-model="dcwf-2017"
                                   checked>
                            <span class="text-white font-semibold text-sm">DCWF 2017</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Section NCWF -->
            <div class="space-y-4">
                <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                    <span class="w-3 h-3 bg-green-500 rounded-full mr-3"></span>
                    NCWF (National Cybersecurity Workforce Framework)
                </h4>
                <div class="grid grid-cols-3 gap-3">
                    <!-- NCWF 2025 -->
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg p-4 shadow-md hover:shadow-lg transition-all duration-200">
                        <label class="flex items-center cursor-pointer" onclick="event.stopPropagation()">
                            <input type="checkbox" 
                                   class="model-toggle mr-3 h-5 w-5 text-orange-700 bg-white border-2 border-orange-300 rounded" 
                                   data-model="ncwf-2025"
                                   checked>
                            <span class="text-white font-semibold text-sm">NCWF 2025</span>
                        </label>
                    </div>
                    
                    <!-- NCWF 2024 -->
                    <div class="bg-gradient-to-r from-red-500 to-red-600 rounded-lg p-4 shadow-md hover:shadow-lg transition-all duration-200">
                        <label class="flex items-center cursor-pointer" onclick="event.stopPropagation()">
                            <input type="checkbox" 
                                   class="model-toggle mr-3 h-5 w-5 text-red-700 bg-white border-2 border-red-300 rounded" 
                                   data-model="ncwf-2024"
                                   checked>
                            <span class="text-white font-semibold text-sm">NCWF 2024</span>
                        </label>
                    </div>
                    
                    <!-- NCWF 2017 -->
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 shadow-md hover:shadow-lg transition-all duration-200">
                        <label class="flex items-center cursor-pointer" onclick="event.stopPropagation()">
                            <input type="checkbox" 
                                   class="model-toggle mr-3 h-5 w-5 text-green-700 bg-white border-2 border-green-300 rounded" 
                                   data-model="ncwf-2017"
                                   checked>
                            <span class="text-white font-semibold text-sm">NCWF 2017</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Légende des couleurs -->
        <div class="mt-6 pt-4 border-t border-gray-200">
            <p class="text-sm text-gray-600 text-center">
                <span class="font-medium">Légende :</span> Chaque modèle a sa couleur distinctive pour faciliter l'identification
            </p>
        </div>
    </div>

    {% for category in categories %}
        {% if category.title == "Cybersecurity" %}
            <div class="category-container rounded-lg mt-6 relative"
                 style="background-color: rgba({{ category.color }}, 0.75);" 
                 id="category-{{ category.title|slugify }}">
                <!-- Titre + description TOUJOURS visibles -->
                <div class="category-content">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-white text-lg font-bold p-2 w-max rounded"
                         style="background-color: rgba({{ category.color }}, 1);">
                        {{ category.title }}
                        </div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   class="category-toggle mr-2 h-5 w-5 text-blue-600" 
                                   data-category="category-{{ category.title|slugify }}">
                            <span class="text-white font-medium">Dérouler</span>
                        </label>
                    </div>
                    <div class="text-white p-2">
                        {{ category.description }}
                    </div>
                </div>

                <!-- Rôles triés par ID prefix -->
                {% for line in cyber_security_lines %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mt-4 pt-6">
                        {% for work_role in line %}
                            {% if work_role == None %}
                                <div class="col-span-1"></div>  {# Espace vide, transparent #}

                            {% else %}
                                <!-- Conteneur relatif pour positionner le detail-box -->
                                <div class="bg-white rounded-lg shadow-md grid grid-rows-6 work-role relative"
                                     id="work-role-{{ work_role.id }}" onclick="toggleDetail('{{ work_role.id }}')">

                                    <!-- ZONE 0 - OPM ID (toujours visible) -->
                                    <div class="px-5 pt-5 flex flex-col items-center justify-center">
                                        <p class="font-semibold text-center"
                                           style="color: rgba({{ category.color }},1);">
                                            {% if work_role.opm.id in highlight_ids %}
                                                <span class="inline-block w-2 h-2 bg-red-600 rounded-full mr-2"></span>
                                            {% endif %}
                                            {{ work_role.opm.id }}
                                        </p>
                                    </div>

                                    <!-- ZONE 1 - NCWF 2025 -->
                                    <div class="px-5 py-1 flex flex-col items-center justify-center">
                                        {% if work_role.ncwf_2025_work_role %}
                                            <p class="text-gray-500 text-sm font-medium text-center">{{ work_role.ncwf_2025_work_role.ncwf_id }}</p>
                                            <p class="font-bold text-sm text-gray-600 text-center">{{ work_role.ncwf_2025_work_role.ncwf_title }}</p>
                                            <input type="checkbox" name="ncwf_2025_{{ work_role.ncwf_2025_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-purple-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 2 - DCWF 2025 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.dcwf_2025_work_role %}
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.dcwf_2025_work_role.title }}</p>
                                            <input type="checkbox" name="dcwf_2025_{{ work_role.dcwf_2025_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-indigo-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 3 - NCWF 2024 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.ncwf_2024_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2024_work_role.nist_id }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2024_work_role.title }}</p>
                                            <input type="checkbox" name="ncwf_2024_{{ work_role.ncwf_2024_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-red-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 4 - NCWF 2017 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.ncwf_2017_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2017_work_role.nist_id }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2017_work_role.title }}</p>
                                            <input type="checkbox" name="ncwf_2017_{{ work_role.ncwf_2017_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-green-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 5 - DCWF (le plus ancien) -->
                                    <div class="text-center px-5 pb-5 flex flex-col justify-center">
                                        <p class="font-normal text-base text-gray-600">{{ work_role.title }}</p>
                                        <input type="checkbox" name="dcwf_{{ work_role.id }}"
                                               class="form-checkbox h-5 w-5 text-blue-600 self-center mt-2">
                                    </div>

                                    <!-- Données cachées -->
                                    <p class="hidden description">{{ work_role.description }}</p>
                                    <p class="hidden ksat-id">{{ item.ncwf_2017_ksat.ncwf_id }}</p>
                                    <p class="hidden dcwf-id">{{ item.dcwf_id }}</p>
                                    <p class="hidden description">{{ item.description }}</p>

                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>

        {% elif category.title == "IT (Cyberspace)" %}
            <div class="category-container rounded-lg mt-6 relative"
                 style="background-color: rgba({{ category.color }}, 0.75);"
                 id="category-{{ category.title|slugify }}">
                <!-- Titre + description TOUJOURS visibles -->
                <div class="category-content">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-white text-lg font-bold p-2 w-max rounded"
                         style="background-color: rgba({{ category.color }}, 1);">
                        {{ category.title }}
                        </div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   class="category-toggle mr-2 h-5 w-5 text-blue-600" 
                                   data-category="category-{{ category.title|slugify }}">
                            <span class="text-white font-medium">Dérouler</span>
                        </label>
                    </div>
                    <div class="text-white p-2">
                        {{ category.description }}
                    </div>
                </div>

                <!-- Rôles triés par ID prefix -->
                {% for line in it_work_lines %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mt-4 pt-6">
                        {% for work_role in line %}
                            {% if work_role == None %}
                                <div class="col-span-1"></div>  {# Espace vide, transparent #}
                            {% else %}
                                <!-- Conteneur relatif pour positionner le detail-box -->
                                <div class="bg-white rounded-lg shadow-md grid grid-rows-6 work-role relative"
                                     id="work-role-{{ work_role.id }}" onclick="toggleDetail('{{ work_role.id }}')">

                                    <!-- ZONE 0 - OPM ID (toujours visible) -->
                                    <div class="px-5 pt-5 flex flex-col items-center justify-center">
                                        <p class="font-semibold text-center"
                                           style="color: rgba({{ category.color }},1);">
                                            {% if work_role.opm.id in highlight_ids %}
                                                <span class="inline-block w-2 h-2 bg-red-600 rounded-full mr-2"></span>
                                            {% endif %}
                                            {{ work_role.opm.id }}
                                        </p>
                                    </div>

                                    <!-- ZONE 1 - NCWF 2025 -->
                                    <div class="px-5 py-1 flex flex-col items-center justify-center">
                                        {% if work_role.ncwf_2025_work_role %}
                                            <p class="text-gray-500 text-sm font-medium text-center">{{ work_role.ncwf_2025_work_role.ncwf_id }}</p>
                                            <p class="font-bold text-sm text-gray-600 text-center">{{ work_role.ncwf_2025_work_role.ncwf_title }}</p>
                                            <input type="checkbox" name="ncwf_2025_{{ work_role.ncwf_2025_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-purple-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 2 - DCWF 2025 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.dcwf_2025_work_role %}
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.dcwf_2025_work_role.title }}</p>
                                            <input type="checkbox" name="dcwf_2025_{{ work_role.dcwf_2025_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-indigo-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 3 - NCWF 2024 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.ncwf_2024_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2024_work_role.nist_id }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2024_work_role.title }}</p>
                                            <input type="checkbox" name="ncwf_2024_{{ work_role.ncwf_2024_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-red-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 4 - NCWF 2017 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.ncwf_2017_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2017_work_role.nist_id }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2017_work_role.title }}</p>
                                            <input type="checkbox" name="ncwf_2017_{{ work_role.ncwf_2017_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-green-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 5 - DCWF (le plus ancien) -->
                                    <div class="text-center px-5 pb-5 flex flex-col justify-center">
                                        <p class="font-normal text-base text-gray-600">{{ work_role.title }}</p>
                                        <input type="checkbox" name="dcwf_{{ work_role.id }}"
                                               class="form-checkbox h-5 w-5 text-blue-600 self-center mt-2">
                                    </div>

                                    <!-- Données cachées -->
                                    <p class="hidden description">{{ work_role.description }}</p>
                                    <p class="hidden ksat-id">{{ item.ncwf_2017_ksat.ncwf_id }}</p>
                                    <p class="hidden dcwf-id">{{ item.dcwf_id }}</p>
                                    <p class="hidden description">{{ item.description }}</p>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>

        {% else %}
            <!-- Autres catégories normales -->
            <div class="category-container rounded-lg mt-6"
                 style="background-color: rgba({{ category.color }}, 0.75);"
                 id="category-{{ category.title|slugify }}">

                <div class="category-content">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-white text-lg font-bold p-2 w-max rounded"
                         style="background-color: rgba({{ category.color }}, 1);">
                        {{ category.title }}
                        </div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   class="category-toggle mr-2 h-5 w-5 text-blue-600" 
                                   data-category="category-{{ category.title|slugify }}">
                            <span class="text-white font-medium">Dérouler</span>
                        </label>
                    </div>
                    <div class="text-white p-2">
                        {{ category.description }}
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mt-4 pt-10">
                    {% for work_role in category.dcwf_work_roles.all %}
                        <div class="bg-white rounded-lg shadow-md grid grid-rows-6 work-role relative"
                             id="work-role-{{ work_role.id }}" onclick="toggleDetail('{{ work_role.id }}')">
                            <!-- ZONE 0 - OPM ID (toujours visible) -->
                            <div class="px-5 pt-5 flex flex-col items-center justify-center">
                                <p class="font-semibold text-center"
                                   style="color: rgba({{ category.color }},1);">
                                    {% if work_role.opm.id in highlight_ids %}
                                        <span class="inline-block w-2 h-2 bg-red-600 rounded-full mr-2"></span>
                                    {% endif %}
                                    {{ work_role.opm.id }}
                                </p>
                            </div>
                            <!-- ZONE 1 - NCWF 2025 -->
                            <div class="px-5 py-1 flex flex-col items-center justify-center">
                                {% if work_role.ncwf_2025_work_role %}
                                    <p class="text-gray-500 text-sm font-medium text-center">{{ work_role.ncwf_2025_work_role.ncwf_id }}</p>
                                    <p class="font-bold text-sm text-gray-600 text-center">{{ work_role.ncwf_2025_work_role.ncwf_title }}</p>
                                    <input type="checkbox" name="ncwf_2025_{{ work_role.ncwf_2025_work_role.id }}"
                                           class="form-checkbox h-5 w-5 text-purple-600 self-center mt-2">
                                {% endif %}
                            </div>
                            <!-- ZONE 2 - DCWF 2025 -->
                            <div class="text-center px-5 py-1 flex flex-col justify-center">
                                {% if work_role.dcwf_2025_work_role %}
                                    <p class="font-normal text-sm text-gray-600">{{ work_role.dcwf_2025_work_role.title }}</p>
                                    <input type="checkbox" name="dcwf_2025_{{ work_role.dcwf_2025_work_role.id }}"
                                           class="form-checkbox h-5 w-5 text-indigo-600 self-center mt-2">
                                {% endif %}
                            </div>
                            <!-- ZONE 3 - NCWF 2024 -->
                            <div class="text-center px-5 py-1 flex flex-col justify-center">
                                {% if work_role.ncwf_2024_work_role %}
                                    <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2024_work_role.nist_id }}</p>
                                    <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2024_work_role.title }}</p>
                                    <input type="checkbox" name="ncwf_2024_{{ work_role.ncwf_2024_work_role.id }}"
                                           class="form-checkbox h-5 w-5 text-red-600 self-center mt-2">
                                {% endif %}
                            </div>
                            <!-- ZONE 4 - NCWF 2017 -->
                            <div class="text-center px-5 py-1 flex flex-col justify-center">
                                {% if work_role.ncwf_2017_work_role %}
                                    <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2017_work_role.nist_id }}</p>
                                    <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2017_work_role.title }}</p>
                                    <input type="checkbox" name="ncwf_2017_{{ work_role.ncwf_2017_work_role.id }}"
                                           class="form-checkbox h-5 w-5 text-green-600 self-center mt-2">
                                {% endif %}
                            </div>
                            <!-- ZONE 5 - DCWF (le plus ancien) -->
                            <div class="text-center px-5 pb-5 flex flex-col justify-center">
                                <p class="font-normal text-base text-gray-600">{{ work_role.title }}</p>
                                <input type="checkbox" name="dcwf_{{ work_role.id }}"
                                       class="form-checkbox h-5 w-5 text-blue-600 self-center mt-2">
                            </div>
                            <!-- Données cachées -->
                            <p class="hidden description">{{ work_role.description }}</p>
                            <p class="hidden ksat-id">{{ item.ncwf_2017_ksat.ncwf_id }}</p>
                            <p class="hidden dcwf-id">{{ item.dcwf_id }}</p>
                            <p class="hidden description">{{ item.description }}</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endfor %}

    <!-- Div caché pour afficher plus de détails (commun à toutes les catégories) -->
    <div id="detail-box"
         class="detail-box hidden fixed right-0 top-0 h-full w-[400px] p-6 shadow-xl overflow-y-auto z-50">
        <button onclick="toggleDetail(null)" class="text-red-500 font-bold float-right">X</button>
        <div id="detail-box-content"></div>
        <button id="compare-button"
                onclick="compareSelected()"
                class="mt-4 px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700"
                style="display: none;">
            Comparer
            <p id="warning-message"
               class="text-red-600 font-semibold mt-2"
               style="display: none;">
                ⚠️ Il est recommandé de comparer un maximum de 3 rôles pour plus de lisibilité.
            </p>
        </button>
    </div>

    </main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gestion des cases à cocher pour le déroulement des catégories
        document.querySelectorAll('.category-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', function(event) {
                const categoryId = this.getAttribute('data-category');
                const categoryContainer = document.getElementById(categoryId);
                
                if (categoryContainer) {
                    if (this.checked) {
                        categoryContainer.classList.add('expanded');
                    } else {
                        categoryContainer.classList.remove('expanded');
                    }
                }
                
                // Empêcher la propagation du clic
                event.stopPropagation();
            });
            
            // Empêcher que le clic sur la case à cocher déclenche d'autres événements
            checkbox.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        });

        // Gestion des clics sur les work roles pour afficher les détails
        document.querySelectorAll('.work-role').forEach(workRole => {
            workRole.addEventListener('click', function(event) {
                // Ne pas déclencher si on clique sur une checkbox
                if (event.target.type === 'checkbox') {
                    return;
                }
                
                const workRoleId = this.id.replace('work-role-', '');
                toggleDetail(workRoleId);
            });
        });

        // Gestion des checkboxes : afficher TOUJOURS la fenêtre de détails
        document.querySelectorAll('.work-role input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('click', function(event) {
                // TOUJOURS afficher la fenêtre de détails quand on clique sur une checkbox
                const workRoleElement = this.closest('.work-role');
                if (workRoleElement) {
                    const workRoleId = workRoleElement.id.replace('work-role-', '');
                    toggleDetail(workRoleId);
                }
                
                event.stopPropagation();
                updateCompareButton();
            });
        });

        // Initialiser le bouton de comparaison
        updateCompareButton();
        
        // Gestion des sélecteurs de modèles
        document.querySelectorAll('.model-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const modelType = this.getAttribute('data-model');
                const isChecked = this.checked;
                
                // Masquer/afficher les zones correspondantes
                toggleModelVisibility(modelType, isChecked);
            });
        });
    });

    // Fonction pour masquer/afficher les zones selon le modèle sélectionné
    function toggleModelVisibility(modelType, isVisible) {
        const workRoles = document.querySelectorAll('.work-role');
        
        workRoles.forEach(workRole => {
            let targetZone;
            
            switch(modelType) {
                case 'ncwf-2025':
                    targetZone = workRole.querySelector('div:nth-child(2)');
                    break;
                case 'dcwf-2025':
                    targetZone = workRole.querySelector('div:nth-child(3)');
                    break;
                case 'ncwf-2024':
                    targetZone = workRole.querySelector('div:nth-child(4)');
                    break;
                case 'ncwf-2017':
                    targetZone = workRole.querySelector('div:nth-child(5)');
                    break;
                case 'dcwf-2017':
                    targetZone = workRole.querySelector('div:nth-child(6)');
                    break;
            }
            
            if (targetZone) {
                if (isVisible) {
                    targetZone.style.display = 'flex';
                } else {
                    targetZone.style.display = 'none';
                }
            }
        });
    }

    // Fonction pour afficher/masquer la fenêtre de détails
    function toggleDetail(workRoleId) {
        const detailBox = document.getElementById('detail-box');
        const detailContent = document.getElementById('detail-box-content');
        
        if (!workRoleId) {
            // Fermer la fenêtre
            detailBox.classList.add('hidden');
            return;
        }

        const workRoleElement = document.getElementById(`work-role-${workRoleId}`);
        if (!workRoleElement) return;

        // Récupérer les informations de toutes les zones
        const descriptionElement = workRoleElement.querySelector('.description');
        
        // Zone 0 - OPM ID (toujours visible)
        const opmIdElement = workRoleElement.querySelector('div:nth-child(1) p.font-semibold');
        const opmId = opmIdElement ? opmIdElement.textContent.trim() : 'ID non disponible';

        // Zone 1 - NCWF 2025 (le plus récent)
        const ncwf2025Zone = workRoleElement.querySelector('div:nth-child(2)');
        const ncwf2025Id = ncwf2025Zone ? ncwf2025Zone.querySelector('p.text-gray-500')?.textContent : '';
        const ncwf2025Title = ncwf2025Zone ? ncwf2025Zone.querySelector('p.text-gray-600')?.textContent : '';
        
        // Zone 2 - DCWF 2025
        const dcwf2025Zone = workRoleElement.querySelector('div:nth-child(3)');
        const dcwf2025Code = dcwf2025Zone ? dcwf2025Zone.querySelector('p.text-gray-500')?.textContent : '';
        const dcwf2025Title = dcwf2025Zone ? dcwf2025Zone.querySelector('p.text-gray-600')?.textContent : '';
        
        // Zone 3 - NCWF 2024
        const ncwf2024Zone = workRoleElement.querySelector('div:nth-child(4)');
        const ncwf2024Id = ncwf2024Zone ? ncwf2024Zone.querySelector('p.text-gray-500')?.textContent : '';
        const ncwf2024Title = ncwf2024Zone ? ncwf2024Zone.querySelector('p.text-gray-600')?.textContent : '';
        
        // Zone 4 - NCWF 2017
        const ncwf2017Zone = workRoleElement.querySelector('div:nth-child(5)');
        const ncwf2017Id = ncwf2017Zone ? ncwf2017Zone.querySelector('p.text-gray-500')?.textContent : '';
        const ncwf2017Title = ncwf2017Zone ? ncwf2017Zone.querySelector('p.text-gray-600')?.textContent : '';
        
        // Zone 5 - DCWF (le plus ancien)
        const dcwfTitle = workRoleElement.querySelector('div:nth-child(6) p.font-normal')?.textContent;

        // Générer le contenu HTML
        let contentHtml = '';
        
        // Zone 0 - OPM ID (toujours visible)
        contentHtml += `
            <div class="mb-4 p-3 bg-gray-50 rounded">
                <h4 class="font-bold text-gray-800 mb-2">🟦 Zone 0 - OPM ID</h4>
                <p><strong>OPM ID:</strong> ${opmId}</p>
            </div>`;
        
        // Zone 1 - NCWF 2025 (le plus récent)
        if (ncwf2025Id && ncwf2025Title) {
            contentHtml += `
            <div class="mb-4 p-3 bg-purple-50 rounded">
                <h4 class="font-bold text-purple-800 mb-2">🟪 Zone 1 - NCWF 2025 (le plus récent)</h4>
                <p><strong>NCWF ID:</strong> ${ncwf2025Id}</p>
                <p><strong>Titre:</strong> ${ncwf2025Title}</p>
            </div>`;
        }
        
        // Zone 2 - DCWF 2025
        if (dcwf2025Code && dcwf2025Title) {
            contentHtml += `
            <div class="mb-4 p-3 bg-indigo-50 rounded">
                <h4 class="font-bold text-indigo-800 mb-2">🟣 Zone 2 - DCWF 2025</h4>
                <p><strong>Code DCWF:</strong> ${dcwf2025Code}</p>
                <p><strong>Titre:</strong> ${dcwf2025Title}</p>
            </div>`;
        }
        
        // Zone 3 - NCWF 2024
        if (ncwf2024Id && ncwf2024Title) {
            contentHtml += `
            <div class="mb-4 p-3 bg-red-50 rounded">
                <h4 class="font-bold text-red-800 mb-2">🔴 Zone 3 - NCWF 2024</h4>
                <p><strong>NIST ID:</strong> ${ncwf2024Id}</p>
                <p><strong>Titre:</strong> ${ncwf2024Title}</p>
            </div>`;
        }
        
        // Zone 4 - NCWF 2017
        if (ncwf2017Id && ncwf2017Title) {
            contentHtml += `
            <div class="mb-4 p-3 bg-green-50 rounded">
                <h4 class="font-bold text-green-800 mb-2">🟢 Zone 4 - NCWF 2017</h4>
                <p><strong>NIST ID:</strong> ${ncwf2017Id}</p>
                <p><strong>Titre:</strong> ${ncwf2017Title}</p>
            </div>`;
        }
        
        // Zone 5 - DCWF (le plus ancien)
        contentHtml += `
            <div class="mb-4 p-3 bg-blue-50 rounded">
                <h4 class="font-bold text-blue-800 mb-2">🔵 Zone 5 - DCWF (le plus ancien)</h4>
                <p><strong>Titre:</strong> ${dcwfTitle}</p>
                ${descriptionElement ? `<p><strong>Description:</strong> ${descriptionElement.textContent}</p>` : ''}
            </div>`;
        
        // Mettre à jour le contenu et afficher la fenêtre
        detailContent.innerHTML = contentHtml;
        detailBox.classList.remove('hidden');
    }

    // Fonction pour mettre à jour le bouton de comparaison
    function updateCompareButton() {
        const compareButton = document.getElementById('compare-button');
        const checkedBoxes = document.querySelectorAll('.work-role input[type="checkbox"]:checked');
        
        if (checkedBoxes.length > 0) {
            compareButton.style.display = 'block';
        } else {
            compareButton.style.display = 'none';
        }
    }

    // Fonction pour comparer les éléments sélectionnés
    function compareSelected() {
        const checkedBoxes = document.querySelectorAll('.work-role input[type="checkbox"]:checked');
        const selectedWorkRoles = [];
        
        checkedBoxes.forEach(checkbox => {
            const workRoleElement = checkbox.closest('.work-role');
            if (workRoleElement) {
                const opmIdElement = workRoleElement.querySelector('p.font-semibold');
                const titleElement = workRoleElement.querySelector('p.font-bold');
                
                if (opmIdElement && titleElement) {
                    const opmId = opmIdElement.textContent.trim();
                    const title = titleElement.textContent;
                    selectedWorkRoles.push({
                        opm_id: opmId,
                        title: title
                    });
                }
            }
        });

        if (selectedWorkRoles.length > 0) {
            console.log('Work roles sélectionnés pour comparaison:', selectedWorkRoles);
            alert(`${selectedWorkRoles.length} work role(s) sélectionné(s) pour comparaison`);
        } else {
            alert('Veuillez sélectionner au moins un work role pour la comparaison.');
        }
    }
</script>

<style>
    /* Styles pour les 5 zones */
    .work-role {
        min-height: 200px; /* Augmenter la hauteur pour accommoder 5 zones */
        transition: all 0.3s ease;
    }
    
    .work-role:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    /* Couleurs distinctes pour chaque zone */
    .work-role input[name^="dcwf_"]:not([name*="2025"]) {
        border-color: #3b82f6; /* Bleu pour DCWF */
    }
    
    .work-role input[name^="ncwf_2017_"] {
        border-color: #10b981; /* Vert pour NCWF 2017 */
    }
    
    .work-role input[name^="ncwf_2024_"] {
        border-color: #ef4444; /* Rouge pour NCWF 2024 */
    }
    
    .work-role input[name^="dcwf_2025_"] {
        border-color: #6366f1; /* Indigo pour DCWF 2025 */
    }
    
    .work-role input[name^="ncwf_2025_"] {
        border-color: #8b5cf6; /* Violet pour NCWF 2025 */
    }
    
    /* Masquer les work roles par défaut */
    .category-container .work-role-container {
        display: none;
    }
    
    /* Afficher les work roles quand la catégorie est expanded */
    .category-container.expanded .work-role-container {
        display: grid;
    }
    
            /* Animation pour le detail box */
        .detail-box {
            max-width: 350px;
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            /* Améliorer le positionnement */
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            /* Ajouter une ombre pour mieux le distinguer */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            /* Améliorer l'apparence */
            border-radius: 12px;
            background: white;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(-50%) translateX(20px);
        }
        
        .detail-box:not(.hidden) {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
        }
</style>

{% endblock %}
