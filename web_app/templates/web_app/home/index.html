{% extends "web_app/template/base.html" %}

{% block content %}
    <main class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <!-- Sélecteur de mode -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <label for="modeSelector" class="block text-sm font-medium text-gray-700 mb-2">Mode de sélection:</label>
            <select id="modeSelector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                <option value="mode1">Mode 1 - Zone 1 uniquement</option>
                <option value="mode2" selected>Mode 2 - Standard (Zone 3 désactivée)</option>
                <option value="mode3">Mode 3 - Zone 3 uniquement</option>
                <option value="admin">Mode Admin - Toutes les zones</option>
            </select>
        </div>

        <!-- Titre de la page Modèles DCWF 2025 -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 rounded-lg shadow-md mb-6">
            <h1 class="text-white text-2xl font-bold">Modèles DCWF 2025 - Fusion Complète</h1>
            <p class="text-blue-100 mt-2">Intégration des nouveaux rôles et catégories pour l'année 2025</p>
        </div>

    {% for category in categories %}
        {% if category.title == "Cybersecurity" %}
            <div class="category-container rounded-lg mt-6 relative"
                 style="background-color: rgba({{ category.color }}, 0.75);" 
                 id="category-{{ category.title|slugify }}">
                <!-- Titre + description TOUJOURS visibles -->
                <div class="category-content">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-white text-lg font-bold p-2 w-max rounded"
                         style="background-color: rgba({{ category.color }}, 1);">
                        {{ category.title }}
                        </div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   class="category-toggle mr-2 h-5 w-5 text-blue-600" 
                                   data-category="category-{{ category.title|slugify }}">
                            <span class="text-white font-medium">Dérouler</span>
                        </label>
                    </div>
                    <div class="text-white p-2">
                        {{ category.description }}
                    </div>
                </div>

                <!-- Rôles triés par ID prefix -->
                {% for line in cyber_security_lines %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mt-4 pt-6">
                        {% for work_role in line %}
                            {% if work_role == None %}
                                <div class="col-span-1"></div>  {# Espace vide, transparent #}

                            {% else %}
                                <!-- Conteneur relatif pour positionner le detail-box -->
                                <div class="bg-white rounded-lg shadow-md grid grid-rows-5 work-role relative"
                                     id="work-role-{{ work_role.id }}" onclick="toggleDetail('{{ work_role.id }}')">

                                    <!-- ZONE 1 - DCWF -->
                                    <div class="px-5 pt-5 flex flex-col items-center justify-center">
                                        <p class="font-semibold flex items-center justify-center"
                                           style="color: rgba({{ category.color }},1);">
                                            {% if work_role.opm.id in highlight_ids %}
                                                <span class="inline-block w-2 h-2 bg-red-600 rounded-full mr-2"></span>
                                            {% endif %}
                                            {{ work_role.opm.id }}
                                        </p>
                                        <p class="font-bold text-base">{{ work_role.title }}</p>
                                        <input type="checkbox" name="dcwf_{{ work_role.id }}"
                                               class="form-checkbox h-5 w-5 text-blue-600 self-center mt-2">
                                    </div>

                                    <!-- ZONE 2 - NCWF 2017 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.ncwf_2017_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2017_work_role.nist_id }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2017_work_role.title }}</p>
                                            <input type="checkbox" name="ncwf_2017_{{ work_role.ncwf_2017_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-green-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 3 - NCWF 2024 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.ncwf_2024_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2024_work_role.nist_id }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2024_work_role.title }}</p>
                                            <input type="checkbox" name="ncwf_2024_{{ work_role.ncwf_2024_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-red-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 4 - DCWF 2025 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.dcwf_2025_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.dcwf_2025_work_role.dcwf_code }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.dcwf_2025_work_role.title }}</p>
                                            <input type="checkbox" name="dcwf_2025_{{ work_role.dcwf_2025_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-indigo-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 5 - NCWF 2025 -->
                                    <div class="text-center px-5 pb-5 flex flex-col justify-center">
                                        {% if work_role.ncwf_2025_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2025_work_role.ncwf_id }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2025_work_role.ncwf_title }}</p>
                                            <input type="checkbox" name="ncwf_2025_{{ work_role.ncwf_2025_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-purple-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- Données cachées -->
                                    <p class="hidden description">{{ work_role.description }}</p>
                                    <p class="hidden ksat-id">{{ item.ncwf_2017_ksat.ncwf_id }}</p>
                                    <p class="hidden dcwf-id">{{ item.dcwf_id }}</p>
                                    <p class="hidden description">{{ item.description }}</p>

                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>

        {% elif category.title == "IT (Cyberspace)" %}
            <div class="category-container rounded-lg mt-6 relative"
                 style="background-color: rgba({{ category.color }}, 0.75);"
                 id="category-{{ category.title|slugify }}">
                <!-- Titre + description TOUJOURS visibles -->
                <div class="category-content">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-white text-lg font-bold p-2 w-max rounded"
                         style="background-color: rgba({{ category.color }}, 1);">
                        {{ category.title }}
                        </div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   class="category-toggle mr-2 h-5 w-5 text-blue-600" 
                                   data-category="category-{{ category.title|slugify }}">
                            <span class="text-white font-medium">Dérouler</span>
                        </label>
                    </div>
                    <div class="text-white p-2">
                        {{ category.description }}
                    </div>
                </div>

                <!-- Rôles triés par ID prefix -->
                {% for line in it_work_lines %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mt-4 pt-6">
                        {% for work_role in line %}
                            {% if work_role == None %}
                                <div class="col-span-1"></div>  {# Espace vide, transparent #}
                            {% else %}
                                <!-- Conteneur relatif pour positionner le detail-box -->
                                <div class="bg-white rounded-lg shadow-md grid grid-rows-5 work-role relative"
                                     id="work-role-{{ work_role.id }}" onclick="toggleDetail('{{ work_role.id }}')">

                                    <!-- ZONE 1 - DCWF -->
                                    <div class="px-5 pt-5 flex flex-col items-center justify-center">
                                        <p class="font-semibold flex items-center justify-center"
                                           style="color: rgba({{ category.color }},1);">
                                            {% if work_role.opm.id in highlight_ids %}
                                                <span class="inline-block w-2 h-2 bg-red-600 rounded-full mr-2"></span>
                                            {% endif %}
                                            {{ work_role.opm.id }}
                                        </p>
                                        <p class="font-bold text-base">{{ work_role.title }}</p>
                                        <input type="checkbox" name="dcwf_{{ work_role.id }}"
                                               class="form-checkbox h-5 w-5 text-blue-600 self-center mt-2">
                                    </div>

                                    <!-- ZONE 2 - NCWF 2017 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.ncwf_2017_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2017_work_role.nist_id }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2017_work_role.title }}</p>
                                            <input type="checkbox" name="ncwf_2017_{{ work_role.ncwf_2017_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-green-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 3 - NCWF 2024 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.ncwf_2024_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2024_work_role.nist_id }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2024_work_role.title }}</p>
                                            <input type="checkbox" name="ncwf_2024_{{ work_role.ncwf_2024_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-red-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 4 - DCWF 2025 -->
                                    <div class="text-center px-5 py-1 flex flex-col justify-center">
                                        {% if work_role.dcwf_2025_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.dcwf_2025_work_role.dcwf_code }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.dcwf_2025_work_role.title }}</p>
                                            <input type="checkbox" name="dcwf_2025_{{ work_role.dcwf_2025_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-indigo-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- ZONE 5 - NCWF 2025 -->
                                    <div class="text-center px-5 pb-5 flex flex-col justify-center">
                                        {% if work_role.ncwf_2025_work_role %}
                                            <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2025_work_role.ncwf_id }}</p>
                                            <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2025_work_role.ncwf_title }}</p>
                                            <input type="checkbox" name="ncwf_2025_{{ work_role.ncwf_2025_work_role.id }}"
                                                   class="form-checkbox h-5 w-5 text-purple-600 self-center mt-2">
                                        {% endif %}
                                    </div>

                                    <!-- Données cachées -->
                                    <p class="hidden description">{{ work_role.description }}</p>
                                    <p class="hidden ksat-id">{{ item.ncwf_2017_ksat.ncwf_id }}</p>
                                    <p class="hidden dcwf-id">{{ item.dcwf_id }}</p>
                                    <p class="hidden description">{{ item.description }}</p>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>

        {% else %}
            <!-- Autres catégories normales -->
            <div class="category-container rounded-lg mt-6"
                 style="background-color: rgba({{ category.color }}, 0.75);"
                 id="category-{{ category.title|slugify }}">

                <div class="category-content">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-white text-lg font-bold p-2 w-max rounded"
                         style="background-color: rgba({{ category.color }}, 1);">
                        {{ category.title }}
                        </div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   class="category-toggle mr-2 h-5 w-5 text-blue-600" 
                                   data-category="category-{{ category.title|slugify }}">
                            <span class="text-white font-medium">Dérouler</span>
                        </label>
                    </div>
                    <div class="text-white p-2">
                        {{ category.description }}
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mt-4 pt-10">
                    {% for work_role in category.dcwf_work_roles.all %}
                        <div class="bg-white rounded-lg shadow-md grid grid-rows-5 work-role relative"
                             id="work-role-{{ work_role.id }}" onclick="toggleDetail('{{ work_role.id }}')">
                            <!-- ZONE 1 - DCWF -->
                            <div class="px-5 pt-5 flex flex-col items-center justify-center">
                                <p class="font-semibold flex items-center justify-center"
                                   style="color: rgba({{ category.color }},1);">
                                    {% if work_role.opm.id in highlight_ids %}
                                        <span class="inline-block w-2 h-2 bg-red-600 rounded-full mr-2"></span>
                                    {% endif %}
                                    {{ work_role.opm.id }}
                                </p>
                                <p class="font-bold text-base">{{ work_role.title }}</p>
                                <input type="checkbox" name="dcwf_{{ work_role.id }}"
                                       class="form-checkbox h-5 w-5 text-blue-600 self-center mt-2">
                            </div>
                            <!-- ZONE 2 - NCWF 2017 -->
                            <div class="text-center px-5 py-1 flex flex-col justify-center">
                                {% if work_role.ncwf_2017_work_role %}
                                    <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2017_work_role.nist_id }}</p>
                                    <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2017_work_role.title }}</p>
                                    <input type="checkbox" name="ncwf_2017_{{ work_role.ncwf_2017_work_role.id }}"
                                           class="form-checkbox h-5 w-5 text-green-600 self-center mt-2">
                                {% endif %}
                            </div>
                            <!-- ZONE 3 - NCWF 2024 -->
                            <div class="text-center px-5 py-1 flex flex-col justify-center">
                                {% if work_role.ncwf_2024_work_role %}
                                    <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2024_work_role.nist_id }}</p>
                                    <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2024_work_role.title }}</p>
                                    <input type="checkbox" name="ncwf_2024_{{ work_role.ncwf_2024_work_role.id }}"
                                           class="form-checkbox h-5 w-5 text-red-600 self-center mt-2">
                                {% endif %}
                            </div>
                            <!-- ZONE 4 - DCWF 2025 -->
                            <div class="text-center px-5 py-1 flex flex-col justify-center">
                                {% if work_role.dcwf_2025_work_role %}
                                    <p class="text-gray-500 text-sm font-medium">{{ work_role.dcwf_2025_work_role.dcwf_code }}</p>
                                    <p class="font-normal text-sm text-gray-600">{{ work_role.dcwf_2025_work_role.title }}</p>
                                    <input type="checkbox" name="dcwf_2025_{{ work_role.dcwf_2025_work_role.id }}"
                                           class="form-checkbox h-5 w-5 text-indigo-600 self-center mt-2">
                                {% endif %}
                            </div>
                            <!-- ZONE 5 - NCWF 2025 -->
                            <div class="text-center px-5 pb-5 flex flex-col justify-center">
                                {% if work_role.ncwf_2025_work_role %}
                                    <p class="text-gray-500 text-sm font-medium">{{ work_role.ncwf_2025_work_role.ncwf_id }}</p>
                                    <p class="font-normal text-sm text-gray-600">{{ work_role.ncwf_2025_work_role.ncwf_title }}</p>
                                    <input type="checkbox" name="ncwf_2025_{{ work_role.ncwf_2025_work_role.id }}"
                                           class="form-checkbox h-5 w-5 text-purple-600 self-center mt-2">
                                {% endif %}
                            </div>
                            <!-- Données cachées -->
                            <p class="hidden description">{{ work_role.description }}</p>
                            <p class="hidden ksat-id">{{ item.ncwf_2017_ksat.ncwf_id }}</p>
                            <p class="hidden dcwf-id">{{ item.dcwf_id }}</p>
                            <p class="hidden description">{{ item.description }}</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endfor %}

    <!-- Div caché pour afficher plus de détails (commun à toutes les catégories) -->
    <div id="detail-box"
         class="detail-box hidden fixed right-0 top-0 h-full w-[400px] p-6 shadow-xl overflow-y-auto z-50">
        <button onclick="toggleDetail(null)" class="text-red-500 font-bold float-right">X</button>
        <div id="detail-box-content"></div>
        <button id="compare-button"
                onclick="compareSelected()"
                class="mt-4 px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700"
                style="display: none;">
            Comparer
            <p id="warning-message"
               class="text-red-600 font-semibold mt-2"
               style="display: none;">
                ⚠️ Il est recommandé de comparer un maximum de 3 rôles pour plus de lisibilité.
            </p>
        </button>
    </div>

    </main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sélecteur de mode pour contrôler les zones actives
        const modeSelector = document.getElementById('modeSelector');
        
        // Fonction pour appliquer les restrictions selon le mode sélectionné
        function applyModeRestrictions(mode) {
            // Cibler toutes les work-role boxes
            const workRoles = document.querySelectorAll('.work-role');
            
            workRoles.forEach(workRole => {
                // Trouver les checkboxes de chaque zone avec les bons sélecteurs
                const zone1Checkbox = workRole.querySelector('input[name^="dcwf_"]');
                const zone2Checkbox = workRole.querySelector('input[name^="ncwf_2017_"]');
                const zone3Checkbox = workRole.querySelector('input[name^="ncwf_2024_"]');
                const zone4Checkbox = workRole.querySelector('input[name^="dcwf_2025_"]');
                const zone5Checkbox = workRole.querySelector('input[name^="ncwf_2025_"]');
                
                // Réinitialiser l'état actif/désactivé de toutes les checkboxes
                if (zone1Checkbox) zone1Checkbox.disabled = false;
                if (zone2Checkbox) zone2Checkbox.disabled = false;
                if (zone3Checkbox) zone3Checkbox.disabled = false;
                if (zone4Checkbox) zone4Checkbox.disabled = false;
                if (zone5Checkbox) zone5Checkbox.disabled = false;
                
                // Appliquer les restrictions selon le mode
                switch(mode) {
                    case 'mode1':
                        // Mode 1: Seulement la Zone 1 est sélectionnable
                        if (zone2Checkbox) zone2Checkbox.disabled = true;
                        if (zone3Checkbox) zone3Checkbox.disabled = true;
                        if (zone4Checkbox) zone4Checkbox.disabled = true;
                        if (zone5Checkbox) zone5Checkbox.disabled = true;
                        break;
                    case 'mode2':
                        // Mode 2: Standard mais Zone 3 désactivée
                        if (zone3Checkbox) zone3Checkbox.disabled = true;
                        break;
                    case 'mode3':
                        // Mode 3: Seulement la Zone 3 est sélectionnable
                        if (zone1Checkbox) zone1Checkbox.disabled = true;
                        if (zone2Checkbox) zone2Checkbox.disabled = true;
                        if (zone4Checkbox) zone4Checkbox.disabled = true;
                        if (zone5Checkbox) zone5Checkbox.disabled = true;
                        break;
                    case 'admin':
                        // Mode Admin: Toutes les zones sont actives (déjà configuré par défaut)
                        break;
                    default:
                        console.error('Mode inconnu:', mode);
                }
            });
        }
        
        // Appliquer les restrictions au chargement initial
        if (modeSelector) {
            applyModeRestrictions(modeSelector.value);
            
            // Stocker le mode précédent
            let previousMode = modeSelector.value;
            
            // Écouter les changements de mode
            modeSelector.addEventListener('change', function() {
                // Si le mode admin est sélectionné, demander le code d'accès
                if (this.value === 'admin') {
                    const adminCode = prompt('Veuillez entrer le code d\'accès pour le mode Admin:');
                    
                    // Vérifier le code (0000 dans cet exemple)
                    if (adminCode === '0000') {
                        // Code correct, appliquer le mode admin
                        applyModeRestrictions('admin');
                        previousMode = 'admin';
                    } else {
                        // Code incorrect, revenir au mode précédent
                        alert('Code d\'accès incorrect!');
                        this.value = previousMode;
                    }
                } else {
                    // Pour les autres modes, appliquer directement
                    applyModeRestrictions(this.value);
                    previousMode = this.value;
                }
            });
        }

        // Gestion des cases à cocher pour le déroulement des catégories
        document.querySelectorAll('.category-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', function(event) {
                const categoryId = this.getAttribute('data-category');
                const categoryContainer = document.getElementById(categoryId);
                
                if (categoryContainer) {
                    if (this.checked) {
                        categoryContainer.classList.add('expanded');
                    } else {
                        categoryContainer.classList.remove('expanded');
                    }
                }
                
                // Empêcher la propagation du clic
                event.stopPropagation();
            });
            
            // Empêcher que le clic sur la case à cocher déclenche d'autres événements
            checkbox.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        });
    });
</script>

<style>
    /* Styles pour les 5 zones */
    .work-role {
        min-height: 200px; /* Augmenter la hauteur pour accommoder 5 zones */
        transition: all 0.3s ease;
    }
    
    .work-role:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    /* Couleurs distinctes pour chaque zone */
    .work-role input[name^="dcwf_"]:not([name*="2025"]) {
        border-color: #3b82f6; /* Bleu pour DCWF */
    }
    
    .work-role input[name^="ncwf_2017_"] {
        border-color: #10b981; /* Vert pour NCWF 2017 */
    }
    
    .work-role input[name^="ncwf_2024_"] {
        border-color: #ef4444; /* Rouge pour NCWF 2024 */
    }
    
    .work-role input[name^="dcwf_2025_"] {
        border-color: #6366f1; /* Indigo pour DCWF 2025 */
    }
    
    .work-role input[name^="ncwf_2025_"] {
        border-color: #8b5cf6; /* Violet pour NCWF 2025 */
    }
    
    /* Masquer les work roles par défaut */
    .category-container .work-role-container {
        display: none;
    }
    
    /* Afficher les work roles quand la catégorie est expanded */
    .category-container.expanded .work-role-container {
        display: grid;
    }
    
    /* Animation pour le detail box */
    .detail-box {
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateY(-50%) translateX(20px);
    }
    
    .detail-box:not(.hidden) {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
    }
</style>

{% endblock %}
