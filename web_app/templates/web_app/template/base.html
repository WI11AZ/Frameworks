{% load static %}

<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100" id="htmlElement">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon pour différents navigateurs et appareils -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}"/>
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'favicon-16x16.png' %}"/>
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicon-32x32.png' %}"/>
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'apple-touch-icon.png' %}"/>
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'android-chrome-192x192.png' %}"/>
    <link rel="icon" type="image/png" sizes="512x512" href="{% static 'android-chrome-512x512.png' %}"/>
    <link rel="manifest" href="{% static 'site.webmanifest' %}"/>
    <meta name="apple-mobile-web-app-title" content="Cyber Align"/>
    <title>{% block title %}Cyber Align{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Indicateur d'authentification pour serverStorage -->
    <div id="user-authenticated" data-authenticated="{% if user.is_authenticated %}True{% else %}False{% endif %}" style="display:none;"></div>
    <!-- Script serverStorage pour sauvegardes côté serveur -->
    <script src="{% static 'js/serverStorage.js' %}"></script>
    <style>
        @keyframes holographic {
            0% { 
                opacity: 0.85; 
                transform: scale(1) perspective(500px) rotateY(-3deg);
                text-shadow: 0 0 6px #00ffff, 0 0 10px #00ffff, 0 0 14px rgba(183, 0, 255, 0.6);
                box-shadow: 0 0 10px rgba(0, 255, 255, 0.6), inset 0 0 5px rgba(0, 255, 255, 0.4);
                filter: brightness(0.9) contrast(1.1);
            }
            33% {
                opacity: 0.95;
                transform: scale(1.03) perspective(500px) rotateY(-1deg);
                text-shadow: 0 0 8px #00ffff, 0 0 12px #00ffff, 0 0 16px rgba(183, 0, 255, 0.7);
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.7), inset 0 0 8px rgba(0, 255, 255, 0.5);
                filter: brightness(1.1) contrast(1.2);
            }
            66% { 
                opacity: 1; 
                transform: scale(1.05) perspective(500px) rotateY(1deg);
                text-shadow: 0 0 10px #00ffff, 0 0 15px #00ffff, 0 0 20px rgba(183, 0, 255, 0.8);
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.8), inset 0 0 12px rgba(0, 255, 255, 0.6);
                filter: brightness(1.2) contrast(1.3);
            }
            100% { 
                opacity: 0.9; 
                transform: scale(1) perspective(500px) rotateY(3deg);
                text-shadow: 0 0 8px #00ffff, 0 0 12px #00ffff, 0 0 16px rgba(183, 0, 255, 0.7);
                box-shadow: 0 0 12px rgba(0, 255, 255, 0.7), inset 0 0 7px rgba(0, 255, 255, 0.5);
                filter: brightness(1) contrast(1.2);
            }
        }
        
        .category-container {
            max-height: 200px;
            max-width: 900px;
            overflow: hidden; /* Cache les éléments qui dépassent */
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            background-color: rgba(255, 255, 255, 0.1); /* Effet lumineux */
            border-radius: 8px;
            padding: 10px;
            position: relative;
        }

        .category-container.expanded {
            max-height: 5000px; /* Augmenté pour accommoder les 5 zones */
            padding: 24px;
            background-color: rgba(255, 255, 255, 0.2);
            overflow: visible; /* Affiche tout le contenu quand la case est cochée */
        }

        .category-header {
            display: flex;
            flex-direction: column;
            gap: 4px;
            color: white;
            z-index: 10;
            position: relative;
            padding-bottom: 4px;
        }

        .category-content {
            opacity: 1;
            pointer-events: auto;
            margin-top: 16px;
        }


        .role-card {
            cursor: pointer;
        }

        /* Case à droite qui reste cachée au départ */
        .case-detailed-info {
            display: none;
            position: absolute;
            top: 0;
            right: -250px; /* Positionne la case à droite de la catégorie */
            width: 250px;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000; /* S'assure qu'elle est au-dessus des autres éléments */
            transition: right 0.3s ease; /* Ajoute une transition pour un effet fluide */
        }

        /* Active l'affichage de la case avec une animation de glissement */
        .case-detailed-info.visible {
            right: 0; /* Glisse la case vers la droite */
        }


        .hidden {
            display: none;
        }

        /* Style général des work-role (inchangé) */
        .work-role {
            cursor: pointer;
        }

        /* Style de base du detail-box (positionné dynamiquement via JavaScript) */
        .detail-box {
            position: fixed;
            right: 0;
            top: 0;
            width: 33%;
            height: 100%;
            z-index: 999;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            padding: 1.5rem;
            /* Texte lisible sur fond clair */
            color: #1f2937; /* text-gray-800 */
            background-color: white; /* fallback */
            background-repeat: no-repeat;
            background-position: bottom right;
            background-size: 150px; /* taille raisonnable */
        }

        .bg-dd {
            background-color: #ff0000;
        }

        /* Rouge */
        .bg-io {
            background-color: #0db8c4;
        }

        /* Turquoise */
        .bg-pd {
            background-color: #ff75bc;
        }

        /* Rose */
        .bg-in {
            background-color: #6e51c7;
        }

        /* Mauve */
        .bg-ci {
            background-color: #ffd500;
        }

        /* Jaune */
        .bg-ce {
            background-color: #00c54c;
        }

        /* Vert */
        .bg-og {
            background-color: #00469c;
        }

        /* Bleu */

        /* Styles pour le mode sombre */
        .dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        
        /* Éléments d'interface générale */
        .dark-mode .bg-white,
        .dark-mode .bg-gray-50,
        .dark-mode .bg-gray-100 {
            background-color: #2d3748 !important;
            color: #e2e8f0;
        }
        
        /* Textes */
        .dark-mode .text-gray-900,
        .dark-mode .text-gray-800,
        .dark-mode .text-gray-700,
        .dark-mode .text-gray-600 {
            color: #e2e8f0 !important;
        }
        
        /* Bordures */
        .dark-mode .border,
        .dark-mode .border-gray-200,
        .dark-mode .border-gray-300 {
            border-color: #4a5568 !important;
        }
        
        /* Ombres */
        .dark-mode .shadow {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
        }
        
        /* Tableaux */
        .dark-mode table,
        .dark-mode th,
        .dark-mode td {
            border-color: #4a5568 !important;
        }
        
        .dark-mode th {
            background-color: #2d3748 !important;
            color: #e2e8f0 !important;
        }
        
        .dark-mode tr:nth-child(even) {
            background-color: #283141 !important;
        }
        
        .dark-mode tr:hover {
            background-color: #374151 !important;
        }
        
        /* Éléments spécifiques pour KSAT */
        .dark-mode .tab-button {
            color: #e2e8f0 !important;
            border-color: #4a5568 !important;
        }
        
        .dark-mode .tab-button:hover {
            color: #3b82f6 !important;
        }
        
        .dark-mode .tab-button.active {
            color: #3b82f6 !important;
            border-color: #3b82f6 !important;
        }
        
        .dark-mode .text-gray-500,
        .dark-mode .text-gray-600 {
            color: #9ca3af !important;
        }
        
        .dark-mode .hover\:bg-gray-50:hover {
            background-color: #374151 !important;
        }
        
        .dark-mode .bg-gray-100 {
            background-color: #1f2937 !important;
        }
        
        /* Boutons */
        .dark-mode button:not([class*="bg-"]),
        .dark-mode input[type="button"],
        .dark-mode input[type="submit"] {
            background-color: #4a5568 !important;
            color: #e2e8f0 !important;
        }
        
        /* Champs de formulaire */
        .dark-mode input[type="text"],
        .dark-mode input[type="password"],
        .dark-mode input[type="email"],
        .dark-mode select,
        .dark-mode textarea {
            background-color: #2d3748 !important;
            color: #e2e8f0 !important;
            border-color: #4a5568 !important;
        }

        /* --- CORRECTIF ACCORDÉON --- */
        .accordion-collapse.show {
            height: auto !important;
        }
        .accordion-body {
            overflow: visible !important;
        }

    </style>

    <!-- Beta Warning Modal Styles -->
    <style>
        .beta-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .beta-modal.hidden {
            display: none;
        }

        .beta-modal-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            animation: betaModalSlideIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        @keyframes betaModalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .beta-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: #f59e0b;
        }

        .beta-title {
            font-size: 28px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 16px;
        }

        .beta-subtitle {
            font-size: 20px;
            color: #f59e0b;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .beta-message {
            font-size: 16px;
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .beta-contact {
            background: #f3f4f6;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #3b82f6;
        }

        .beta-contact-text {
            font-size: 14px;
            color: #374151;
            margin: 0;
        }

        .beta-contact-email {
            font-weight: 600;
            color: #3b82f6;
        }

        .beta-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 150px;
        }

        .beta-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .beta-button:active {
            transform: translateY(0);
        }

        .beta-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .beta-button:disabled:hover {
            background: #9ca3af;
            transform: none;
            box-shadow: none;
        }

        .beta-checkbox-container {
            margin: 20px 0;
            text-align: left;
        }

        .beta-checkbox-label {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
        }

        .beta-checkbox {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
            accent-color: #3b82f6;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .beta-checkbox-text {
            user-select: none;
        }

        /* Dark mode support */
        .dark-mode .beta-modal-content {
            background: #1f2937;
            color: #e5e7eb;
        }

        .dark-mode .beta-title {
            color: #f9fafb;
        }

        .dark-mode .beta-message {
            color: #d1d5db;
        }

        .dark-mode .beta-contact {
            background: #374151;
            border-left-color: #60a5fa;
        }

        .dark-mode .beta-contact-text {
            color: #e5e7eb;
        }

        .dark-mode .beta-contact-email {
            color: #60a5fa;
        }

        .dark-mode .beta-checkbox-label {
            color: #d1d5db;
        }

        /* Styles pour le wrapper de contenu */
        .beta-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Responsive styles for mobile devices */
        @media (max-width: 768px) {
            .beta-modal {
                padding: 10px;
                align-items: flex-start;
                padding-top: 5vh;
            }

            .beta-modal-content {
                padding: 20px;
                max-height: 85vh;
                margin: 0;
                border-radius: 8px;
            }

            .beta-icon {
                font-size: 36px;
                margin-bottom: 15px;
            }

            .beta-title {
                font-size: 24px;
                margin-bottom: 12px;
            }

            .beta-subtitle {
                font-size: 18px;
                margin-bottom: 15px;
            }

            .beta-message {
                font-size: 14px;
                margin-bottom: 20px;
                line-height: 1.5;
            }

            .beta-message p {
                margin-bottom: 12px;
            }

            .beta-contact {
                padding: 12px;
                margin-bottom: 20px;
            }

            .beta-contact-text {
                font-size: 13px;
            }

            .beta-checkbox-container {
                margin: 15px 0;
                order: 2;
            }

            .beta-checkbox-label {
                font-size: 13px;
                gap: 8px;
            }

            .beta-checkbox {
                width: 16px;
                height: 16px;
            }

            .beta-button {
                padding: 12px 24px;
                font-size: 14px;
                min-width: 120px;
                order: 3;
                margin-top: 10px;
            }

            /* Force le bouton à rester en bas sur mobile */
            .beta-modal-content {
                justify-content: space-between;
            }

            .beta-content-wrapper {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
        }

        /* Styles pour très petits écrans */
        @media (max-width: 480px) {
            .beta-modal {
                padding: 5px;
                padding-top: 2vh;
            }

            .beta-modal-content {
                padding: 15px;
                max-height: 90vh;
            }

            .beta-title {
                font-size: 20px;
            }

            .beta-subtitle {
                font-size: 16px;
            }

            .beta-message {
                font-size: 13px;
            }

            .beta-button {
                padding: 10px 20px;
                font-size: 13px;
                width: 100%;
                margin-top: 15px;
            }
        }

        /* Améliorations pour les écrans tactiles */
        @media (hover: none) and (pointer: coarse) {
            .beta-button {
                min-height: 44px; /* Taille minimale recommandée pour les écrans tactiles */
                padding: 12px 24px;
            }

            .beta-checkbox {
                min-width: 20px;
                min-height: 20px;
            }
        }

        /* Styles pour les écrans en mode paysage mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .beta-modal {
                padding-top: 2vh;
                padding-bottom: 2vh;
            }

            .beta-modal-content {
                max-height: 95vh;
                padding: 15px;
            }

            .beta-icon {
                font-size: 28px;
                margin-bottom: 10px;
            }

            .beta-title {
                font-size: 20px;
                margin-bottom: 8px;
            }

            .beta-subtitle {
                font-size: 16px;
                margin-bottom: 10px;
            }

            .beta-message {
                font-size: 13px;
                margin-bottom: 15px;
            }

            .beta-message p {
                margin-bottom: 8px;
            }

            .beta-contact {
                padding: 10px;
                margin-bottom: 15px;
            }

            .beta-checkbox-container {
                margin: 10px 0;
            }

            .beta-button {
                margin-top: 8px;
                padding: 10px 20px;
            }
        }
    </style>


</head>

<body class="h-full">
<div class="min-h-full">
    <!-- Élément caché pour indiquer l'état d'authentification de l'utilisateur pour serverStorage -->
    <div id="user-authenticated" data-authenticated="{% if user.is_authenticated %}True{% else %}False{% endif %}" style="display: none;"></div>
    
    <!-- CSRF Token pour les requêtes AJAX -->
    {% csrf_token %}

    {% include "web_app/template/menu.html" %}

    <header class="bg-white shadow">
        <div class="mx-auto max-w-7xl px-4 py-3 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">Cyber Align Dashboard</h1>
                
                <!-- Informations utilisateur et numéro de poste -->
                <div class="flex items-start space-x-6 max-w-2xl">
                    <!-- Section Numéro de poste -->
                    <div class="flex flex-col space-y-2">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="header-job-number-input" 
                                   class="px-3 py-1 border border-gray-300 rounded-md text-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="Numéro de poste">
                            <button id="header-save-job-number" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm">
                                Valider
                            </button>
                        </div>
                        
                        <!-- Affichage du numéro de poste -->
                        <div id="header-job-number" class="text-sm font-medium text-gray-700 hidden">
                            Numéro de poste: <span id="header-job-number-value" class="font-bold text-blue-600"></span>
                        </div>
                    </div>
                    
                    <!-- Section Informations utilisateur -->
                    {% if user.is_authenticated %}
                    <div class="flex flex-col space-y-2">
                        <div class="text-left">
                            <h3 class="text-lg font-semibold text-gray-800">{{ user.last_name }}</h3>
                            <p class="text-sm text-gray-600">Matricule: {{ user.matricule }}</p>
                            <div class="flex items-center mt-1">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                  {% if user.is_super_user %}bg-purple-100 text-purple-800{% elif user.is_beta_tester %}bg-orange-100 text-orange-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                  {% if user.is_super_user %}
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                      <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    Super User
                                  {% elif user.is_beta_tester %}
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                      <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                                    </svg>
                                    Bêta testeur
                                  {% else %}
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                      <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                    </svg>
                                    User Normal
                                  {% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Boutons d'action -->
                        <div class="flex items-center space-x-4">
                          <a href="{% url 'account_options' %}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Options
                          </a>
                          <a href="{% url 'logout' %}" class="text-red-600 hover:text-red-800 text-sm font-medium">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Déconnexion
                          </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
            {% block content %}
                <!-- Ajout des catégories et work roles ici -->
            {% endblock %}
        </div>
    </main>
</div>

<script>
    // Synchronisation du numéro de poste dans le header
    document.addEventListener('DOMContentLoaded', function() {
        const headerJobNumber = document.getElementById('header-job-number');
        const headerJobNumberValue = document.getElementById('header-job-number-value');
        const headerJobNumberInput = document.getElementById('header-job-number-input');
        const headerSaveJobNumber = document.getElementById('header-save-job-number');
        
        // Charger le numéro de poste depuis localStorage
        const currentJobNumber = localStorage.getItem('currentJobNumber');
        if (currentJobNumber) {
            headerJobNumberValue.textContent = currentJobNumber;
            headerJobNumber.classList.remove('hidden');
            headerJobNumberInput.value = currentJobNumber;
        }
        
        // Sauvegarder le numéro de poste
        headerSaveJobNumber.addEventListener('click', function() {
            const jobNumber = headerJobNumberInput.value.trim();
            if (jobNumber) {
                localStorage.setItem('currentJobNumber', jobNumber);
                headerJobNumberValue.textContent = jobNumber;
                headerJobNumber.classList.remove('hidden');
                alert(`Numéro de poste ${jobNumber} enregistré avec succès.`);
            } else {
                alert('Veuillez entrer un numéro de poste valide.');
            }
        });
        
        // Permettre de valider avec la touche Entrée
        headerJobNumberInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                headerSaveJobNumber.click();
            }
        });
        
        // Écouter les changements de numéro de poste
        window.addEventListener('storage', function(event) {
            if (event.key === 'currentJobNumber') {
                if (event.newValue) {
                    headerJobNumberValue.textContent = event.newValue;
                    headerJobNumber.classList.remove('hidden');
                    headerJobNumberInput.value = event.newValue;
                } else {
                    headerJobNumber.classList.add('hidden');
                    headerJobNumberInput.value = '';
                }
            }
        });
    });

    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');

    // Stop the menu from being hiding or hide it
    mobileMenuButton.addEventListener('click', () => {
        // Remove the hidden class to show the menu or add it to hide it
        mobileMenu.classList.toggle('hidden');
    });


    document.addEventListener('DOMContentLoaded', () => {
        const cards = document.querySelectorAll('.work-role-card');
        const tooltip = document.getElementById('opm-tooltip');

        const opmDescriptions = {
            '2210': 'OPM 2210 : Spécialiste des systèmes informatiques',
            '0132': 'OPM 0132 : Analyste du renseignement',
            // Ajoute d'autres descriptions ici selon tes OPM_ID
        };

        cards.forEach(card => {
            card.addEventListener('mouseenter', (e) => {
                const opmId = card.getAttribute('data-opm-id');

                // surligne toutes les cartes avec le même opm_id
                document.querySelectorAll(`[data-opm-id="${opmId}"]`).forEach(c => {
                    c.classList.add('highlighted');
                });

                // affiche le tooltip s'il y a une description
                if (opmDescriptions[opmId]) {
                    tooltip.innerText = opmDescriptions[opmId];
                    tooltip.style.display = 'block';

                    // position du tooltip à droite de la souris
                    tooltip.style.left = e.pageX + 20 + 'px';
                    tooltip.style.top = e.pageY + 'px';
                }
            });

            card.addEventListener('mousemove', (e) => {
                tooltip.style.left = e.pageX + 20 + 'px';
                tooltip.style.top = e.pageY + 'px';
            });

            card.addEventListener('mouseleave', () => {
                const opmId = card.getAttribute('data-opm-id');
                document.querySelectorAll(`[data-opm-id="${opmId}"]`).forEach(c => {
                    c.classList.remove('highlighted');
                });
                tooltip.style.display = 'none';
            });
        });
    });

</script>


<script>
    function toggleDetail(workRoleId) {
        const detailBox = document.getElementById(`detail-box-${workRoleId}`);
        if (detailBox) {
            detailBox.classList.toggle('hidden');  // Toggle visibility (hidden/visible)
        }
    }
</script>


<script>
    const categoryLabels = {
      DD: "Design & Development",
      IO: "Implementation & Operation",
      PD: "Protection & Defense",
      IN: "Investigation",
      CI: "Cyberspace Intelligence",
      CE: "Cyberspace Effects",
      OG: "Oversight & Governance"
    };
    
    const backgroundColors = {
      DD: "#dc2626",
      IO: "#06b6d4",
      PD: "#ec4899",
      IN: "#8b5cf6",
      CI: "#facc15",
      CE: "#22c55e",
      OG: "#3b82f6",
      DD9: "#dc2626"
    };
    
    const backgroundImages = {
      DD: 'url("/static/images/backgrounds/DD.png")',
      IO: 'url("/static/images/backgrounds/IO.png")',
      PD: 'url("/static/images/backgrounds/PD.png")',
      IN: 'url("/static/images/backgrounds/IN.png")',
      CI: 'url("/static/images/backgrounds/CI.png")',
      CE: 'url("/static/images/backgrounds/CE.png")',
      OG: 'url("/static/images/backgrounds/OG.png")',
      DD9: 'url("/static/images/backgrounds/DD9.png")'
    };
    
    function toggleDetail(workRoleId) {
      const detailBox = document.getElementById('detail-box');
      const contentBox = document.getElementById('detail-box-content');
      const workRole = document.getElementById('work-role-' + workRoleId);
      
    
      if (!workRoleId || !workRole) {
        detailBox.classList.add('hidden');
        contentBox.innerHTML = '';
        detailBox.style.backgroundColor = '';
        detailBox.style.backgroundImage = '';
        return;
      }
    
      // Récupérer l'OMP ID depuis la Zone 0 (premier bloc)
      const opmIdElement = workRole.querySelector('div:nth-child(1) p.font-semibold');
      let opmId = 'ID non disponible';
      if (opmIdElement) {
        // Enlever le point rouge et garder seulement le texte de l'ID
        opmId = opmIdElement.textContent.trim().replace(/^●\s*/, '').replace(/^\s*/, '');
      }
    
      // Extraction du préfixe depuis la Zone 3 (NCWF 2024) ou Zone 4 (NCWF 2017)
      let prefix = '??';
      const ncwf2024Zone = workRole.querySelector('div:nth-child(4)');
      const ncwf2017Zone = workRole.querySelector('div:nth-child(5)');
      
      if (ncwf2024Zone) {
        const ncwfId = ncwf2024Zone.querySelector('p.text-gray-500');
        if (ncwfId) {
          const m = ncwfId.textContent.trim().match(/^([A-Z]{2})-/);
          if (m) { prefix = m[1]; }
        }
      } else if (ncwf2017Zone) {
        const ncwfId = ncwf2017Zone.querySelector('p.text-gray-500');
        if (ncwfId) {
          const m = ncwfId.textContent.trim().match(/^([A-Z]{2})-/);
          if (m) { prefix = m[1]; }
        }
      }
    
      const bgColor = backgroundColors[prefix] || '#ffffff';
      const bgImage = backgroundImages[prefix] || '';
    
      console.log('toggleDetail:', 'OMP ID:', opmId, 'Prefix:', prefix, bgImage);
    
      detailBox.style.backgroundColor = bgColor;
      detailBox.style.backgroundImage = bgImage;
      detailBox.style.backgroundRepeat = 'no-repeat';
      detailBox.style.backgroundSize = '350px 200px';
      detailBox.style.backgroundPosition = 'right 10px top 300px';
    
      // Génération du contenu avec OMP ID et informations du work role
      let html = `<h2 class="text-xl font-bold mb-4 text-gray-800">OMP ID: ${opmId}</h2>`;
      
      // Ajouter le titre du work role depuis la Zone 5
      const workRoleTitle = workRole.querySelector('div:nth-child(6) p.font-normal');
      if (workRoleTitle) {
        html += `<h3 class="text-lg font-semibold mb-3 text-gray-700">${workRoleTitle.textContent.trim()}</h3>`;
      }
      
      // Ajouter la description si disponible
      const descEl = workRole.querySelector('.description');
      if (descEl) {
        html += `<div class="bg-gray-50 p-3 rounded mb-3"><p class="text-gray-600">${descEl.innerText.trim()}</p></div>`;
      }
      
      // Vérifier quelles cases sont cochées et afficher les infos correspondantes
      const checkedBoxes = workRole.querySelectorAll('input[type="checkbox"]:checked');
      
      if (checkedBoxes.length > 0) {
        html += `<div class="mt-4"><h4 class="font-semibold text-gray-700 mb-2">Modèles sélectionnés :</h4>`;
        
        checkedBoxes.forEach(checkbox => {
          const checkboxName = checkbox.name;
          let modelInfo = '';
          
          if (checkboxName.startsWith('ncwf_2025_')) {
            // NCWF 2025 - Zone 1
            const ncwf2025Zone = workRole.querySelector('div:nth-child(2)');
            const ncwfId = ncwf2025Zone?.querySelector('p.text-gray-500')?.textContent?.trim();
            const ncwfTitle = ncwf2025Zone?.querySelector('p.font-bold')?.textContent?.trim();
            if (ncwfId && ncwfTitle) {
              modelInfo = `<div class="bg-purple-50 p-2 rounded mb-2"><p class="text-purple-800"><strong>NCWF 2025:</strong> ${ncwfId} - ${ncwfTitle}</p></div>`;
            }
          } else if (checkboxName.startsWith('dcwf_2025_')) {
            // DCWF 2025 - Zone 2
            const dcwf2025Zone = workRole.querySelector('div:nth-child(3)');
            const dcwfTitle = dcwf2025Zone?.querySelector('p.font-normal')?.textContent?.trim();
            if (dcwfTitle) {
              modelInfo = `<div class="bg-indigo-50 p-2 rounded mb-2"><p class="text-indigo-800"><strong>DCWF 2025:</strong> ${dcwfTitle}</p></div>`;
            }
          } else if (checkboxName.startsWith('ncwf_2024_')) {
            // NCWF 2024 - Zone 3
            const ncwf2024Zone = workRole.querySelector('div:nth-child(4)');
            const ncwfId = ncwf2024Zone?.querySelector('p.text-gray-500')?.textContent?.trim();
            const ncwfTitle = ncwf2024Zone?.querySelector('p.font-normal')?.textContent?.trim();
            if (ncwfId && ncwfTitle) {
              modelInfo = `<div class="bg-red-50 p-2 rounded mb-2"><p class="text-red-800"><strong>NCWF 2024:</strong> ${ncwfId} - ${ncwfTitle}</p></div>`;
            }
          } else if (checkboxName.startsWith('ncwf_2017_')) {
            // NCWF 2017 - Zone 4
            const ncwf2017Zone = workRole.querySelector('div:nth-child(5)');
            const ncwfId = ncwf2017Zone?.querySelector('p.text-gray-500')?.textContent?.trim();
            const ncwfTitle = ncwf2017Zone?.querySelector('p.font-normal')?.textContent?.trim();
            if (ncwfId && ncwfTitle) {
              modelInfo = `<div class="bg-green-50 p-2 rounded mb-2"><p class="text-green-800"><strong>NCWF 2017:</strong> ${ncwfId} - ${ncwfTitle}</p></div>`;
            }
          } else if (checkboxName.startsWith('dcwf_')) {
            // DCWF - Zone 5 (déjà affiché dans le titre)
            modelInfo = `<div class="bg-blue-50 p-2 rounded mb-2"><p class="text-blue-800"><strong>DCWF:</strong> ${workRoleTitle?.textContent?.trim()}</p></div>`;
          }
          
          if (modelInfo) {
            html += modelInfo;
          }
        });
        
        html += `</div>`;
      }
      
      // Gérer le bouton comparer externe
      updateGlobalCompareButton();
    
      contentBox.innerHTML = html;
      detailBox.classList.remove('hidden');
      
      // Ajouter les écouteurs d'événements pour les cases à cocher de ce work role
      addCheckboxListeners(workRoleId);
    }
    
    // Fonction pour rafraîchir le contenu du panneau
    function refreshDetailContent(workRoleId) {
      toggleDetail(workRoleId);
    }
    
    // Fonction pour ajouter les écouteurs d'événements aux cases à cocher
    function addCheckboxListeners(workRoleId) {
      const workRole = document.getElementById('work-role-' + workRoleId);
      if (!workRole) return;
      
      const checkboxes = workRole.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        // Supprimer les anciens écouteurs pour éviter les doublons
        checkbox.removeEventListener('change', checkboxChangeHandler);
        // Ajouter le nouvel écouteur
        checkbox.addEventListener('change', checkboxChangeHandler);
      });
    }
    
    // Gestionnaire de changement pour les cases à cocher
    function checkboxChangeHandler(event) {
      // Trouver l'ID du work role parent
      const workRole = event.target.closest('.work-role');
      if (workRole) {
        const workRoleId = workRole.id.replace('work-role-', '');
        // Ouvrir le panneau pour ce work role (pas seulement rafraîchir)
        toggleDetail(workRoleId);
      }
      // Mettre à jour le bouton comparer global
      updateGlobalCompareButton();
    }
    
    // Fonction pour gérer l'affichage du bouton comparer global
    function updateGlobalCompareButton() {
      // Créer ou récupérer le conteneur du bouton comparer
      let compareContainer = document.getElementById('external-compare-container');
      if (!compareContainer) {
        compareContainer = document.createElement('div');
        compareContainer.id = 'external-compare-container';
        compareContainer.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          z-index: 1000;
          transition: all 0.3s ease;
        `;
        document.body.appendChild(compareContainer);
      }
      
      // Compter toutes les cases cochées sur la page
      const allCheckedBoxes = document.querySelectorAll('.work-role input[type="checkbox"]:checked');
      const checkedCount = allCheckedBoxes.length;
      
      if (checkedCount > 0) {
        compareContainer.innerHTML = `
          <button onclick="compareAllSelected()" 
                  class="bg-green-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors shadow-lg border-2 border-green-600">
            🔍 Comparer (${checkedCount} sélection${checkedCount > 1 ? 's' : ''})
          </button>
        `;
        compareContainer.style.display = 'block';
      } else {
        compareContainer.style.display = 'none';
      }
    }
    
    // Fonction pour comparer tous les modèles sélectionnés sur la page
    function compareAllSelected() {
      // Collecter les IDs de tous les modèles sélectionnés sur la page
      const allCheckedBoxes = document.querySelectorAll('.work-role input[type="checkbox"]:checked');
      const dcwfIds = [];
      const dcwf2025Ids = [];
      const ncwf2025Ids = [];
      const ncwf2024Ids = [];
      const ncwf2017Ids = [];
      
      allCheckedBoxes.forEach(checkbox => {
        const checkboxName = checkbox.name;
        
        if (checkboxName.startsWith('dcwf_') && !checkboxName.startsWith('dcwf_2025_')) {
          const m = checkboxName.match(/dcwf_(\d+)$/);
          if (m) dcwfIds.push(m[1]);
        } else if (checkboxName.startsWith('dcwf_2025_')) {
          const m = checkboxName.match(/dcwf_2025_(\d+)$/);
          if (m) dcwf2025Ids.push(m[1]);
        } else if (checkboxName.startsWith('ncwf_2025_')) {
          const m = checkboxName.match(/ncwf_2025_(\d+)$/);
          if (m) ncwf2025Ids.push(m[1]);
        } else if (checkboxName.startsWith('ncwf_2024_')) {
          const m = checkboxName.match(/ncwf_2024_(\d+)$/);
          if (m) ncwf2024Ids.push(m[1]);
        } else if (checkboxName.startsWith('ncwf_2017_')) {
          const m = checkboxName.match(/ncwf_2017_(\d+)$/);
          if (m) ncwf2017Ids.push(m[1]);
        }
      });
      
      // Construire l'URL avec les paramètres
      const params = new URLSearchParams();
      dcwfIds.forEach(id => params.append('dcwf_ids', id));
      dcwf2025Ids.forEach(id => params.append('dcwf_2025_ids', id));
      ncwf2025Ids.forEach(id => params.append('ncwf_2025_ids', id));
      ncwf2024Ids.forEach(id => params.append('ncwf_2024_ids', id));
      ncwf2017Ids.forEach(id => params.append('ncwf_2017_ids', id));
      
      // Rediriger vers la page de comparaison
      window.open(`/compare/?${params.toString()}`, '_blank');
    }
    </script>


<script>
    function updateCompareButtonVisibility() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:not(.category-toggle)');
        const compareButton = document.getElementById('compare-button');
        const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

        compareButton.style.display = checkedCount > 0 ? 'inline-block' : 'none';

        // Avertir si plus de 3 cases cochées
        const warning = document.getElementById('warning-message');
        if (checkedCount >6) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:not(.category-toggle)');
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateCompareButtonVisibility);
            cb.addEventListener('change', updateGlobalCompareButton);
        });
        
        // Afficher le numéro de poste dans l'en-tête sur toutes les pages
        const headerJobNumber = document.getElementById('header-job-number');
        const headerJobNumberValue = document.getElementById('header-job-number-value');
        
        if (headerJobNumber && headerJobNumberValue) {
            const currentJobNumber = localStorage.getItem('currentJobNumber');
            if (currentJobNumber) {
                headerJobNumberValue.textContent = currentJobNumber;
                headerJobNumber.classList.remove('hidden');
            }
        }
        
        // Initialiser le bouton comparer global
        updateGlobalCompareButton();
    });

    function compareSelected() {
        const selected = [];
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked:not(.category-toggle)');
        checkboxes.forEach(cb => {
            const workRoleCard = cb.closest('.work-role');
            if (workRoleCard) {
                selected.push(workRoleCard.id);
            }
        });
        alert("Éléments sélectionnés : " + selected.join(", "));
    }
</script>


<script>
    // 1. On ajoute un écouteur de changement sur toutes les cases à cocher SAUF les cases de déroulement
    document.querySelectorAll('input[type=checkbox]:not(.category-toggle)').forEach(cb => {
        cb.addEventListener('change', updateCompareButton);
    });

    function updateCompareButton() {
        // Compter le total de TOUTES les cases à cocher, SAUF les cases de déroulement de catégorie
        const totalChecked = document.querySelectorAll('input[type=checkbox]:checked:not(.category-toggle)').length;
        const btn = document.getElementById('compare-button');
        
        // Assurons-nous que le bouton existe
        if (btn) {
            // Définir si le bouton doit être visible
            if (totalChecked > 0) {
                btn.style.removeProperty('display');
                // Si le bouton est dans un conteneur parent qui est aussi caché, rendons-le visible aussi
                if (btn.parentElement && btn.parentElement.classList.contains('detail-box') && 
                    btn.parentElement.classList.contains('hidden')) {
                    btn.parentElement.classList.remove('hidden');
                }
            } else {
                btn.style.display = 'none';
            }
            
            // Gérer le message d'avertissement à l'intérieur du bouton
            const warning = document.getElementById('warning-message');
            if (warning) {
                // Afficher l'avertissement EXACTEMENT à partir de 6 cases cochées
                if (totalChecked >= 6) {
                    warning.style.removeProperty('display');
                } else {
                    warning.style.display = 'none';
                }
            }
        }
        
        console.log('Cases cochées:', totalChecked, 'Afficher avertissement:', totalChecked >= 6);
    }

    function compareSelected() {
        const checkboxes = Array.from(document.querySelectorAll('input[type=checkbox]:checked:not(.category-toggle)'));

        const dcwf_ids = [];
        const ncwf_2024_ids = [];
        const ncwf_2017_ids = [];

        checkboxes.forEach(cb => {
            const name = cb.name;

            if (name.startsWith('dcwf_')) {
                const m = name.match(/dcwf_(\d+)$/);
                if (m) dcwf_ids.push(m[1]);
            } else if (name.startsWith('ncwf_2024_')) {
                const m = name.match(/ncwf_2024_(\d+)$/);
                if (m) ncwf_2024_ids.push(m[1]);
            } else if (name.startsWith('ncwf_2017_')) {
                const m = name.match(/ncwf_2017_(\d+)$/);
                if (m) ncwf_2017_ids.push(m[1]);
            }
        });

        if (dcwf_ids.length === 0 && ncwf_2024_ids.length === 0 && ncwf_2017_ids.length === 0) {
            alert('Veuillez sélectionner au moins un rôle à comparer.');
            return;
        }

        const params = new URLSearchParams();
        dcwf_ids.forEach(id => params.append('dcwf_ids', id));
        ncwf_2024_ids.forEach(id => params.append('ncwf_2024_ids', id));
        ncwf_2017_ids.forEach(id => params.append('ncwf_2017_ids', id));

        window.open(`/compare/?${params.toString()}`, '_blank');
    }
</script>











{% block scripts %}
{% endblock %}

<script>
    // Gestion du mode sombre
    document.addEventListener('DOMContentLoaded', function() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        const htmlElement = document.getElementById('htmlElement');
        const moonIcon = document.getElementById('moonIcon');
        const sunIcon = document.getElementById('sunIcon');
        
        // Fonction pour appliquer le mode sombre
        function applyDarkMode(isDark) {
            if (isDark) {
                // Appliquer le mode sombre
                htmlElement.classList.remove('bg-gray-100');
                htmlElement.classList.add('bg-gray-900');
                document.body.classList.add('dark-mode');
                if (moonIcon && sunIcon) {
                    moonIcon.classList.add('hidden');
                    sunIcon.classList.remove('hidden');
                }
                
                // Appliquer le mode sombre aux éléments spécifiques
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(button => {
                    if (button.classList.contains('text-blue-600')) {
                        button.classList.add('active');
                    }
                });
                
                // Appliquer le mode sombre à tous les iframes (s'il y en a)
                document.querySelectorAll('iframe').forEach(iframe => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc.body) {
                            iframeDoc.body.classList.add('dark-mode');
                        }
                    } catch (e) {
                        console.log('Impossible d\'appliquer le mode sombre à l\'iframe:', e);
                    }
                });
            } else {
                // Désactiver le mode sombre
                htmlElement.classList.add('bg-gray-100');
                htmlElement.classList.remove('bg-gray-900');
                document.body.classList.remove('dark-mode');
                if (moonIcon && sunIcon) {
                    moonIcon.classList.remove('hidden');
                    sunIcon.classList.add('hidden');
                }
                
                // Désactiver le mode sombre sur les iframes
                document.querySelectorAll('iframe').forEach(iframe => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc.body) {
                            iframeDoc.body.classList.remove('dark-mode');
                        }
                    } catch (e) {
                        console.log('Impossible de désactiver le mode sombre à l\'iframe:', e);
                    }
                });
            }
        }
        
        // Vérifier si un état précédent est enregistré
        const darkMode = localStorage.getItem('darkMode') === 'true';
        
        // Appliquer le mode précédemment enregistré
        applyDarkMode(darkMode);
        
        // Activer la mutation observer pour détecter les changements dynamiques
        const observer = new MutationObserver(function(mutations) {
            if (document.body.classList.contains('dark-mode')) {
                // Si des éléments sont ajoutés dynamiquement, s'assurer que le mode sombre s'applique
                mutations.forEach(mutation => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Si des onglets tab-button sont ajoutés, appliquer les styles appropriés
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) { // Element node
                                if (node.classList && node.classList.contains('tab-button')) {
                                    if (node.classList.contains('text-blue-600')) {
                                        node.classList.add('active');
                                    }
                                }
                                // Appliquer aux enfants récursivement
                                const tabButtons = node.querySelectorAll('.tab-button');
                                tabButtons.forEach(button => {
                                    if (button.classList.contains('text-blue-600')) {
                                        button.classList.add('active');
                                    }
                                });
                            }
                        });
                    }
                });
            }
        });
        
        // Observer les changements dans le document
        observer.observe(document.body, { childList: true, subtree: true });
        
        // Ajouter l'écouteur d'événement au bouton
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', function() {
                // Déterminer le nouvel état du mode sombre (inversé)
                const isDarkMode = !document.body.classList.contains('dark-mode');
                
                // Appliquer le mode sombre ou clair
                applyDarkMode(isDarkMode);
                
                // Enregistrer l'état
                localStorage.setItem('darkMode', isDarkMode);
                
                console.log('Mode sombre activé:', isDarkMode);
            });
        } else {
            console.log('Bouton mode sombre non trouvé sur cette page');
        }
    });
</script>


</body>

</html>