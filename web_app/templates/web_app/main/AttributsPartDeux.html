{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attributs Part Deux</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #1a1a1a; margin: 0; padding: 0; }
        .step-indicator { 
            display: none; 
        }
        .step-item { padding: 10px 20px; border-bottom: 3px solid #e5e7eb; color: #9ca3af; font-weight: 500; transition: all 0.3s; position: relative; }
        .step-item.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 700; }
        .step-item.completed { border-bottom-color: #10b981; color: #10b981; }
        .step-item.completed::after { content: ' ✓'; }
        .step-item-level { 
            font-size: 11px; 
            color: #10b981; 
            font-weight: 600; 
            margin-top: 4px; 
            display: block;
        }
        .level-scale-container { 
            margin: 30px 0 20px 0; 
            background: #f3f4f6;
        }
        .level-preview-container {
            min-height: 120px;
            margin: 15px 0 20px 0;
            position: relative;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 12px 16px;
        }
        .level-preview { 
            opacity: 1;
            transition: opacity 0.2s;
        }
        .level-preview.hidden { 
            opacity: 0; 
        }
        .level-preview-number { 
            font-size: 15px; 
            font-weight: bold; 
            color: #3b82f6; 
            margin-bottom: 6px; 
        }
        .level-preview-title { 
            font-size: 14px; 
            font-weight: 600; 
            color: #1f2937; 
            margin-bottom: 6px; 
        }
        .level-preview-description { 
            color: #4b5563; 
            line-height: 1.5; 
            font-size: 12px; 
        }
        .level-scale-label {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
            text-align: left;
        }
        .level-scale { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 12px; 
            margin: 0; 
        }
        .level-scale-item { 
            flex: 1; 
            height: 60px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 2px solid #d1d5db; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s; 
            background: #ffffff;
            font-size: 20px;
            font-weight: bold;
            color: #6b7280;
            position: relative;
        }
        .level-scale-item:hover { 
            border-color: #9ca3af; 
            background: #f9fafb; 
            color: #6b7280;
        }
        .level-scale-item.selected { 
            border-color: #6b7280; 
            background: #6b7280; 
            color: white;
            box-shadow: none;
        }
        .previous-choices { background: #f9fafb; border-radius: 8px; padding: 10px; margin: 10px 0; border-left: 4px solid #10b981; }
        .previous-choice-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .previous-choice-item:last-child { border-bottom: none; }
        .navigation-buttons { 
            display: flex; 
            justify-content: flex-end; 
            margin-top: 20px; 
            padding: 0; 
        }
        .btn { 
            padding: 8px 24px; 
            border-radius: 6px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            border: none; 
            font-size: 13px;
        }
        .btn-primary { 
            background: #9ca3af; 
            color: white; 
        }
        .btn-primary:hover:not(:disabled) { 
            background: #4b5563; 
        }
        .btn-primary:disabled { 
            background: #d1d5db; 
            cursor: not-allowed; 
            color: #9ca3af;
        }
        .btn-secondary { 
            background: #6b7280; 
            color: white; 
        }
        .btn-secondary:hover { 
            background: #4b5563; 
        }
        .main-container { 
            background: #ffffff;
            min-height: calc(100vh - 64px);
            padding: 15px;
            position: relative;
        }
        .attributes-table-container { 
            width: 480px; 
            float: left;
            margin-right: 25px;
            margin-bottom: 15px;
        }
        #nfcomSelector {
            width: 100%;
        }
        #nfcomSelector .bg-white {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .category-container { 
            border-radius: 15px; 
            overflow: visible; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); 
            min-width: auto; 
            margin-bottom: 0; 
            height: fit-content;
            background-color: #2d2d2d; 
            border: 1px solid #404040;
        }
        .category-header { 
            color: #e5e5e5; 
            background: linear-gradient(135deg, #404040, #2d2d2d); 
            padding: 10px 12px; 
            font-weight: bold; 
            font-size: 14px; 
            text-align: center; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            border-radius: 12px 12px 0 0; 
            border-bottom: 2px solid #555; 
        }
        .level-header { 
            display: flex; 
            padding: 8px 10px; 
            font-weight: bold; 
            background-color: #333; 
            border-bottom: 1px solid #555; 
            color: #e5e5e5; 
            align-items: center;
            font-size: 11px;
        }
        .subcategory-header { 
            padding: 8px 10px; 
            font-weight: 600; 
            border-bottom-width: 1px; 
            font-size: 12px; 
            background-color: #363636; 
            border-bottom: 1px solid #555; 
            color: #d5d5d5; 
        }
        .skill-row { 
            display: flex; 
            align-items: center; 
            padding: 6px 10px; 
            border-bottom: 1px solid #404040; 
            font-size: 10px; 
            border-radius: 6px; 
            margin: 2px 6px; 
            background-color: #2d2d2d; 
        }
        .skill-row:last-child { 
            border-bottom: none; 
        }
        .skill-row:hover { 
            background-color: #363636; 
        }
        .skill-name { 
            flex: 3; 
            padding-right: 8px; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            color: #e5e5e5; 
            cursor: help; 
        }
        .skill-pm { 
            flex: 0 0 50px; 
            font-weight: normal; 
            color: #a0a0a0; 
            text-align: right;
            padding-right: 8px;
        }
        .skill-pm.red {
            color: #ef4444;
        }
        .skill-code { 
            flex: 1; 
            font-weight: bold; 
            color: #a0a0a0; 
        }
        .level-boxes { 
            display: flex; 
            justify-content: flex-end; 
            gap: 3px; 
            align-items: center;
        }
        .level-number, .level-box { 
            width: 20px; 
            height: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 0; 
            font-size: 10px; 
            border-radius: 3px; 
            transition: all 0.2s ease; 
            background-color: #404040; 
            border: 1px solid #555; 
            color: #a0a0a0; 
            text-align: center; 
            line-height: 20px; 
            position: relative; 
            cursor: pointer; 
        }
        .level-box:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); 
        }
        .level-box.filled { 
            background: #ffffff; 
            border: 2px solid #ffffff; 
            color: #2d2d2d; 
            box-shadow: none; 
            font-weight: bold;
        }
        .level-box.clear-btn {
            color: #ef4444;
            border-color: #ef4444;
            font-weight: bold;
        }
        .level-box.clear-btn:hover {
            background: #ef4444;
            color: white;
        }
        .flex-grow { 
            flex-grow: 1; 
        }
        .right-content-wrapper {
            margin-left: 505px;
            background: #f3f4f6;
            padding: 20px 35px;
            height: fit-content;
            border-radius: 8px;
        }
        .content-section { 
            display: flex;
            flex-direction: column;
        }
        .definition-section { 
            background: #ffffff; 
            border-radius: 8px; 
            padding: 12px 16px; 
            margin: 15px 0; 
            max-height: 320px; 
            overflow-y: auto;
            box-shadow: none;
            border: 1px solid #e5e7eb;
        }
        .definition-title { 
            font-size: 13px; 
            font-weight: 600; 
            color: #1f2937; 
            margin-bottom: 10px; 
        }
        .definition-text { 
            color: #4b5563; 
            line-height: 1.5; 
            margin-bottom: 12px; 
            font-size: 12px; 
        }
        .guidance-title { 
            font-size: 13px; 
            font-weight: 600; 
            color: #1f2937; 
            margin-top: 8px; 
            margin-bottom: 10px; 
        }
        .guidance-text { 
            color: #4b5563; 
            line-height: 1.5; 
            font-size: 12px; 
        }
        .summary-card { background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin: 20px 0; }
        .summary-title { font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 20px; text-align: center; }
        .summary-item { display: flex; justify-content: space-between; padding: 15px; margin: 10px 0; background: #f9fafb; border-radius: 8px; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <nav class="bg-gray-800 mb-0 -mx-0 -mt-0 px-4" style="margin-top: 0 !important; margin-bottom: 0 !important;">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center">
                    <div class="shrink-0 flex items-center">
                        <span class="mr-2 px-2 py-1 text-sm font-bold text-white rounded" style="border: 1px solid rgba(255, 255, 255, 0.5); text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.6), inset 0 0 10px rgba(0, 255, 255, 0.3); animation: holographic 3s infinite alternate; background: linear-gradient(-45deg, rgba(0, 255, 255, 0.1), rgba(0, 150, 255, 0.2), rgba(183, 0, 255, 0.1));">bêta v0.1.2</span>
                        <span class="text-2xl font-bold text-white">DCWF</span>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="{% url 'main' %}" class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Home</a>
                            <a href="{% url 'summary_chart' %}" class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Tableau des compétences</a>
                            <a href="{% url 'attributs_part_deux' %}" class="rounded-md px-3 py-2 text-sm font-medium bg-gray-900 text-white">PARTIE 2</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Tableau noir des attributs génériques SFIA à gauche -->
        <div class="attributes-table-container">
            <div id="sfiaAttributesTable" class="category-container">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <!-- NF-COM Selector - Below the black table -->
            <div id="nfcomSelector" class="mt-3" style="display: none;">
                <div class="bg-white border border-gray-300 rounded-lg p-3">
                    <h3 class="text-base font-semibold mb-2 text-gray-800">Selected Competency Areas (NF-COM)</h3>
                    <div id="nfcomList" class="flex flex-wrap gap-2 mb-2"></div>
                    <div class="flex gap-2 mt-2">
                        <button id="copySelectionsBtn" class="btn btn-secondary" style="display: none; padding: 6px 16px; font-size: 12px;" onclick="showCopySelectionsModal()">Copy Selections</button>
                        <button id="resetCurrentBtn" class="btn btn-secondary" style="display: none; padding: 6px 16px; font-size: 12px;" onclick="resetCurrentNFCOM()">Reset Current</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenu principal à droite -->
        <div class="right-content-wrapper">
            <!-- Page Title -->
            <div class="mb-3">
                <h1 class="text-xl font-bold text-gray-800" style="margin-bottom: 15px;" id="pageTitle">Attributs Part Deux</h1>
            </div>
            
            <!-- Main Content Area -->
            <div id="mainContent">
                <!-- Content will be dynamically loaded here -->
            </div>

            <!-- Navigation Buttons -->
            <div class="navigation-buttons" id="navigationButtons" style="display: none;">
                <button class="btn btn-secondary" id="backButton" onclick="goToPreviousStep()">Back</button>
                <button class="btn btn-primary" id="nextButton" onclick="goToNextStep()" disabled>Next</button>
            </div>
        </div>

        <!-- Copy Selections Modal -->
        <div id="copyModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Copy Selections</h3>
                <p class="mb-4 text-gray-600">Select source NF-COM to copy from:</p>
                <div id="copySourceList" class="mb-4"></div>
                <div class="flex justify-end gap-2">
                    <button class="btn btn-secondary" onclick="closeCopyModal()">Cancel</button>
                    <button class="btn btn-primary" id="confirmCopyBtn" onclick="confirmCopySelections()" disabled>Copy</button>
                </div>
            </div>
        </div>
        
        <!-- Clear float -->
        <div style="clear: both;"></div>
    </div>

    <script>
        let genericAttributesData = [];
        let selectedLevels = {}; // Structure: { 'NF-COM-003': { 'AUTO': 2, 'INFL': 3, ... }, ... }
        let currentStep = 0;
        let selectedNFCOMs = []; // Array of NF-COM codes like ['NF-COM-003', 'NF-COM-004']
        let currentNFCOM = null; // Current NF-COM being processed
        let copySourceNFCOM = null; // NF-COM selected as source for copying
        const requiredAttributes = ['AUTO', 'INFL', 'COMP', 'KNGE'];
        const attributeNames = {
            'AUTO': 'Autonomy',
            'INFL': 'Influence',
            'COMP': 'Complexity',
            'KNGE': 'Knowledge'
        };

        // NF-COM data mapping
        const nfcomData = {
            'NF-COM-001': 'Access Controls',
            'NF-COM-002': 'Artificial Intelligence (AI) Security',
            'NF-COM-003': 'Asset Management',
            'NF-COM-004': 'Cloud Security',
            'NF-COM-005': 'Communications Security',
            'NF-COM-006': 'Cryptography',
            'NF-COM-007': 'Cyber Resiliency',
            'NF-COM-008': 'DevSecOps',
            'NF-COM-009': 'Operating Systems (OS) Security',
            'NF-COM-010': 'Operational Technology (OT) Security',
            'NF-COM-011': 'Supply Chain Security',
            'NF-COM-012': 'Cybersecurity Fundamentals',
            'NF-COM-013': 'Cybersecurity Leadership',
            'NF-COM-014': 'Data Security',
            'NF-COM-015': 'Secure Programming'
        };

        // Load selected NF-COMs from etape2_first_step
        async function loadSelectedNFCOMs() {
            try {
                // Try to get from localStorage first (from etape2_first_step)
                // The key used in etape2_first_step is 'selectedNFDomains'
                let storedData = localStorage.getItem('selectedNFDomains');
                
                if (storedData) {
                    try {
                        const parsed = JSON.parse(storedData);
                        if (Array.isArray(parsed)) {
                            selectedNFCOMs = parsed.filter(d => d && (d.startsWith('NF-COM-') || d.match(/^NF-COM-\d+$/)));
                        }
                    } catch (e) {
                        console.error('Error parsing selectedNFDomains:', e);
                    }
                }

                // Also try other possible keys
                if (selectedNFCOMs.length === 0) {
                    storedData = localStorage.getItem('selectedDomains') || localStorage.getItem('nfcomSelections');
                    if (storedData) {
                        try {
                            const parsed = JSON.parse(storedData);
                            if (Array.isArray(parsed)) {
                                selectedNFCOMs = parsed.filter(d => d && (d.startsWith('NF-COM-') || d.match(/^NF-COM-\d+$/)));
                            } else if (parsed.selectedDomains) {
                                selectedNFCOMs = parsed.selectedDomains.filter(d => d && (d.startsWith('NF-COM-') || d.match(/^NF-COM-\d+$/)));
                            }
                        } catch (e) {
                            console.error('Error parsing stored data:', e);
                        }
                    }
                }

                // Also try serverStorage if available
                if (typeof serverStorage !== 'undefined' && selectedNFCOMs.length === 0) {
                    try {
                        const serverData = await serverStorage.getItem('selectedNFDomains');
                        if (serverData) {
                            const parsed = typeof serverData === 'string' ? JSON.parse(serverData) : serverData;
                            if (Array.isArray(parsed)) {
                                selectedNFCOMs = parsed.filter(d => d && (d.startsWith('NF-COM-') || d.match(/^NF-COM-\d+$/)));
                            }
                        }
                    } catch (e) {
                        console.error('Error loading from serverStorage:', e);
                    }
                }

                // If still no NF-COMs, check for currentKsatSelection
                if (selectedNFCOMs.length === 0) {
                    const ksatData = localStorage.getItem('currentKsatSelection');
                    if (ksatData) {
                        try {
                            const parsed = JSON.parse(ksatData);
                            if (parsed.selectedDomains && Array.isArray(parsed.selectedDomains)) {
                                selectedNFCOMs = parsed.selectedDomains.filter(d => d && (d.startsWith('NF-COM-') || d.match(/^NF-COM-\d+$/)));
                            }
                        } catch (e) {
                            console.error('Error parsing currentKsatSelection:', e);
                        }
                    }
                }

                console.log('Loaded NF-COMs:', selectedNFCOMs);

                // Initialize selectedLevels structure for each NF-COM
                selectedNFCOMs.forEach(nfcom => {
                    if (!selectedLevels[nfcom]) {
                        selectedLevels[nfcom] = {};
                    }
                });

                // Don't load saved selections automatically - start fresh each time
                // This prevents old selections from persisting when restarting the process
                // If you want to load saved selections, uncomment the code below:
                /*
                const savedSelections = localStorage.getItem('nfcomAttributeSelections');
                if (savedSelections) {
                    try {
                        const parsed = JSON.parse(savedSelections);
                        // Merge saved selections with current structure
                        Object.keys(parsed).forEach(nfcom => {
                            if (selectedNFCOMs.includes(nfcom)) {
                                selectedLevels[nfcom] = parsed[nfcom];
                            }
                        });
                    } catch (e) {
                        console.error('Error loading saved selections:', e);
                    }
                }
                */

                if (selectedNFCOMs.length > 0) {
                    currentNFCOM = selectedNFCOMs[0];
                    renderNFCOMSelector();
                } else {
                    // No NF-COMs selected, show message
                    document.getElementById('mainContent').innerHTML = 
                        '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6"><p class="text-yellow-800">No Competency Areas (NF-COM) selected. Please go back to Step 2 and select at least one NF-COM using the "Simplify Heatmap" feature.</p></div>';
                }
            } catch (error) {
                console.error('Error loading selected NF-COMs:', error);
            }
        }

        // Render NF-COM selector UI
        function renderNFCOMSelector() {
            const selector = document.getElementById('nfcomSelector');
            const list = document.getElementById('nfcomList');
            
            if (selectedNFCOMs.length === 0) {
                selector.style.display = 'none';
                return;
            }

            selector.style.display = 'block';
            list.innerHTML = '';

            selectedNFCOMs.forEach((nfcom, index) => {
                const isCurrent = nfcom === currentNFCOM;
                const isComplete = isNFCOMComplete(nfcom);
                const badge = document.createElement('div');
                badge.className = `px-3 py-1.5 rounded-lg cursor-pointer transition-all text-sm ${
                    isCurrent 
                        ? 'bg-blue-600 text-white font-semibold' 
                        : isComplete 
                            ? 'bg-green-100 text-green-800 border border-green-300' 
                            : 'bg-gray-100 text-gray-700 border border-gray-300 hover:bg-gray-200'
                }`;
                badge.textContent = `${nfcom} - ${nfcomData[nfcom] || nfcom}`;
                badge.onclick = () => switchToNFCOM(nfcom);
                
                if (isComplete) {
                    const checkmark = document.createElement('span');
                    checkmark.className = 'ml-2';
                    checkmark.textContent = '✓';
                    badge.appendChild(checkmark);
                }
                
                list.appendChild(badge);
            });

            // Show/hide action buttons
            document.getElementById('copySelectionsBtn').style.display = selectedNFCOMs.length > 1 ? 'block' : 'none';
            document.getElementById('resetCurrentBtn').style.display = currentNFCOM ? 'block' : 'none';
        }

        // Check if NF-COM selection is complete
        function isNFCOMComplete(nfcom) {
            if (!selectedLevels[nfcom]) return false;
            const levels = selectedLevels[nfcom];
            return requiredAttributes.every(attr => levels[attr] !== undefined && levels[attr] !== null);
        }

        // Switch to a different NF-COM
        function switchToNFCOM(nfcom) {
            if (nfcom === currentNFCOM) return;
            
            // Save current state
            saveCurrentNFCOMState();
            
            // Switch to new NF-COM
            currentNFCOM = nfcom;
            currentStep = 0;
            
            // Load state for new NF-COM
            loadNFCOMState(nfcom);
            
            // Update UI
            renderNFCOMSelector();
            renderCurrentStep();
            updateNavigationButtons();
        }

        // Save current NF-COM state
        function saveCurrentNFCOMState() {
            if (!currentNFCOM) return;
            if (!selectedLevels[currentNFCOM]) {
                selectedLevels[currentNFCOM] = {};
            }
            // State is already in selectedLevels[currentNFCOM] through selectLevel function
        }

        // Load NF-COM state
        function loadNFCOMState(nfcom) {
            if (!selectedLevels[nfcom]) {
                selectedLevels[nfcom] = {};
            }
            // State is already loaded in selectedLevels[nfcom]
        }

        // Reset current NF-COM
        function resetCurrentNFCOM() {
            if (!currentNFCOM) return;
            if (confirm(`Are you sure you want to reset all selections for ${currentNFCOM}?`)) {
                selectedLevels[currentNFCOM] = {};
                currentStep = 0;
                renderCurrentStep();
                updateNavigationButtons();
                renderNFCOMSelector();
            }
        }

        // Show copy selections modal
        function showCopySelectionsModal() {
            const modal = document.getElementById('copyModal');
            const list = document.getElementById('copySourceList');
            
            list.innerHTML = '';
            copySourceNFCOM = null;
            document.getElementById('confirmCopyBtn').disabled = true;

            selectedNFCOMs.forEach(nfcom => {
                if (nfcom === currentNFCOM) return; // Skip current NF-COM
                
                const isComplete = isNFCOMComplete(nfcom);
                if (!isComplete) return; // Only show complete NF-COMs

                const item = document.createElement('div');
                item.className = `p-3 mb-2 border rounded-lg cursor-pointer transition-all ${
                    copySourceNFCOM === nfcom 
                        ? 'bg-blue-100 border-blue-500' 
                        : 'bg-gray-50 border-gray-300 hover:bg-gray-100'
                }`;
                item.innerHTML = `<strong>${nfcom}</strong> - ${nfcomData[nfcom] || nfcom}`;
                item.onclick = () => {
                    copySourceNFCOM = nfcom;
                    document.querySelectorAll('#copySourceList > div').forEach(el => {
                        el.className = el.className.replace('bg-blue-100 border-blue-500', 'bg-gray-50 border-gray-300');
                    });
                    item.className = 'p-3 mb-2 border rounded-lg cursor-pointer transition-all bg-blue-100 border-blue-500';
                    document.getElementById('confirmCopyBtn').disabled = false;
                };
                list.appendChild(item);
            });

            if (list.children.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No completed NF-COM selections available to copy.</p>';
            }

            modal.classList.remove('hidden');
        }

        // Close copy modal
        function closeCopyModal() {
            document.getElementById('copyModal').classList.add('hidden');
            copySourceNFCOM = null;
        }

        // Confirm and copy selections
        function confirmCopySelections() {
            if (!copySourceNFCOM || !currentNFCOM) return;

            if (confirm(`Copy all selections from ${copySourceNFCOM} to ${currentNFCOM}? This will overwrite any existing selections.`)) {
                selectedLevels[currentNFCOM] = JSON.parse(JSON.stringify(selectedLevels[copySourceNFCOM]));
                currentStep = 0;
                renderCurrentStep();
                updateNavigationButtons();
                renderNFCOMSelector();
                closeCopyModal();
            }
        }

        async function loadGenericAttributes() {
            try {
                const response = await fetch('/api/sfia-generic-attributes/');
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                genericAttributesData = await response.json();
                
                // Load NF-COMs first, then initialize
                await loadSelectedNFCOMs();
                if (selectedNFCOMs.length > 0) {
                    initializeSteps();
                }
            } catch (error) {
                console.error('Error loading generic attributes:', error);
                document.getElementById('mainContent').innerHTML = '<p style="color: red; padding: 20px;">Error loading data: ' + error.message + '</p>';
            }
        }

        function createLevelBoxes(attribute) {
            if (!currentNFCOM || !selectedLevels[currentNFCOM]) return '';
            let levelBoxesHtml = '';
            const nfcomLevels = selectedLevels[currentNFCOM];
            const selectedLevel = nfcomLevels[attribute.four_letters];
            
            for (let level = 1; level <= 7; level++) {
                const isFilled = selectedLevel === level ? 'filled' : '';
                // Ajouter un espace après le niveau 2 et après le niveau 4
                const spacer = (level === 2 || level === 4) ? '<div style="width: 8px;"></div>' : '';
                levelBoxesHtml += `<div class="level-box ${isFilled}" data-attribute-code="${attribute.four_letters}" data-level="${level}" onclick="toggleAttributeLevel('${attribute.four_letters}', ${level})">${level}</div>${spacer}`;
            }
            
            return levelBoxesHtml;
        }

        function createSkillRow(attribute) {
            const levelBoxesHtml = createLevelBoxes(attribute);
            // Ajouter "p.m." avant le code à partir de Collaboration (COLL) inclus
            const collIndex = genericAttributesData.findIndex(a => a.four_letters === 'COLL');
            const currentIndex = genericAttributesData.findIndex(a => a.four_letters === attribute.four_letters);
            const shouldAddPM = collIndex !== -1 && currentIndex >= collIndex;
            const pmDisplay = shouldAddPM ? '<div class="skill-pm">p.m.</div>' : '<div class="skill-pm"></div>';
            return `<div class="skill-row" data-skill-row-code="${attribute.four_letters}"><div class="skill-name">${attribute.h1}</div>${pmDisplay}<div class="skill-code">${attribute.four_letters}</div><div class="level-boxes">${levelBoxesHtml}</div></div>`;
        }

        function createLevelHeader() {
            let levelNumbersHtml = '';
            for (let i = 1; i <= 7; i++) {
                levelNumbersHtml += `<div class="level-number">${i}</div>`;
            }
            return `<div class="level-header"><div class="flex-grow">Generic Attribute:</div><div class="skill-pm"></div><div class="level-boxes">${levelNumbersHtml}</div></div>`;
        }

        function toggleAttributeLevel(attributeCode, level) {
            if (!currentNFCOM) return;
            
            // Initialize NF-COM levels if needed
            if (!selectedLevels[currentNFCOM]) {
                selectedLevels[currentNFCOM] = {};
            }
            
            const nfcomLevels = selectedLevels[currentNFCOM];
            // If same level clicked, deselect, otherwise select new level
            if (nfcomLevels[attributeCode] === level) {
                delete nfcomLevels[attributeCode];
            } else {
                nfcomLevels[attributeCode] = level;
            }
            populateSfiaAttributesTable();
            renderNFCOMSelector(); // Update NF-COM selector
            // If it's the current attribute, update display
            const currentAttribute = getCurrentAttribute();
            if (currentAttribute && currentAttribute.four_letters === attributeCode) {
                renderCurrentStep();
                updateNavigationButtons();
            }
        }

        function createBusinessSkillsRow() {
            // Créer une ligne vide pour "BUSINESS SKILLS BEHAVIOURAL FACTORS"
            const emptyBoxes = '<div class="level-boxes"></div>';
            return `<div class="skill-row"><div class="skill-name">BUSINESS SKILLS BEHAVIOURAL FACTORS</div><div class="skill-pm red">p.m.</div><div class="skill-code"></div>${emptyBoxes}</div>`;
        }

        function populateSfiaAttributesTable() {
            const container = document.getElementById('sfiaAttributesTable');
            if (!container || !genericAttributesData.length) return;

            // Filtrer les attributs jusqu'à Knowledge (KNGE) inclus
            const kngeIndex = genericAttributesData.findIndex(a => a.four_letters === 'KNGE');
            const filteredAttributes = kngeIndex !== -1 
                ? genericAttributesData.slice(0, kngeIndex + 1)
                : genericAttributesData;

            const skillsHtml = filteredAttributes.map(createSkillRow).join('');
            const businessSkillsRow = createBusinessSkillsRow();
            let html = '<div class="category-header">(SFIA 9) GENERIC ATTRIBUTES, BUSINESS SKILLS BEHAVIOURAL FACTORS</div>';
            html += `<div class="subcategory"><div class="subcategory-header">Generic Attribute :</div>${skillsHtml}${businessSkillsRow}</div>`;
            
            container.innerHTML = html;
        }

        function initializeSteps() {
            populateSfiaAttributesTable();
            renderCurrentStep();
            updateStepIndicator();
            updateNavigationButtons();
        }

        function getCurrentAttribute() {
            const attributeCode = requiredAttributes[currentStep];
            return genericAttributesData.find(attr => attr.four_letters === attributeCode);
        }

        function renderCurrentStep() {
            const attribute = getCurrentAttribute();
            if (!attribute) {
                if (currentStep === requiredAttributes.length) {
                    renderSummary();
                    return;
                }
                return;
            }

            let html = '';

            // Update title with attribute name and current NF-COM
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                const nfcomName = currentNFCOM ? `${currentNFCOM} - ${nfcomData[currentNFCOM] || currentNFCOM}` : '';
                pageTitle.textContent = `${attribute.h1}${nfcomName ? ` (${nfcomName})` : ''}`;
            }

            // Nettoyer le texte guidance_notes pour supprimer "Guidance notes" au début
            let guidanceText = attribute.guidance_notes || '';
            // Supprimer "Guidance notes" au début (insensible à la casse)
            guidanceText = guidanceText.replace(/^Guidance notes/i, '').trim();

            // Definition & Guidance - En haut
            html += '<div class="definition-section">';
            html += '<div class="definition-title"><strong>Definition & guidance note</strong></div>';
            html += `<div class="definition-text">${attribute.lead}</div>`;
            html += '<div class="guidance-title"><strong>Guidance Notes</strong></div>';
            html += `<div class="guidance-text">${guidanceText}</div>`;
            html += '</div>';

            // Level Preview Area - Zone pour afficher la définition du niveau au survol
            html += '<div class="level-preview-container">';
            html += '<div class="level-preview hidden" id="levelPreview">';
            html += '<div class="level-preview-number" id="previewNumber"></div>';
            html += '<div class="level-preview-title" id="previewTitle"></div>';
            html += '<div class="level-preview-description" id="previewDescription"></div>';
            html += '</div>';
            html += '</div>';

            // Level Scale - Fixe en bas
            html += '<div class="level-scale-container">';
            html += '<div class="level-scale-label"><strong>Select Level</strong></div>';
            html += '<div class="level-scale">';
            
            // Create scale items 1-7
            const nfcomLevels = currentNFCOM && selectedLevels[currentNFCOM] ? selectedLevels[currentNFCOM] : {};
            for (let i = 1; i <= 7; i++) {
                const isSelected = nfcomLevels[attribute.four_letters] === i;
                html += `<div class="level-scale-item ${isSelected ? 'selected' : ''}" 
                             onclick="selectLevel(${i})" 
                             onmouseenter="showLevelPreview(${i})" 
                             onmouseleave="hideLevelPreview()"
                             data-level="${i}">${i}</div>`;
            }
            
            html += '</div>';
            html += '</div>';

            document.getElementById('mainContent').innerHTML = html;
            document.getElementById('navigationButtons').style.display = 'flex';
            
            // Show selected level if one is selected
            const selectedLevel = nfcomLevels[attribute.four_letters];
            if (selectedLevel) {
                setTimeout(() => showLevelPreview(selectedLevel, true), 100);
            }
        }

        function selectLevel(level) {
            const attribute = getCurrentAttribute();
            if (!attribute || !currentNFCOM) return;

            // Initialize NF-COM levels if needed
            if (!selectedLevels[currentNFCOM]) {
                selectedLevels[currentNFCOM] = {};
            }
            
            selectedLevels[currentNFCOM][attribute.four_letters] = level;
            populateSfiaAttributesTable(); // Update left list
            renderCurrentStep();
            updateNavigationButtons();
            renderNFCOMSelector(); // Update NF-COM selector to show progress
            // Show selected level preview
            showLevelPreview(level, true);
        }

        function showLevelPreview(level, persist = false) {
            const attribute = getCurrentAttribute();
            if (!attribute) return;

            const levelData = attribute.skill_levels[level - 1];
            if (!levelData) return;

            const preview = document.getElementById('levelPreview');
            const previewNumber = document.getElementById('previewNumber');
            const previewTitle = document.getElementById('previewTitle');
            const previewDescription = document.getElementById('previewDescription');

            if (preview && previewNumber && previewTitle && previewDescription) {
                previewNumber.textContent = `Level ${level}`;
                previewTitle.textContent = levelData.level;
                previewDescription.textContent = levelData.description;
                
                // Toujours visible, juste changer l'opacité
                preview.classList.remove('hidden');
                preview.style.opacity = '1';
                
                if (persist) {
                    preview.dataset.persist = 'true';
                } else {
                    delete preview.dataset.persist;
                }
            }
        }

        function hideLevelPreview() {
            const preview = document.getElementById('levelPreview');
            if (preview) {
                // Don't hide if a level is selected
                const attribute = getCurrentAttribute();
                const nfcomLevels = currentNFCOM && selectedLevels[currentNFCOM] ? selectedLevels[currentNFCOM] : {};
                if (attribute && nfcomLevels[attribute.four_letters]) {
                    const selectedLevel = nfcomLevels[attribute.four_letters];
                    showLevelPreview(selectedLevel, true);
                    return;
                }
                // Only hide content if not persisted
                if (!preview.dataset.persist) {
                    preview.classList.add('hidden');
                    preview.style.opacity = '0';
                }
            }
        }

        function updateStepIndicator() {
            const indicators = document.querySelectorAll('.step-item');
            const nfcomLevels = currentNFCOM && selectedLevels[currentNFCOM] ? selectedLevels[currentNFCOM] : {};
            
            indicators.forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                
                // Remove previous level display if exists
                const existingLevel = indicator.querySelector('.step-item-level');
                if (existingLevel) {
                    existingLevel.remove();
                }
                
                if (index < currentStep) {
                    indicator.classList.add('completed');
                    // Display selected level for completed steps
                    const attributeCode = requiredAttributes[index];
                    const level = nfcomLevels[attributeCode];
                    if (level) {
                        const levelSpan = document.createElement('span');
                        levelSpan.className = 'step-item-level';
                        levelSpan.textContent = `Level ${level}`;
                        indicator.appendChild(levelSpan);
                    }
                } else if (index === currentStep) {
                    indicator.classList.add('active');
                }
            });
        }

        function updateNavigationButtons() {
            const attribute = getCurrentAttribute();
            const nfcomLevels = currentNFCOM && selectedLevels[currentNFCOM] ? selectedLevels[currentNFCOM] : {};
            const hasSelection = attribute && nfcomLevels[attribute.four_letters];
            
            document.getElementById('backButton').style.display = currentStep === 0 ? 'none' : 'block';
            document.getElementById('nextButton').disabled = !hasSelection && currentStep < requiredAttributes.length;
            
            if (currentStep === requiredAttributes.length) {
                // Check if current NF-COM is complete
                const isCurrentNFCOMComplete = isNFCOMComplete(currentNFCOM);
                
                // Check if there are more NF-COMs to process
                const currentIndex = selectedNFCOMs.indexOf(currentNFCOM);
                const hasMoreNFCOMs = currentIndex < selectedNFCOMs.length - 1;
                
                // Only show "Next NF-COM" or "Finish" if current NF-COM is complete
                if (isCurrentNFCOMComplete) {
                    document.getElementById('nextButton').textContent = hasMoreNFCOMs ? 'Next NF-COM' : 'Finish';
                    document.getElementById('nextButton').disabled = false;
                } else {
                    // Current NF-COM not complete, stay on review but disable finish
                    document.getElementById('nextButton').textContent = 'Review';
                    document.getElementById('nextButton').disabled = true;
                }
            } else if (currentStep === requiredAttributes.length - 1) {
                document.getElementById('nextButton').textContent = 'Review';
            } else {
                document.getElementById('nextButton').textContent = 'Next';
            }
        }

        function goToNextStep() {
            const nfcomLevels = currentNFCOM && selectedLevels[currentNFCOM] ? selectedLevels[currentNFCOM] : {};
            
            if (currentStep < requiredAttributes.length) {
                const attribute = getCurrentAttribute();
                if (!nfcomLevels[attribute.four_letters]) {
                    alert('Please select a level before continuing.');
                    return;
                }
                currentStep++;
            } else if (currentStep === requiredAttributes.length) {
                // Check if current NF-COM is complete before proceeding
                const isCurrentNFCOMComplete = isNFCOMComplete(currentNFCOM);
                
                if (!isCurrentNFCOMComplete) {
                    alert('Please complete all attribute selections for the current Competency Area before proceeding.');
                    return;
                }
                
                // Current NF-COM is complete, move to next NF-COM or finish
                const currentIndex = selectedNFCOMs.indexOf(currentNFCOM);
                const nextIndex = currentIndex + 1;
                
                if (nextIndex < selectedNFCOMs.length) {
                    // Switch to next NF-COM
                    switchToNFCOM(selectedNFCOMs[nextIndex]);
                    return;
                } else {
                    // Check if all NF-COMs are complete before finishing
                    const allNFCOMsComplete = selectedNFCOMs.every(nfcom => isNFCOMComplete(nfcom));
                    
                    if (allNFCOMsComplete) {
                        // All NF-COMs complete, finish
                        confirmSelections();
                        return;
                    } else {
                        alert('Please complete all Competency Areas before finishing.');
                        return;
                    }
                }
            }
            renderCurrentStep();
            updateStepIndicator();
            updateNavigationButtons();
        }

        function goToPreviousStep() {
            if (currentStep > 0) {
                currentStep--;
                renderCurrentStep();
                updateStepIndicator();
                updateNavigationButtons();
            }
        }

        function renderSummary() {
            if (!currentNFCOM) return;
            
            const nfcomLevels = selectedLevels[currentNFCOM] || {};
            const nfcomName = `${currentNFCOM} - ${nfcomData[currentNFCOM] || currentNFCOM}`;
            
            let html = '<div class="summary-card">';
            html += `<div class="summary-title">Summary for ${nfcomName}</div>`;
            
            requiredAttributes.forEach(code => {
                const attr = genericAttributesData.find(a => a.four_letters === code);
                const level = nfcomLevels[code];
                if (!level) return;
                
                const levelData = attr.skill_levels.find(sl => {
                    const match = sl.level.match(/Level (\d+)/);
                    return match && parseInt(match[1]) === level;
                });
                
                html += '<div class="summary-item">';
                html += `<div><strong>${attributeNames[code]}</strong><br><span style="color: #6b7280; font-size: 14px;">${attr.lead}</span></div>`;
                html += `<div style="text-align: right;"><strong>${levelData ? levelData.level : 'Level ' + level}</strong><br><span style="color: #6b7280; font-size: 12px;">${levelData ? levelData.description : ''}</span></div>`;
                html += '</div>';
            });
            
            html += '</div>';
            
            document.getElementById('mainContent').innerHTML = html;
            document.getElementById('navigationButtons').style.display = 'flex';
            document.getElementById('backButton').style.display = 'block';
        }

        function confirmSelections() {
            // Save all NF-COM selections
            console.log('All NF-COM selections:', selectedLevels);
            
            // Save to localStorage (for potential future use, but we'll reset after)
            localStorage.setItem('nfcomAttributeSelections', JSON.stringify(selectedLevels));
            
            // Save to serverStorage if available
            if (typeof serverStorage !== 'undefined') {
                serverStorage.setItem('nfcomAttributeSelections', JSON.stringify(selectedLevels))
                    .then(() => console.log('Selections saved to server'))
                    .catch(err => console.error('Error saving to server:', err));
            }
            
            // Afficher un message de confirmation
            alert(`All selections for ${selectedNFCOMs.length} Competency Area(s) have been saved successfully!`);
            
            // Rediriger vers attributs-part-deux-opm-id
            window.location.href = "{% url 'attributs_part_deux_opm_id' %}";
        }

        // Reset all NF-COM selections
        function resetAllSelections() {
            // Clear all selections
            selectedLevels = {};
            
            // Reinitialize structure for each NF-COM (empty)
            selectedNFCOMs.forEach(nfcom => {
                selectedLevels[nfcom] = {};
            });
            
            // Reset current state
            currentNFCOM = selectedNFCOMs.length > 0 ? selectedNFCOMs[0] : null;
            currentStep = 0;
            
            // Clear saved selections from localStorage
            localStorage.removeItem('nfcomAttributeSelections');
            
            // Clear from serverStorage if available
            if (typeof serverStorage !== 'undefined') {
                serverStorage.removeItem('nfcomAttributeSelections')
                    .catch(err => console.error('Error removing from serverStorage:', err));
            }
            
            // Update UI
            renderNFCOMSelector();
            renderCurrentStep();
            updateNavigationButtons();
            populateSfiaAttributesTable();
            
            console.log('All selections have been reset');
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Attributs Part Deux: DOM loaded, starting initialization...');
            loadGenericAttributes();
        });
    </script>
</body>
</html>

 
