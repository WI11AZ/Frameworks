<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadre de Compétences SFIA (Complet)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ajouter le script serverStorage.js -->
    <script src="/static/js/serverStorage.js"></script>
    <style>
        /* --- STYLES GÉNÉRAUX --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            line-height: 1.2;
            background-color: #f8fafc;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- MODE SOMBRE --- */
        body.dark-mode {
            background-color: #1a202c;
            color: #f1f5f9;
        }
        .dark-mode .mx-auto { background-color: #1a202c; }
        .dark-mode .category-container { background-color: #2d3748; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25); }
        .dark-mode .category-header { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
        .dark-mode .skill-name { color: #e2e8f0; }
        .dark-mode .skill-code { color: #a0aec0; }
        .dark-mode .skill-row { border-color: #4a5568; background-color: #2d3748; }
        .dark-mode .skill-row:nth-child(odd) { background-color: #283141; }
        .dark-mode .skill-row:hover { background-color: #374151; }
        .dark-mode .level-box { background-color: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); }
        .dark-mode nav.bg-gray-800 { background-color: #111827; }
        .dark-mode .text-gray-900 { color: #f1f5f9; }
        .dark-mode header.bg-white { background-color: #1f2937; }
        .dark-mode header h1 { color: #f1f5f9; }
        .dark-mode #header-job-number { color: #cbd5e1; }
        .dark-mode #header-job-number-value { color: #60a5fa; }
        .dark-mode #opm-ids-container { background-color: #2d3748; border-color: #4a5568; }
        #darkModeToggle { transition: all 0.2s ease-in-out; }
        #darkModeToggle:hover { transform: scale(1.05); }

        /* --- GRILLE & CONTENEURS --- */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
        }
        .category-container {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            height: fit-content;
        }
        .category-container:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        /* --- EN-TÊTES --- */
        .category-header {
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .level-header {
            display: flex;
            padding: 8px 10px;
            font-weight: bold;
            border-bottom-width: 1px;
        }
        .subcategory-header {
            padding: 8px 10px;
            font-weight: 600;
            border-bottom-width: 1px;
            font-size: 12px;
        }

        /* --- LIGNES DE COMPÉTENCES --- */
        .skill-row {
            display: flex;
            align-items: center;
            padding: 4px 10px;
            border-bottom: 1px solid #eee;
            font-size: 11px;
        }
        .skill-row:last-child { border-bottom: none; }
        .skill-name { flex: 3; padding-right: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .skill-code { flex: 1; font-weight: bold; color: #666; }
        .level-boxes { display: flex; justify-content: flex-end; }
        .level-number, .level-box {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1px;
            font-size: 11px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        .level-box:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .level-box.filled { color: white; border: none; }

        /* --- OPM IDs --- */
        #opm-ids-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: white;
        }
        .opm-id-badge {
            display: inline-block;
            padding: 5px 10px;
            margin: 3px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
            background-color: #3b82f6;
        }

        /* --- THÈMES DE COULEURS PAR CATÉGORIE --- */
        :root {
            --cat-strategy-architecture-main: #e11d48; --cat-strategy-architecture-dark: #be123c; --cat-strategy-architecture-text: #881337; --cat-strategy-architecture-light-bg: rgba(254, 205, 211, 0.4);
            --cat-dev-implementation-main: #facc15; --cat-dev-implementation-dark: #eab308; --cat-dev-implementation-text: #854d0e; --cat-dev-implementation-light-bg: rgba(254, 249, 195, 0.6);
            --cat-delivery-operation-main: #ea580c; --cat-delivery-operation-dark: #c2410c; --cat-delivery-operation-text: #9a3412; --cat-delivery-operation-light-bg: rgba(255, 237, 213, 0.6);
            --cat-change-transformation-main: #db2777; --cat-change-transformation-dark: #be185d; --cat-change-transformation-text: #9d174d; --cat-change-transformation-light-bg: rgba(252, 231, 243, 0.6);
            --cat-people-skills-main: #0891b2; --cat-people-skills-dark: #0e7490; --cat-people-skills-text: #0c4a6e; --cat-people-skills-light-bg: rgba(224, 242, 254, 0.6);
            --cat-relationships-engagement-main: #16a34a; --cat-relationships-engagement-dark: #15803d; --cat-relationships-engagement-text: #166534; --cat-relationships-engagement-light-bg: rgba(220, 252, 231, 0.6);
        }
        .category-container { --cat-main: #666; --cat-dark: #555; --cat-text: #444; --cat-light-bg: #f0f0f0; }
        .strategy-architecture { --cat-main: var(--cat-strategy-architecture-main); --cat-dark: var(--cat-strategy-architecture-dark); --cat-text: var(--cat-strategy-architecture-text); --cat-light-bg: var(--cat-strategy-architecture-light-bg); }
        .dev-implementation { --cat-main: var(--cat-dev-implementation-main); --cat-dark: var(--cat-dev-implementation-dark); --cat-text: var(--cat-dev-implementation-text); --cat-light-bg: var(--cat-dev-implementation-light-bg); }
        .delivery-operation { --cat-main: var(--cat-delivery-operation-main); --cat-dark: var(--cat-delivery-operation-dark); --cat-text: var(--cat-delivery-operation-text); --cat-light-bg: var(--cat-delivery-operation-light-bg); }
        .change-transformation { --cat-main: var(--cat-change-transformation-main); --cat-dark: var(--cat-change-transformation-dark); --cat-text: var(--cat-change-transformation-text); --cat-light-bg: var(--cat-change-transformation-light-bg); }
        .people-skills { --cat-main: var(--cat-people-skills-main); --cat-dark: var(--cat-people-skills-dark); --cat-text: var(--cat-people-skills-text); --cat-light-bg: var(--cat-people-skills-light-bg); }
        .relationships-engagement { --cat-main: var(--cat-relationships-engagement-main); --cat-dark: var(--cat-relationships-engagement-dark); --cat-text: var(--cat-relationships-engagement-text); --cat-light-bg: var(--cat-relationships-engagement-light-bg); }
        
        .category-header { background: linear-gradient(135deg, var(--cat-main), var(--cat-dark)); box-shadow: 0 2px 4px color-mix(in srgb, var(--cat-dark) 30%, transparent); }
        .level-header { background: color-mix(in srgb, var(--cat-main) 8%, transparent); border-color: color-mix(in srgb, var(--cat-dark) 15%, transparent); }
        .level-number { background-color: color-mix(in srgb, var(--cat-main) 15%, transparent); color: var(--cat-text); }
        .subcategory-header { background: color-mix(in srgb, var(--cat-main) 20%, transparent); border-color: color-mix(in srgb, var(--cat-dark) 25%, transparent); color: var(--cat-text); }
        .skill-row { border-color: color-mix(in srgb, var(--cat-dark) 15%, transparent); }
        .skill-row:nth-child(even) { background-color: var(--cat-light-bg); }
        .skill-row:hover { background-color: color-mix(in srgb, var(--cat-light-bg) 80%, var(--cat-main) 10%); }
        .level-box { background-color: color-mix(in srgb, var(--cat-main) 5%, transparent); border: 1px solid color-mix(in srgb, var(--cat-main) 15%, transparent); }
        .level-box.filled { background: linear-gradient(135deg, var(--cat-main), var(--cat-dark)); box-shadow: 0 2px 4px color-mix(in srgb, var(--cat-dark) 30%, transparent); }
        
        .dark-mode .level-box.filled { background: linear-gradient(135deg, color-mix(in srgb, var(--cat-main) 50%, #000), color-mix(in srgb, var(--cat-dark) 50%, #000)); }
        .dark-mode .category-header { background: linear-gradient(135deg, color-mix(in srgb, var(--cat-main) 60%, #000), color-mix(in srgb, var(--cat-dark) 60%, #000)); }
        .dark-mode .level-header { background: rgba(255, 255, 255, 0.03); border-color: rgba(255, 255, 255, 0.1); }
        .dark-mode .subcategory-header { background: rgba(255, 255, 255, 0.05); color: var(--cat-main); border-color: rgba(255, 255, 255, 0.1); }
        
        /* --- MODAL --- */
        #modal-backdrop { transition: opacity 0.3s ease-in-out; }
        #modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }

        /* --- TOOLTIP PERSONNALISÉ --- */
        #custom-tooltip {
            position: fixed;
            z-index: 9999;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 4px;
            font-size: 13px;
            pointer-events: none;
            max-width: 300px;
            opacity: 0;
            display: none;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #custom-tooltip.visible {
            opacity: 1;
            display: block;
        }
        .dark-mode #custom-tooltip {
            background-color: rgba(30, 41, 59, 0.95);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .tooltip-title {
            font-weight: bold;
            margin-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 4px;
        }
        .tooltip-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 5px;
        }
        .tooltip-info {
            margin-top: 4px;
        }

        /* Styles pour le tooltip */
        .tooltip {
            position: absolute;
            z-index: 1000;
            background-color: #333;
            color: white;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            padding: 12px;
            max-width: 320px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
        
        .tooltip.visible {
            opacity: 1;
        }
        
        .tooltip-title {
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 1px solid #555;
            padding-bottom: 6px;
            color: white;
        }
        
        .tooltip-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .tooltip-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
            background-color: #666;
        }
        
        .tooltip-info {
            font-size: 0.9em;
            margin-top: 4px;
            color: #fff;
        }
        
        .tooltip-info strong {
            font-weight: 600;
            color: #fff;
        }
        
        /* Animation de clignotement */
        @keyframes blink-animation {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.15); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes holographic {
            0% { 
                opacity: 0.85; 
                transform: scale(1) perspective(500px) rotateY(-3deg);
                text-shadow: 0 0 6px #00ffff, 0 0 10px #00ffff, 0 0 14px rgba(183, 0, 255, 0.6);
                box-shadow: 0 0 10px rgba(0, 255, 255, 0.6), inset 0 0 5px rgba(0, 255, 255, 0.4);
                filter: brightness(0.9) contrast(1.1);
            }
            33% {
                opacity: 0.95;
                transform: scale(1.03) perspective(500px) rotateY(-1deg);
                text-shadow: 0 0 8px #00ffff, 0 0 12px #00ffff, 0 0 16px rgba(183, 0, 255, 0.7);
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.7), inset 0 0 8px rgba(0, 255, 255, 0.5);
                filter: brightness(1.1) contrast(1.2);
            }
            66% { 
                opacity: 1; 
                transform: scale(1.05) perspective(500px) rotateY(1deg);
                text-shadow: 0 0 10px #00ffff, 0 0 15px #00ffff, 0 0 20px rgba(183, 0, 255, 0.8);
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.8), inset 0 0 12px rgba(0, 255, 255, 0.6);
                filter: brightness(1.2) contrast(1.3);
            }
            100% { 
                opacity: 0.9; 
                transform: scale(1) perspective(500px) rotateY(3deg);
                text-shadow: 0 0 8px #00ffff, 0 0 12px #00ffff, 0 0 16px rgba(183, 0, 255, 0.7);
                box-shadow: 0 0 12px rgba(0, 255, 255, 0.7), inset 0 0 7px rgba(0, 255, 255, 0.5);
                filter: brightness(1) contrast(1.2);
            }
        }
    </style>
</head>
<body class="bg-slate-50 p-6">
    <!-- Barre de navigation -->
    <nav class="bg-gray-800 mb-6 -mx-6 -mt-6 px-4">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center">
                    <div class="shrink-0 flex items-center">
                        <span class="mr-2 px-2 py-1 text-sm font-bold text-white rounded" style="border: 1px solid rgba(255, 255, 255, 0.5); text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.6), inset 0 0 10px rgba(0, 255, 255, 0.3); animation: holographic 3s infinite alternate; background: linear-gradient(-45deg, rgba(0, 255, 255, 0.1), rgba(0, 150, 255, 0.2), rgba(183, 0, 255, 0.1));">BETA</span>
                        <span class="text-2xl font-bold text-white">DCWF</span>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="{% url 'main' %}" class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Home</a>
                            <a href="#" class="rounded-md px-3 py-2 text-sm font-medium bg-gray-900 text-white flex items-center">
                                Tableau des compétences
                            </a>
                        </div>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-4 flex items-center md:ml-6">
                        <button type="button" id="darkModeToggle" class="relative rounded-full bg-gray-700 p-1.5 text-gray-300 hover:bg-gray-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-gray-800 mr-3">
                            <span class="sr-only">Basculer en mode sombre</span>
                            <svg id="moonIcon" class="size-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                            <svg id="sunIcon" class="hidden size-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                        </button>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="mobile-menu-button" class="relative inline-flex items-center justify-center rounded-md bg-gray-800 p-2 text-gray-400 hover:bg-gray-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-gray-800" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <svg class="block size-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                        <svg class="hidden size-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
        </div>
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="space-y-1 px-2 pb-3 pt-2 sm:px-3">
                <a href="{% url 'main' %}" class="block rounded-md px-3 py-2 text-base font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Home</a>
                <a href="#" class="block rounded-md px-3 py-2 text-base font-medium bg-gray-900 text-white flex items-center">
                    Tableau des compétences
                </a>
            </div>
        </div>
    </nav>

    <div class="mx-auto max-w-full px-4">
        <!-- Titre et description du tableau -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold mb-2">
                SFIA 9 Skills List <span class="text-yellow-500">(Summary Chart)</span>
                <button id="info-button" class="ml-2 inline-flex items-center justify-center p-1 rounded-full bg-blue-500 text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" title="Voir les niveaux de responsabilité SFIA">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </h1>
            <p class="text-gray-600 italic">The summary chart shows the list of all SFIA 9 skills and their relevant levels, with links to their descriptions. <a href="https://help.sfia.nz/hc/en-nz/articles/39051117630361-SFIA-9-Skills-List" target="_blank" class="text-blue-600 hover:underline">View official SFIA 9 Skills List</a></p>
        </div>
        
        <!-- Conteneur pour afficher les OPM IDs -->
        <div id="opm-ids-container" class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
            <h2 class="text-lg font-semibold mb-2">OPM IDs de la sauvegarde</h2>
            <div id="opm-ids-list" class="flex flex-wrap gap-2">
                <span class="text-gray-500">Chargement des OPM IDs...</span>
            </div>
        </div>

        <!-- Le conteneur de la grille sera rempli par JavaScript -->
        <div id="sfia-grid" class="categories-grid"></div>

        <!-- Bouton pour terminer l'étape -->
        <div class="flex justify-center my-8">
            <button id="complete-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">
                Terminer l'étape et ajouter un nouveau poste
            </button>
        </div>
    </div>

    <!-- Fenêtre Modale de Confirmation -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="modal-backdrop" class="absolute inset-0 bg-black opacity-50"></div>
        <div id="modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 m-4 max-w-sm w-full z-10 scale-95 opacity-0">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Confirmation requise</h3>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">Voulez-vous vraiment terminer cette étape et démarrer un nouveau poste ?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">Annuler</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Ajouter la fenêtre modale d'information avant la fermeture du body -->
    <!-- Fenêtre Modale d'Information sur les Niveaux SFIA -->
    <div id="info-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 m-4 max-w-4xl w-full z-10 scale-95 opacity-100 relative overflow-auto max-h-[90vh]">
            <button id="close-info-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white text-center">SFIA 9 Levels of Responsibility</h2>
            
            <div class="bg-blue-600 text-white p-6 rounded-md mb-6">
                <h3 class="text-xl font-bold mb-3 text-center">SFIA 9 Levels of Responsibility (Essence of the levels)</h3>
                <p class="mb-3 text-lg">The <em>essence</em> of the level provides a short summary to help characterise the level.</p>
                <p class="mb-3 text-lg">Successive levels show increasing responsibility, accountability and impact.</p>
                <p class="text-center"><a href="https://help.sfia.nz/hc/en-nz/articles/39048803381273-Levels-of-Responsibility" target="_blank" class="text-white underline hover:text-blue-100">https://help.sfia.nz/hc/en-nz/articles/39048803381273-Levels-of-Responsibility</a></p>
            </div>
            
            <div class="space-y-6">
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 1 - Follow</h4>
                    <p class="mt-2 text-base">Performs routine tasks under close supervision, follows instructions, and requires guidance to complete their work. Learns and applies basic skills and knowledge.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 2 - Assist</h4>
                    <p class="mt-2 text-base">Provides assistance to others, works under routine supervision, and uses their discretion to address routine problems. Actively learns through training and on-the-job experiences.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 3 - Apply</h4>
                    <p class="mt-2 text-base">Performs varied tasks, sometimes complex and non-routine, using standard methods and procedures. Works under general direction, exercises discretion, and manages own work within deadlines. Proactively enhances skills and impact in the workplace.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 4 - Enable</h4>
                    <p class="mt-2 text-base">Performs diverse complex activities, supports and guides others, delegates tasks when appropriate, works autonomously under general direction, and contributes expertise to deliver team objectives.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 5 - Ensure</h4>
                    <p class="mt-2 text-base">Provides authoritative guidance in their field and works under broad direction. Accountable for delivering significant work outcomes, from analysis through execution to evaluation.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 6 - Initiate, influence</h4>
                    <p class="mt-2 text-base">Has significant organisational influence, makes high-level decisions, shapes policies, demonstrates leadership, promotes organisational collaboration, and accepts accountability in key areas.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 7 - Set strategy, inspire, mobilise</h4>
                    <p class="mt-2 text-base">Sets strategy at the highest levels of the organisation, makes decisions with far-reaching implications, and assumes accountability for overall success.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Ajouter la gestion du bouton d'information et de la fenêtre modale
        document.addEventListener('DOMContentLoaded', function() {
            const infoButton = document.getElementById('info-button');
            const infoModal = document.getElementById('info-modal');
            const closeInfoModal = document.getElementById('close-info-modal');
            
            if (infoButton && infoModal && closeInfoModal) {
                infoButton.addEventListener('click', function() {
                    infoModal.classList.remove('hidden');
                });
                
                closeInfoModal.addEventListener('click', function() {
                    infoModal.classList.add('hidden');
                });
                
                // Fermer la modale en cliquant à l'extérieur
                infoModal.addEventListener('click', function(e) {
                    if (e.target === infoModal) {
                        infoModal.classList.add('hidden');
                    }
                });
                
                // Fermer la modale avec la touche Echap
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && !infoModal.classList.contains('hidden')) {
                        infoModal.classList.add('hidden');
                    }
                });
            }
        });
    </script>

    <script>
    // --- STRUCTURE DE DONNÉES SFIA ---
    const sfiaData = [
        {
            name: "Strategy and architecture",
            cssClass: "strategy-architecture",
            subcategories: [
                {
                    name: "Strategy and planning",
                    skills: [
                        { name: "Strategic planning", code: "ITSP", levels: [4, 5, 6, 7] },
                        { name: "Information systems coordination", code: "ISCO", levels: [5, 6, 7] },
                        { name: "Information management", code: "IRMG", levels: [3, 4, 5, 6, 7] },
                        { name: "Enterprise and business architecture", code: "STPL", levels: [5, 6, 7] },
                        { name: "Solution architecture", code: "ARCH", levels: [4, 5, 6, 7] },
                        { name: "Innovation management", code: "INOV", levels: [5, 6, 7] },
                        { name: "Emerging technology monitoring", code: "EMRG", levels: [4, 5, 6] },
                        { name: "Formal research", code: "RSCH", levels: [2, 3, 4, 5, 6] },
                        { name: "Sustainability", code: "SUST", levels: [4, 5, 6] }
                    ]
                },
                {
                    name: "Financial and value management",
                    skills: [
                        { name: "Financial management", code: "FMIT", levels: [4, 5, 6] },
                        { name: "Investment appraisal", code: "INVA", levels: [4, 5, 6] },
                        { name: "Benefits management", code: "BENM", levels: [3, 4, 5, 6] },
                        { name: "Budgeting and forecasting", code: "BUDF", levels: [2, 3, 4, 5, 6] },
                        { name: "Financial analysis", code: "FIAN", levels: [2, 3, 4, 5, 6] },
                        { name: "Cost management", code: "COMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Demand management", code: "DEMM", levels: [4, 5, 6] },
                        { name: "Measurement", code: "MEAS", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Security and privacy",
                    skills: [
                        { name: "Information security", code: "SCTY", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Information assurance", code: "INAS", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Information and data compliance", code: "PEDP", levels: [4, 5, 6] },
                        { name: "Vulnerability research", code: "VURE", levels: [2, 3, 4, 5, 6] },
                        { name: "Threat intelligence", code: "THIN", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Governance, risk and compliance",
                    skills: [
                        { name: "Governance", code: "GOVN", levels: [5, 6, 7] },
                        { name: "Risk management", code: "BURM", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Artificial intelligence (AI) and data ethics", code: "AIDE", levels: [3, 4, 5, 6] },
                        { name: "Audit", code: "AUDT", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Quality management", code: "QUMG", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Quality assurance", code: "QUAS", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Advice and guidance",
                    skills: [
                        { name: "Consultancy", code: "CNSL", levels: [4, 5, 6, 7] },
                        { name: "Specialist advice", code: "TECH", levels: [4, 5, 6] },
                        { name: "Methods and tools", code: "METL", levels: [2, 3, 4, 5, 6] }
                    ]
                }
            ]
        },
        {
            name: "Development and implementation",
            cssClass: "dev-implementation",
            subcategories: [
                {
                    name: "Systems development",
                    skills: [
                        { name: "Product management", code: "PROD", levels: [3, 4, 5, 6] },
                        { name: "Systems development management", code: "DLMG", levels: [4, 5, 6, 7] },
                        { name: "Systems and software lifecycle engineering", code: "SLEN", levels: [3, 4, 5, 6, 7] },
                        { name: "Systems design", code: "DESN", levels: [2, 3, 4, 5, 6] },
                        { name: "Software design", code: "SWDN", levels: [2, 3, 4, 5, 6] },
                        { name: "Network design", code: "NTDS", levels: [2, 3, 4, 5, 6] },
                        { name: "Infrastructure design", code: "IFDN", levels: [2, 3, 4, 5, 6] },
                        { name: "Hardware design", code: "HWDE", levels: [2, 3, 4, 5, 6] },
                        { name: "Programming/software development", code: "PROG", levels: [2, 3, 4, 5, 6] },
                        { name: "Systems integration and build", code: "SINT", levels: [2, 3, 4, 5, 6] },
                        { name: "Functional testing", code: "TEST", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Non-functional testing", code: "NFTS", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Process testing", code: "PRTS", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Software configuration", code: "PORT", levels: [2, 3, 4, 5, 6] },
                        { name: "Real-time/embedded systems development", code: "RESD", levels: [2, 3, 4, 5, 6] },
                        { name: "Safety engineering", code: "SFEN", levels: [2, 3, 4, 5, 6] },
                        { name: "Safety assessment", code: "SFAS", levels: [4, 5, 6] },
                        { name: "Radio frequency engineering", code: "RFEN", levels: [2, 3, 4, 5, 6] },
                        { name: "Animation development", code: "ADEV", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Data and analytics",
                    skills: [
                        { name: "Data management", code: "DATM", levels: [2, 3, 4, 5, 6] },
                        { name: "Data modelling and design", code: "DTAN", levels: [2, 3, 4, 5] },
                        { name: "Database design", code: "DBDS", levels: [2, 3, 4, 5] },
                        { name: "Data analytics", code: "DNAN", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Data science", code: "DATS", levels: [2, 3, 4, 5, 6] },
                        { name: "Machine learning", code: "MLNG", levels: [2, 3, 4, 5, 6] },
                        { name: "Business intelligence", code: "BINT", levels: [2, 3, 4, 5] },
                        { name: "Data engineering", code: "DENG", levels: [2, 3, 4, 5, 6] },
                        { name: "Data visualisation", code: "VISL", levels: [2, 3, 4, 5] }
                    ]
                },
                {
                    name: "User centred design",
                    skills: [
                        { name: "User research", code: "URCH", levels: [3, 4, 5, 6] },
                        { name: "Customer experience", code: "CEXP", levels: [2, 3, 4, 5, 6] },
                        { name: "Accessibility and inclusion", code: "ACIN", levels: [2, 3, 4, 5, 6] },
                        { name: "User experience analysis", code: "UNAN", levels: [2, 3, 4, 5] },
                        { name: "User experience design", code: "HCEV", levels: [2, 3, 4, 5, 6] },
                        { name: "User experience evaluation", code: "USEV", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Content management",
                    skills: [
                        { name: "Content design and authoring", code: "INCA", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Content publishing", code: "ICPM", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Knowledge management", code: "KNOW", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Graphic design", code: "GRON", levels: [1, 2, 3, 4, 5] }
                    ]
                },
                {
                    name: "Computational science",
                    skills: [
                        { name: "Scientific modelling", code: "SCMO", levels: [4, 5, 6, 7] },
                        { name: "Numerical analysis", code: "NUAN", levels: [4, 5, 6, 7] },
                        { name: "High-performance computing", code: "HPCC", levels: [4, 5, 6, 7] }
                    ]
                }
            ]
        },
        {
            name: "Delivery and operation",
            cssClass: "delivery-operation",
            subcategories: [
                 {
                    name: "Technology management",
                    skills: [
                        { name: "Technology service management", code: "ITMG", levels: [5, 6, 7] },
                        { name: "Application support", code: "ASUP", levels: [2, 3, 4, 5] },
                        { name: "Infrastructure operations", code: "ITOP", levels: [1, 2, 3, 4, 5] },
                        { name: "System software administration", code: "SYSP", levels: [1, 2, 3, 4, 5] },
                        { name: "Network support", code: "NTAS", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Systems installation and removal", code: "HSIN", levels: [1, 2, 3, 4] },
                        { name: "Configuration management", code: "CFMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Release management", code: "RELM", levels: [2, 3, 4, 5, 6] },
                        { name: "Deployment", code: "DEPL", levels: [2, 3, 4, 5, 6] },
                        { name: "Storage management", code: "STMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Facilities management", code: "DCMA", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Service management",
                    skills: [
                        { name: "Service level management", code: "SLMO", levels: [3, 4, 5, 6, 7] },
                        { name: "Service catalogue management", code: "SCMG", levels: [2, 3, 4, 5] },
                        { name: "Availability management", code: "AVMT", levels: [3, 4, 5, 6] },
                        { name: "Continuity management", code: "COPL", levels: [2, 3, 4, 5, 6] },
                        { name: "Capacity management", code: "CPMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Incident management", code: "USUP", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Problem management", code: "PBMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Change control", code: "CHMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Asset management", code: "ASMG", levels: [2, 3, 4, 5] },
                        { name: "Service acceptance", code: "SEAC", levels: [3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Security services",
                    skills: [
                        { name: "Security operations", code: "SCAD", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Identity and access management", code: "IAMT", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Vulnerability assessment", code: "VUAS", levels: [2, 3, 4, 5] },
                        { name: "Digital forensics", code: "DGFS", levels: [2, 3, 4, 5, 6] },
                        { name: "Cybercrime investigation", code: "CRIM", levels: [2, 3, 4, 5, 6] },
                        { name: "Offensive cyber operations", code: "OCOP", levels: [2, 3, 4, 5, 6] },
                        { name: "Penetration testing", code: "PENT", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Data and records operations",
                    skills: [
                        { name: "Records management", code: "RMGT", levels: [1, 2, 3, 4, 5] },
                        { name: "Analytical classification and coding", code: "ANCC", levels: [2, 3, 4, 5, 6] },
                        { name: "Database administration", code: "DBAD", levels: [2, 3, 4, 5] }
                    ]
                }
            ]
        },
        {
            name: "Change and transformation",
            cssClass: "change-transformation",
            subcategories: [
                {
                    name: "Change implementation",
                    skills: [
                        { name: "Portfolio management", code: "POMG", levels: [5, 6, 7] },
                        { name: "Programme management", code: "PGMG", levels: [6, 7] },
                        { name: "Project management", code: "PRMG", levels: [4, 5, 6, 7] },
                        { name: "Portfolio, programme and project support", code: "PROF", levels: [2, 3, 4, 5, 6] },
                        { name: "Delivery management", code: "DLMG", levels: [3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Change analysis",
                    skills: [
                        { name: "Business situation analysis", code: "BUSA", levels: [2, 3, 4, 5, 6] },
                        { name: "Feasibility assessment", code: "FEAS", levels: [2, 3, 4, 5, 6] },
                        { name: "Requirements definition and management", code: "REQM", levels: [2, 3, 4, 5, 6] },
                        { name: "Business modelling", code: "BSMO", levels: [2, 3, 4, 5, 6] },
                        { name: "Business process testing", code: "BPTS", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Change planning",
                    skills: [
                        { name: "Business process improvement", code: "BPRE", levels: [1, 2, 3, 4, 5, 6, 7] },
                        { name: "Organisational capability development", code: "OCDV", levels: [5, 6, 7] },
                        { name: "Job analysis and design", code: "JADN", levels: [3, 4, 5] },
                        { name: "Organisation design and implementation", code: "ORDI", levels: [3, 4, 5, 6, 7] },
                        { name: "Organisational change management", code: "CIPM", levels: [2, 3, 4, 5, 6] },
                        { name: "Organisational change enablement", code: "OCEN", levels: [4, 5, 6] }
                    ]
                }
            ]
        },
        {
            name: "People and skills",
            cssClass: "people-skills",
            subcategories: [
                {
                    name: "People management",
                    skills: [
                        { name: "Performance management", code: "PEMT", levels: [4, 5, 6] },
                        { name: "Employee experience", code: "EEXP", levels: [4, 5, 6] },
                        { name: "Organisational facilitation", code: "OFCL", levels: [4, 5, 6] },
                        { name: "Professional development", code: "PDSV", levels: [4, 5, 6] },
                        { name: "Workforce planning", code: "WFPL", levels: [4, 5, 6] },
                        { name: "Resourcing", code: "RESC", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Skills management",
                    skills: [
                        { name: "Learning and development management", code: "ETMG", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Learning design and development", code: "TMCR", levels: [2, 3, 4, 5] },
                        { name: "Learning delivery", code: "ETDL", levels: [2, 3, 4, 5] },
                        { name: "Competency assessment", code: "LEDA", levels: [2, 3, 4, 5, 6] },
                        { name: "Certification scheme operation", code: "CSOP", levels: [2, 3, 4, 5, 6] },
                        { name: "Teaching", code: "TEAC", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Subject formation", code: "SUBF", levels: [4, 5, 6, 7] }
                    ]
                }
            ]
        },
        {
            name: "Relationships and engagement",
            cssClass: "relationships-engagement",
            subcategories: [
                {
                    name: "Stakeholder management",
                    skills: [
                        { name: "Sourcing", code: "SORC", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Supplier management", code: "SUPP", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Contract management", code: "ITCM", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Stakeholder relationship management", code: "RLMT", levels: [4, 5, 6, 7] },
                        { name: "Customer service support", code: "CSMG", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Business administration", code: "ADMN", levels: [1, 2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Sales and bid management",
                    skills: [
                        { name: "Bid/proposal management", code: "BIDM", levels: [3, 4, 5, 6] },
                        { name: "Selling", code: "SALE", levels: [3, 4, 5, 6] },
                        { name: "Sales support", code: "SSUP", levels: [1, 2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Marketing",
                    skills: [
                        { name: "Marketing management", code: "MKTG", levels: [4, 5, 6, 7] },
                        { name: "Market research", code: "MRCH", levels: [3, 4, 5, 6] },
                        { name: "Brand management", code: "BRMG", levels: [4, 5, 6] },
                        { name: "Customer engagement and loyalty", code: "CELO", levels: [3, 4, 5, 6] },
                        { name: "Marketing campaign management", code: "MKCM", levels: [3, 4, 5] },
                        { name: "Digital marketing", code: "DIGM", levels: [2, 3, 4, 5] }
                    ]
                }
            ]
        }
    ];

    document.addEventListener('DOMContentLoaded', function() {
        // Récupérer les OPM IDs de la sauvegarde
        async function loadOpmIdsFromSavedSelection() {
            try {
                // Afficher un indicateur de chargement
                const opmIdsList = document.getElementById('opm-ids-list');
                opmIdsList.innerHTML = `
                    <div class="flex items-center justify-center p-4">
                        <svg class="animate-spin h-6 w-6 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Chargement des données...</span>
                    </div>
                `;
                
                // Initialiser serverStorage
                if (typeof initServerStorage === 'function') {
                    initServerStorage();
                    console.log('serverStorage initialisé');
                } else {
                    console.warn('La fonction initServerStorage n\'est pas disponible');
                }
                
                // Vérifier si nous avons une sélection active pour l'étape 3
                const activateStep3 = localStorage.getItem('activateStep3');
                console.log('Activation étape 3:', activateStep3);
                
                // Essayer d'abord de récupérer les données depuis serverStorage
                let currentSelection;
                let dataSource = 'serverStorage';
                
                try {
                    console.log('Tentative de récupération depuis serverStorage...');
                    const serverData = await serverStorage.getItem('currentKsatSelection');
                    if (serverData) {
                        currentSelection = JSON.parse(serverData);
                        console.log('Sélection récupérée depuis serverStorage');
                    } else {
                        // Fallback à localStorage si serverStorage ne contient pas les données
                        console.log('Aucune donnée dans serverStorage, tentative avec localStorage');
                        currentSelection = JSON.parse(localStorage.getItem('currentKsatSelection') || '{}');
                        dataSource = 'localStorage';
                        console.log('Sélection récupérée depuis localStorage (fallback)');
                    }
                } catch (error) {
                    // En cas d'erreur avec serverStorage, utiliser localStorage
                    console.error('Erreur avec serverStorage, utilisation de localStorage:', error);
                    currentSelection = JSON.parse(localStorage.getItem('currentKsatSelection') || '{}');
                    dataSource = 'localStorage';
                }
                
                console.log('Source des données:', dataSource);
                console.log('Sélection courante:', currentSelection);
                
                if (activateStep3 === 'true' && currentSelection && currentSelection.roles) {
                    // Filtrer les rôles qui ont un opm_id
                    const rolesWithOpmIds = currentSelection.roles.filter(role => role.opmId);
                    
                    if (rolesWithOpmIds.length > 0) {
                        // Effacer le message de chargement
                        opmIdsList.innerHTML = '';
                        
                        // Mapping spécifique des OPM IDs aux couleurs des colonnes dans compare_ksat.html
                        // Ces couleurs sont basées sur les catégories des rôles
                        const opmIdColors = {
                            // IT (Cyberspace) - Bleu
                            '411': '2, 125, 184',
                            '421': '2, 125, 184',
                            '431': '2, 125, 184',
                            '441': '2, 125, 184',
                            '451': '2, 125, 184',
                            '632': '2, 125, 184',
                            '641': '2, 125, 184',
                            '651': '2, 125, 184',
                            '661': '2, 125, 184',
                            '671': '2, 125, 184',
                            
                            // Cybersecurity - Vert
                            '212': '94, 151, 49',
                            '462': '94, 151, 49',
                            '511': '94, 151, 49',
                            '521': '94, 151, 49',
                            '531': '94, 151, 49',
                            '541': '94, 151, 49',
                            '611': '94, 151, 49',
                            '612': '94, 151, 49',
                            '622': '94, 151, 49',
                            '631': '94, 151, 49',
                            '652': '94, 151, 49',
                            '722': '94, 151, 49',
                            '723': '94, 151, 49',
                            
                            // Cyberspace Effects - Orange
                            '121': '255, 145, 3',
                            '122': '255, 145, 3',
                            '131': '255, 145, 3',
                            '132': '255, 145, 3',
                            '133': '255, 145, 3',
                            '322': '255, 145, 3',
                            '332': '255, 145, 3',
                            '341': '255, 145, 3',
                            '442': '255, 145, 3',
                            '443': '255, 145, 3',
                            '463': '255, 145, 3',
                            
                            // Intelligence (Cyberspace) - Jaune
                            '111': '255, 204, 2',
                            '112': '255, 204, 2',
                            '141': '255, 204, 2',
                            '151': '255, 204, 2',
                            '311': '255, 204, 2',
                            '312': '255, 204, 2',
                            '331': '255, 204, 2',
                            '333': '255, 204, 2',
                            
                            // Cyberspace Enablers - Mauve
                            '211': '153, 86, 206',
                            '221': '153, 86, 206',
                            '711': '153, 86, 206',
                            '712': '153, 86, 206',
                            '731': '153, 86, 206',
                            '732': '153, 86, 206',
                            '751': '153, 86, 206',
                            '752': '153, 86, 206',
                            '801': '153, 86, 206',
                            '802': '153, 86, 206',
                            '803': '153, 86, 206',
                            '804': '153, 86, 206',
                            '805': '153, 86, 206',
                            '901': '153, 86, 206',
                            
                            // Software Engineering - Rouge
                            '461': '214, 39, 40',
                            '621': '214, 39, 40',
                            '625': '214, 39, 40',
                            '626': '214, 39, 40',
                            '627': '214, 39, 40',
                            '628': '214, 39, 40',
                            '673': '214, 39, 40',
                            '806': '214, 39, 40',
                            
                            // Data/AI - Turquoise
                            '422': '23, 190, 207',
                            '423': '23, 190, 207',
                            '424': '23, 190, 207',
                            '623': '23, 190, 207',
                            '624': '23, 190, 207',
                            '653': '23, 190, 207',
                            '672': '23, 190, 207',
                            '733': '23, 190, 207',
                            '753': '23, 190, 207',
                            '902': '23, 190, 207',
                            '903': '23, 190, 207'
                        };
                        
                        // Créer un mapping des OPM IDs aux rôles (prendre le premier rôle trouvé pour chaque OPM ID)
                        const opmIdToRole = {};
                        
                        // Associer les rôles aux OPM IDs (prendre le premier rôle trouvé pour chaque OPM ID)
                        rolesWithOpmIds.forEach(role => {
                            const opmId = role.opmId.toString().match(/\d+/)?.[0] || role.opmId;
                            
                            // Si nous n'avons pas encore de rôle pour cet OPM ID
                            if (!opmIdToRole[opmId]) {
                                opmIdToRole[opmId] = role;
                            }
                        });
                        
                        // Extraire uniquement les numéros d'OPM ID et éliminer les doublons
                        const uniqueOpmIds = [...new Set(
                            rolesWithOpmIds.map(role => {
                                // Extraire uniquement les chiffres de l'OPM ID
                                const numericMatch = role.opmId.toString().match(/\d+/);
                                return numericMatch ? numericMatch[0] : role.opmId;
                            })
                        )];
                        
                        // Trier les OPM IDs numériquement
                        uniqueOpmIds.sort((a, b) => parseInt(a) - parseInt(b));
                        
                        // Ajouter une information sur la source des données
                        const dataSourceInfo = document.createElement('div');
                        dataSourceInfo.className = 'text-sm text-gray-500 mb-2';
                        dataSourceInfo.innerHTML = `<span class="font-medium">Source des données:</span> ${dataSource} | <span class="font-medium">Nombre de rôles:</span> ${rolesWithOpmIds.length}`;
                        opmIdsList.appendChild(dataSourceInfo);
                        
                        // Ajouter un message d'aide pour expliquer la fonction des cases à cocher
                        const helpTips = document.createElement('div');
                        helpTips.className = 'flex flex-col gap-2 p-3 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-100 mb-4 shadow-sm';
                        helpTips.innerHTML = `
                            <div class="flex gap-4">
                                <div class="flex-1 border-r border-blue-200 pr-4">
                                    <div class="flex items-center mb-1">
                                        <div class="w-4 h-4 border border-gray-300 rounded mr-2 bg-white"></div>
                                        <span class="font-semibold text-blue-700">Case de surbrillance</span>
                                    </div>
                                    <p class="text-sm text-gray-600">Active ou désactive la mise en surbrillance des compétences associées à cet OPM ID dans les tableaux ci-dessous.</p>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center mb-1">
                                        <div class="w-4 h-4 border border-gray-300 rounded mr-2 bg-white"></div>
                                        <span class="font-semibold text-purple-700">Case de filtrage</span>
                                    </div>
                                    <p class="text-sm text-gray-600">Filtre les tableaux pour n'afficher que les compétences associées aux OPM IDs sélectionnés. <span class="text-purple-800 font-medium">Active automatiquement la surbrillance</span> si nécessaire.</p>
                                </div>
                            </div>
                            <div class="border-t border-blue-200 pt-2 mt-1">
                                <p class="text-sm text-gray-600">
                                    <span class="font-semibold text-gray-700">Sélection rapide :</span> En haut du tableau, utilisez les cases <span class="text-blue-700 font-medium">Tout sélectionner</span> pour activer/désactiver rapidement toutes les surbrillances ou tous les filtres. La case à gauche permet de tout sélectionner/désélectionner d'un seul clic.
                                </p>
                            </div>
                        `;
                        opmIdsList.appendChild(helpTips);
                        
                        // Créer un tableau pour afficher les OPM IDs avec leurs graduations
                        const table = document.createElement('table');
                        table.className = 'w-full border-collapse mt-4 rounded-lg overflow-hidden shadow-sm';
                        table.style.borderRadius = '8px';
                        table.style.overflow = 'hidden';
                        table.style.border = '1px solid rgba(59, 130, 246, 0.2)';
                        
                        // Créer le corps du tableau
                        const tbody = document.createElement('tbody');
                        tbody.className = 'bg-white divide-y divide-gray-200';
                        
                        // Ajouter une ligne d'en-tête avec les cases à cocher "Tout sélectionner"
                        const headerRow = document.createElement('tr');
                        headerRow.className = 'border-b border-blue-100'; // Suppression du fond gris, juste une bordure subtile
                        
                        // Cellule pour la case à cocher générale
                        const generalCell = document.createElement('td');
                        generalCell.className = 'px-2 py-2 text-center border-r border-blue-100';
                        generalCell.style.width = '40px';
                        
                        // Case à cocher générale
                        const generalCheckbox = document.createElement('input');
                        generalCheckbox.type = 'checkbox';
                        generalCheckbox.className = 'select-all-general';
                        generalCheckbox.checked = true; // Par défaut, tout est coché
                        generalCheckbox.title = "Tout sélectionner/désélectionner";
                        generalCheckbox.style.width = '18px';
                        generalCheckbox.style.height = '18px';
                        generalCheckbox.style.cursor = 'pointer';
                        
                        // Ajouter la case à cocher générale à la cellule
                        generalCell.appendChild(generalCheckbox);
                        headerRow.appendChild(generalCell);
                        
                        // Cellule pour le libellé "OPM ID"
                        const opmHeaderCell = document.createElement('td');
                        opmHeaderCell.className = 'px-2 py-2 text-left border-r border-blue-100';
                        opmHeaderCell.style.width = '80px';
                        
                        // Texte discret pour indiquer "Tout sélectionner" 
                        const selectAllText = document.createElement('span');
                        selectAllText.className = 'text-xs text-gray-500';
                        selectAllText.textContent = 'Tout sélectionner:';
                        opmHeaderCell.appendChild(selectAllText);
                        headerRow.appendChild(opmHeaderCell);
                        
                        // Cellule pour le titre
                        const titleHeaderCell = document.createElement('td');
                        titleHeaderCell.className = 'px-2 py-2 text-left border-r border-blue-100';
                        titleHeaderCell.style.width = '120px';
                        titleHeaderCell.textContent = 'Titre';
                        headerRow.appendChild(titleHeaderCell);
                        
                        // Cellule pour les cases "Tout sélectionner" des colonnes
                        const selectAllCell = document.createElement('td');
                        selectAllCell.className = 'px-2 py-2 border-r border-blue-100';
                        selectAllCell.style.width = '150px';
                        
                        // Conteneur pour les deux cases à cocher "Tout sélectionner"
                        const selectAllContainer = document.createElement('div');
                        selectAllContainer.className = 'flex items-center space-x-6';
                        
                        // Conteneur pour la case de surbrillance
                        const highlightContainer = document.createElement('div');
                        highlightContainer.className = 'flex items-center';
                        
                        // Case à cocher "Tout sélectionner" pour la surbrillance
                        const selectAllHighlights = document.createElement('input');
                        selectAllHighlights.type = 'checkbox';
                        selectAllHighlights.className = 'select-all-highlights';
                        selectAllHighlights.checked = true; // Par défaut, tout est coché
                        selectAllHighlights.title = "Sélectionner toutes les surbrillances";
                        selectAllHighlights.style.width = '18px';
                        selectAllHighlights.style.height = '18px';
                        selectAllHighlights.style.cursor = 'pointer';
                        
                        // Label pour la case surbrillance
                        const highlightLabel = document.createElement('span');
                        highlightLabel.className = 'ml-1 text-xs text-blue-600';
                        highlightLabel.textContent = 'Surbrillance';
                        
                        // Ajouter à son conteneur
                        highlightContainer.appendChild(selectAllHighlights);
                        highlightContainer.appendChild(highlightLabel);
                        
                        // Conteneur pour la case de filtrage
                        const filterContainer = document.createElement('div');
                        filterContainer.className = 'flex items-center';
                        
                        // Case à cocher "Tout sélectionner" pour le filtrage
                        const selectAllFilters = document.createElement('input');
                        selectAllFilters.type = 'checkbox';
                        selectAllFilters.className = 'select-all-filters';
                        selectAllFilters.title = "Sélectionner tous les filtres";
                        selectAllFilters.style.width = '18px';
                        selectAllFilters.style.height = '18px';
                        selectAllFilters.style.cursor = 'pointer';
                        
                        // Label pour la case filtrage
                        const filterLabel = document.createElement('span');
                        filterLabel.className = 'ml-1 text-xs text-purple-600';
                        filterLabel.textContent = 'Filtrage';
                        
                        // Ajouter à son conteneur
                        filterContainer.appendChild(selectAllFilters);
                        filterContainer.appendChild(filterLabel);
                        
                        // Ajouter les cases à cocher au conteneur principal
                        selectAllContainer.appendChild(highlightContainer);
                        selectAllContainer.appendChild(filterContainer);
                        selectAllCell.appendChild(selectAllContainer);
                        headerRow.appendChild(selectAllCell);
                        
                        // Cellule d'en-tête pour les compétences associées
                        const competencesHeaderCell = document.createElement('td');
                        competencesHeaderCell.className = 'px-2 py-2 text-left';
                        competencesHeaderCell.textContent = 'Compétences associées';
                        headerRow.appendChild(competencesHeaderCell);
                        
                        // Ajouter la ligne d'en-tête au tableau
                        tbody.appendChild(headerRow);
                        
                        // Stocker l'état de surbrillance pour chaque OPM ID
                        const opmHighlightState = {};
                        uniqueOpmIds.forEach(id => opmHighlightState[id] = false);
                        
                        // Ajouter une ligne pour chaque OPM ID
                        uniqueOpmIds.forEach(opmId => {
                            const role = opmIdToRole[opmId];
                            
                            // Utiliser la couleur spécifique de compare_ksat.html si disponible
                            // Sinon, utiliser la couleur du rôle ou une couleur par défaut
                            const color = opmIdColors[opmId] || 
                                         (role && role.category_color ? role.category_color : '59, 130, 246');
                            
                            // Créer une ligne pour cet OPM ID
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors';
                            row.dataset.opmId = opmId;
                            
                            // Ajouter une bordure inférieure sauf pour la dernière ligne
                            row.style.borderBottom = '1px solid rgba(59, 130, 246, 0.1)';
                            
                            // Lors de la survole, mettre en évidence les cases à cocher
                            row.addEventListener('mouseenter', function() {
                                const checkboxes = this.querySelectorAll('input[type="checkbox"]');
                                checkboxes.forEach(cb => {
                                    cb.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.2)';
                                });
                            });
                            
                            row.addEventListener('mouseleave', function() {
                                const checkboxes = this.querySelectorAll('input[type="checkbox"]');
                                checkboxes.forEach(cb => {
                                    cb.style.boxShadow = '';
                                });
                            });
                            
                            // Ajouter une cellule pour la case à cocher
                            const checkboxCell = document.createElement('td');
                            checkboxCell.className = 'px-2 py-1 text-center border-r border-blue-100';
                            checkboxCell.style.width = '40px';
                            
                            // Conteneur pour les deux cases à cocher
                            const checkboxContainer = document.createElement('div');
                            checkboxContainer.className = 'flex items-center justify-between';
                            
                            // Créer la première case à cocher (surbrillance)
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = 'opm-checkbox';
                            checkbox.dataset.opmId = opmId;
                            checkbox.setAttribute('id', `checkbox-opm-${opmId}`);
                            checkbox.style.cursor = 'pointer';
                            checkbox.style.width = '16px';
                            checkbox.style.height = '16px';
                            checkbox.checked = true; // Activer par défaut
                            checkbox.title = "Activer/désactiver la surbrillance";
                            
                            // Créer la deuxième case à cocher (filtre)
                            const filterCheckbox = document.createElement('input');
                            filterCheckbox.type = 'checkbox';
                            filterCheckbox.className = 'opm-filter-checkbox';
                            filterCheckbox.dataset.opmId = opmId;
                            filterCheckbox.setAttribute('id', `filter-opm-${opmId}`);
                            filterCheckbox.style.cursor = 'pointer';
                            filterCheckbox.style.width = '16px';
                            filterCheckbox.style.height = '16px';
                            filterCheckbox.style.marginLeft = '8px';
                            filterCheckbox.title = "Filtrer les lignes pour n'afficher que celles-ci";
                            
                            // Ajouter un gestionnaire d'événement pour la case à cocher de surbrillance
                            checkbox.addEventListener('change', function() {
                                console.log(`Case à cocher changée pour OPM ID ${opmId}: ${this.checked ? 'cochée' : 'décochée'}`);
                                
                                // Sauvegarder l'état dans localStorage
                                try {
                                    const checkboxStates = JSON.parse(localStorage.getItem('opmCheckboxStates') || '{}');
                                    checkboxStates[opmId] = this.checked;
                                    localStorage.setItem('opmCheckboxStates', JSON.stringify(checkboxStates));
                                    console.log(`État de la case à cocher pour OPM ID ${opmId} sauvegardé: ${this.checked}`);
                                } catch (e) {
                                    console.error('Erreur lors de la sauvegarde de l\'état de la case à cocher:', e);
                                }
                                
                                if (window.updateOpmHighlights) {
                                    window.updateOpmHighlights(opmId, this.checked);
                                    
                                    // Mettre à jour l'état dans la configuration
                                    const config = window.specialOpmConfigs.find(cfg => cfg.opmId === opmId);
                                    if (config) {
                                        config.isPresent = this.checked;
                                    }
                                    
                                    // SOLUTION AU PROBLÈME : Réappliquer la surbrillance après un court délai
                                    if (this.checked) {
                                        setTimeout(() => {
                                            if (this.checked && config && config.isPresent) {
                                                console.log(`Réapplication de la surbrillance pour OPM ID ${opmId}`);
                                                window.updateOpmHighlights(opmId, true);
                                            }
                                        }, 100);
                                    }
                                } else {
                                    console.error('La fonction updateOpmHighlights n\'est pas disponible');
                                }
                            });
                            
                            // Ajouter un gestionnaire d'événement pour la case à cocher de filtrage
                            filterCheckbox.addEventListener('change', function() {
                                console.log(`Case de filtre changée pour OPM ID ${opmId}: ${this.checked ? 'cochée' : 'décochée'}`);
                                
                                // Si on active le filtre, s'assurer que la surbrillance est également activée
                                if (this.checked && !checkbox.checked) {
                                    console.log(`Activation automatique de la surbrillance pour OPM ID ${opmId}`);
                                    checkbox.checked = true;
                                    
                                    // Déclencher manuellement l'événement de changement sur la case de surbrillance
                                    const event = new Event('change');
                                    checkbox.dispatchEvent(event);
                                }
                                
                                // Sauvegarder l'état dans localStorage
                                try {
                                    const filterStates = JSON.parse(localStorage.getItem('opmFilterStates') || '{}');
                                    filterStates[opmId] = this.checked;
                                    localStorage.setItem('opmFilterStates', JSON.stringify(filterStates));
                                } catch (e) {
                                    console.error('Erreur lors de la sauvegarde de l\'état du filtre:', e);
                                }
                                
                                // Appliquer le filtrage
                                applySkillRowsFiltering();
                            });
                            
                            // Ajouter les deux cases à cocher au conteneur
                            checkboxContainer.appendChild(checkbox);
                            checkboxContainer.appendChild(filterCheckbox);
                            checkboxCell.appendChild(checkboxContainer);
                            row.appendChild(checkboxCell);
                            
                            // Cellule pour l'OPM ID avec sa couleur
                            const opmIdCell = document.createElement('td');
                            opmIdCell.className = 'px-2 py-1 border-r border-blue-100';
                            opmIdCell.style.width = '80px';
                            
                            // Afficher l'OPM ID avec sa couleur
                            const opmIdText = document.createElement('span');
                            opmIdText.className = 'font-semibold';
                            opmIdText.style.color = `rgba(${color}, 1)`;
                            opmIdText.textContent = opmId;
                            opmIdCell.appendChild(opmIdText);
                            row.appendChild(opmIdCell);
                            
                            // Cellule pour le titre du rôle
                            const titleCell = document.createElement('td');
                            titleCell.className = 'px-2 py-1 border-r border-blue-100';
                            titleCell.style.width = '120px';
                            
                            // Afficher le titre du rôle si disponible
                            if (role && role.title) {
                                titleCell.textContent = role.title;
                            } else {
                                titleCell.textContent = getOpmIdTitle(opmId);
                            }
                            row.appendChild(titleCell);
                            
                            // Cellule contenant les niveaux de graduation (1-7)
                            const graduationCell = document.createElement('td');
                            graduationCell.className = 'px-2 py-1 border-r border-blue-100';
                            graduationCell.style.width = '150px';
                            
                            // Créer un conteneur flex pour les niveaux
                            const levelContainer = document.createElement('div');
                            levelContainer.className = 'flex flex-row items-center space-x-1';
                            
                            // Ajouter les 7 niveaux de graduation
                            for (let i = 1; i <= 7; i++) {
                                // Créer un conteneur pour chaque niveau
                                const levelBox = document.createElement('div');
                                levelBox.className = 'flex flex-col items-center justify-center';
                                
                                // Créer le cercle de niveau
                                const circle = document.createElement('div');
                                circle.className = 'w-5 h-5 rounded-full flex items-center justify-center';
                                circle.style.backgroundColor = `rgba(${color}, 0.15)`;
                                circle.style.border = `1px solid rgba(${color}, 0.5)`;
                                
                                // Ajouter le numéro dans le cercle
                                const levelNumber = document.createElement('span');
                                levelNumber.className = 'text-xs font-medium';
                                levelNumber.style.color = `rgba(${color}, 1)`;
                                levelNumber.textContent = i;
                                circle.appendChild(levelNumber);
                                
                                levelBox.appendChild(circle);
                                levelContainer.appendChild(levelBox);
                            }
                            
                            graduationCell.appendChild(levelContainer);
                            row.appendChild(graduationCell);
                            
                            // Cellule pour les compétences associées
                            const competencesCell = document.createElement('td');
                            competencesCell.className = 'px-2 py-1 competences-cell';
                            competencesCell.dataset.opmId = opmId;
                            row.appendChild(competencesCell);
                            
                            tbody.appendChild(row);
                        });
                        
                        table.appendChild(tbody);
                        opmIdsList.appendChild(table);
                        
                        // Gérer les cases "Tout sélectionner"
                        const selectAllHighlightsCheckbox = document.querySelector('.select-all-highlights');
                        const selectAllFiltersCheckbox = document.querySelector('.select-all-filters');
                        const selectAllGeneralCheckbox = document.querySelector('.select-all-general');
                        
                        if (selectAllHighlightsCheckbox && selectAllFiltersCheckbox && selectAllGeneralCheckbox) {
                            // Fonction pour mettre à jour l'état des cases à cocher individuelles
                            function updateCheckboxes(checkboxClass, checked) {
                                document.querySelectorAll(checkboxClass).forEach(checkbox => {
                                    if (checkbox.checked !== checked) {
                                        checkbox.checked = checked;
                                        // Déclencher manuellement l'événement change
                                        const event = new Event('change');
                                        checkbox.dispatchEvent(event);
                                    }
                                });
                            }
                            
                            // Fonction pour vérifier si tous les éléments d'une classe sont cochés ou non
                            function areAllChecked(checkboxClass) {
                                const checkboxes = document.querySelectorAll(checkboxClass);
                                let allChecked = true;
                                checkboxes.forEach(checkbox => {
                                    if (!checkbox.checked) {
                                        allChecked = false;
                                    }
                                });
                                return allChecked;
                            }
                            
                            // Gestionnaire pour la case "Tout sélectionner" des surbrillances
                            selectAllHighlightsCheckbox.addEventListener('change', function() {
                                updateCheckboxes('.opm-checkbox', this.checked);
                                // Mettre à jour la case générale
                                selectAllGeneralCheckbox.checked = this.checked && selectAllFiltersCheckbox.checked;
                            });
                            
                            // Gestionnaire pour la case "Tout sélectionner" des filtres
                            selectAllFiltersCheckbox.addEventListener('change', function() {
                                updateCheckboxes('.opm-filter-checkbox', this.checked);
                                // Mettre à jour la case générale
                                selectAllGeneralCheckbox.checked = this.checked && selectAllHighlightsCheckbox.checked;
                            });
                            
                            // Gestionnaire pour la case "Tout sélectionner" générale
                            selectAllGeneralCheckbox.addEventListener('change', function() {
                                const checked = this.checked;
                                selectAllHighlightsCheckbox.checked = checked;
                                selectAllFiltersCheckbox.checked = checked;
                                updateCheckboxes('.opm-checkbox', checked);
                                updateCheckboxes('.opm-filter-checkbox', checked);
                            });
                            
                            // Mettre à jour les cases "Tout sélectionner" en fonction de l'état initial des cases individuelles
                            document.querySelectorAll('.opm-checkbox').forEach(checkbox => {
                                checkbox.addEventListener('change', function() {
                                    selectAllHighlightsCheckbox.checked = areAllChecked('.opm-checkbox');
                                    selectAllGeneralCheckbox.checked = selectAllHighlightsCheckbox.checked && selectAllFiltersCheckbox.checked;
                                });
                            });
                            
                            document.querySelectorAll('.opm-filter-checkbox').forEach(checkbox => {
                                checkbox.addEventListener('change', function() {
                                    selectAllFiltersCheckbox.checked = areAllChecked('.opm-filter-checkbox');
                                    selectAllGeneralCheckbox.checked = selectAllHighlightsCheckbox.checked && selectAllFiltersCheckbox.checked;
                                });
                            });
                        }
                        
                        // Restaurer l'état des cases à cocher depuis localStorage
                        setTimeout(() => {
                            try {
                                const checkboxStates = JSON.parse(localStorage.getItem('opmCheckboxStates') || '{}');
                                const filterStates = JSON.parse(localStorage.getItem('opmFilterStates') || '{}');
                                
                                document.querySelectorAll('.opm-checkbox').forEach(checkbox => {
                                    const opmId = checkbox.dataset.opmId;
                                    if (opmId in checkboxStates) {
                                        checkbox.checked = checkboxStates[opmId];
                                        console.log(`État de la case à cocher pour OPM ID ${opmId} restauré: ${checkbox.checked}`);
                                        
                                        // Appliquer la surbrillance si nécessaire
                                        if (checkbox.checked && window.updateOpmHighlights) {
                                            window.updateOpmHighlights(opmId, true);
                                        }
                                    }
                                });
                                
                                document.querySelectorAll('.opm-filter-checkbox').forEach(checkbox => {
                                    const opmId = checkbox.dataset.opmId;
                                    if (opmId in filterStates) {
                                        checkbox.checked = filterStates[opmId];
                                        console.log(`État du filtre pour OPM ID ${opmId} restauré: ${checkbox.checked}`);
                                    }
                                });
                                
                                // Mettre à jour les cases "Tout sélectionner"
                                if (selectAllHighlightsCheckbox) {
                                    selectAllHighlightsCheckbox.checked = areAllChecked('.opm-checkbox');
                                }
                                if (selectAllFiltersCheckbox) {
                                    selectAllFiltersCheckbox.checked = areAllChecked('.opm-filter-checkbox');
                                }
                                if (selectAllGeneralCheckbox && selectAllHighlightsCheckbox && selectAllFiltersCheckbox) {
                                    selectAllGeneralCheckbox.checked = selectAllHighlightsCheckbox.checked && selectAllFiltersCheckbox.checked;
                                }
                                
                                // Appliquer le filtrage initial
                                applySkillRowsFiltering();
                            } catch (e) {
                                console.error('Erreur lors de la restauration des états:', e);
                            }
                            
                            // Ajouter les badges de compétences dans la colonne dédiée
                            setTimeout(() => {
                                // Accéder à la variable globale specialOpmConfigs
                                const specialConfigs = window.specialOpmConfigs || [];
                                console.log("Configurations spéciales disponibles:", specialConfigs);
                                
                                                                        // Définir un mapping de couleurs pour chaque type de compétence
                                        const competenceColors = {
                                            // Catégorie: Strategy and architecture (Rouge)
                                            'ITSP': '#e11d48', 'ISCO': '#e11d48', 'IRMG': '#e11d48', 'STPL': '#e11d48',
                                            'ARCH': '#e11d48', 'INOV': '#e11d48', 'EMRG': '#e11d48', 'RSCH': '#e11d48',
                                            'SUST': '#e11d48', 'FMIT': '#e11d48', 'INVA': '#e11d48', 'BENM': '#e11d48',
                                            'BUDF': '#e11d48', 'FIAN': '#e11d48', 'COMG': '#e11d48', 'DEMM': '#e11d48',
                                            'MEAS': '#e11d48', 'SCTY': '#e11d48', 'INAS': '#e11d48', 'PEDP': '#e11d48',
                                            'VURE': '#e11d48', 'THIN': '#e11d48', 'GOVN': '#e11d48', 'BURM': '#e11d48',
                                            'AIDE': '#e11d48', 'AUDT': '#e11d48', 'QUMG': '#e11d48', 'QUAS': '#e11d48',
                                            'CNSL': '#e11d48', 'TECH': '#e11d48', 'METL': '#e11d48',
                                            
                                            // Catégorie: Development and implementation (Jaune)
                                            'PROD': '#facc15', 'DLMG': '#facc15', 'SLEN': '#facc15', 'DESN': '#facc15',
                                            'SWDN': '#facc15', 'NTDS': '#facc15', 'IFDN': '#facc15', 'HWDE': '#facc15',
                                            'PROG': '#facc15', 'SINT': '#facc15', 'TEST': '#facc15', 'NFTS': '#facc15',
                                            'PRTS': '#facc15', 'PORT': '#facc15', 'RESD': '#facc15', 'SFEN': '#facc15',
                                            'SFAS': '#facc15', 'RFEN': '#facc15', 'ADEV': '#facc15', 'DATM': '#facc15',
                                            'DTAN': '#facc15', 'DBDS': '#facc15', 'DNAN': '#facc15', 'DATS': '#facc15',
                                            'MLNG': '#facc15', 'BINT': '#facc15', 'DENG': '#facc15', 'VISL': '#facc15',
                                            'URCH': '#facc15', 'CEXP': '#facc15', 'ACIN': '#facc15', 'UNAN': '#facc15',
                                            'HCEV': '#facc15', 'USEV': '#facc15', 'INCA': '#facc15', 'ICPM': '#facc15',
                                            'KNOW': '#facc15', 'GRON': '#facc15', 'SCMO': '#facc15', 'NUAN': '#facc15',
                                            'HPCC': '#facc15',
                                            
                                            // Catégorie: Delivery and operation (Orange)
                                            'ITMG': '#ea580c', 'ASUP': '#ea580c', 'ITOP': '#ea580c', 'SYSP': '#ea580c',
                                            'NTAS': '#ea580c', 'HSIN': '#ea580c', 'CFMG': '#ea580c', 'RELM': '#ea580c',
                                            'DEPL': '#ea580c', 'STMG': '#ea580c', 'DCMA': '#ea580c', 'SLMO': '#ea580c',
                                            'SCMG': '#ea580c', 'AVMT': '#ea580c', 'COPL': '#ea580c', 'CPMG': '#ea580c',
                                            'USUP': '#ea580c', 'PBMG': '#ea580c', 'CHMG': '#ea580c', 'ASMG': '#ea580c',
                                            'SEAC': '#ea580c', 'SCAD': '#ea580c', 'IAMT': '#ea580c', 'VUAS': '#ea580c',
                                            'DGFS': '#ea580c', 'CRIM': '#ea580c', 'OCOP': '#ea580c', 'PENT': '#ea580c',
                                            'RMGT': '#ea580c', 'ANCC': '#ea580c', 'DBAD': '#ea580c',
                                            
                                            // Catégorie: Change and transformation (Rose)
                                            'POMG': '#db2777', 'PGMG': '#db2777', 'PRMG': '#db2777', 'PROF': '#db2777',
                                            'BUSA': '#db2777', 'FEAS': '#db2777', 'REQM': '#db2777', 'BSMO': '#db2777',
                                            'BPTS': '#db2777', 'BPRE': '#db2777', 'OCDV': '#db2777', 'JADN': '#db2777',
                                            'ORDI': '#db2777', 'CIPM': '#db2777', 'OCEN': '#db2777',
                                            
                                            // Catégorie: People and skills (Cyan)
                                            'PEMT': '#0891b2', 'EEXP': '#0891b2', 'OFCL': '#0891b2', 'PDSV': '#0891b2',
                                            'WFPL': '#0891b2', 'RESC': '#0891b2', 'ETMG': '#0891b2', 'TMCR': '#0891b2',
                                            'ETDL': '#0891b2', 'LEDA': '#0891b2', 'CSOP': '#0891b2', 'TEAC': '#0891b2',
                                            'SUBF': '#0891b2',
                                            
                                            // Catégorie: Relationships and engagement (Vert)
                                            'SORC': '#16a34a', 'SUPP': '#16a34a', 'ITCM': '#16a34a', 'RLMT': '#16a34a',
                                            'CSMG': '#16a34a', 'ADMN': '#16a34a', 'BIDM': '#16a34a', 'SALE': '#16a34a',
                                            'SSUP': '#16a34a', 'MKTG': '#16a34a', 'MRCH': '#16a34a', 'BRMG': '#16a34a',
                                            'CELO': '#16a34a', 'MKCM': '#16a34a', 'DIGM': '#16a34a'
                                        };
                                
                                // Pour chaque OPM ID dans le tableau, mettre à jour les compétences associées
                                document.querySelectorAll('#opm-ids-list tr[data-opm-id]').forEach(row => {
                                    const opmId = row.dataset.opmId;
                                    if (!opmId) return;
                                    
                                    // Trouver la cellule dédiée aux compétences (5ème colonne)
                                    const competencesCell = row.querySelector('td.competences-cell');
                                    if (!competencesCell) return;
                                    
                                    // Vérifier si cette cellule a déjà des badges
                                    if (competencesCell.querySelector('.competence-container')) return;
                                    
                                    // Chercher d'abord dans les configurations spéciales
                                    let competenceCodes = [];
                                    const specialConfig = specialConfigs.find(cfg => cfg.opmId === opmId);
                                    
                                    if (specialConfig && specialConfig.competences && specialConfig.competences.length > 0) {
                                        // Utiliser les compétences définies dans la configuration spéciale
                                        competenceCodes = specialConfig.competences.map(comp => comp.code);
                                        console.log(`Compétences pour OPM ID ${opmId} trouvées dans specialOpmConfigs:`, competenceCodes);
                                    } else {
                                        // Si on ne trouve pas dans les configurations spéciales, chercher dans le DOM
                                        document.querySelectorAll('.level-box.filled[data-opm-id]').forEach(cell => {
                                            const cellOpmIds = cell.dataset.opmId ? cell.dataset.opmId.split(',') : [];
                                            if (cellOpmIds.includes(opmId)) {
                                                const row = cell.closest('.skill-row');
                                                if (row) {
                                                    const codeElement = row.querySelector('.skill-code');
                                                    if (codeElement && codeElement.textContent) {
                                                        const code = codeElement.textContent.trim();
                                                        if (!competenceCodes.includes(code)) {
                                                            competenceCodes.push(code);
                                                        }
                                                    }
                                                }
                                            }
                                        });
                                        console.log(`Compétences pour OPM ID ${opmId} trouvées dans le DOM:`, competenceCodes);
                                    }
                                    
                                    // Ajout manuel pour certains OPM IDs qui pourraient manquer
                                    const manualMappings = {
                                        '111': ['VURE', 'THIN', 'SCAD'],
                                        '112': ['MEAS', 'SCTY', 'INAS', 'THIN'],
                                        '121': ['GOVN', 'METL'],
                                        '141': ['THIN', 'VISL', 'SCAD'],
                                        '151': ['KNOW', 'DATS', 'PENT'],
                                        '221': ['EMRG', 'TECH', 'RSCH'],
                                        '332': ['PENT', 'SCTY', 'PROG'],
                                        '421': ['DATS', 'DBAD', 'DENG'],
                                        '422': ['DATS', 'MLNG', 'DENG'],
                                        '431': ['KNOW', 'ICPM'],
                                        '443': ['KNOW', 'DATS', 'PENT'],
                                        '461': ['PROG', 'SWDN', 'TECH'],
                                        '511': ['DBAD', 'STMG'],
                                        '521': ['TECH', 'USUP'],
                                        '531': ['NTAS', 'NTDS'],
                                        '541': ['ITOP', 'COPL'],
                                        '611': ['IRMG', 'BURM', 'SCTY'],
                                        '621': ['SCTY', 'INAS', 'VUAS'],
                                        '622': ['VUAS', 'PENT'],
                                        '631': ['SCTY', 'VUAS', 'COPL', 'ARCH', 'DESN', 'TEST', 'PENT'],
                                        '661': ['VURE', 'RSCH', 'EMRG', 'TECH'],
                                        '722': ['SCTY', 'INAS'],
                                        '723': ['INAS', 'VUAS', 'SCAD'],
                                        '752': ['INAS', 'SCTY', 'OCDV', 'WFPL'],
                                        '901': ['SCTY', 'BURM', 'INAS'],
                                    };
                                    
                                    // Si on a déjà trouvé des compétences, ne pas utiliser le mapping manuel
                                    if (manualMappings[opmId] && competenceCodes.length === 0) {
                                        competenceCodes = manualMappings[opmId];
                                        console.log(`Compétences pour OPM ID ${opmId} ajoutées manuellement:`, competenceCodes);
                                    }
                                    
                                    // Si on a des codes de compétence, créer les badges
                                    if (competenceCodes.length > 0) {
                                        const competenceContainer = document.createElement('div');
                                        competenceContainer.className = 'competence-container flex flex-wrap gap-2 items-center';
                                        
                                        // Ajouter le libellé "related:"
                                        const relatedLabel = document.createElement('span');
                                        relatedLabel.className = 'text-gray-600 mr-3';
                                        relatedLabel.style.fontSize = '12px';
                                        relatedLabel.style.fontWeight = '600';
                                        relatedLabel.style.display = 'inline-flex';
                                        relatedLabel.style.alignItems = 'center';
                                        relatedLabel.textContent = 'related:';
                                        competenceContainer.appendChild(relatedLabel);
                                        
                                        // Fonction pour obtenir une couleur basée sur le code
                                        function getColorForCode(code) {
                                            // Utiliser les couleurs définies dans competenceColors
                                            return competenceColors[code] || '#6c757d'; // Gris par défaut
                                        }
                                        
                                        // Fonction pour obtenir une description pour un code
                                        function getDescriptionForCode(code) {
                                            const descriptions = {
                                                'SCTY': 'Sécurité des systèmes d\'information',
                                                'INAS': 'Assurance de l\'information',
                                                'VURE': 'Recherche de vulnérabilités',
                                                'THIN': 'Renseignement sur les menaces',
                                                'BURM': 'Gestion des risques',
                                                'PROG': 'Programmation et développement',
                                                'SWDN': 'Conception de logiciels',
                                                'ARCH': 'Architecture de solutions',
                                                'DATS': 'Science des données',
                                                'VISL': 'Visualisation de données',
                                                'DBAD': 'Administration de bases de données',
                                                'STMG': 'Gestion du stockage',
                                                'NTAS': 'Services réseau',
                                                'NTDS': 'Conception de réseau',
                                                'COPL': 'Planification de la continuité',
                                                'ITOP': 'Opérations informatiques',
                                                'TECH': 'Conseil technique',
                                                'USUP': 'Support utilisateur',
                                                'GOVN': 'Gouvernance',
                                                'METL': 'Méthodes et outils',
                                                'KNOW': 'Gestion des connaissances',
                                                'OCDV': 'Développement des capacités',
                                                'WFPL': 'Planification de la main-d\'œuvre',
                                                'IRMG': 'Gestion des risques informationnels',
                                                'VUAS': 'Évaluation des vulnérabilités',
                                                'PENT': 'Tests de pénétration',
                                                'SCAD': 'Opérations de sécurité',
                                                'ICPM': 'Gestion des contenus informatifs',
                                                'DENG': 'Ingénierie des données',
                                                'MLNG': 'Apprentissage automatique',
                                                'EMRG': 'Technologies émergentes',
                                                'RSCH': 'Recherche',
                                                'DESN': 'Conception de systèmes',
                                                'TEST': 'Tests fonctionnels'
                                            };
                                            
                                            return descriptions[code] || '';
                                        }
                                        
                                        // Limite du nombre de badges à afficher (pour éviter de surcharger l'interface)
                                        const maxBadges = 8; // On peut en afficher plus maintenant qu'on a plus d'espace
                                        const displayCodes = competenceCodes.slice(0, maxBadges);
                                        
                                        // Créer un badge pour chaque code
                                        displayCodes.forEach(code => {
                                            const badge = document.createElement('span');
                                            badge.className = 'inline-block text-white px-2.5 py-1 rounded-md mr-2';
                                            badge.style.backgroundColor = getColorForCode(code);
                                            badge.style.fontWeight = '600';
                                            badge.style.fontSize = '12px';
                                            badge.style.letterSpacing = '0.03em';
                                            badge.style.lineHeight = '1.3';
                                            badge.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
                                            badge.style.border = '1px solid rgba(255,255,255,0.2)';
                                            badge.textContent = code;
                                            
                                            // Ajouter un tooltip avec description si disponible
                                            const description = getDescriptionForCode(code);
                                            if (description) {
                                                badge.title = description;
                                                badge.style.cursor = 'help';
                                            }
                                            
                                            competenceContainer.appendChild(badge);
                                        });
                                        
                                        // Si on a plus de compétences que la limite, ajouter un badge +X
                                        if (competenceCodes.length > maxBadges) {
                                            const moreBadge = document.createElement('span');
                                            moreBadge.className = 'inline-block text-white px-2.5 py-1 rounded-md';
                                            moreBadge.style.backgroundColor = '#6c757d';
                                            moreBadge.style.fontWeight = '600';
                                            moreBadge.style.fontSize = '12px';
                                            moreBadge.style.lineHeight = '1.3';
                                            moreBadge.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
                                            moreBadge.style.border = '1px solid rgba(255,255,255,0.2)';
                                            moreBadge.textContent = `+${competenceCodes.length - maxBadges}`;
                                            moreBadge.style.cursor = 'help';
                                            moreBadge.title = competenceCodes.join(', ');
                                            competenceContainer.appendChild(moreBadge);
                                        }
                                        
                                        // Ajouter les badges à la cellule dédiée
                                        competencesCell.appendChild(competenceContainer);
                                    }
                                });
                            }, 500);
                        }, 100);
                    } else {
                        opmIdsList.innerHTML = `
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">
                                            Aucun OPM ID trouvé dans la sélection.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    opmIdsList.innerHTML = `
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">
                                        Veuillez d'abord sélectionner une sauvegarde à l'étape 2.
                                        <a href="{% url 'etape2_first_step' %}" class="font-medium underline text-blue-700 hover:text-blue-600">
                                            Aller à l'étape 2
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des OPM IDs:', error);
                document.getElementById('opm-ids-list').innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700">
                                    Erreur lors du chargement des OPM IDs: ${error.message}
                                </p>
                                <p class="text-xs text-red-600 mt-1">
                                    Essayez de rafraîchir la page ou de retourner à l'étape 2.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // --- GÉNÉRATEUR DYNAMIQUE DE GRILLE ---
        const gridContainer = document.getElementById('sfia-grid');

        function createSkillRow(skill) {
            // Ajouter une cellule "X" avant les niveaux 1 à 7
            let levelBoxesHtml = `<div class="level-box">X</div>`;
            for (let i = 1; i <= 7; i++) {
                const isFilled = skill.levels.includes(i) ? 'filled' : '';
                levelBoxesHtml += `<div class="level-box ${isFilled}">${i}</div>`;
            }

            return `
                <div class="skill-row">
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-code">${skill.code}</div>
                    <div class="level-boxes">${levelBoxesHtml}</div>
                </div>
            `;
        }
        
        function createLevelHeader() {
            // Ajouter une cellule "X" avant les niveaux 1 à 7 dans l'en-tête
            let levelNumbersHtml = '<div class="level-number">X</div>';
            for (let i = 1; i <= 7; i++) {
                levelNumbersHtml += `<div class="level-number">${i}</div>`;
            }
            return `
                 <div class="level-header">
                    <div class="flex-grow"></div>
                    ${levelNumbersHtml}
                </div>
            `;
        }

        sfiaData.forEach(category => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = `category-container ${category.cssClass}`;

            let subcategoriesHtml = '';
            category.subcategories.forEach(subcategory => {
                const skillsHtml = subcategory.skills.map(createSkillRow).join('');
                subcategoriesHtml += `
                    <div class="subcategory">
                        <div class="subcategory-header">${subcategory.name}</div>
                        ${skillsHtml}
                    </div>
                `;
            });

            categoryDiv.innerHTML = `
                <div class="category-header">${category.name}</div>
                ${createLevelHeader()}
                ${subcategoriesHtml}
            `;
            gridContainer.appendChild(categoryDiv);
        });
        
        // --- LOGIQUE DE LA PAGE ---

        // Mobile menu
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

        // Dark Mode
        const darkModeToggle = document.getElementById('darkModeToggle');
        const moonIcon = document.getElementById('moonIcon');
        const sunIcon = document.getElementById('sunIcon');
        const isDarkMode = () => localStorage.getItem('darkMode') === 'true';

        const updateDarkMode = () => {
            if (isDarkMode()) {
                document.body.classList.add('dark-mode');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark-mode');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
        };

        darkModeToggle.addEventListener('click', () => {
            localStorage.setItem('darkMode', !isDarkMode());
            updateDarkMode();
        });

        // Initialiser le mode sombre en fonction de la préférence stockée
        updateDarkMode();

        // --- MODAL HANDLERS ---
        const completeButton = document.getElementById('complete-button');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');

        completeButton.addEventListener('click', () => {
            confirmationModal.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.add('opacity-50');
                modalContent.classList.add('opacity-100', 'scale-100');
                modalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);
        });

        function closeModal() {
            modalBackdrop.classList.remove('opacity-50');
            modalContent.classList.remove('opacity-100', 'scale-100');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                confirmationModal.classList.add('hidden');
            }, 300);
        }

        modalBackdrop.addEventListener('click', closeModal);
        modalCancel.addEventListener('click', closeModal);
        modalConfirm.addEventListener('click', () => {
            window.location.href = "/ksat/step2/"; // Retourner à l'étape 2
        });
        
        // --- HANDLE OPM ID 901 SPECIAL BEHAVIOR ---
        function handleSpecialOpmBehavior() {
            // Vérifier si l'OPM ID 901 ou 722 est présent
            const opmIdsList = document.getElementById('opm-ids-list');
            const has901 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('901');
            const has722 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('722');
            const has723 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('723');
            const has752 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('752');
            const has661 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('661');
            const has622 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('622');
            const has631 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('631');
            const has461 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('461');
            const has511 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('511');
            const has521 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('521');
                            const has531 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('531');
                const has541 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('541');
                const has141 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('141');
                const has121 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('121');
                const has111 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('111');
                const has112 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('112');
                const has443 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('443');
                const has151 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('151');
                const has331 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('331');
                const has332 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('332');
                const has132 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('132');
                const has333 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('333');
                const has334 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('334');
                const has131 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('131');
                const has321 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('321');
                const has221 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('221');
                const has211 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('211');
                const has212 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('212');
                const has651 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('651');
                const has652 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('652');
                const has621 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('621');
                const has641 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('641');
                const has671 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('671');
                const has632 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('632');
                const has411 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('411');
                const has451 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('451');
                const has441 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('441');
                const has803 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('803');
                const has801 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('801');
                const has802 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('802');
                const has804 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('804');
                const has312 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('312');
                const has421 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('421');
                const has422 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('422');
                const has612 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('612');
                const has805 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('805');
                const has731 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('731');
                const has732 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('732');
                const has751 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('751');
                const has711 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('711');
                const has712 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('712');
                const has311 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('311');
                const has431 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('431');
                const has611 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('611');
            
            // Configuration des OPM IDs spéciaux et leurs comportements - TOUJOURS isPresent: false par défaut
            window.specialOpmConfigs = [
                {
                    opmId: '901',
                    color: '153, 86, 206', // Mauve
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'SCTY', levels: [7], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'BURM', levels: [7], description: 'Identification, évaluation et contrôle des risques au sein de l\'organisation.' },
                        { code: 'INAS', levels: [7], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' }
                    ]
                },
                {
                    opmId: '722',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'SCTY', levels: [5, 6], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [5, 6], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' }
                    ]
                },
                {
                    opmId: '723',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'INAS', levels: [5, 6], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' },
                        { code: 'VUAS', levels: [5, 6], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'SCAD', levels: [5, 6], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' }
                    ]
                },
                {
                    opmId: '752',
                    color: '153, 86, 206', // Mauve (couleur des cyberspace enablers)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'INAS', levels: [6], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' },
                        { code: 'SCTY', levels: [6], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'OCDV', levels: [6], description: 'Développement et amélioration des capacités organisationnelles pour répondre aux besoins actuels et futurs.' },
                        { code: 'WFPL', levels: [6], description: 'Planification stratégique de la main-d\'œuvre pour répondre aux besoins organisationnels.' }
                    ]
                },
                {
                    opmId: '661',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vulnérabilités pour améliorer la sécurité des systèmes.' },
                        { code: 'RSCH', levels: [3, 4, 5], description: 'Conduite de recherche formelle pour développer de nouvelles connaissances et technologies.' },
                        { code: 'EMRG', levels: [4, 5], description: 'Suivi des technologies émergentes pour identifier les opportunités et les risques futurs.' },
                        { code: 'TECH', levels: [4, 5], description: 'Fourniture de conseils techniques spécialisés pour soutenir les décisions stratégiques.' }
                    ]
                },
                {
                    opmId: '622',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'VUAS', levels: [3, 4, 5], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' }
                    ]
                },
                {
                    opmId: '631',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'SCTY', levels: [3, 4, 5], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'VUAS', levels: [3, 4, 5], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'COPL', levels: [3, 4, 5], description: 'Planification et gestion de la continuité des services informatiques face aux incidents.' },
                        { code: 'ARCH', levels: [4, 5], description: 'Conception de solutions techniques répondant aux exigences métier et techniques.' },
                        { code: 'DESN', levels: [3, 4, 5], description: 'Conception de systèmes conformes aux spécifications et adaptés aux besoins des utilisateurs.' },
                        { code: 'TEST', levels: [3, 4, 5], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' }
                    ]
                },
                {
                    opmId: '461',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'PROG', levels: [3, 4, 5], description: 'Développement de logiciels selon des spécifications et standards établis.' },
                        { code: 'SWDN', levels: [3, 4, 5], description: 'Conception d\'architectures logicielles adaptées aux besoins métier et techniques.' },
                        { code: 'TECH', levels: [3, 4, 5], description: 'Fourniture de conseils techniques spécialisés pour soutenir les décisions et projets.' }
                    ]
                },
                {
                    opmId: '511',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'DBAD', levels: [2, 3, 4, 5], description: 'Administration des bases de données pour en assurer la disponibilité et la performance.' },
                        { code: 'STMG', levels: [2, 3, 4, 5], description: 'Gestion du stockage des données pour garantir leur sécurité et accessibilité.' }
                    ]
                },
                {
                    opmId: '521',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'TECH', levels: [1, 2, 3, 4, 5], description: 'Fourniture de conseils techniques spécialisés pour aider à la résolution des problèmes.' },
                        { code: 'USUP', levels: [1, 2, 3, 4, 5], description: 'Support utilisateur pour résoudre les problèmes techniques et répondre aux questions.' }
                    ]
                },
                {
                    opmId: '531',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'NTAS', levels: [2, 3, 4, 5], description: 'Configuration et maintenance des services réseau pour assurer leur disponibilité.' },
                        { code: 'NTDS', levels: [2, 3, 4, 5], description: 'Conception d\'architectures réseau adaptées aux besoins de l\'organisation.' }
                    ]
                },
                {
                    opmId: '541',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'ITOP', levels: [2, 3, 4, 5], description: 'Gestion des opérations informatiques pour garantir la qualité des services.' },
                        { code: 'COPL', levels: [2, 3, 4, 5], description: 'Planification de la continuité des services informatiques en cas d\'incident.' }
                    ]
                },
                {
                    opmId: '121',
                    color: '255, 145, 3', // Orange (couleur des cyberspace effects)
                    isPresent: false, // Désactivé par défaut, sera activé par la case à cocher
                    competences: [
                        { code: 'GOVN', levels: [3, 4, 5], description: 'Mise en place des politiques et processus de gouvernance pour garantir l\'alignement stratégique.' },
                        { code: 'METL', levels: [3, 4, 5], description: 'Développement et application des méthodes et outils pour optimiser les processus de travail.' }
                    ]
                },
                {
                    opmId: '141',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has141,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'VISL', levels: [3, 4, 5], description: 'Création de représentations graphiques des données pour faciliter leur interprétation et leur analyse.' },
                        { code: 'SCAD', levels: [3, 4, 5], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' }
                    ]
                },
                {
                    opmId: '111',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has111,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'SCAD', levels: [3, 4, 5], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' },
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vulnérabilités pour améliorer la sécurité des systèmes.' }
                    ]
                },
                {
                    opmId: '112',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has112,
                    competences: [
                        { code: 'MEAS', levels: [4, 5], description: 'Définition et utilisation de métriques pour mesurer et améliorer la performance des systèmes.' },
                        { code: 'SCTY', levels: [4, 5], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [4, 5], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' },
                        { code: 'THIN', levels: [4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' }
                    ]
                },
                {
                    opmId: '443',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has443,
                    competences: [
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'DATS', levels: [3, 4, 5], description: 'Application de méthodes scientifiques et mathématiques pour extraire des connaissances des données.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' }
                    ]
                },
                {
                    opmId: '151',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has151,
                    competences: [
                        { code: 'TECH', levels: [4, 5], description: 'Fourniture de conseils techniques spécialisés pour soutenir les décisions stratégiques.' },
                        { code: 'KNOW', levels: [4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'VUAS', levels: [4, 5], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'THIN', levels: [4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' }
                    ]
                },
                {
                    opmId: '331',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has331,
                    competences: [
                        { code: 'THIN', levels: [5, 6], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'DEMM', levels: [5, 6], description: 'Gestion de la demande pour optimiser l\'allocation des ressources informatiques.' },
                        { code: 'ITSP', levels: [5, 6], description: 'Planification stratégique des technologies de l\'information pour soutenir les objectifs organisationnels.' }
                    ]
                },
                {
                    opmId: '332',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has332,
                    competences: [
                        { code: 'SCAD', levels: [5, 6], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' },
                        { code: 'THIN', levels: [5, 6], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'SUPP', levels: [5, 6], description: 'Gestion des relations avec les fournisseurs pour assurer la qualité des services et produits.' }
                    ]
                },
                {
                    opmId: '132',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has132,
                    competences: [
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'DATS', levels: [3, 4, 5], description: 'Application de méthodes scientifiques et mathématiques pour extraire des connaissances des données.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' }
                    ]
                },
                {
                    opmId: '333',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has333,
                    competences: [
                        { code: 'RLMT', levels: [5, 6], description: 'Gestion des relations avec les parties prenantes pour assurer leur engagement et satisfaction.' },
                        { code: 'SCTY', levels: [5, 6], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'KNOW', levels: [5, 6], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' }
                    ]
                },
                {
                    opmId: '334',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has334,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique numérique pour l\'investigation et la collecte de preuves électroniques.' }
                    ]
                },
                {
                    opmId: '131',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has131,
                    competences: [
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vulnérabilités pour améliorer la sécurité des systèmes.' },
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' }
                    ]
                },
                {
                    opmId: '321',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has321,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et prévenir les attaques.' },
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vulnérabilités pour améliorer la sécurité des systèmes.' }
                    ]
                },
                {
                    opmId: '221',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has221,
                    competences: [
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique numérique pour l\'investigation et la collecte de preuves électroniques.' }
                    ]
                },
                {
                    opmId: '211',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has211,
                    competences: [
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique numérique pour l\'investigation et la collecte de preuves électroniques.' }
                    ]
                },
                {
                    opmId: '212',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has212,
                    competences: [
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique numérique pour l\'investigation et la collecte de preuves électroniques.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' },
                        { code: 'VUAS', levels: [3, 4, 5], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' }
                    ]
                },
                {
                    opmId: '651',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has651,
                    competences: [
                        { code: 'STPL', levels: [5, 6], description: 'Planification stratégique pour définir les orientations futures et les objectifs à long terme.' },
                        { code: 'REQM', levels: [5, 6], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '652',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has652,
                    competences: [
                        { code: 'SCTY', levels: [4, 5, 6], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'STPL', levels: [5, 6], description: 'Planification stratégique pour définir les orientations futures et les objectifs à long terme.' },
                        { code: 'ARCH', levels: [4, 5, 6], description: 'Conception de solutions techniques répondant aux exigences métier et techniques.' },
                        { code: 'REQM', levels: [4, 5, 6], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '621',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: has621,
                    competences: [
                        { code: 'PROG', levels: [2, 3, 4, 5], description: 'Développement de logiciels à l\'aide de langages de programmation et d\'outils appropriés.' },
                        { code: 'TEST', levels: [2, 3, 4, 5], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' },
                        { code: 'PORT', levels: [3, 4, 5], description: 'Configuration logicielle pour adapter les applications aux environnements spécifiques.' },
                        { code: 'RESD', levels: [2, 3, 4, 5], description: 'Développement de systèmes embarqués et temps réel avec des contraintes matérielles.' },
                        { code: 'SINT', levels: [2, 3, 4, 5], description: 'Intégration de composants système pour créer des solutions fonctionnelles complètes.' }
                    ]
                },
                {
                    opmId: '641',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has641,
                    competences: [
                        { code: 'REQM', levels: [3, 4, 5], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' },
                        { code: 'UNAN', levels: [3, 4, 5], description: 'Analyse de l\'expérience utilisateur pour comprendre les besoins et les comportements des utilisateurs.' },
                        { code: 'ARCH', levels: [4, 5], description: 'Conception de solutions techniques répondant aux exigences métier et techniques.' }
                    ]
                },
                {
                    opmId: '671',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has671,
                    competences: [
                        { code: 'TEST', levels: [3, 4], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' },
                        { code: 'QUAS', levels: [3, 4], description: 'Assurance qualité pour garantir que les produits et services répondent aux normes définies.' },
                        { code: 'PENT', levels: [3, 4], description: 'Tests d\'intrusion pour évaluer la sécurité des systèmes et identifier les vulnérabilités exploitables.' },
                        { code: 'USEV', levels: [3, 4], description: 'Évaluation de l\'expérience utilisateur pour mesurer la satisfaction et l\'efficacité des interfaces.' }
                    ]
                },
                {
                    opmId: '632',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has632,
                    competences: [
                        { code: 'ARCH', levels: [4, 5], description: 'Conception de solutions techniques répondant aux exigences métier et techniques.' },
                        { code: 'RESD', levels: [3, 4, 5], description: 'Développement de systèmes informatiques selon les spécifications de conception.' },
                        { code: 'DESN', levels: [3, 4, 5], description: 'Conception de systèmes conformes aux spécifications et adaptés aux besoins des utilisateurs.' },
                        { code: 'HWDE', levels: [3, 4, 5], description: 'Conception de matériel informatique répondant aux exigences métier et techniques.' },
                        { code: 'NTDS', levels: [3, 4, 5], description: 'Conception de réseaux informatiques répondant aux exigences métier et techniques.' },
                        { code: 'SWDN', levels: [3, 4, 5], description: 'Conception de logiciels informatiques répondant aux exigences métier et techniques.' },
                        { code: 'TEST', levels: [3, 4, 5], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' }
                    ]
                },
                {
                    opmId: '411',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has411,
                    competences: [
                        { code: 'PBMG', levels: [3, 4], description: 'Gestion des problèmes pour minimiser les perturbations et restaurer les services rapidement.' },
                        { code: 'SCAD', levels: [2, 3, 4], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' },
                        { code: 'VUAS', levels: [2, 3, 4], description: 'Évaluation des systèmes et réseaux pour détecter les vulnérabilités et les faiblesses de sécurité.' },
                        { code: 'SYSP', levels: [3, 4], description: 'Programmation système pour développer et maintenir des composants logiciels de bas niveau.' },
                        { code: 'ITOP', levels: [2, 3, 4], description: 'Gestion et exploitation des infrastructures informatiques, assurant leur disponibilité et leur performance.' },
                        { code: 'HSIN', levels: [2, 3, 4], description: 'Installation, migration et désinstallation des systèmes matériels et logiciels.' },
                        { code: 'NTAS', levels: [2, 3, 4], description: 'Support et maintenance des infrastructures réseau pour assurer leur disponibilité et leur performance.' }
                    ]
                },
                {
                    opmId: '451',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has451,
                    competences: [
                        { code: 'SCAD', levels: [1, 2, 3, 4], description: 'Surveillance et gestion des opérations de sécurité pour protéger contre les menaces et incidents.' },
                        { code: 'ITOP', levels: [1, 2, 3, 4], description: 'Gestion et exploitation des infrastructures informatiques, assurant leur disponibilité et leur performance.' },
                        { code: 'HSIN', levels: [1, 2, 3, 4], description: 'Installation, migration et désinstallation des systèmes matériels et logiciels.' },
                        { code: 'SYSP', levels: [3, 4], description: 'Programmation système pour développer et maintenir des composants logiciels de bas niveau.' },
                        { code: 'TEST', levels: [1, 2, 3, 4], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' },
                        { code: 'PBMG', levels: [3, 4], description: 'Gestion des problèmes pour minimiser les perturbations et restaurer les services rapidement.' }
                    ]
                },
                {
                    opmId: '441',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has441,
                    competences: [
                        { code: 'SYSP', levels: [3, 4], description: 'Programmation système pour développer et maintenir des composants logiciels de bas niveau.' },
                        { code: 'NTAS', levels: [2, 3, 4], description: 'Support et maintenance des infrastructures réseau pour assurer leur disponibilité et leur performance.' },
                        { code: 'HSIN', levels: [2, 3, 4], description: 'Installation, migration et désinstallation des systèmes matériels et logiciels.' },
                        { code: 'TEST', levels: [2, 3, 4], description: 'Conception et exécution de tests fonctionnels pour vérifier la conformité des systèmes.' }
                    ]
                },
                {
                    opmId: '803',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has803,
                    competences: [
                        { code: 'SLMO', levels: [3, 4, 5], description: 'Gestion des niveaux de service pour optimiser la disponibilité et la performance des services.' },
                        { code: 'BUSA', levels: [3, 4, 5], description: 'Analyse des situations d\'affaires pour identifier les opportunités et les menaces.' },
                        { code: 'FEAS', levels: [3, 4, 5], description: 'Amélioration des processus métier pour répondre aux besoins organisationnels.' },
                        { code: 'REQM', levels: [3, 4, 5], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '801',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has801,
                    competences: [
                        { code: 'PGMG', levels: [6], description: 'Gestion de programme pour coordonner et superviser un ensemble de projets liés.' },
                        { code: 'QUMG', levels: [6], description: 'Gestion de la qualité pour garantir que les produits et services répondent aux normes définies.' },
                        { code: 'RLMT', levels: [6], description: 'Gestion des relations pour maintenir des partenariats efficaces avec les parties prenantes.' },
                        { code: 'BENM', levels: [6], description: 'Gestion des bénéfices pour maximiser la valeur des investissements.' },
                        { code: 'CIPM', levels: [6], description: 'Gestion de l\'amélioration continue pour optimiser les processus et les performances.' },
                        { code: 'SUPP', levels: [6], description: 'Gestion des fournisseurs pour optimiser la valeur des relations avec les prestataires externes.' }
                    ]
                },
                {
                    opmId: '802',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has802,
                    competences: [
                        { code: 'PRMG', levels: [4, 5, 6], description: 'Gestion de programme pour coordonner et superviser un ensemble de projets liés.' },
                        { code: 'SLMO', levels: [4, 5, 6], description: 'Gestion des niveaux de service pour optimiser la disponibilité et la performance des services.' },
                        { code: 'REQM', levels: [4, 5, 6], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' },
                        { code: 'QUMG', levels: [4, 5, 6], description: 'Gestion de la qualité pour garantir que les produits et services répondent aux normes définies.' }
                    ]
                },
                {
                    opmId: '804',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has804,
                    competences: [
                        { code: 'POMG', levels: [5, 6], description: 'Gestion de portefeuille pour optimiser les investissements et les performances.' },
                        { code: 'INVA', levels: [5, 6], description: 'Évaluation et sélection des investissements pour maximiser la valeur.' },
                        { code: 'RLMT', levels: [5, 6], description: 'Gestion des relations pour maintenir des partenariats efficaces avec les parties prenantes.' }
                    ]
                },
                {
                    opmId: '312',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has312,
                    competences: [
                        { code: 'DEMM', levels: [5, 6], description: 'Suivi des technologies émergentes pour identifier les opportunités et les risques futurs.' },
                        { code: 'REQM', levels: [5, 6], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '421',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has421,
                    competences: [
                        { code: 'DBAD', levels: [2, 3, 4, 5], description: 'Gestion des bases de données pour assurer la sécurité et la conformité.' },
                        { code: 'STMG', levels: [3, 4, 5], description: 'Gestion du stockage pour optimiser l\'utilisation des ressources et assurer la disponibilité des données.' }
                    ]
                },
                {
                    opmId: '422',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has422,
                    competences: [
                        { code: 'DENG', levels: [2, 3, 4, 5], description: 'Ingénierie des données pour concevoir et développer des architectures de traitement de données.' },
                        { code: 'DTAN', levels: [2, 3, 4, 5], description: 'Analyse de données pour extraire des informations utiles et soutenir la prise de décision.' },
                        { code: 'REQM', levels: [2, 3, 4, 5], description: 'Définition et gestion des exigences pour garantir que les solutions répondent aux besoins des parties prenantes.' },
                        { code: 'DATS', levels: [2, 3, 4, 5], description: 'Science des données pour appliquer des méthodes scientifiques et statistiques avancées aux données.' },
                        { code: 'BINT', levels: [2, 3, 4, 5], description: 'Intelligence d\'affaires pour transformer les données en informations stratégiques pour l\'organisation.' }
                    ]
                },
                {
                    opmId: '612',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has612,
                    competences: [
                        { code: 'SCTY', levels: [3, 4, 5], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [3, 4, 5], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' },
                        { code: 'AUDT', levels: [3, 4, 5], description: 'Gestion des processus d\'audit pour assurer la conformité aux normes et réglementations.' },
                        { code: 'BURM', levels: [3, 4, 5], description: 'Gestion des risques d\'affaires pour identifier et gérer les menaces potentielles.' }
                    ]
                },
                {
                    opmId: '805',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has805,
                    competences: [
                        { code: 'AUDT', levels: [3, 4, 5], description: 'Gestion des processus d\'audit pour assurer la conformité aux normes et réglementations.' },
                        { code: 'INAS', levels: [3, 4, 5], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' },
                        { code: 'BURM', levels: [3, 4, 5], description: 'Identification, évaluation et contrôle des risques au sein de l\'organisation.' },
                        { code: 'QUAS', levels: [3, 4, 5], description: 'Assurance qualité pour garantir que les produits et services répondent aux normes définies.' }
                    ]
                },
                {
                    opmId: '731',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: has731,
                    competences: [
                        { code: 'TECH', levels: [4, 5], description: 'Fourniture de conseils techniques spécialisés pour soutenir les décisions stratégiques.' },
                        { code: 'SCTY', levels: [4, 5], description: 'Sécurisation des systèmes d\'information et des données contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [4, 5], description: 'Protection des informations critiques et maintien de leur confidentialité, intégrité et disponibilité.' }
                    ]
                },
                {
                    opmId: '732',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has732,
                    competences: [
                        { code: 'PEDP', levels: [5, 6], description: 'Développement des personnes pour améliorer les compétences et les performances de l\'équipe.' }
                    ]
                },
                {
                    opmId: '751',
                    color: '153, 86, 206', // Mauve (couleur des cyberspace enablers)
                    isPresent: has751,
                    competences: [
                        { code: 'WFPL', levels: [4, 5, 6], description: 'Planification stratégique de la main-d\'œuvre pour répondre aux besoins organisationnels.' },
                        { code: 'PDSV', levels: [4, 5, 6], description: 'Conception de services pour créer des solutions adaptées aux besoins des utilisateurs.' },
                        { code: 'ETMG', levels: [4, 5, 6], description: 'Architecture d\'entreprise pour aligner les systèmes d\'information sur la stratégie organisationnelle.' },
                        { code: 'ORDI', levels: [4, 5, 6], description: 'Conception et implémentation organisationnelle pour optimiser la structure et les processus.' }
                    ]
                },
                {
                    opmId: '711',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has711,
                    competences: [
                        { code: 'TMCR', levels: [4, 5], description: 'Création d\'équipes efficaces pour atteindre les objectifs organisationnels.' },
                        { code: 'SUBF', levels: [4, 5], description: 'Gestion des fournisseurs pour optimiser la valeur des relations avec les prestataires externes.' },
                        { code: 'INCA', levels: [4, 5], description: 'Création et promotion de l\'innovation pour développer de nouvelles solutions et approches.' }
                    ]
                },
                {
                    opmId: '712',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has712,
                    competences: [
                        { code: 'ETDL', levels: [3, 4, 5], description: 'Formation et développement des équipes pour assurer la qualité et la cohérence des services.' },
                        { code: 'TEAC', levels: [3, 4, 5], description: 'Enseignement et formation des équipes pour améliorer les compétences et les performances.' },
                        { code: 'TMCR', levels: [3, 4, 5], description: 'Gestion des ressources humaines pour optimiser les compétences et les performances.' },
                        { code: 'INCA', levels: [3, 4, 5], description: 'Création et promotion de l\'innovation pour développer de nouvelles solutions et approches.' }
                    ]
                },
                {
                    opmId: '311',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: has311,
                    competences: [
                        { code: 'KNOW', levels: [5, 6], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'OCDV', levels: [5, 6], description: 'Développement et amélioration des capacités organisationnelles pour répondre aux besoins actuels et futurs.' },
                        { code: 'BPRE', levels: [5, 6], description: 'Amélioration des processus d\'affaires pour optimiser l\'allocation des ressources et les performances.' }
                    ]
                },
                {
                    opmId: '431',
                    color: '2, 125, 184', // Turquoise (couleur des Data/AI)
                    isPresent: has431,
                    competences: [
                        { code: 'KNOW', levels: [2, 3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'ICPM', levels: [2, 3, 4, 5], description: 'Gestion des contenus informatifs pour assurer la qualité et la cohérence des informations.' }
                    ]
                },
                {
                    opmId: '611',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has611,
                    competences: [
                        { code: 'IRMG', levels: [6, 7], description: 'Gestion des risques liés à l\'information pour protéger les actifs informationnels critiques.' },
                        { code: 'BURM', levels: [6, 7], description: 'Gestion des risques d\'affaires au niveau stratégique pour assurer la résilience organisationnelle.' },
                        { code: 'SCTY', levels: [6, 7], description: 'Sécurisation des systèmes d\'information et des données au niveau de direction et de gouvernance.' }
                    ]
                }
            ];
            
            // Fonctions simplifiées pour la gestion du tooltip
            let tooltipTimeout;
            
            function showTooltipNextToElement(element, tooltipContent) {
                clearTimeout(tooltipTimeout);
                
                const tooltip = document.getElementById('custom-tooltip');
                if (!tooltip) return;
                
                // Mettre à jour le contenu
                tooltip.innerHTML = tooltipContent;
                
                // Positionner le tooltip
                const rect = element.getBoundingClientRect();
                const offsetX = 15;
                const offsetY = 5;
                
                // Position initiale (à droite de l'élément)
                let left = rect.right + offsetX;
                let top = rect.top + offsetY;
                
                // Appliquer les positions
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
                
                // Rendre visible
                tooltip.classList.add('visible');
                
                // Vérifier si le tooltip dépasse à droite
                tooltipTimeout = setTimeout(() => {
                    const tooltipRect = tooltip.getBoundingClientRect();
                    
                    if (tooltipRect.right > window.innerWidth) {
                        // Repositionner à gauche de l'élément
                        left = rect.left - tooltipRect.width - offsetX;
                        tooltip.style.left = left + 'px';
                    }
                    
                    // Si le tooltip dépasse en bas
                    if (tooltipRect.bottom > window.innerHeight) {
                        // Repositionner au-dessus de l'élément
                        top = rect.top - tooltipRect.height - offsetY;
                        tooltip.style.top = top + 'px';
                    }
                }, 0);
            }
            
            function hideTooltip() {
                const tooltip = document.getElementById('custom-tooltip');
                if (tooltip) {
                    tooltip.classList.remove('visible');
                }
                clearTimeout(tooltipTimeout);
            }
            
            // Repositionner le tooltip lors du défilement
            window.addEventListener('scroll', () => {
                hideTooltip();
            });
            
            // Masquer le tooltip lors du redimensionnement de la fenêtre
            window.addEventListener('resize', () => {
                hideTooltip();
            });
            
            // Traiter chaque configuration d'OPM ID spéciale
            specialOpmConfigs.forEach(config => {
                if (config.isPresent) {
                    console.log(`OPM ID ${config.opmId} detected, applying special behavior`);
                    
                    // Sélectionner automatiquement les cellules pour cet OPM ID dans la table des OPM IDs
                    const opmRows = document.querySelectorAll('#opm-ids-list table tr');
                    opmRows.forEach(row => {
                        const opmIdText = row.querySelector('td:nth-child(2) span'); // Ajusté pour la nouvelle structure avec case à cocher
                        if (opmIdText && opmIdText.textContent === config.opmId) {
                            // Accéder aux cercles de niveau dans la cellule des niveaux
                            const levelCircles = row.querySelectorAll('td:last-child .flex-row > div');
                            
                            // Déterminer les niveaux à mettre en surbrillance basés sur l'OPM ID
                            const levelsToHighlight = getLevelsForOpmId(config.opmId);
                            
                            levelsToHighlight.forEach(level => {
                                const levelIndex = level - 1; // Convertir niveau à index 0-based
                                if (levelIndex >= 0 && levelIndex < levelCircles.length) {
                                    const levelCircle = levelCircles[levelIndex];
                                    const circle = levelCircle.querySelector('div');
                                    if (circle) {
                                        circle.style.backgroundColor = `rgba(${config.color}, 0.8)`;
                                        circle.style.transform = 'scale(1.2)';
                                        circle.style.boxShadow = `0 0 5px rgba(${config.color.split(',')[0]}, ${config.color.split(',')[1]}, ${config.color.split(',')[2]}, 0.7)`;
                                        circle.style.transition = 'all 0.3s ease';
                                    }
                                }
                            });
                        }
                    });
                    
                    // 2. Mettre en surbrillance les cellules des compétences spécifiques
                    const targetSkillRows = document.querySelectorAll('.skill-row');
                    targetSkillRows.forEach(row => {
                        const codeElement = row.querySelector('.skill-code');
                        
                        // Vérifier si cette compétence est dans la liste des compétences spéciales pour cet OPM ID
                        const competenceConfig = config.competences.find(comp => 
                            codeElement && comp.code === codeElement.textContent.trim()
                        );
                        
                        if (competenceConfig) {
                            const skillCode = codeElement.textContent.trim();
                            const skillName = row.querySelector('.skill-name').textContent.trim();
                            console.log(`Activation de la surbrillance pour compétence: ${skillCode} (OPM ID: ${config.opmId})`);
                            
                            // Obtenir les level-box pour cette compétence
                            const levelBoxes = row.querySelectorAll('.level-boxes .level-box');
                            
                            // Parcourir chaque niveau spécifié dans la configuration
                            competenceConfig.levels.forEach(level => {
                                const levelIndex = parseInt(level) - 1; // Convertir niveau à index 0-based
                                if (levelIndex >= 0 && levelIndex < levelBoxes.length) {
                                    const levelBox = levelBoxes[levelIndex];
                                    
                                    // Vérifier si ce level-box a la classe 'filled'
                                    if (levelBox.classList.contains('filled')) {
                                        // Vérifier si la cellule a déjà des attributs OPM ID
                                        let currentOpmIds = levelBox.dataset.opmId ? levelBox.dataset.opmId.split(',') : [];
                                        
                                        // Ajouter cet OPM ID s'il n'est pas déjà présent
                                        if (!currentOpmIds.includes(config.opmId)) {
                                            currentOpmIds.push(config.opmId);
                                            levelBox.dataset.opmId = currentOpmIds.join(',');
                                        }
                                        
                                        // Ajouter une animation de clignotement
                                        levelBox.style.animation = 'blink-animation 1.5s infinite';
                                        
                                        // Appliquer les styles de surbrillance avec fusion des couleurs
                                        if (currentOpmIds.length > 1) {
                                            // Créer un dégradé avec toutes les couleurs des OPM IDs actifs
                                            let gradientColors = [];
                                            let boxShadowColors = [];
                                            
                                            currentOpmIds.forEach((id, index) => {
                                                const opmConfig = specialOpmConfigs.find(cfg => cfg.opmId === id);
                                                if (opmConfig) {
                                                    // Calculer la position du gradient pour cette couleur
                                                    const position = Math.round((index / (currentOpmIds.length - 1)) * 100);
                                                    gradientColors.push(`rgba(${opmConfig.color}, 0.8) ${position}%`);
                                                    boxShadowColors.push(`rgba(${opmConfig.color}, 0.5)`);
                                                }
                                            });
                                            
                                            // Appliquer un dégradé multi-couleurs
                                            if (gradientColors.length > 1) {
                                                levelBox.style.background = `linear-gradient(135deg, ${gradientColors.join(', ')})`;
                                                // Utiliser la première couleur pour l'ombre
                                                levelBox.style.boxShadow = `0 0 8px ${boxShadowColors[0]}`;
                                            } else {
                                                // Fallback si une seule couleur est disponible
                                                levelBox.style.background = `linear-gradient(135deg, rgb(${config.color}), rgba(${config.color}, 0.8))`;
                                                levelBox.style.boxShadow = `0 0 8px rgba(${config.color}, 0.9)`;
                                            }
                                        } else {
                                            // Style standard pour une seule couleur
                                            levelBox.style.boxShadow = `0 0 8px rgba(${config.color}, 0.9)`;
                                            levelBox.style.background = `linear-gradient(135deg, rgb(${config.color}), rgba(${config.color}, 0.8))`;
                                        }
                                        
                                        levelBox.style.cursor = 'default';
                                        
                                        // Supprimer les gestionnaires d'événements existants pour éviter les doublons
                                        if (levelBox._mouseEnterHandler) {
                                            levelBox.removeEventListener('mouseenter', levelBox._mouseEnterHandler);
                                        }
                                        if (levelBox._mouseLeaveHandler) {
                                            levelBox.removeEventListener('mouseleave', levelBox._mouseLeaveHandler);
                                        }
                                        
                                        // Stocker les informations nécessaires au tooltip
                                        levelBox.dataset.skillName = skillName;
                                        levelBox.dataset.skillCode = skillCode;
                                        levelBox.dataset.level = level;
                                        levelBox.dataset.description = competenceConfig.description || "Compétence requise pour ce rôle";
                                        
                                        // Créer de nouveaux gestionnaires d'événements
                                        const mouseEnterHandler = () => {
                                            // Récupérer tous les OPM IDs associés à cette cellule
                                            const cellOpmIds = levelBox.dataset.opmId ? levelBox.dataset.opmId.split(',') : [];
                                            
                                            // Construire les badges pour chaque OPM ID
                                            let opmIdBadges = '';
                                            cellOpmIds.forEach(id => {
                                                const opmConfig = specialOpmConfigs.find(cfg => cfg.opmId === id);
                                                if (opmConfig) {
                                                    opmIdBadges += `<span class="tooltip-badge" style="background-color: rgba(${opmConfig.color}, 0.8);">OPM ID: ${id}</span>`;
                                                }
                                            });
                                            
                                            // Construire le contenu du tooltip
                                            let tooltipContent = `
                                                <div class="tooltip-title">${levelBox.dataset.skillName} (${levelBox.dataset.skillCode})</div>
                                                <div class="tooltip-badges">
                                                    ${opmIdBadges}
                                                    <span class="tooltip-badge">Niveau: ${levelBox.dataset.level}</span>
                                                </div>
                                                <div class="tooltip-info">
                                                    <strong>Description:</strong> ${levelBox.dataset.description}
                                                </div>
                                            `;
                                            
                                            // Afficher le tooltip à côté de la cellule
                                            showTooltipNextToElement(levelBox, tooltipContent);
                                        };
                                        
                                        const mouseLeaveHandler = () => {
                                            hideTooltip();
                                        };
                                        
                                        // Stocker les références aux gestionnaires
                                        levelBox._mouseEnterHandler = mouseEnterHandler;
                                        levelBox._mouseLeaveHandler = mouseLeaveHandler;
                                        
                                        // Ajouter les nouveaux gestionnaires d'événements
                                        levelBox.addEventListener('mouseenter', mouseEnterHandler);
                                        levelBox.addEventListener('mouseleave', mouseLeaveHandler);
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            // Ne pas appliquer automatiquement les surbrillances - attendez que les cases à cocher soient utilisées
            // Nous ne modifierons que l'état interne pour le moment
            specialOpmConfigs.forEach(config => {
                config.isPresent = false; // Désactiver par défaut, sera activé par les cases à cocher
            });

            // Réinitialiser toutes les surbrillances existantes pour s'assurer que rien n'est allumé au chargement
            document.querySelectorAll('.level-box').forEach(box => {
                box.style.animation = '';
                box.style.boxShadow = '';
                box.style.background = '';
                box.removeAttribute('data-opm-id');
            });

            // Réinitialiser tous les cercles de niveaux dans le tableau des OPM IDs
            document.querySelectorAll('#opm-ids-list table tr td:last-child .flex-row > div div').forEach(circle => {
                // Récupérer la couleur de base pour cet OPM ID
                const row = circle.closest('tr');
                const opmIdText = row ? row.querySelector('td:nth-child(2) span') : null;
                const opmId = opmIdText ? opmIdText.textContent : null;
                const color = opmId ? getOpmIdColor(opmId) : '59, 130, 246';
                
                circle.style.backgroundColor = `rgba(${color}, 0.15)`;
                circle.style.transform = 'scale(1)';
                circle.style.boxShadow = 'none';
            });
        }
        
        // Fonction pour réinitialiser les surbrillances pour un OPM ID spécifique
        function resetHighlightsForOpmId(opmId) {
            console.log(`Réinitialisation des surbrillances pour OPM ID ${opmId}`);
            
            // Réinitialiser les cercles de niveaux dans le tableau des OPM IDs
            const opmRows = document.querySelectorAll('#opm-ids-list table tr');
            opmRows.forEach(row => {
                const opmIdText = row.querySelector('td:nth-child(2) span');
                if (opmIdText && opmIdText.textContent === opmId) {
                    const levelCircles = row.querySelectorAll('td:last-child .flex-row > div');
                    levelCircles.forEach(levelCircle => {
                        const circle = levelCircle.querySelector('div');
                        if (circle) {
                            // Récupérer la couleur de base pour cet OPM ID
                            const color = getOpmIdColor(opmId);
                            circle.style.backgroundColor = `rgba(${color}, 0.15)`;
                            circle.style.transform = 'scale(1)';
                            circle.style.boxShadow = 'none';
                        }
                    });
                }
            });
            
            // Trouver toutes les cellules qui contiennent cet OPM ID
            const levelBoxes = document.querySelectorAll('.level-box.filled');
            levelBoxes.forEach(box => {
                // Vérifier si cette cellule a des OPM IDs associés
                if (box.dataset.opmId) {
                    const opmIds = box.dataset.opmId.split(',');
                    
                    // Si cette cellule contient l'OPM ID à réinitialiser
                    if (opmIds.includes(opmId)) {
                        // Retirer cet OPM ID de la liste
                        const updatedOpmIds = opmIds.filter(id => id !== opmId);
                        
                        // Si plus aucun OPM ID n'est associé, réinitialiser complètement la cellule
                        if (updatedOpmIds.length === 0) {
                            box.style.animation = '';
                            box.style.boxShadow = '';
                            box.style.background = '';
                            box.removeAttribute('data-opm-id');
                        } else {
                            // Sinon, mettre à jour la liste des OPM IDs
                            box.dataset.opmId = updatedOpmIds.join(',');
                            
                            // Filtrer pour ne garder que les OPM IDs actifs (cases cochées)
                            const activeOpmIds = updatedOpmIds.filter(id => {
                                const config = window.specialOpmConfigs.find(cfg => cfg.opmId === id);
                                return config && config.isPresent;
                            });
                            
                            // Appliquer un dégradé avec les couleurs des OPM IDs restants actifs
                            if (activeOpmIds.length > 0) {
                                // Créer un dégradé avec toutes les couleurs des OPM IDs actifs restants
                                let gradientColors = [];
                                let boxShadowColors = [];
                                
                                activeOpmIds.forEach((id, index) => {
                                    const opmConfig = specialOpmConfigs.find(cfg => cfg.opmId === id);
                                    if (opmConfig && opmConfig.isPresent) {
                                        // Calculer la position du gradient pour cette couleur
                                        const position = Math.round((index / Math.max(1, activeOpmIds.length - 1)) * 100);
                                        gradientColors.push(`rgba(${opmConfig.color}, 0.8) ${position}%`);
                                        boxShadowColors.push(`rgba(${opmConfig.color}, 0.5)`);
                                    }
                                });
                                
                                // Appliquer un dégradé multi-couleurs
                                if (gradientColors.length > 1) {
                                    box.style.background = `linear-gradient(135deg, ${gradientColors.join(', ')})`;
                                    // Utiliser la première couleur pour l'ombre
                                    box.style.boxShadow = `0 0 8px ${boxShadowColors[0]}`;
                                } else if (gradientColors.length === 1) {
                                    // S'il ne reste qu'une seule couleur
                                    const lastOpmId = activeOpmIds[0];
                                    const activeConfig = specialOpmConfigs.find(cfg => cfg.opmId === lastOpmId);
                                    if (activeConfig) {
                                        box.style.background = `linear-gradient(135deg, rgb(${activeConfig.color}), rgba(${activeConfig.color}, 0.8))`;
                                        box.style.boxShadow = `0 0 8px rgba(${activeConfig.color}, 0.9)`;
                                    }
                                } else {
                                    // Aucun OPM ID actif restant
                                    box.style.animation = '';
                                    box.style.boxShadow = '';
                                    box.style.background = '';
                                }
                            } else {
                                // Aucun OPM ID actif restant
                                box.style.animation = '';
                                box.style.boxShadow = '';
                                box.style.background = '';
                            }
                        }
                    }
                }
            });
        }
        
        // Fonction auxiliaire pour obtenir les niveaux à mettre en surbrillance pour un OPM ID
        function getLevelsForOpmId(opmId) {
            switch(opmId) {
                case '901': return [7];
                case '722': return [5, 6];
                case '723': return [5, 6];
                case '752': return [6];
                case '661': return [3, 4, 5];
                case '622': return [3, 4, 5];
                case '631': return [3, 4, 5];
                case '461': return [3, 4, 5];
                case '511': return [2, 3, 4, 5];
                case '521': return [1, 2, 3, 4, 5];
                case '531': return [2, 3, 4, 5];
                case '541': return [2, 3, 4, 5];
                case '121': return [3, 4, 5];
                case '141': return [3, 4, 5];
                case '111': return [3, 4, 5];
                case '112': return [4, 5];
                case '443': return [3, 4, 5];
                case '151': return [4, 5];
                case '331': return [5, 6];
                case '332': return [5, 6];
                case '132': return [3, 4, 5];
                case '333': return [5, 6];
                case '334': return [3, 4, 5];
                case '131': return [3, 4, 5];
                case '321': return [3, 4, 5];
                case '221': return [3, 4, 5];
                case '211': return [3, 4, 5];
                case '212': return [3, 4, 5];
                case '651': return [5, 6];
                case '652': return [4, 5, 6];
                case '621': return [2, 3, 4, 5];
                case '641': return [3, 4, 5];
                case '671': return [3, 4];
                case '632': return [3, 4, 5];
                case '411': return [2, 3, 4];
                case '451': return [1, 2, 3, 4];
                case '441': return [2, 3, 4];
                case '803': return [3, 4, 5];
                case '801': return [6];
                case '802': return [4, 5, 6];
                case '804': return [5, 6];
                case '312': return [5, 6];
                case '421': return [2, 3, 4, 5];
                case '422': return [2, 3, 4, 5];
                case '612': return [3, 4, 5];
                case '805': return [3, 4, 5];
                case '731': return [4, 5];
                case '732': return [4, 5, 6];
                case '751': return [4, 5, 6];
                case '711': return [4, 5];
                case '712': return [3, 4, 5];
                case '311': return [5, 6];
                case '431': return [2, 3, 4, 5];
                case '611': return [6, 7];
                default: return [5, 6];
            }
        }
        
        // Fonction auxiliaire pour obtenir la couleur d'un OPM ID
        function getOpmIdColor(opmId) {
            // Ce mapping est basé sur les couleurs définies plus haut dans le code
            const opmIdColors = {
                // IT (Cyberspace) - Bleu
                '411': '2, 125, 184',
                '421': '2, 125, 184',
                '431': '2, 125, 184',
                '441': '2, 125, 184',
                '451': '2, 125, 184',
                '632': '2, 125, 184',
                '641': '2, 125, 184',
                '651': '2, 125, 184',
                '661': '2, 125, 184',
                '671': '2, 125, 184',
                '711': '2, 125, 184',
                
                // Cybersecurity - Vert
                '212': '94, 151, 49',
                '462': '94, 151, 49',
                '511': '94, 151, 49',
                '521': '94, 151, 49',
                '531': '94, 151, 49',
                '541': '94, 151, 49',
                '611': '94, 151, 49',
                '612': '94, 151, 49',
                '622': '94, 151, 49',
                '631': '94, 151, 49',
                '652': '94, 151, 49',
                '722': '94, 151, 49',
                '723': '94, 151, 49',
                
                // Cyberspace Effects - Orange
                '121': '255, 145, 3',
                '122': '255, 145, 3',
                '131': '255, 145, 3',
                '132': '255, 145, 3',
                '133': '255, 145, 3',
                '322': '255, 145, 3',
                '332': '255, 145, 3',
                '341': '255, 145, 3',
                '442': '255, 145, 3',
                '443': '255, 145, 3',
                '463': '255, 145, 3',
                
                // Intelligence (Cyberspace) - Jaune
                '111': '255, 204, 2',
                '112': '255, 204, 2',
                '141': '255, 204, 2',
                '151': '255, 204, 2',
                '311': '255, 204, 2',
                '312': '255, 204, 2',
                '331': '255, 204, 2',
                '333': '255, 204, 2',
                
                // Cyberspace Enablers - Mauve
                '211': '153, 86, 206',
                '221': '153, 86, 206',
                '712': '153, 86, 206',
                '731': '153, 86, 206',
                '732': '153, 86, 206',
                '751': '153, 86, 206',
                '752': '153, 86, 206',
                '801': '153, 86, 206',
                '802': '153, 86, 206',
                '803': '153, 86, 206',
                '804': '153, 86, 206',
                '805': '153, 86, 206',
                '901': '153, 86, 206',
                
                // Software Engineering - Rouge
                '461': '214, 39, 40',
                '621': '214, 39, 40',
                '625': '214, 39, 40',
                '626': '214, 39, 40',
                '627': '214, 39, 40',
                '628': '214, 39, 40',
                '673': '214, 39, 40',
                '806': '214, 39, 40',
                
                // Data/AI - Turquoise
                '422': '23, 190, 207',
                '423': '23, 190, 207',
                '424': '23, 190, 207',
                '623': '23, 190, 207',
                '624': '23, 190, 207',
                '653': '23, 190, 207',
                '672': '23, 190, 207',
                '733': '23, 190, 207',
                '753': '23, 190, 207',
                '902': '23, 190, 207',
                '903': '23, 190, 207'
            };
            
            return opmIdColors[opmId] || '59, 130, 246'; // Couleur par défaut si non trouvée
        }
        
        // Ajouter une animation de clignotement
        const styleElement = document.createElement('style');
        styleElement.textContent = `
            @keyframes blink-animation {
                0% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.6; transform: scale(1.15); }
                100% { opacity: 1; transform: scale(1); }
            }
        `;
        document.head.appendChild(styleElement);
        
        // Exécuter une fois que les OPM IDs ont été chargés
        // On utilise un MutationObserver pour détecter quand le contenu du opm-ids-list est modifié
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' && mutation.target.id === 'opm-ids-list') {
                    handleSpecialOpmBehavior();
                    
                    // Ajouter un message informatif pour indiquer à l'utilisateur comment activer les surbrillances
                    const opmIdsContainer = document.getElementById('opm-ids-container');
                    if (opmIdsContainer) {
                        // Supprimer d'abord tous les messages d'information existants
                        const existingInfoMessages = opmIdsContainer.querySelectorAll('.info-message');
                        existingInfoMessages.forEach(msg => msg.remove());
                        
                        // Ajouter un seul message d'information, seulement s'il n'existe pas déjà
                        if (opmIdsContainer.querySelector('.info-message') === null) {
                            const infoMessage = document.createElement('div');
                            infoMessage.className = 'text-sm text-blue-600 mt-4 p-3 bg-blue-50 rounded-md border border-blue-200 info-message';
                            infoMessage.innerHTML = `
                                <p><svg class="inline-block h-5 w-5 mr-1 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
                                </svg>Cochez les cases à côté des OPM IDs pour activer leur mise en surbrillance dans le tableau.</p>
                            `;
                            opmIdsContainer.appendChild(infoMessage);
                        }
                    }
                }
            });
        });
        
        // Observer les changements dans l'élément opm-ids-list
        const opmIdsList = document.getElementById('opm-ids-list');
        if (opmIdsList) {
            observer.observe(opmIdsList, { childList: true });
            
            // Exécuter également immédiatement au cas où le contenu est déjà chargé
            setTimeout(handleSpecialOpmBehavior, 1000);
        }

        // Charger les OPM IDs au chargement de la page
        loadOpmIdsFromSavedSelection();

        // Au lieu d'appliquer immédiatement les surbrillances, nous allons désormais
        // vérifier si les cases à cocher correspondantes sont cochées.
        // Cette fonction sera appelée chaque fois qu'une case à cocher change d'état.
        window.updateOpmHighlights = function(opmId, isChecked) {
            // Créer le tooltip s'il n'existe pas
            if (!document.getElementById('custom-tooltip')) {
                const tooltip = document.createElement('div');
                tooltip.id = 'custom-tooltip';
                document.body.appendChild(tooltip);
            }
            
            // Fonction pour ajouter des tooltips à une cellule
            function setupTooltip(cell, skillName, skillCode, level, description) {
                // Stocker les informations nécessaires au tooltip
                cell.dataset.skillName = skillName;
                cell.dataset.skillCode = skillCode;
                cell.dataset.level = level;
                cell.dataset.description = description || "Compétence requise pour ce rôle";
                
                // Ajouter des gestionnaires d'événements directs
                cell.onmouseenter = function() {
                    const tooltip = document.getElementById('custom-tooltip');
                    if (!tooltip) return;
                    
                    // Récupérer tous les OPM IDs associés à cette cellule
                    const cellOpmIds = this.dataset.opmId ? this.dataset.opmId.split(',') : [];
                    if (cellOpmIds.length === 0) return;
                    
                    // Construire les badges pour chaque OPM ID
                    let opmIdBadges = '';
                    cellOpmIds.forEach(id => {
                        const opmConfig = specialOpmConfigs.find(cfg => cfg.opmId === id);
                        if (opmConfig && opmConfig.isPresent) {
                            opmIdBadges += `<span class="tooltip-badge" style="background-color: rgba(${opmConfig.color}, 0.8);">OPM ID: ${id}</span>`;
                        }
                    });
                    
                    if (opmIdBadges === '') return; // Ne pas afficher le tooltip s'il n'y a pas d'OPM IDs actifs
                    
                    // Construire le contenu du tooltip
                    const tooltipContent = `
                        <div class="tooltip-title">${this.dataset.skillName} (${this.dataset.skillCode})</div>
                        <div class="tooltip-badges">
                            ${opmIdBadges}
                            <span class="tooltip-badge">Niveau: ${this.dataset.level}</span>
                        </div>
                        <div class="tooltip-info">
                            <strong>Description:</strong> ${this.dataset.description}
                        </div>
                    `;
                    
                    // Afficher le tooltip
                    tooltip.innerHTML = tooltipContent;
                    tooltip.classList.add('visible');
                    
                    // Positionner le tooltip
                    const rect = this.getBoundingClientRect();
                    tooltip.style.left = (rect.right + 15) + 'px';
                    tooltip.style.top = rect.top + 'px';
                    
                    // Vérifier si le tooltip dépasse à droite
                    setTimeout(() => {
                        const tooltipRect = tooltip.getBoundingClientRect();
                        if (tooltipRect.right > window.innerWidth) {
                            tooltip.style.left = (rect.left - tooltipRect.width - 15) + 'px';
                        }
                    }, 0);
                };
                
                cell.onmouseleave = function() {
                    const tooltip = document.getElementById('custom-tooltip');
                    if (tooltip) {
                        tooltip.classList.remove('visible');
                    }
                };
            }
            
            // Trouver la configuration pour cet OPM ID
            const config = specialOpmConfigs.find(cfg => cfg.opmId === opmId);
            if (!config) return;
            
            // Mise à jour de l'état de présence basé sur la case à cocher
            config.isPresent = isChecked;
            
            // Vérifier si la case à cocher est cochée
            const checkbox = document.querySelector(`.opm-checkbox[data-opm-id="${opmId}"]`);
            if (checkbox && !checkbox.checked) {
                // Si la case n'est pas cochée, réinitialiser les surbrillances pour cet OPM ID
                resetHighlightsForOpmId(opmId);
                return; // Sortir de la fonction sans appliquer de nouvelles surbrillances
            }
            
            // Si la case est cochée, ne pas réinitialiser d'abord pour éviter le clignotement
            // Appliquer directement les nouvelles surbrillances
            if (isChecked) {
                // 1. Mettre en surbrillance les cercles de niveaux dans le tableau des OPM IDs
                const opmRows = document.querySelectorAll('#opm-ids-list table tr');
                opmRows.forEach(row => {
                    const opmIdText = row.querySelector('td:nth-child(2) span'); // Ajusté pour la nouvelle structure avec case à cocher
                    if (opmIdText && opmIdText.textContent === opmId) {
                        // Accéder aux cercles de niveau dans la cellule des niveaux
                        const levelCircles = row.querySelectorAll('td:last-child .flex-row > div');
                        
                        // Déterminer les niveaux à mettre en surbrillance basés sur l'OPM ID
                        const levelsToHighlight = getLevelsForOpmId(opmId);
                        
                        levelsToHighlight.forEach(level => {
                            const levelIndex = level - 1; // Convertir niveau à index 0-based
                            if (levelIndex >= 0 && levelIndex < levelCircles.length) {
                                const levelCircle = levelCircles[levelIndex];
                                const circle = levelCircle.querySelector('div');
                                if (circle) {
                                    circle.style.backgroundColor = `rgba(${config.color}, 0.8)`;
                                    circle.style.transform = 'scale(1.2)';
                                    circle.style.boxShadow = `0 0 5px rgba(${config.color.split(',')[0]}, ${config.color.split(',')[1]}, ${config.color.split(',')[2]}, 0.7)`;
                                    circle.style.transition = 'all 0.3s ease';
                                }
                            }
                        });
                    }
                });
                
                // 2. Mettre en surbrillance les cellules des compétences spécifiques
                const targetSkillRows = document.querySelectorAll('.skill-row');
                targetSkillRows.forEach(row => {
                    const codeElement = row.querySelector('.skill-code');
                    
                    // Vérifier si cette compétence est dans la liste des compétences spéciales pour cet OPM ID
                    if (codeElement) {
                        const competenceConfig = config.competences.find(comp => 
                            comp.code === codeElement.textContent.trim()
                        );
                        
                        if (competenceConfig) {
                            const skillCode = codeElement.textContent.trim();
                            const skillName = row.querySelector('.skill-name').textContent.trim();
                            
                            // Obtenir les level-box pour cette compétence
                            const levelBoxes = row.querySelectorAll('.level-boxes .level-box');
                            
                            // Parcourir chaque niveau spécifié dans la configuration
                            competenceConfig.levels.forEach(level => {
                                const levelIndex = parseInt(level) - 1; // Convertir niveau à index 0-based
                                if (levelIndex >= 0 && levelIndex < levelBoxes.length) {
                                    const levelBox = levelBoxes[levelIndex];
                                    
                                    // Vérifier si ce level-box a la classe 'filled'
                                    if (levelBox.classList.contains('filled')) {
                                        // Vérifier si la cellule a déjà des attributs OPM ID
                                        let currentOpmIds = levelBox.dataset.opmId ? levelBox.dataset.opmId.split(',') : [];
                                        
                                        // Ajouter cet OPM ID s'il n'est pas déjà présent
                                        if (!currentOpmIds.includes(opmId)) {
                                            currentOpmIds.push(opmId);
                                            levelBox.dataset.opmId = currentOpmIds.join(',');
                                        }
                                        
                                        // Ajouter une animation de clignotement si elle n'existe pas déjà
                                        if (!levelBox.style.animation || levelBox.style.animation === '') {
                                            levelBox.style.animation = 'blink-animation 1.5s infinite';
                                        }
                                        
                                        // Filtrer pour ne garder que les OPM IDs actifs
                                        const activeOpmIds = currentOpmIds.filter(id => {
                                            const cfg = specialOpmConfigs.find(c => c.opmId === id);
                                            return cfg && cfg.isPresent;
                                        });
                                        
                                        // Appliquer les styles de surbrillance avec fusion des couleurs
                                        if (activeOpmIds.length > 1) {
                                            // Créer un dégradé avec toutes les couleurs des OPM IDs actifs
                                            let gradientColors = [];
                                            let boxShadowColors = [];
                                            
                                            activeOpmIds.forEach((id, index) => {
                                                const opmConfig = specialOpmConfigs.find(cfg => cfg.opmId === id);
                                                if (opmConfig && opmConfig.isPresent) {
                                                    // Calculer la position du gradient pour cette couleur
                                                    const position = Math.round((index / (activeOpmIds.length - 1)) * 100);
                                                    gradientColors.push(`rgba(${opmConfig.color}, 0.8) ${position}%`);
                                                    boxShadowColors.push(`rgba(${opmConfig.color}, 0.5)`);
                                                }
                                            });
                                            
                                            // Appliquer un dégradé multi-couleurs
                                            if (gradientColors.length > 1) {
                                                levelBox.style.background = `linear-gradient(135deg, ${gradientColors.join(', ')})`;
                                                // Utiliser la première couleur pour l'ombre
                                                levelBox.style.boxShadow = `0 0 8px ${boxShadowColors[0]}`;
                                            } else if (gradientColors.length === 1) {
                                                // Fallback si une seule couleur est disponible
                                                levelBox.style.background = `linear-gradient(135deg, rgb(${config.color}), rgba(${config.color}, 0.8))`;
                                                levelBox.style.boxShadow = `0 0 8px rgba(${config.color}, 0.9)`;
                                            }
                                        } else if (activeOpmIds.length === 1) {
                                            // Style standard pour une seule couleur
                                            levelBox.style.boxShadow = `0 0 8px rgba(${config.color}, 0.9)`;
                                            levelBox.style.background = `linear-gradient(135deg, rgb(${config.color}), rgba(${config.color}, 0.8))`;
                                        }
                                        
                                        // Configurer le tooltip pour cette cellule
                                        setupTooltip(levelBox, skillName, skillCode, level, competenceConfig.description);
                                    }
                                }
                            });
                        }
                    }
                });
            }
        }

        window.addEventListener('load', function() {
            // Initialiser les configurations OPM
            handleSpecialOpmBehavior();
            
            // Récupérer les états des cases à cocher depuis localStorage
            let checkboxStates = {};
            try {
                checkboxStates = JSON.parse(localStorage.getItem('opmCheckboxStates') || '{}');
                console.log('États des cases à cocher récupérés:', checkboxStates);
            } catch (e) {
                console.error('Erreur lors de la récupération des états des cases à cocher:', e);
            }
            
            // Appliquer les états des cases à cocher et les surbrillances correspondantes
            document.querySelectorAll('.opm-checkbox').forEach(checkbox => {
                const opmId = checkbox.dataset.opmId;
                
                // Appliquer l'état sauvegardé s'il existe, sinon cocher par défaut
                if (opmId in checkboxStates) {
                    checkbox.checked = checkboxStates[opmId];
                } else {
                    checkbox.checked = true; // Par défaut, toutes les cases sont cochées
                    
                    // Sauvegarder l'état par défaut
                    try {
                        checkboxStates[opmId] = true;
                        localStorage.setItem('opmCheckboxStates', JSON.stringify(checkboxStates));
                    } catch (e) {
                        console.error('Erreur lors de la sauvegarde de l\'état par défaut:', e);
                    }
                }
                
                // Mettre à jour l'état dans la configuration
                if (window.specialOpmConfigs) {
                    const config = window.specialOpmConfigs.find(cfg => cfg.opmId === opmId);
                    if (config) {
                        config.isPresent = checkbox.checked;
                    }
                }
                
                // Appliquer la surbrillance si la case est cochée
                if (checkbox.checked && window.updateOpmHighlights) {
                    window.updateOpmHighlights(opmId, true);
                }
            });
            
            // Supprimer tous les messages d'information existants
            document.querySelectorAll('.info-message').forEach(msg => msg.remove());
            
            // Ajouter un message informatif
            const opmIdsContainer = document.getElementById('opm-ids-container');
            if (opmIdsContainer) {
                const infoMessage = document.createElement('div');
                infoMessage.className = 'text-sm text-blue-600 mt-4 p-3 bg-blue-50 rounded-md border border-blue-200 info-message';
                infoMessage.innerHTML = `
                    <p><svg class="inline-block h-5 w-5 mr-1 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
                    </svg>Cochez ou décochez les cases pour afficher ou masquer les surbrillances des OPM IDs.</p>
                `;
                opmIdsContainer.appendChild(infoMessage);
            }
            
            console.log('Initialisation terminée: les surbrillances ont été appliquées selon les états sauvegardés');
            
            // Configurer les tooltips après un court délai pour s'assurer que les modifications DOM sont appliquées
            setTimeout(() => {
                if (typeof setupAllTooltips === 'function') {
                    setupAllTooltips();
                }
            }, 500);
        });

        // Fonction pour réappliquer toutes les surbrillances actives
        function reapplyAllActiveHighlights() {
            // Réappliquer sans log pour éviter de polluer la console
            document.querySelectorAll('.opm-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    const opmId = checkbox.dataset.opmId;
                    if (opmId && window.updateOpmHighlights) {
                        window.updateOpmHighlights(opmId, true);
                    }
                }
            });
        }
        
        // Réappliquer toutes les surbrillances actives plus fréquemment pour éviter les coupures visibles
        setInterval(reapplyAllActiveHighlights, 200);
        
        // Protection contre la désactivation des surbrillances
        // Observer les changements sur les cellules pour détecter les réinitialisations non désirées
        const highlightObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && 
                   (mutation.attributeName === 'style' || mutation.attributeName === 'data-opm-id')) {
                    const target = mutation.target;
                    if (target.classList.contains('level-box') && target.classList.contains('filled')) {
                        // Vérifier si la cellule a des OPM IDs associés
                        const opmIds = target.dataset.opmId ? target.dataset.opmId.split(',') : [];
                        if (opmIds.length > 0) {
                            // Vérifier si au moins un OPM ID a sa case à cocher activée
                            const hasActiveOpmId = opmIds.some(id => {
                                const checkbox = document.querySelector(`.opm-checkbox[data-opm-id="${id}"]`);
                                return checkbox && checkbox.checked;
                            });
                            
                            // Si la cellule devrait être en surbrillance mais ne l'est pas, réappliquer
                            if (hasActiveOpmId && 
                               (!target.style.background || !target.style.boxShadow || 
                                target.style.background === '' || target.style.boxShadow === '')) {
                                // Réappliquer immédiatement la surbrillance
                                reapplyAllActiveHighlights();
                            }
                        }
                    }
                }
            });
        });
        
        // Observer les changements sur toutes les cellules
        document.querySelectorAll('.level-box.filled').forEach(box => {
            highlightObserver.observe(box, { 
                attributes: true, 
                attributeFilter: ['style', 'data-opm-id'] 
            });
        });
    });

    // Fonction pour appliquer le filtrage des lignes de compétences basé sur les OPM IDs sélectionnés
    function applySkillRowsFiltering() {
        console.log('Application du filtrage des lignes de compétences...');
        
        // Récupérer tous les OPM IDs qui ont leur case de filtrage cochée
        const selectedOpmIds = [];
        document.querySelectorAll('.opm-filter-checkbox').forEach(checkbox => {
            if (checkbox.checked) {
                selectedOpmIds.push(checkbox.dataset.opmId);
            }
        });
        
        console.log('OPM IDs sélectionnés pour le filtrage:', selectedOpmIds);
        
        // Si aucun OPM ID n'est sélectionné, afficher toutes les lignes
        if (selectedOpmIds.length === 0) {
            document.querySelectorAll('.category-container, .subcategory, .skill-row').forEach(element => {
                if (element.style.display === 'none') {
                    element.style.display = '';
                }
            });
            console.log('Aucun OPM ID sélectionné, toutes les lignes sont affichées');
            return;
        }
        
        // Garder trace des lignes de compétences, sous-catégories et catégories qui ont des compétences visibles
        const visibleSkillRows = new Set();
        const visibleSubcategories = new Set();
        const visibleCategories = new Set();
        
        // Première passe : identifier les lignes de compétences qui contiennent des OPM IDs sélectionnés
        document.querySelectorAll('.level-box.filled[data-opm-id]').forEach(box => {
            const boxOpmIds = box.dataset.opmId ? box.dataset.opmId.split(',') : [];
            
            // Si au moins un des OPM IDs de cette cellule est dans la liste des OPM IDs sélectionnés
            if (boxOpmIds.some(id => selectedOpmIds.includes(id))) {
                // Trouver la ligne de compétence parente
                const skillRow = box.closest('.skill-row');
                if (skillRow) {
                    visibleSkillRows.add(skillRow);
                }
            }
        });
        
        // Deuxième passe : pour chaque ligne de compétence visible, déterminer sa sous-catégorie et catégorie
        visibleSkillRows.forEach(skillRow => {
            // Trouver la sous-catégorie parente
            const subcategory = skillRow.closest('.subcategory');
            if (subcategory) {
                visibleSubcategories.add(subcategory);
                
                // Trouver la catégorie parente
                const category = subcategory.closest('.category-container');
                if (category) {
                    visibleCategories.add(category);
                }
            }
        });
        
        // Troisième passe : masquer toutes les lignes de compétences, puis afficher uniquement celles qui sont visibles
        document.querySelectorAll('.skill-row').forEach(row => {
            row.style.display = visibleSkillRows.has(row) ? '' : 'none';
        });
        
        // Quatrième passe : masquer toutes les sous-catégories, puis afficher uniquement celles qui sont visibles
        document.querySelectorAll('.subcategory').forEach(subcategory => {
            subcategory.style.display = visibleSubcategories.has(subcategory) ? '' : 'none';
        });
        
        // Cinquième passe : masquer toutes les catégories, puis afficher uniquement celles qui sont visibles
        document.querySelectorAll('.category-container').forEach(category => {
            category.style.display = visibleCategories.has(category) ? '' : 'none';
        });
        
        console.log('Filtrage des lignes terminé');
    }

    window.addEventListener('load', function() {
        // Initialiser les configurations OPM
        handleSpecialOpmBehavior();
        
        // Récupérer les états des cases à cocher depuis localStorage
        let checkboxStates = {};
        try {
            checkboxStates = JSON.parse(localStorage.getItem('opmCheckboxStates') || '{}');
            console.log('États des cases à cocher récupérés:', checkboxStates);
        } catch (e) {
            console.error('Erreur lors de la récupération des états des cases à cocher:', e);
        }
        
        // Appliquer les états des cases à cocher et les surbrillances correspondantes
        document.querySelectorAll('.opm-checkbox').forEach(checkbox => {
            const opmId = checkbox.dataset.opmId;
            
            // Appliquer l'état sauvegardé s'il existe, sinon cocher par défaut
            if (opmId in checkboxStates) {
                checkbox.checked = checkboxStates[opmId];
            } else {
                checkbox.checked = true; // Par défaut, toutes les cases sont cochées
                
                // Sauvegarder l'état par défaut
                try {
                    checkboxStates[opmId] = true;
                    localStorage.setItem('opmCheckboxStates', JSON.stringify(checkboxStates));
                } catch (e) {
                    console.error('Erreur lors de la sauvegarde de l\'état par défaut:', e);
                }
            }
            
            // Mettre à jour l'état dans la configuration
            if (window.specialOpmConfigs) {
                const config = window.specialOpmConfigs.find(cfg => cfg.opmId === opmId);
                if (config) {
                    config.isPresent = checkbox.checked;
                }
            }
            
            // Appliquer la surbrillance si la case est cochée
            if (checkbox.checked && window.updateOpmHighlights) {
                window.updateOpmHighlights(opmId, true);
            }
        });
        
        // Supprimer tous les messages d'information existants
        document.querySelectorAll('.info-message').forEach(msg => msg.remove());
        
        // Ajouter un message informatif
        const opmIdsContainer = document.getElementById('opm-ids-container');
        if (opmIdsContainer) {
            const infoMessage = document.createElement('div');
            infoMessage.className = 'text-sm text-blue-600 mt-4 p-3 bg-blue-50 rounded-md border border-blue-200 info-message';
            infoMessage.innerHTML = `
                <p><svg class="inline-block h-5 w-5 mr-1 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
                </svg>Cochez ou décochez les cases pour afficher ou masquer les surbrillances des OPM IDs.</p>
            `;
            opmIdsContainer.appendChild(infoMessage);
        }
        
        console.log('Initialisation terminée: les surbrillances ont été appliquées selon les états sauvegardés');
        
        // Configurer les tooltips après un court délai pour s'assurer que les modifications DOM sont appliquées
        setTimeout(() => {
            if (typeof setupAllTooltips === 'function') {
                setupAllTooltips();
            }
        }, 500);
    });
    </script>
    
    <!-- Élément tooltip qui sera utilisé pour afficher les informations au survol -->
    <div id="custom-tooltip"></div>
    
    <script>
        // Script d'initialisation du tooltip
        document.addEventListener('DOMContentLoaded', function() {
            // S'assurer que le tooltip existe
            let tooltip = document.getElementById('custom-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'custom-tooltip';
                document.body.appendChild(tooltip);
            }
            
            // Fonction pour configurer les tooltips pour toutes les cellules avec un data-opm-id
            function setupAllTooltips() {
                console.log("Configuration des tooltips pour toutes les cellules...");
                
                // Récupérer les états des cases à cocher depuis localStorage
                let checkboxStates = {};
                try {
                    checkboxStates = JSON.parse(localStorage.getItem('opmCheckboxStates') || '{}');
                } catch (e) {
                    console.error('Erreur lors de la récupération des états des cases à cocher:', e);
                }
                
                // Ajouter des gestionnaires d'événements à toutes les cellules qui ont un OPM ID
                document.querySelectorAll('.level-box.filled[data-opm-id]').forEach(box => {
                    box.onmouseenter = function() {
                        const cellOpmIds = this.dataset.opmId.split(',');
                        let opmIdBadges = '';
                        
                        cellOpmIds.forEach(id => {
                            // Vérifier si l'OPM ID est actif (case à cocher cochée)
                            const isActive = id in checkboxStates ? checkboxStates[id] : true;
                            
                            if (isActive) {
                                const opmConfig = window.specialOpmConfigs.find(cfg => cfg.opmId === id);
                                const color = opmConfig ? opmConfig.color : getOpmIdColor(id);
                                opmIdBadges += `<span class="tooltip-badge" style="background-color: rgba(${color}, 0.8);">OPM ID: ${id}</span>`;
                            }
                        });
                        
                        // Ne pas afficher le tooltip si aucun OPM ID n'est actif
                        if (opmIdBadges === '') return;
                        
                        const tooltipContent = `
                            <div class="tooltip-title">${this.dataset.skillName || 'Compétence'} (${this.dataset.skillCode || 'Code'})</div>
                            <div class="tooltip-badges">
                                ${opmIdBadges}
                                <span class="tooltip-badge">Niveau: ${this.dataset.level || '?'}</span>
                            </div>
                            <div class="tooltip-info">
                                <strong>Description:</strong> ${this.dataset.description || 'Compétence requise pour ce rôle'}
                            </div>
                        `;
                        
                        tooltip.innerHTML = tooltipContent;
                        tooltip.classList.add('visible');
                        
                        const rect = this.getBoundingClientRect();
                        tooltip.style.left = (rect.right + 15) + 'px';
                        tooltip.style.top = rect.top + 'px';
                        
                        // Vérifier si le tooltip dépasse à droite
                        setTimeout(() => {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            if (tooltipRect.right > window.innerWidth) {
                                tooltip.style.left = (rect.left - tooltipRect.width - 15) + 'px';
                            }
                        }, 0);
                    };
                    
                    box.onmouseleave = function() {
                        tooltip.classList.remove('visible');
                    };
                });
            }
            
            // Configurer les tooltips immédiatement
            setupAllTooltips();
            
            // Configurer les tooltips après chaque changement de case à cocher
            document.querySelectorAll('.opm-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // Attendre que les modifications DOM soient appliquées
                    setTimeout(setupAllTooltips, 100);
                });
            });
            
            // Observer les changements dans le DOM pour reconfigurer les tooltips
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-opm-id') {
                        setupAllTooltips();
                    }
                });
            });
            
            // Observer les changements d'attributs data-opm-id sur toutes les cellules
            document.querySelectorAll('.level-box.filled').forEach(box => {
                observer.observe(box, { attributes: true });
            });
        });
    </script>


</body>
</html>
