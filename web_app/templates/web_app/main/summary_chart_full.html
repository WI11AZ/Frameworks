{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Align - √âtape 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'js/serverStorage.js' %}"></script>
    <style>
        /* --- STYLES G√âN√âRAUX --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            line-height: 1.2;
            background-color: #f8fafc;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Classe pour masquer visuellement mais garder accessible */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* --- MODE SOMBRE --- */
        body.dark-mode {
            background-color: #1a202c;
            color: #f1f5f9;
        }
        .dark-mode .mx-auto { background-color: #1a202c; }
        .dark-mode .category-container { background-color: #2d3748; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25); }
        .dark-mode .category-header { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
        .dark-mode .skill-name { color: #e2e8f0; }
        .dark-mode .skill-code { color: #a0aec0; }
        .dark-mode .skill-row { border-color: #4a5568; background-color: #2d3748; }
        .dark-mode .skill-row:nth-child(odd) { background-color: #283141; }
        .dark-mode .skill-row:hover { background-color: #374151; }
        .dark-mode .level-box { background-color: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); }
        .dark-mode nav.bg-gray-800 { background-color: #111827; }
        .dark-mode .text-gray-900 { color: #f1f5f9; }
        .dark-mode header.bg-white { background-color: #1f2937; }
        .dark-mode header h1 { color: #f1f5f9; }
        .dark-mode #header-job-number { color: #cbd5e1; }
        .dark-mode #header-job-number-value { color: #60a5fa; }
        .dark-mode #opm-ids-container { background-color: #2d3748; border-color: #4a5568; }
        #darkModeToggle { transition: all 0.2s ease-in-out; }
        #darkModeToggle:hover { transform: scale(1.05); }
        
        /* Styles pour les cartes de r√¥les s√©lectionn√©s depuis Step0 */
        #step0-selected-roles {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            margin-top: 1.5rem;
            text-align: center;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #step0-selected-roles h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: white;
        }

        #selected-roles-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }

        #step0-selected-roles .selected-role-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            transition: all 0.3s ease;
            min-width: 280px;
            max-width: 320px;
            flex: 0 0 auto;
        }

        #step0-selected-roles .selected-role-card:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        #step0-selected-roles .selected-role-card.primary {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.3) 0%, rgba(255, 152, 0, 0.3) 100%);
            border: 2px solid rgba(255, 193, 7, 0.8);
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.4);
        }

        #step0-selected-roles .selected-role-card.primary::before {
            content: '‚≠ê Principal';
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #ffc107;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }

        #step0-selected-roles .selected-role-card .role-opm {
            font-size: 1.25rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 0.5rem;
            text-align: left;
        }

        #step0-selected-roles .selected-role-card .role-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1.3;
            text-align: left;
        }

        #step0-selected-roles .selected-role-card .role-element {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.5rem;
            font-weight: 500;
            text-align: left;
        }
        
        #step0-selected-roles .selected-role-card .role-checkboxes {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
            justify-content: flex-start;
            align-items: center;
        }
        
        #step0-selected-roles .selected-role-card .role-checkboxes label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            user-select: none;
        }
        
        #step0-selected-roles .selected-role-card .role-checkboxes input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: rgba(59, 130, 246, 0.9);
        }
        
        #step0-selected-roles .selected-role-card .role-competences {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        
        #step0-selected-roles .selected-role-card .role-graduation {
            text-align: center;
        }
        
        #step0-selected-roles .selected-role-card .graduation-circle {
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        #step0-selected-roles .selected-role-card .graduation-circle:hover {
            transform: scale(1.1);
            cursor: pointer;
        }

        /* --- GRILLE & CONTENEURS --- */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 15px;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Am√©lioration responsive */
        @media (max-width: 1400px) {
            .categories-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }
        
        @media (max-width: 900px) {
            .categories-grid {
                grid-template-columns: 1fr;
                padding: 10px;
                gap: 15px;
            }
            .category-container {
                min-width: auto;
            }
        }
        .category-container {
            border-radius: 15px;
            overflow: visible;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            min-width: 300px;
            margin-bottom: 20px;
            height: fit-content;
        }
        .category-container:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        /* --- EN-T√äTES --- */
        .category-header {
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 15px 15px 0 0;
        }
        .level-header {
            display: flex;
            padding: 8px 10px;
            font-weight: bold;
            border-bottom-width: 1px;
        }
        .subcategory-header {
            padding: 8px 10px;
            font-weight: 600;
            border-bottom-width: 1px;
            font-size: 12px;
        }

        /* --- LIGNES DE COMP√âTENCES --- */
        .skill-row {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 11px;
            border-radius: 8px;
            margin: 2px 8px;
        }
        .skill-row:last-child { border-bottom: none; }
        .skill-name { flex: 3; padding-right: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .skill-code { flex: 1; font-weight: bold; color: #666; }
        
        /* Styles pour le wizard de s√©lection de niveaux */
        .wizard-active .level-box {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .wizard-active .level-box:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        
        .wizard-active .level-box.selected {
            background-color: #6366f1 !important;
            color: white !important;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.8);
            border: 2px solid #4f46e5;
        }
        
        /* Pas de style de fond pour les skill-row s√©lectionn√©es, uniquement le checkmark */
        
        .skill-code.has-level-selected::after {
            content: '‚úì';
            display: inline-block;
            margin-left: 8px;
            color: #22c55e;
            font-weight: bold;
            font-size: 16px;
            animation: checkmarkAppear 0.3s ease-out;
        }
        
        /* Styles pour la jauge OPM-ID du wizard */
        #wizard-opm-scale {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 0.5rem;
        }
        
        .wizard-opm-item {
            position: relative;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background-color: #e5e7eb;
            color: #6b7280;
            border: 2px solid transparent;
        }
        
        .wizard-opm-item.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-color: #4f46e5;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            transform: scale(1.1);
            z-index: 10;
        }
        
        .wizard-opm-item.completed {
            background-color: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }
        
        .wizard-opm-item::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            transition: width 0.3s ease;
        }
        
        .wizard-opm-item.active::after {
            width: 80%;
        }
        
        @keyframes checkmarkAppear {
            0% { opacity: 0; transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .wizard-active .level-box.selected {
            animation: levelSelected 0.3s ease-out;
        }
        
        @keyframes levelSelected {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Pas de r√©duction d'opacit√© - tous les skills restent visibles et cliquables */
        .wizard-active .skill-row {
            opacity: 1;
        }
        
        /* Styles pour le mode sombre du wizard */
        .dark-mode #level-selection-wizard {
            background: linear-gradient(135deg, #1e293b 0%, #312e81 100%);
            border-color: #4c1d95;
        }
        
        .dark-mode #current-opm-info {
            background-color: #1f2937;
            border-color: #6366f1;
        }
        
        .dark-mode #current-opm-info h3,
        .dark-mode #current-opm-info p {
            color: #e5e7eb;
        }
        
        .dark-mode #current-opm-id,
        .dark-mode #current-average-level {
            color: #818cf8 !important;
        }
        
        .dark-mode .wizard-active .level-box.selected {
            background-color: #818cf8 !important;
        }
        .level-boxes { display: flex; justify-content: flex-end; }
        .level-number, .level-box {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1px;
            font-size: 11px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .level-box:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .level-box.filled { color: white; border: none; }

        /* --- OPM IDs --- */
        #opm-ids-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: white;
        }
        .opm-id-badge {
            display: inline-block;
            padding: 5px 10px;
            margin: 3px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
            background-color: #3b82f6;
        }

        /* --- TH√àMES DE COULEURS PAR CAT√âGORIE --- */
        :root {
            --cat-strategy-architecture-main: #e11d48; --cat-strategy-architecture-dark: #be123c; --cat-strategy-architecture-text: #881337; --cat-strategy-architecture-light-bg: rgba(254, 205, 211, 0.4);
            --cat-dev-implementation-main: #facc15; --cat-dev-implementation-dark: #eab308; --cat-dev-implementation-text: #854d0e; --cat-dev-implementation-light-bg: rgba(254, 249, 195, 0.6);
            --cat-delivery-operation-main: #ea580c; --cat-delivery-operation-dark: #c2410c; --cat-delivery-operation-text: #9a3412; --cat-delivery-operation-light-bg: rgba(255, 237, 213, 0.6);
            --cat-change-transformation-main: #db2777; --cat-change-transformation-dark: #be185d; --cat-change-transformation-text: #9d174d; --cat-change-transformation-light-bg: rgba(252, 231, 243, 0.6);
            --cat-people-skills-main: #0891b2; --cat-people-skills-dark: #0e7490; --cat-people-skills-text: #0c4a6e; --cat-people-skills-light-bg: rgba(224, 242, 254, 0.6);
            --cat-relationships-engagement-main: #16a34a; --cat-relationships-engagement-dark: #15803d; --cat-relationships-engagement-text: #166534; --cat-relationships-engagement-light-bg: rgba(220, 252, 231, 0.6);
        }
        .category-container { --cat-main: #666; --cat-dark: #555; --cat-text: #444; --cat-light-bg: #f0f0f0; }
        .strategy-architecture { --cat-main: var(--cat-strategy-architecture-main); --cat-dark: var(--cat-strategy-architecture-dark); --cat-text: var(--cat-strategy-architecture-text); --cat-light-bg: var(--cat-strategy-architecture-light-bg); }
        .dev-implementation { --cat-main: var(--cat-dev-implementation-main); --cat-dark: var(--cat-dev-implementation-dark); --cat-text: var(--cat-dev-implementation-text); --cat-light-bg: var(--cat-dev-implementation-light-bg); }
        .delivery-operation { --cat-main: var(--cat-delivery-operation-main); --cat-dark: var(--cat-delivery-operation-dark); --cat-text: var(--cat-delivery-operation-text); --cat-light-bg: var(--cat-delivery-operation-light-bg); }
        .change-transformation { --cat-main: var(--cat-change-transformation-main); --cat-dark: var(--cat-change-transformation-dark); --cat-text: var(--cat-change-transformation-text); --cat-light-bg: var(--cat-change-transformation-light-bg); }
        .people-skills { --cat-main: var(--cat-people-skills-main); --cat-dark: var(--cat-people-skills-dark); --cat-text: var(--cat-people-skills-text); --cat-light-bg: var(--cat-people-skills-light-bg); }
        .relationships-engagement { --cat-main: var(--cat-relationships-engagement-main); --cat-dark: var(--cat-relationships-engagement-dark); --cat-text: var(--cat-relationships-engagement-text); --cat-light-bg: var(--cat-relationships-engagement-light-bg); }
        
        .category-header { background: linear-gradient(135deg, var(--cat-main), var(--cat-dark)); box-shadow: 0 2px 4px color-mix(in srgb, var(--cat-dark) 30%, transparent); }
        .level-header { background: color-mix(in srgb, var(--cat-main) 8%, transparent); border-color: color-mix(in srgb, var(--cat-dark) 15%, transparent); }
        .level-number { background-color: color-mix(in srgb, var(--cat-main) 15%, transparent); color: var(--cat-text); }
        .subcategory-header { background: color-mix(in srgb, var(--cat-main) 20%, transparent); border-color: color-mix(in srgb, var(--cat-dark) 25%, transparent); color: var(--cat-text); }
        .skill-row { border-color: color-mix(in srgb, var(--cat-dark) 15%, transparent); }
        .skill-row:nth-child(even) { background-color: var(--cat-light-bg); }
        .skill-row:hover { background-color: color-mix(in srgb, var(--cat-light-bg) 80%, var(--cat-main) 10%); }
        .level-box { background-color: color-mix(in srgb, var(--cat-main) 5%, transparent); border: 1px solid color-mix(in srgb, var(--cat-main) 15%, transparent); }
        .level-box.filled { background: linear-gradient(135deg, var(--cat-main), var(--cat-dark)); box-shadow: 0 2px 4px color-mix(in srgb, var(--cat-dark) 30%, transparent); }
        
        .dark-mode .level-box.filled { background: linear-gradient(135deg, color-mix(in srgb, var(--cat-main) 50%, #000), color-mix(in srgb, var(--cat-dark) 50%, #000)); }
        .dark-mode .category-header { background: linear-gradient(135deg, color-mix(in srgb, var(--cat-main) 60%, #000), color-mix(in srgb, var(--cat-dark) 60%, #000)); }
        .dark-mode .level-header { background: rgba(255, 255, 255, 0.03); border-color: rgba(255, 255, 255, 0.1); }
        .dark-mode .subcategory-header { background: rgba(255, 255, 255, 0.05); color: var(--cat-main); border-color: rgba(255, 255, 255, 0.1); }
        
        /* --- MODAL --- */
        #modal-backdrop { transition: opacity 0.3s ease-in-out; }
        #modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }

        /* --- TOOLTIP PERSONNALIS√â --- */
        #custom-tooltip {
            position: fixed;
            z-index: 9999;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 4px;
            font-size: 13px;
            pointer-events: none;
            max-width: 300px;
            opacity: 0;
            display: none;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #custom-tooltip.visible {
            opacity: 1;
            display: block;
        }
        .dark-mode #custom-tooltip {
            background-color: rgba(30, 41, 59, 0.95);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .tooltip-title {
            font-weight: bold;
            margin-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 4px;
        }
        .tooltip-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 5px;
        }
        .tooltip-info {
            margin-top: 4px;
        }

        /* Styles pour le tooltip */
        .tooltip {
            position: absolute;
            z-index: 1000;
            background-color: #333;
            color: white;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            padding: 12px;
            max-width: 320px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
        
        .tooltip.visible {
            opacity: 1;
        }
        
        .tooltip-title {
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 1px solid #555;
            padding-bottom: 6px;
            color: white;
        }
        
        .tooltip-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .tooltip-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
            background-color: #666;
        }
        
        .tooltip-info {
            font-size: 0.9em;
            margin-top: 4px;
            color: #fff;
        }
        
        .tooltip-info strong {
            font-weight: 600;
            color: #fff;
        }
        
        /* Animation de clignotement */
        @keyframes blink-animation {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.15); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes holographic {
            0% { 
                opacity: 0.85; 
                transform: scale(1) perspective(500px) rotateY(-3deg);
                text-shadow: 0 0 6px #00ffff, 0 0 10px #00ffff, 0 0 14px rgba(183, 0, 255, 0.6);
                box-shadow: 0 0 10px rgba(0, 255, 255, 0.6), inset 0 0 5px rgba(0, 255, 255, 0.4);
                filter: brightness(0.9) contrast(1.1);
            }
            33% {
                opacity: 0.95;
                transform: scale(1.03) perspective(500px) rotateY(-1deg);
                text-shadow: 0 0 8px #00ffff, 0 0 12px #00ffff, 0 0 16px rgba(183, 0, 255, 0.7);
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.7), inset 0 0 8px rgba(0, 255, 255, 0.5);
                filter: brightness(1.1) contrast(1.2);
            }
            66% { 
                opacity: 1; 
                transform: scale(1.05) perspective(500px) rotateY(1deg);
                text-shadow: 0 0 10px #00ffff, 0 0 15px #00ffff, 0 0 20px rgba(183, 0, 255, 0.8);
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.8), inset 0 0 12px rgba(0, 255, 255, 0.6);
                filter: brightness(1.2) contrast(1.3);
            }
            100% { 
                opacity: 0.9; 
                transform: scale(1) perspective(500px) rotateY(3deg);
                text-shadow: 0 0 8px #00ffff, 0 0 12px #00ffff, 0 0 16px rgba(183, 0, 255, 0.7);
                box-shadow: 0 0 12px rgba(0, 255, 255, 0.7), inset 0 0 7px rgba(0, 255, 255, 0.5);
                filter: brightness(1) contrast(1.2);
            }
        }
    </style>
</head>
<body class="bg-slate-50 p-6">
    <!-- Barre de navigation -->
    <nav class="bg-gray-800 mb-6 -mx-6 -mt-6 px-4">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center">
                    <div class="shrink-0 flex items-center">
                        <span class="mr-2 px-2 py-1 text-sm font-bold text-white rounded" style="border: 1px solid rgba(255, 255, 255, 0.5); text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.6), inset 0 0 10px rgba(0, 255, 255, 0.3); animation: holographic 3s infinite alternate; background: linear-gradient(-45deg, rgba(0, 255, 255, 0.1), rgba(0, 150, 255, 0.2), rgba(183, 0, 255, 0.1));">b√™ta v0.1.2</span>
                        <span class="text-2xl font-bold text-white">Cyber Align</span>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="/" class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Home</a>
                            <a href="#" class="rounded-md px-3 py-2 text-sm font-medium bg-gray-900 text-white flex items-center">
                                Tableau des comp√©tences
                            </a>
                            <a href="/ksat/etape2_first_step" class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">PARTIE 2</a>
                        </div>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-4 flex items-center md:ml-6">
                        <button type="button" id="darkModeToggle" class="relative rounded-full bg-gray-700 p-1.5 text-gray-300 hover:bg-gray-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-gray-800 mr-3">
                            <span class="sr-only">Basculer en mode sombre</span>
                            <svg id="moonIcon" class="size-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                            <svg id="sunIcon" class="hidden size-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                        </button>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="mobile-menu-button" class="relative inline-flex items-center justify-center rounded-md bg-gray-800 p-2 text-gray-400 hover:bg-gray-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-gray-800" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <svg class="block size-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                        <svg class="hidden size-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
        </div>
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="space-y-1 px-2 pb-3 pt-2 sm:px-3">
                <a href="/" class="block rounded-md px-3 py-2 text-base font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Home</a>
                <a href="#" class="block rounded-md px-3 py-2 text-base font-medium bg-gray-900 text-white flex items-center">
                    Tableau des comp√©tences
                </a>
                <a href="/ksat/etape2_first_step" class="block rounded-md px-3 py-2 text-base font-medium text-gray-300 hover:bg-gray-700 hover:text-white">PARTIE 2</a>
            </div>
        </div>
    </nav>

    <div class="mx-auto max-w-full px-4">
        <!-- Titre et description du tableau -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold mb-2">
                SFIA 9 Skills List <span class="text-yellow-500">(Summary Chart)</span>
                <button id="info-button" class="ml-2 inline-flex items-center justify-center p-1 rounded-full bg-blue-500 text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" title="Voir les niveaux de responsabilit√© SFIA">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </h1>
            <p class="text-gray-600 italic">The summary chart shows the list of all SFIA 9 skills and their relevant levels, with links to their descriptions. <a href="https://help.sfia.nz/hc/en-nz/articles/39051117630361-SFIA-9-Skills-List" target="_blank" class="text-blue-600 hover:underline">View official SFIA 9 Skills List</a></p>
        </div>
        
        <!-- Affichage des work roles s√©lectionn√©s depuis Step0 -->
        <div id="step0-selected-roles" class="w-full mb-6" style="display: none;">
            <h3 class="text-xl font-semibold mb-3 text-white">Work Roles s√©lectionn√©s depuis la baseline :</h3>
            <div id="selected-roles-container" class="flex flex-wrap gap-3 justify-center"></div>
            
            <!-- Bouton Start Level Selection en bas √† droite -->
            <div class="flex justify-end mt-6">
                <button id="start-level-selection-btn" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white text-lg font-bold rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    <span>Start Level Selection</span>
                </button>
            </div>
            
            <!-- Contr√¥les du wizard (masqu√©s par d√©faut) -->
            <div id="wizard-controls" class="mt-6 p-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-400 shadow-lg" style="display: none;">
                <!-- Ligne sup√©rieure : Exit button -->
                <div class="flex justify-between items-center mb-4 pb-4 border-b-2 border-indigo-200">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                        <h3 class="text-lg font-bold text-black">Level Selection Wizard</h3>
                    </div>
                    <button id="wizard-exit-btn" class="px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg hover:bg-red-600 transition-all shadow-md flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Exit Wizard
                    </button>
                </div>
                
                <!-- Section OPM-ID et Statistiques -->
                <div class="mb-6 p-4 bg-white rounded-lg border border-indigo-200 shadow-sm">
                    <div class="text-center mb-4">
                        <div class="text-2xl font-bold text-indigo-800 mb-3">
                            OPM-ID: <span id="wizard-current-opm-id" class="text-indigo-600 text-3xl">-</span>
                        </div>
                        
                        <!-- Jauge/√âchelle des OPM-IDs -->
                        <div class="mb-4">
                            <div class="flex items-center justify-center gap-2 flex-wrap" id="wizard-opm-scale">
                                <!-- Les OPM-IDs seront ajout√©s ici dynamiquement -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistiques en cards -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 text-center">
                            <div class="text-xs font-medium text-blue-700 mb-1">Proposed</div>
                            <div class="text-2xl font-bold text-blue-600" id="wizard-proposed-count">0</div>
                        </div>
                        <div class="bg-green-50 border-2 border-green-200 rounded-lg p-3 text-center">
                            <div class="text-xs font-medium text-green-700 mb-1">Selected</div>
                            <div class="text-2xl font-bold text-green-600" id="wizard-selected-count">0</div>
                        </div>
                        <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-3 text-center">
                            <div class="text-xs font-medium text-orange-700 mb-1">Other</div>
                            <div class="text-2xl font-bold text-orange-600" id="wizard-other-count">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Ligne principale : Navigation -->
                <div class="flex justify-between items-center gap-4">
                    <button id="wizard-prev-btn" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-all shadow-md flex items-center gap-2 min-w-[120px] justify-center" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
                        </svg>
                        <span>Previous</span>
                    </button>
                    
                    <div class="flex-1"></div>
                    
                    <button id="wizard-next-btn" class="px-8 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white font-bold rounded-lg hover:from-green-700 hover:to-teal-700 transition-all shadow-lg flex items-center gap-2 min-w-[140px] justify-center">
                        <span id="wizard-btn-text">Next</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- L√©gende Symbology -->
        <div id="symbology-legend" class="mb-6 p-4 bg-amber-50 border-2 border-amber-300 rounded-lg shadow-sm">
            <!-- La l√©gende sera ajout√©e par JavaScript -->
        </div>
        
        <!-- Modal de r√©capitulatif du wizard -->
        <div id="wizard-summary-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
            <div id="wizard-summary-backdrop" class="absolute inset-0 bg-black opacity-50"></div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 m-4 max-w-3xl w-full z-10 relative max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold text-indigo-900 dark:text-indigo-300 mb-4">Level Selection Summary</h2>
                
                <div id="wizard-summary-content" class="mb-6">
                    <!-- Le contenu sera rempli par JavaScript -->
                </div>
                
                <div class="flex justify-end gap-3">
                    <button id="wizard-summary-cancel" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-all">
                        Go Back
                    </button>
                    <button id="wizard-summary-confirm" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg">
                        Save & Continue to Summary
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Toggle View Mode (toujours visible) -->
        <div id="view-mode-container" class="mb-6 p-4 bg-white rounded-lg border-2 border-indigo-200 shadow-sm">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="font-semibold text-indigo-900 mb-1 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        Display Mode
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        <div class="flex items-start">
                            <span class="mr-2">üéØ</span>
                            <div><strong>Focus Mode</strong>: Shows only skills related to the current OPM-ID. Recommended for focused evaluation.</div>
                        </div>
                        <div class="flex items-start">
                            <span class="mr-2">üåê</span>
                            <div><strong>Full View</strong>: Shows all skill tables. Use this to select levels for additional skills outside the current OPM-ID scope.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Toggle switch -->
                <div class="flex items-center gap-3 ml-6 px-4 py-3 bg-indigo-50 rounded-lg">
                    <span class="text-sm font-medium text-gray-700">View Mode:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="wizard-view-toggle" class="sr-only peer">
                        <div class="w-14 h-7 bg-indigo-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-purple-600"></div>
                        <span id="wizard-view-label" class="ml-3 text-base font-bold text-indigo-900">Focus</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Le conteneur de la grille sera rempli par JavaScript -->
        <div id="sfia-grid" class="categories-grid"></div>

        <!-- Bouton pour terminer l'√©tape -->
        <div class="flex justify-center my-8">
            <button id="complete-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">
                Terminer l'√©tape et ajouter un nouveau poste
            </button>
        </div>
    </div>

    <!-- Fen√™tre Modale de Confirmation -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="modal-backdrop" class="absolute inset-0 bg-black opacity-50"></div>
        <div id="modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 m-4 max-w-sm w-full z-10 scale-95 opacity-0">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Confirmation requise</h3>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">Voulez-vous vraiment terminer cette √©tape et d√©marrer un nouveau poste ?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">Annuler</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Ajouter la fen√™tre modale d'information avant la fermeture du body -->
    <!-- Fen√™tre Modale d'Information sur les Niveaux SFIA -->
    <div id="info-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 m-4 max-w-4xl w-full z-10 scale-95 opacity-100 relative overflow-auto max-h-[90vh]">
            <button id="close-info-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white text-center">SFIA 9 Levels of Responsibility</h2>
            
            <div class="bg-blue-600 text-white p-6 rounded-md mb-6">
                <h3 class="text-xl font-bold mb-3 text-center">SFIA 9 Levels of Responsibility (Essence of the levels)</h3>
                <p class="mb-3 text-lg">The <em>essence</em> of the level provides a short summary to help characterise the level.</p>
                <p class="mb-3 text-lg">Successive levels show increasing responsibility, accountability and impact.</p>
                <p class="text-center"><a href="https://help.sfia.nz/hc/en-nz/articles/39048803381273-Levels-of-Responsibility" target="_blank" class="text-white underline hover:text-blue-100">https://help.sfia.nz/hc/en-nz/articles/39048803381273-Levels-of-Responsibility</a></p>
            </div>
            
            <div class="space-y-6">
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 1 - Follow</h4>
                    <p class="mt-2 text-base">Performs routine tasks under close supervision, follows instructions, and requires guidance to complete their work. Learns and applies basic skills and knowledge.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 2 - Assist</h4>
                    <p class="mt-2 text-base">Provides assistance to others, works under routine supervision, and uses their discretion to address routine problems. Actively learns through training and on-the-job experiences.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 3 - Apply</h4>
                    <p class="mt-2 text-base">Performs varied tasks, sometimes complex and non-routine, using standard methods and procedures. Works under general direction, exercises discretion, and manages own work within deadlines. Proactively enhances skills and impact in the workplace.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 4 - Enable</h4>
                    <p class="mt-2 text-base">Performs diverse complex activities, supports and guides others, delegates tasks when appropriate, works autonomously under general direction, and contributes expertise to deliver team objectives.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 5 - Ensure</h4>
                    <p class="mt-2 text-base">Provides authoritative guidance in their field and works under broad direction. Accountable for delivering significant work outcomes, from analysis through execution to evaluation.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 6 - Initiate, influence</h4>
                    <p class="mt-2 text-base">Has significant organisational influence, makes high-level decisions, shapes policies, demonstrates leadership, promotes organisational collaboration, and accepts accountability in key areas.</p>
                </div>
                
                <div class="p-4 border-l-8 border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-white rounded-r-md shadow-md">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-300">Level 7 - Set strategy, inspire, mobilise</h4>
                    <p class="mt-2 text-base">Sets strategy at the highest levels of the organisation, makes decisions with far-reaching implications, and assumes accountability for overall success.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Ajouter la gestion du bouton d'information et de la fen√™tre modale
        document.addEventListener('DOMContentLoaded', function() {
            const infoButton = document.getElementById('info-button');
            const infoModal = document.getElementById('info-modal');
            const closeInfoModal = document.getElementById('close-info-modal');
            
            if (infoButton && infoModal && closeInfoModal) {
                infoButton.addEventListener('click', function() {
                    infoModal.classList.remove('hidden');
                });
                
                closeInfoModal.addEventListener('click', function() {
                    infoModal.classList.add('hidden');
                });
                
                // Fermer la modale en cliquant √† l'ext√©rieur
                infoModal.addEventListener('click', function(e) {
                    if (e.target === infoModal) {
                        infoModal.classList.add('hidden');
                    }
                });
                
                // Fermer la modale avec la touche Echap
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && !infoModal.classList.contains('hidden')) {
                        infoModal.classList.add('hidden');
                    }
                });
            }
        });
    </script>

    <script>
    // --- STRUCTURE DE DONN√âES SFIA ---
    const sfiaData = [
        {
            name: "Strategy and architecture",
            cssClass: "strategy-architecture",
            subcategories: [
                {
                    name: "Strategy and planning",
                    skills: [
                        { name: "Strategic planning", code: "ITSP", levels: [4, 5, 6, 7] },
                        { name: "Information systems coordination", code: "ISCO", levels: [5, 6, 7] },
                        { name: "Information management", code: "IRMG", levels: [3, 4, 5, 6, 7] },
                        { name: "Enterprise and business architecture", code: "STPL", levels: [5, 6, 7] },
                        { name: "Solution architecture", code: "ARCH", levels: [4, 5, 6, 7] },
                        { name: "Innovation management", code: "INOV", levels: [5, 6, 7] },
                        { name: "Emerging technology monitoring", code: "EMRG", levels: [4, 5, 6] },
                        { name: "Formal research", code: "RSCH", levels: [2, 3, 4, 5, 6] },
                        { name: "Sustainability", code: "SUST", levels: [4, 5, 6] }
                    ]
                },
                {
                    name: "Financial and value management",
                    skills: [
                        { name: "Financial management", code: "FMIT", levels: [4, 5, 6] },
                        { name: "Investment appraisal", code: "INVA", levels: [4, 5, 6] },
                        { name: "Benefits management", code: "BENM", levels: [3, 4, 5, 6] },
                        { name: "Budgeting and forecasting", code: "BUDF", levels: [2, 3, 4, 5, 6] },
                        { name: "Financial analysis", code: "FIAN", levels: [2, 3, 4, 5, 6] },
                        { name: "Cost management", code: "COMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Demand management", code: "DEMM", levels: [4, 5, 6] },
                        { name: "Measurement", code: "MEAS", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Security and privacy",
                    skills: [
                        { name: "Information security", code: "SCTY", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Information assurance", code: "INAS", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Information and data compliance", code: "PEDP", levels: [4, 5, 6] },
                        { name: "Vulnerability research", code: "VURE", levels: [2, 3, 4, 5, 6] },
                        { name: "Threat intelligence", code: "THIN", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Governance, risk and compliance",
                    skills: [
                        { name: "Governance", code: "GOVN", levels: [5, 6, 7] },
                        { name: "Risk management", code: "BURM", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Artificial intelligence (AI) and data ethics", code: "AIDE", levels: [3, 4, 5, 6] },
                        { name: "Audit", code: "AUDT", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Quality management", code: "QUMG", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Quality assurance", code: "QUAS", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Advice and guidance",
                    skills: [
                        { name: "Consultancy", code: "CNSL", levels: [4, 5, 6, 7] },
                        { name: "Specialist advice", code: "TECH", levels: [4, 5, 6] },
                        { name: "Methods and tools", code: "METL", levels: [2, 3, 4, 5, 6] }
                    ]
                }
            ]
        },
        {
            name: "Development and implementation",
            cssClass: "dev-implementation",
            subcategories: [
                {
                    name: "Systems development",
                    skills: [
                        { name: "Product management", code: "PROD", levels: [3, 4, 5, 6] },
                        { name: "Systems development management", code: "DLMG", levels: [4, 5, 6, 7] },
                        { name: "Systems and software lifecycle engineering", code: "SLEN", levels: [3, 4, 5, 6, 7] },
                        { name: "Systems design", code: "DESN", levels: [2, 3, 4, 5, 6] },
                        { name: "Software design", code: "SWDN", levels: [2, 3, 4, 5, 6] },
                        { name: "Network design", code: "NTDS", levels: [2, 3, 4, 5, 6] },
                        { name: "Infrastructure design", code: "IFDN", levels: [2, 3, 4, 5, 6] },
                        { name: "Hardware design", code: "HWDE", levels: [2, 3, 4, 5, 6] },
                        { name: "Programming/software development", code: "PROG", levels: [2, 3, 4, 5, 6] },
                        { name: "Systems integration and build", code: "SINT", levels: [2, 3, 4, 5, 6] },
                        { name: "Functional testing", code: "TEST", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Non-functional testing", code: "NFTS", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Process testing", code: "PRTS", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Software configuration", code: "PORT", levels: [2, 3, 4, 5, 6] },
                        { name: "Real-time/embedded systems development", code: "RESD", levels: [2, 3, 4, 5, 6] },
                        { name: "Safety engineering", code: "SFEN", levels: [2, 3, 4, 5, 6] },
                        { name: "Safety assessment", code: "SFAS", levels: [4, 5, 6] },
                        { name: "Radio frequency engineering", code: "RFEN", levels: [2, 3, 4, 5, 6] },
                        { name: "Animation development", code: "ADEV", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Data and analytics",
                    skills: [
                        { name: "Data management", code: "DATM", levels: [2, 3, 4, 5, 6] },
                        { name: "Data modelling and design", code: "DTAN", levels: [2, 3, 4, 5] },
                        { name: "Database design", code: "DBDS", levels: [2, 3, 4, 5] },
                        { name: "Data analytics", code: "DNAN", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Data analytics", code: "DAAN", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Data science", code: "DATS", levels: [2, 3, 4, 5, 6] },
                        { name: "Machine learning", code: "MLNG", levels: [2, 3, 4, 5, 6] },
                        { name: "Business intelligence", code: "BINT", levels: [2, 3, 4, 5] },
                        { name: "Data engineering", code: "DENG", levels: [2, 3, 4, 5, 6] },
                        { name: "Data visualisation", code: "VISL", levels: [2, 3, 4, 5] }
                    ]
                },
                {
                    name: "User centred design",
                    skills: [
                        { name: "User research", code: "URCH", levels: [3, 4, 5, 6] },
                        { name: "Customer experience", code: "CEXP", levels: [2, 3, 4, 5, 6] },
                        { name: "Accessibility and inclusion", code: "ACIN", levels: [2, 3, 4, 5, 6] },
                        { name: "User experience analysis", code: "UNAN", levels: [2, 3, 4, 5] },
                        { name: "User experience design", code: "HCEV", levels: [2, 3, 4, 5, 6] },
                        { name: "User experience evaluation", code: "USEV", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Content management",
                    skills: [
                        { name: "Content design and authoring", code: "INCA", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Content publishing", code: "ICPM", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Knowledge management", code: "KNOW", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Graphic design", code: "GRON", levels: [1, 2, 3, 4, 5] }
                    ]
                },
                {
                    name: "Computational science",
                    skills: [
                        { name: "Scientific modelling", code: "SCMO", levels: [4, 5, 6, 7] },
                        { name: "Numerical analysis", code: "NUAN", levels: [4, 5, 6, 7] },
                        { name: "High-performance computing", code: "HPCC", levels: [4, 5, 6, 7] }
                    ]
                }
            ]
        },
        {
            name: "Delivery and operation",
            cssClass: "delivery-operation",
            subcategories: [
                 {
                    name: "Technology management",
                    skills: [
                        { name: "Technology service management", code: "ITMG", levels: [5, 6, 7] },
                        { name: "Application support", code: "ASUP", levels: [2, 3, 4, 5] },
                        { name: "Infrastructure operations", code: "ITOP", levels: [1, 2, 3, 4, 5] },
                        { name: "System software administration", code: "SYSP", levels: [1, 2, 3, 4, 5] },
                        { name: "Network support", code: "NTAS", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Systems installation and removal", code: "HSIN", levels: [1, 2, 3, 4] },
                        { name: "Configuration management", code: "CFMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Release management", code: "RELM", levels: [2, 3, 4, 5, 6] },
                        { name: "Deployment", code: "DEPL", levels: [2, 3, 4, 5, 6] },
                        { name: "Storage management", code: "STMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Facilities management", code: "DCMA", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Service management",
                    skills: [
                        { name: "Service level management", code: "SLMO", levels: [3, 4, 5, 6, 7] },
                        { name: "Service catalogue management", code: "SCMG", levels: [2, 3, 4, 5] },
                        { name: "Availability management", code: "AVMT", levels: [3, 4, 5, 6] },
                        { name: "Continuity management", code: "COPL", levels: [2, 3, 4, 5, 6] },
                        { name: "Capacity management", code: "CPMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Incident management", code: "USUP", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Problem management", code: "PBMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Change control", code: "CHMG", levels: [2, 3, 4, 5, 6] },
                        { name: "Asset management", code: "ASMG", levels: [2, 3, 4, 5] },
                        { name: "Service acceptance", code: "SEAC", levels: [3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Security services",
                    skills: [
                        { name: "Security operations", code: "SCAD", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Identity and access management", code: "IAMT", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Vulnerability assessment", code: "VUAS", levels: [2, 3, 4, 5] },
                        { name: "Digital forensics", code: "DGFS", levels: [2, 3, 4, 5, 6] },
                        { name: "Cybercrime investigation", code: "CRIM", levels: [2, 3, 4, 5, 6] },
                        { name: "Offensive cyber operations", code: "OCOP", levels: [2, 3, 4, 5, 6] },
                        { name: "Penetration testing", code: "PENT", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Data and records operations",
                    skills: [
                        { name: "Records management", code: "RMGT", levels: [1, 2, 3, 4, 5] },
                        { name: "Analytical classification and coding", code: "ANCC", levels: [2, 3, 4, 5, 6] },
                        { name: "Database administration", code: "DBAD", levels: [2, 3, 4, 5] }
                    ]
                }
            ]
        },
        {
            name: "Change and transformation",
            cssClass: "change-transformation",
            subcategories: [
                {
                    name: "Change implementation",
                    skills: [
                        { name: "Portfolio management", code: "POMG", levels: [5, 6, 7] },
                        { name: "Programme management", code: "PGMG", levels: [6, 7] },
                        { name: "Project management", code: "PRMG", levels: [4, 5, 6, 7] },
                        { name: "Portfolio, programme and project support", code: "PROF", levels: [2, 3, 4, 5, 6] },
                        { name: "Delivery management", code: "DEMG", levels: [] }
                    ]
                },
                {
                    name: "Change analysis",
                    skills: [
                        { name: "Business situation analysis", code: "BUSA", levels: [2, 3, 4, 5, 6] },
                        { name: "Feasibility assessment", code: "FEAS", levels: [2, 3, 4, 5, 6] },
                        { name: "Requirements definition and management", code: "REQM", levels: [2, 3, 4, 5, 6] },
                        { name: "Business modelling", code: "BSMO", levels: [2, 3, 4, 5, 6] },
                        { name: "Business process testing", code: "BPTS", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Change planning",
                    skills: [
                        { name: "Business process improvement", code: "BPRE", levels: [1, 2, 3, 4, 5, 6, 7] },
                        { name: "Organisational capability development", code: "OCDV", levels: [5, 6, 7] },
                        { name: "Job analysis and design", code: "JADN", levels: [3, 4, 5] },
                        { name: "Organisation design and implementation", code: "ORDI", levels: [3, 4, 5, 6, 7] },
                        { name: "Organisational change management", code: "CIPM", levels: [2, 3, 4, 5, 6] },
                        { name: "Organisational change enablement", code: "OCEN", levels: [4, 5, 6] }
                    ]
                }
            ]
        },
        {
            name: "People and skills",
            cssClass: "people-skills",
            subcategories: [
                {
                    name: "People management",
                    skills: [
                        { name: "Performance management", code: "PEMT", levels: [4, 5, 6] },
                        { name: "Employee experience", code: "EEXP", levels: [4, 5, 6] },
                        { name: "Organisational facilitation", code: "OFCL", levels: [4, 5, 6] },
                        { name: "Professional development", code: "PDSV", levels: [4, 5, 6] },
                        { name: "Workforce planning", code: "WFPL", levels: [4, 5, 6] },
                        { name: "Resourcing", code: "RESC", levels: [2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Skills management",
                    skills: [
                        { name: "Learning and development management", code: "ETMG", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Learning design and development", code: "TMCR", levels: [2, 3, 4, 5] },
                        { name: "Learning delivery", code: "ETDL", levels: [2, 3, 4, 5] },
                        { name: "Competency assessment", code: "LEDA", levels: [2, 3, 4, 5, 6] },
                        { name: "Certification scheme operation", code: "CSOP", levels: [2, 3, 4, 5, 6] },
                        { name: "Teaching", code: "TEAC", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Subject formation", code: "SUBF", levels: [4, 5, 6, 7] }
                    ]
                }
            ]
        },
        {
            name: "Relationships and engagement",
            cssClass: "relationships-engagement",
            subcategories: [
                {
                    name: "Stakeholder management",
                    skills: [
                        { name: "Sourcing", code: "SORC", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Supplier management", code: "SUPP", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Contract management", code: "ITCM", levels: [2, 3, 4, 5, 6, 7] },
                        { name: "Stakeholder relationship management", code: "RLMT", levels: [4, 5, 6, 7] },
                        { name: "Customer service support", code: "CSMG", levels: [1, 2, 3, 4, 5, 6] },
                        { name: "Business administration", code: "ADMN", levels: [1, 2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Sales and bid management",
                    skills: [
                        { name: "Bid/proposal management", code: "BIDM", levels: [3, 4, 5, 6] },
                        { name: "Selling", code: "SALE", levels: [3, 4, 5, 6] },
                        { name: "Sales support", code: "SSUP", levels: [1, 2, 3, 4, 5, 6] }
                    ]
                },
                {
                    name: "Marketing",
                    skills: [
                        { name: "Marketing management", code: "MKTG", levels: [4, 5, 6, 7] },
                        { name: "Market research", code: "MRCH", levels: [3, 4, 5, 6] },
                        { name: "Brand management", code: "BRMG", levels: [4, 5, 6] },
                        { name: "Customer engagement and loyalty", code: "CELO", levels: [3, 4, 5, 6] },
                        { name: "Marketing campaign management", code: "MKCM", levels: [3, 4, 5] },
                        { name: "Digital marketing", code: "DIGM", levels: [2, 3, 4, 5] }
                    ]
                }
            ]
        }
    ];

    document.addEventListener('DOMContentLoaded', function() {
        // Fonction pour charger et afficher les s√©lections de Step0
        function loadAndDisplayStep0Selections() {
            return new Promise((resolve, reject) => {
                try {
                    const step0Data = localStorage.getItem('step0_baseline_data');
                    if (!step0Data) {
                        console.log('Aucune donn√©e Step0 trouv√©e');
                        resolve();
                        return;
                    }
                    
                    const data = JSON.parse(step0Data);
                    console.log('Donn√©es Step0 charg√©es:', data);
                    
                    if (!data.selectedWorkRoles || data.selectedWorkRoles.length === 0) {
                        resolve();
                        return;
                    }
                    
                    const container = document.getElementById('selected-roles-container');
                    const sectionDiv = document.getElementById('step0-selected-roles');
                    
                    if (!container || !sectionDiv) {
                        console.error('Conteneur non trouv√©');
                        resolve();
                        return;
                    }
                    
                    // Afficher la section
                    sectionDiv.style.display = 'block';
                    
                    // Cr√©er les cartes pour chaque work role
                    console.log('=== DEBUG Step0 Data ===');
                    console.log('primaryRoleOpmId:', data.primaryRoleOpmId, 'type:', typeof data.primaryRoleOpmId);
                    console.log('selectedWorkRoles:', data.selectedWorkRoles);
                    
                    data.selectedWorkRoles.forEach(role => {
                        // Normaliser role.opm_code en string
                        const roleOpmCode = role.opm_code !== null && role.opm_code !== undefined 
                            ? String(role.opm_code).trim() 
                            : '';
                        const primaryOpmId = data.primaryRoleOpmId !== null && data.primaryRoleOpmId !== undefined
                            ? String(data.primaryRoleOpmId).trim()
                            : '';
                        
                        // Comparaison directe apr√®s normalisation
                        const isPrimary = roleOpmCode !== '' && primaryOpmId !== '' && roleOpmCode === primaryOpmId;
                        
                        console.log(`Role opm_code: "${roleOpmCode}" (type: ${typeof role.opm_code}) vs Primary: "${primaryOpmId}" (type: ${typeof data.primaryRoleOpmId}) -> isPrimary: ${isPrimary}`);
                        
                        const roleCard = document.createElement('div');
                        roleCard.className = `selected-role-card ${isPrimary ? 'primary' : ''}`;
                        roleCard.setAttribute('data-opm-code', role.opm_code);
                        
                        // Ajouter un attribut data pour le d√©bogage
                        if (isPrimary) {
                            roleCard.setAttribute('data-is-primary', 'true');
                            console.log('‚úÖ Carte principale cr√©√©e pour:', roleOpmCode);
                        }
                        
                        const roleName = role.ncwf_work_role || role.dcwf_work_role || 'N/A';
                        const roleElement = role.dcwf_element || role.ncwf_element || '';
                        
                        roleCard.innerHTML = `
                            <div class="role-opm">OPM-ID: ${role.opm_code}</div>
                            <div class="role-name">${roleName}</div>
                            ${roleElement ? `<div class="role-element">${roleElement}</div>` : ''}
                            <div class="role-checkboxes">
                                <label>
                                    <input type="checkbox" class="role-primary-checkbox" data-opm-id="${role.opm_code}" checked>
                                    <span>Primary</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="role-secondary-checkbox" data-opm-id="${role.opm_code}" checked>
                                    <span>Secondary</span>
                                </label>
                            </div>
                            <div class="role-competences mt-3" data-opm-id="${role.opm_code}">
                                <!-- Les badges de comp√©tences seront ajout√©s ici -->
                            </div>
                            <div class="role-graduation mt-3" data-opm-id="${role.opm_code}">
                                <div class="text-xs text-white mb-1 font-semibold">Level:</div>
                                <div class="flex items-center justify-center space-x-1">
                                    ${[1,2,3,4,5,6,7].map(i => `
                                        <div class="graduation-circle w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold border-2 border-white" style="background-color: rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.7);">
                                            ${i}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(roleCard);
                    });
                    
                    // Charger les donn√©es output.json et activer les fonctionnalit√©s Primary/Secondary
                    loadOutputJsonAndSetupRoleCheckboxes().then(() => {
                        resolve();
                    }).catch((e) => {
                        console.error('Erreur lors du chargement de output.json:', e);
                        resolve(); // R√©soudre quand m√™me pour continuer
                    });
                    
                } catch (e) {
                    console.error('Erreur lors du chargement des donn√©es Step0:', e);
                    reject(e);
                }
            });
        }
        
        // Variable globale pour stocker les donn√©es output.json
        window.outputJsonData = null;
        
        // Variable globale pour stocker les donn√©es sfia_skills.json
        window.sfiaSkillsData = null;
        
        // Fonction pour charger output.json et configurer les checkboxes Primary/Secondary
        async function loadOutputJsonAndSetupRoleCheckboxes() {
            try {
                // Charger le fichier output.json via l'API Django
                const response = await fetch('{% url "output_json" %}');
                if (!response.ok) {
                    console.error('Erreur lors du chargement de output.json:', response.statusText);
                    return Promise.resolve();
                }
                const data = await response.json();
                window.outputJsonData = data;
                console.log('Donn√©es output.json charg√©es:', data);
                
                // Cr√©er un mapping OPM_ID -> comp√©tences primaires/secondaires
                const opmCompetencesMap = {};
                data.forEach(item => {
                    const opmId = item.OPM_ID.toString();
                    opmCompetencesMap[opmId] = {
                        primaires: [],
                        secondaires: []
                    };
                    
                    // Traiter les comp√©tences primaires
                    if (item.Primaires && Array.isArray(item.Primaires)) {
                        item.Primaires.forEach(comp => {
                            if (typeof comp === 'string') {
                                // C'est un code simple sans niveaux sp√©cifi√©s - on l'ajoute quand m√™me
                                opmCompetencesMap[opmId].primaires.push({
                                    code: comp,
                                    levels: [] // Pas de niveaux sp√©cifi√©s
                                });
                            } else if (comp.code) {
                                // C'est un objet avec code (peut avoir ou non des levels et markers)
                                opmCompetencesMap[opmId].primaires.push({
                                    code: comp.code,
                                    levels: comp.levels || [], // Utiliser les levels s'ils existent, sinon tableau vide
                                    markers: comp.markers || '' // Utiliser les markers s'ils existent, sinon cha√Æne vide
                                });
                            }
                        });
                    }
                    
                    // Traiter les comp√©tences secondaires
                    if (item.Secondaires && Array.isArray(item.Secondaires)) {
                        item.Secondaires.forEach(comp => {
                            if (typeof comp === 'string') {
                                // C'est un code simple sans niveaux sp√©cifi√©s - on l'ajoute quand m√™me
                                opmCompetencesMap[opmId].secondaires.push({
                                    code: comp,
                                    levels: [] // Pas de niveaux sp√©cifi√©s
                                });
                            } else if (comp.code) {
                                // C'est un objet avec code (peut avoir ou non des levels et markers)
                                opmCompetencesMap[opmId].secondaires.push({
                                    code: comp.code,
                                    levels: comp.levels || [], // Utiliser les levels s'ils existent, sinon tableau vide
                                    markers: comp.markers || '' // Utiliser les markers s'ils existent, sinon cha√Æne vide
                                });
                            }
                        });
                    }
                });
                
                window.opmCompetencesMap = opmCompetencesMap;
                console.log('Mapping OPM -> Comp√©tences cr√©√©:', opmCompetencesMap);
                
                // Ajouter les event listeners aux checkboxes Primary/Secondary
                setTimeout(() => {
                    document.querySelectorAll('.role-primary-checkbox, .role-secondary-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const opmId = this.dataset.opmId;
                            const isPrimary = this.classList.contains('role-primary-checkbox');
                            const isChecked = this.checked;
                            
                            console.log(`Checkbox ${isPrimary ? 'Primary' : 'Secondary'} pour OPM ID ${opmId}: ${isChecked ? 'coch√©e' : 'd√©coch√©e'}`);
                            
                            // Mettre √† jour les surbrillances et badges pour cet OPM-ID
                            updateRoleHighlightsAndBadges(opmId);
                            
                            // R√©appliquer le filtrage apr√®s la mise √† jour des badges
                            setTimeout(() => {
                                if (typeof applySkillRowsFiltering === 'function') {
                                    console.log('R√©application du filtrage apr√®s changement de checkbox');
                                    applySkillRowsFiltering();
                                }
                            }, 100);
                        });
                    });
                    
                    // Appliquer les surbrillances initiales pour TOUS les OPM-IDs
                    // R√©cup√©rer tous les OPM-IDs pr√©sents dans les cards
                    const allOpmIds = [];
                    document.querySelectorAll('.selected-role-card[data-opm-code]').forEach(card => {
                        allOpmIds.push(card.dataset.opmCode);
                    });
                    
                    console.log(`=== INITIALISATION BADGES POUR TOUS LES OPM-IDS ===`);
                    console.log(`Total OPM-IDs trouv√©s: ${allOpmIds.length}`, allOpmIds);
                    
                    // Appeler la fonction pour CHAQUE OPM-ID avec un l√©ger d√©lai entre chaque
                    // pour √©viter les conflits d'acc√®s simultan√©
                    allOpmIds.forEach((opmId, index) => {
                        setTimeout(() => {
                            console.log(`[${index + 1}/${allOpmIds.length}] Initialisation des badges pour OPM-ID ${opmId}`);
                            updateRoleHighlightsAndBadges(opmId);
                            
                            // Si c'est le dernier OPM-ID, appliquer le filtrage
                            if (index === allOpmIds.length - 1) {
                                setTimeout(() => {
                                    if (typeof applySkillRowsFiltering === 'function') {
                                        console.log('=== APPLICATION DU FILTRAGE INITIAL ===');
                                        applySkillRowsFiltering();
                                    }
                                }, 200);
                            }
                        }, index * 100); // 100ms de d√©lai entre chaque OPM-ID
                    });
                }, 1000); // Augmenter le d√©lai initial √† 1000ms
                
            } catch (error) {
                console.error('Erreur lors du chargement de output.json:', error);
            }
        }
        
        // Fonction pour mettre √† jour les surbrillances et badges selon Primary/Secondary
        function updateRoleHighlightsAndBadges(opmId) {
            if (!window.opmCompetencesMap || !window.opmCompetencesMap[opmId]) {
                return;
            }
            
            // Fonction helper pour cr√©er un d√©grad√© avec plusieurs couleurs d'OPM IDs
            function createGradientForOpmIds(opmIds) {
                if (opmIds.length === 0) return '';
                
                // R√©cup√©rer les couleurs uniques pour chaque OPM ID
                const colors = opmIds.map(id => getOpmIdColor(id));
                const uniqueColors = [...new Set(colors)];
                
                if (uniqueColors.length === 1) {
                    // Une seule couleur : d√©grad√© simple
                    const color = uniqueColors[0];
                    return `linear-gradient(135deg, rgba(${color}, 0.8), rgba(${color}, 0.6))`;
                } else {
                    // Plusieurs couleurs : d√©grad√© avec toutes les couleurs
                    const gradientStops = uniqueColors.map((color, index) => {
                        const position = (index / (uniqueColors.length - 1)) * 100;
                        return `rgba(${color}, ${index === 0 || index === uniqueColors.length - 1 ? '0.8' : '0.7'}) ${position}%`;
                    });
                    return `linear-gradient(135deg, ${gradientStops.join(', ')})`;
                }
            }
            
            // Fonction helper pour cr√©er une ombre avec plusieurs couleurs
            function createShadowForOpmIds(opmIds) {
                if (opmIds.length === 0) return '';
                
                const colors = opmIds.map(id => getOpmIdColor(id));
                const uniqueColors = [...new Set(colors)];
                
                if (uniqueColors.length === 1) {
                    const color = uniqueColors[0];
                    return `0 0 8px rgba(${color}, 0.9)`;
                } else {
                    // Cr√©er plusieurs ombres pour chaque couleur
                    const shadows = uniqueColors.map((color, index) => {
                        const offset = index * 2;
                        return `0 0 ${8 + offset}px rgba(${color}, ${0.7 + index * 0.1})`;
                    });
                    return shadows.join(', ');
                }
            }
            
            // R√©cup√©rer les √©tats des checkboxes Primary/Secondary pour cet OPM ID
            const primaryCheckbox = document.querySelector(`.role-primary-checkbox[data-opm-id="${opmId}"]`);
            const secondaryCheckbox = document.querySelector(`.role-secondary-checkbox[data-opm-id="${opmId}"]`);
            
            const isPrimaryChecked = primaryCheckbox ? primaryCheckbox.checked : false;
            const isSecondaryChecked = secondaryCheckbox ? secondaryCheckbox.checked : false;
            
            // R√©cup√©rer les comp√©tences √† afficher (uniquement si au moins une checkbox est coch√©e)
            const competencesToShow = [];
            if (isPrimaryChecked && window.opmCompetencesMap[opmId].primaires) {
                // Ajouter toutes les comp√©tences primaires, m√™me celles sans niveaux
                competencesToShow.push(...window.opmCompetencesMap[opmId].primaires.map(c => ({...c, type: 'primary'})));
            }
            if (isSecondaryChecked && window.opmCompetencesMap[opmId].secondaires) {
                // Ajouter toutes les comp√©tences secondaires, m√™me celles sans niveaux
                competencesToShow.push(...window.opmCompetencesMap[opmId].secondaires.map(c => ({...c, type: 'secondary'})));
            }
            
            // Si aucune checkbox n'est coch√©e, ne rien afficher
            // (on ne fait rien ici, competencesToShow reste vide)
            
            console.log(`Comp√©tences √† afficher pour OPM ID ${opmId}:`, competencesToShow);
            
            // Mettre √† jour les badges de comp√©tences dans la card
            updateCompetencesBadges(opmId, competencesToShow);
            
            // R√©initialiser les surbrillances pr√©c√©dentes pour cet OPM ID
            document.querySelectorAll(`.level-box.filled[data-role-opm-id="${opmId}"]`).forEach(box => {
                const currentOpmIds = box.dataset.roleOpmId ? box.dataset.roleOpmId.split(',') : [];
                const updatedOpmIds = currentOpmIds.filter(id => id !== opmId);
                if (updatedOpmIds.length === 0) {
                    box.style.background = '';
                    box.style.boxShadow = '';
                    box.removeAttribute('data-role-opm-id');
                } else {
                    box.dataset.roleOpmId = updatedOpmIds.join(',');
                    // Recalculer le d√©grad√© avec les OPM IDs restants
                    box.style.background = createGradientForOpmIds(updatedOpmIds);
                    box.style.boxShadow = createShadowForOpmIds(updatedOpmIds);
                }
            });
            
            // Appliquer les nouvelles surbrillances
            competencesToShow.forEach(comp => {
                // V√©rifier que la comp√©tence a des niveaux sp√©cifi√©s
                if (!comp.levels || comp.levels.length === 0) {
                    return; // Ignorer les comp√©tences sans niveaux sp√©cifi√©s
                }
                
                const skillRow = Array.from(document.querySelectorAll('.skill-row')).find(row => {
                    const codeElement = row.querySelector('.skill-code');
                    return codeElement && codeElement.textContent.trim() === comp.code;
                });
                
                if (skillRow) {
                    const levelBoxes = skillRow.querySelectorAll('.level-boxes .level-box');
                    // Les niveaux 1-7 sont maintenant aux indices 0-6 (plus de cellule "X")
                    // Ne mettre en surbrillance QUE les niveaux explicitement sp√©cifi√©s dans le JSON
                    comp.levels.forEach(level => {
                        // L'index correspond au niveau - 1 (niveau 1 = index 0, niveau 2 = index 1, etc.)
                        const levelIndex = level - 1;
                        if (levelIndex >= 0 && levelIndex < levelBoxes.length) {
                            const levelBox = levelBoxes[levelIndex];
                            // V√©rifier que cette cellule a la classe 'filled' (niveau disponible pour cette comp√©tence SFIA)
                            if (levelBox.classList.contains('filled')) {
                                // Ajouter l'OPM ID √† la liste
                                let currentOpmIds = levelBox.dataset.roleOpmId ? levelBox.dataset.roleOpmId.split(',') : [];
                                if (!currentOpmIds.includes(opmId)) {
                                    currentOpmIds.push(opmId);
                                    levelBox.dataset.roleOpmId = currentOpmIds.join(',');
                                }
                                
                                // Appliquer la surbrillance avec un d√©grad√© de toutes les couleurs des OPM IDs actifs
                                levelBox.style.background = createGradientForOpmIds(currentOpmIds);
                                levelBox.style.boxShadow = createShadowForOpmIds(currentOpmIds);
                                levelBox.style.animation = 'blink-animation 1.5s infinite';
                                
                                // Stocker les informations pour le tooltip
                                const skillName = skillRow.querySelector('.skill-name')?.textContent.trim() || '';
                                const skillCode = comp.code;
                                levelBox.dataset.skillName = skillName;
                                levelBox.dataset.skillCode = skillCode;
                                levelBox.dataset.level = level;
                                
                                // Supprimer les anciens gestionnaires d'√©v√©nements s'ils existent
                                if (levelBox._tooltipMouseEnter) {
                                    levelBox.removeEventListener('mouseenter', levelBox._tooltipMouseEnter);
                                }
                                if (levelBox._tooltipMouseLeave) {
                                    levelBox.removeEventListener('mouseleave', levelBox._tooltipMouseLeave);
                                }
                                
                                // Cr√©er de nouveaux gestionnaires d'√©v√©nements pour le tooltip
                                levelBox._tooltipMouseEnter = function() {
                                    const tooltip = document.getElementById('custom-tooltip');
                                    if (!tooltip) return;
                                    
                                    // R√©cup√©rer tous les OPM IDs actifs sur cette cellule
                                    const cellOpmIds = this.dataset.roleOpmId ? this.dataset.roleOpmId.split(',') : [];
                                    if (cellOpmIds.length === 0) return;
                                    
                                    // Construire les badges pour chaque OPM ID avec leur couleur
                                    let opmIdBadges = '';
                                    cellOpmIds.forEach(id => {
                                        const opmColor = getOpmIdColor(id);
                                        // V√©rifier si cet OPM ID a des checkboxes Primary/Secondary coch√©es
                                        const primaryCheckbox = document.querySelector(`.role-primary-checkbox[data-opm-id="${id}"]`);
                                        const secondaryCheckbox = document.querySelector(`.role-secondary-checkbox[data-opm-id="${id}"]`);
                                        const isActive = (primaryCheckbox && primaryCheckbox.checked) || (secondaryCheckbox && secondaryCheckbox.checked);
                                        
                                        if (isActive) {
                                            opmIdBadges += `<span class="tooltip-badge" style="background-color: rgba(${opmColor}, 0.8);">OPM ID: ${id}</span>`;
                                        }
                                    });
                                    
                                    if (opmIdBadges === '') return; // Ne pas afficher si aucun OPM ID actif
                                    
                                    // Construire le contenu du tooltip
                                    const tooltipContent = `
                                        <div class="tooltip-title">${this.dataset.skillName} (${this.dataset.skillCode})</div>
                                        <div class="tooltip-badges">
                                            ${opmIdBadges}
                                            <span class="tooltip-badge">Niveau: ${this.dataset.level}</span>
                                        </div>
                                        <div class="tooltip-info">
                                            <strong>Comp√©tence:</strong> ${this.dataset.skillName}<br>
                                            <strong>Code:</strong> ${this.dataset.skillCode}<br>
                                            <strong>Niveau SFIA:</strong> ${this.dataset.level}
                                        </div>
                                    `;
                                    
                                    // Afficher le tooltip
                                    tooltip.innerHTML = tooltipContent;
                                    tooltip.classList.add('visible');
                                    
                                    // Positionner le tooltip
                                    const rect = this.getBoundingClientRect();
                                    const offsetX = 15;
                                    const offsetY = 5;
                                    
                                    let left = rect.right + offsetX;
                                    let top = rect.top + offsetY;
                                    
                                    tooltip.style.left = left + 'px';
                                    tooltip.style.top = top + 'px';
                                    
                                    // V√©rifier si le tooltip d√©passe √† droite
                                    setTimeout(() => {
                                        const tooltipRect = tooltip.getBoundingClientRect();
                                        if (tooltipRect.right > window.innerWidth) {
                                            tooltip.style.left = (rect.left - tooltipRect.width - offsetX) + 'px';
                                        }
                                        // V√©rifier si le tooltip d√©passe en bas
                                        if (tooltipRect.bottom > window.innerHeight) {
                                            tooltip.style.top = (rect.top - tooltipRect.height - offsetY) + 'px';
                                        }
                                    }, 0);
                                };
                                
                                levelBox._tooltipMouseLeave = function() {
                                    const tooltip = document.getElementById('custom-tooltip');
                                    if (tooltip) {
                                        tooltip.classList.remove('visible');
                                    }
                                };
                                
                                // Ajouter les gestionnaires d'√©v√©nements
                                levelBox.addEventListener('mouseenter', levelBox._tooltipMouseEnter);
                                levelBox.addEventListener('mouseleave', levelBox._tooltipMouseLeave);
                            }
                        }
                    });
                }
            });
            
            // Le filtrage sera appliqu√© apr√®s via l'event listener des checkboxes
        }
        
        // Fonction pour charger les donn√©es SFIA skills
        async function loadSfiaSkillsData() {
            if (window.sfiaSkillsData) {
                return window.sfiaSkillsData; // D√©j√† charg√©
            }
            
            try {
                const response = await fetch('{% url "sfia_skills_json" %}');
                if (!response.ok) {
                    console.error('Erreur lors du chargement de sfia_skills.json:', response.statusText);
                    return null;
                }
                const data = await response.json();
                window.sfiaSkillsData = data;
                console.log('Donn√©es sfia_skills.json charg√©es:', data);
                return data;
            } catch (error) {
                console.error('Erreur lors du chargement de sfia_skills.json:', error);
                return null;
            }
        }
        
        // Fonction pour obtenir les informations d'un skill par son code
        function getSkillInfo(code) {
            if (!window.sfiaSkillsData) {
                return null;
            }
            return window.sfiaSkillsData.find(skill => skill.code === code) || null;
        }
        
        // Fonction pour configurer les tooltips pour les skills et les niveaux
        async function setupSkillTooltips() {
            // S'assurer que les donn√©es SFIA sont charg√©es
            await loadSfiaSkillsData();
            
            if (!window.sfiaSkillsData) {
                console.warn('Donn√©es SFIA non disponibles pour les tooltips');
                return;
            }
            
            // Configurer les tooltips pour les skill-name et skill-code
            document.querySelectorAll('.skill-name[data-skill-code], .skill-code[data-skill-code]').forEach(element => {
                const skillCode = element.getAttribute('data-skill-code');
                const skillInfo = getSkillInfo(skillCode);
                
                if (skillInfo) {
                    // Cr√©er le tooltip avec la d√©finition du skill
                    const tooltipText = `${skillInfo.name} (${skillCode})\n\n${skillInfo.definition}`;
                    element.setAttribute('title', tooltipText);
                    element.style.cursor = 'help';
                }
            });
            
            // Configurer les tooltips pour les level-boxes
            document.querySelectorAll('.level-box[data-skill-code][data-level]').forEach(box => {
                const skillCode = box.getAttribute('data-skill-code');
                const level = parseInt(box.getAttribute('data-level'), 10);
                const skillInfo = getSkillInfo(skillCode);
                
                if (skillInfo && skillInfo.levels) {
                    const levelInfo = skillInfo.levels.find(l => l.level === level);
                    if (levelInfo) {
                        // Cr√©er le tooltip avec la d√©finition du niveau
                        const tooltipText = `${skillInfo.name} - Level ${level}\n\n${levelInfo.definition}`;
                        box.setAttribute('title', tooltipText);
                        box.style.cursor = 'help';
                    }
                }
            });
            
            console.log('Tooltips configur√©s pour les skills et niveaux');
        }
        
        // Variable pour √©viter les appels simultan√©s
        const pendingBadgeUpdates = {};
        
        // Fonction pour mettre √† jour les badges de comp√©tences dans la card
        async function updateCompetencesBadges(opmId, competences) {
            // V√©rifier si une mise √† jour est d√©j√† en cours pour cet OPM-ID
            if (pendingBadgeUpdates[opmId]) {
                console.log(`Mise √† jour des badges d√©j√† en cours pour OPM-ID ${opmId}, ignor√©e`);
                return;
            }
            
            pendingBadgeUpdates[opmId] = true;
            
            try {
                // Trouver la card correspondante √† cet OPM ID
                const roleCard = document.querySelector(`.selected-role-card[data-opm-code="${opmId}"]`);
                if (!roleCard) {
                    delete pendingBadgeUpdates[opmId];
                    return;
                }
                
                const competencesContainer = roleCard.querySelector(`.role-competences[data-opm-id="${opmId}"]`);
                if (!competencesContainer) {
                    delete pendingBadgeUpdates[opmId];
                    return;
                }
                
                // Vider le conteneur
                competencesContainer.innerHTML = '';
                
                // Si aucune comp√©tence √† afficher, ne rien faire
                if (!competences || competences.length === 0) {
                    delete pendingBadgeUpdates[opmId];
                    return;
                }
                
                // S'assurer que les donn√©es SFIA sont charg√©es
                await loadSfiaSkillsData();
            
            // Cr√©er un nouveau conteneur
            const competenceContainer = document.createElement('div');
            competenceContainer.className = 'competence-container flex flex-wrap gap-2 items-center';
            
            // Mapping de couleurs (r√©utiliser celui existant)
            const competenceColors = {
                'ITSP': '#e11d48', 'ISCO': '#e11d48', 'IRMG': '#e11d48', 'STPL': '#e11d48',
                'ARCH': '#e11d48', 'INOV': '#e11d48', 'EMRG': '#e11d48', 'RSCH': '#e11d48',
                'SUST': '#e11d48', 'FMIT': '#e11d48', 'INVA': '#e11d48', 'BENM': '#e11d48',
                'BUDF': '#e11d48', 'FIAN': '#e11d48', 'COMG': '#e11d48', 'DEMM': '#e11d48',
                'MEAS': '#e11d48', 'SCTY': '#e11d48', 'INAS': '#e11d48', 'PEDP': '#e11d48',
                'VURE': '#e11d48', 'THIN': '#e11d48', 'GOVN': '#e11d48', 'BURM': '#e11d48',
                'AIDE': '#e11d48', 'AUDT': '#e11d48', 'QUMG': '#e11d48', 'QUAS': '#e11d48',
                'CNSL': '#e11d48', 'TECH': '#e11d48', 'METL': '#e11d48',
                'PROD': '#facc15', 'DLMG': '#facc15', 'SLEN': '#facc15', 'DESN': '#facc15',
                'SWDN': '#facc15', 'NTDS': '#facc15', 'IFDN': '#facc15', 'HWDE': '#facc15',
                'PROG': '#facc15', 'SINT': '#facc15', 'TEST': '#facc15', 'NFTS': '#facc15',
                'PRTS': '#facc15', 'PORT': '#facc15', 'RESD': '#facc15', 'SFEN': '#facc15',
                'SFAS': '#facc15', 'RFEN': '#facc15', 'ADEV': '#facc15', 'DATM': '#facc15',
                'DTAN': '#facc15', 'DBDS': '#facc15', 'DNAN': '#facc15', 'DATS': '#facc15',
                'MLNG': '#facc15', 'BINT': '#facc15', 'DENG': '#facc15', 'VISL': '#facc15',
                'URCH': '#facc15', 'CEXP': '#facc15', 'ACIN': '#facc15', 'UNAN': '#facc15',
                'HCEV': '#facc15', 'USEV': '#facc15', 'INCA': '#facc15', 'ICPM': '#facc15',
                'KNOW': '#facc15', 'GRON': '#facc15', 'SCMO': '#facc15', 'NUAN': '#facc15',
                'HPCC': '#facc15',
                'ITMG': '#ea580c', 'ASUP': '#ea580c', 'ITOP': '#ea580c', 'SYSP': '#ea580c',
                'NTAS': '#ea580c', 'HSIN': '#ea580c', 'CFMG': '#ea580c', 'RELM': '#ea580c',
                'DEPL': '#ea580c', 'STMG': '#ea580c', 'DCMA': '#ea580c', 'SLMO': '#ea580c',
                'SCMG': '#ea580c', 'AVMT': '#ea580c', 'COPL': '#ea580c', 'CPMG': '#ea580c',
                'USUP': '#ea580c', 'PBMG': '#ea580c', 'CHMG': '#ea580c', 'ASMG': '#ea580c',
                'SEAC': '#ea580c', 'SCAD': '#ea580c', 'IAMT': '#ea580c', 'VUAS': '#ea580c',
                'DGFS': '#ea580c', 'CRIM': '#ea580c', 'OCOP': '#ea580c', 'PENT': '#ea580c',
                'RMGT': '#ea580c', 'ANCC': '#ea580c', 'DBAD': '#ea580c',
                'POMG': '#db2777', 'PGMG': '#db2777', 'PRMG': '#db2777', 'PROF': '#db2777',
                'BUSA': '#db2777', 'FEAS': '#db2777', 'REQM': '#db2777', 'BSMO': '#db2777',
                'BPTS': '#db2777', 'BPRE': '#db2777', 'OCDV': '#db2777', 'JADN': '#db2777',
                'ORDI': '#db2777', 'CIPM': '#db2777', 'OCEN': '#db2777',
                'PEMT': '#0891b2', 'EEXP': '#0891b2', 'OFCL': '#0891b2', 'PDSV': '#0891b2',
                'WFPL': '#0891b2', 'RESC': '#0891b2', 'ETMG': '#0891b2', 'TMCR': '#0891b2',
                'ETDL': '#0891b2', 'LEDA': '#0891b2', 'CSOP': '#0891b2', 'TEAC': '#0891b2',
                'SUBF': '#0891b2',
                'SORC': '#16a34a', 'SUPP': '#16a34a', 'ITCM': '#16a34a', 'RLMT': '#16a34a',
                'CSMG': '#16a34a', 'ADMN': '#16a34a', 'BIDM': '#16a34a', 'SALE': '#16a34a',
                'SSUP': '#16a34a', 'MKTG': '#16a34a', 'MRCH': '#16a34a', 'BRMG': '#16a34a',
                'CELO': '#16a34a', 'MKCM': '#16a34a', 'DIGM': '#16a34a'
            };
            
            // Cr√©er les badges pour chaque comp√©tence
            competences.forEach(comp => {
                const badge = document.createElement('span');
                badge.className = 'inline-block text-white px-2.5 py-1 rounded-md mr-2';
                badge.style.backgroundColor = competenceColors[comp.code] || '#6c757d';
                badge.style.fontWeight = '600';
                badge.style.fontSize = '12px';
                badge.style.letterSpacing = '0.03em';
                badge.style.lineHeight = '1.3';
                badge.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
                badge.style.border = '1px solid rgba(255,255,255,0.2)';
                badge.style.cursor = 'help';
                
                // Cr√©er le contenu avec le marker et le code
                if (comp.markers) {
                    badge.innerHTML = `<span class="inline">${comp.markers}</span> ${comp.code}`;
                } else {
                    badge.textContent = comp.code;
                }
                
                // Obtenir les informations du skill depuis le JSON
                const skillInfo = getSkillInfo(comp.code);
                
                // Supprimer les anciens gestionnaires d'√©v√©nements s'ils existent
                if (badge._tooltipMouseEnter) {
                    badge.removeEventListener('mouseenter', badge._tooltipMouseEnter);
                }
                if (badge._tooltipMouseLeave) {
                    badge.removeEventListener('mouseleave', badge._tooltipMouseLeave);
                }
                
                // Cr√©er les gestionnaires d'√©v√©nements pour le tooltip
                badge._tooltipMouseEnter = function() {
                    const tooltip = document.getElementById('custom-tooltip');
                    if (!tooltip) return;
                    
                    // Construire le contenu du tooltip
                    let tooltipContent = '';
                    
                    if (skillInfo) {
                        // Afficher le titre et la d√©finition depuis le JSON
                        let levelsText = 'Aucun niveau sp√©cifi√©';
                        if (comp.levels && comp.levels.length > 0) {
                            levelsText = comp.levels.length === 7 ? 'Tous niveaux' : `Niveaux: ${comp.levels.join(', ')}`;
                        }
                        tooltipContent = `
                            <div class="tooltip-title">${skillInfo.name} (${skillInfo.code})</div>
                            <div class="tooltip-badges">
                                <span class="tooltip-badge">${comp.type === 'primary' ? 'Primaire' : 'Secondaire'}</span>
                                <span class="tooltip-badge">${levelsText}</span>
                            </div>
                            <div class="tooltip-info">
                                <strong>D√©finition:</strong><br>
                                ${skillInfo.definition || 'D√©finition non disponible'}
                            </div>
                        `;
                    } else {
                        // Fallback si les donn√©es ne sont pas disponibles
                        let levelsText = 'Aucun niveau sp√©cifi√©';
                        if (comp.levels && comp.levels.length > 0) {
                            levelsText = comp.levels.length === 7 ? 'Tous niveaux' : `Niveaux: ${comp.levels.join(', ')}`;
                        }
                        tooltipContent = `
                            <div class="tooltip-title">${comp.code}</div>
                            <div class="tooltip-badges">
                                <span class="tooltip-badge">${comp.type === 'primary' ? 'Primaire' : 'Secondaire'}</span>
                                <span class="tooltip-badge">${levelsText}</span>
                            </div>
                            <div class="tooltip-info">
                                Informations non disponibles
                            </div>
                        `;
                    }
                    
                    // Afficher le tooltip
                    tooltip.innerHTML = tooltipContent;
                    tooltip.classList.add('visible');
                    
                    // Positionner le tooltip
                    const rect = this.getBoundingClientRect();
                    const offsetX = 15;
                    const offsetY = 5;
                    
                    let left = rect.right + offsetX;
                    let top = rect.top + offsetY;
                    
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                    
                    // V√©rifier si le tooltip d√©passe √† droite
                    setTimeout(() => {
                        const tooltipRect = tooltip.getBoundingClientRect();
                        if (tooltipRect.right > window.innerWidth) {
                            tooltip.style.left = (rect.left - tooltipRect.width - offsetX) + 'px';
                        }
                        // V√©rifier si le tooltip d√©passe en bas
                        if (tooltipRect.bottom > window.innerHeight) {
                            tooltip.style.top = (rect.top - tooltipRect.height - offsetY) + 'px';
                        }
                    }, 0);
                };
                
                badge._tooltipMouseLeave = function() {
                    const tooltip = document.getElementById('custom-tooltip');
                    if (tooltip) {
                        tooltip.classList.remove('visible');
                    }
                };
                
                // Ajouter les gestionnaires d'√©v√©nements
                badge.addEventListener('mouseenter', badge._tooltipMouseEnter);
                badge.addEventListener('mouseleave', badge._tooltipMouseLeave);
                
                competenceContainer.appendChild(badge);
            });
            
            competencesContainer.appendChild(competenceContainer);
            
            } finally {
                // Lib√©rer le verrou
                delete pendingBadgeUpdates[opmId];
            }
        }
        
        // Fonction pour initialiser la l√©gende Symbology
        function initializeSymbologyLegend() {
            const symbologyLegend = document.getElementById('symbology-legend');
            if (symbologyLegend) {
                symbologyLegend.innerHTML = `
                    <div class="flex items-center mb-2">
                        <span class="font-semibold text-amber-800">Symbology</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div class="flex items-center">
                            <span class="inline-block mr-2 text-amber-600 font-bold text-lg">‚óè</span>
                            <span class="text-gray-700"><strong>Technical Original</strong>: Original technical competency</span>
                        </div>
                        <div class="flex items-center">
                            <span class="inline-block mr-2 text-amber-600 font-bold text-lg">‚óÜ</span>
                            <span class="text-gray-700"><strong>Transversal Original</strong>: Original transversal competency</span>
                        </div>
                        <div class="flex items-center">
                            <span class="inline-block mr-2 text-amber-600 font-bold text-lg">‚òÖ‚óè</span>
                            <span class="text-gray-700"><strong>Technical added by AI analysis</strong>: Technical competency added by AI analysis</span>
                        </div>
                        <div class="flex items-center">
                            <span class="inline-block mr-2 text-amber-600 font-bold text-lg">‚òÖ‚óÜ</span>
                            <span class="text-gray-700"><strong>Transversal added by AI analysis</strong>: Transversal competency added by AI analysis</span>
                        </div>
                    </div>
                    <div class="border-t border-amber-200 pt-2 mt-2">
                        <p class="text-xs text-gray-600">
                            <span class="font-semibold">Note:</span> Symbols appear in front of competency codes to indicate their origin and type (Technical/Transversal, Original/AI-added).
                        </p>
                    </div>
                `;
                console.log('L√©gende Symbology initialis√©e');
            }
        }
        
        // Charger les s√©lections Step0 au chargement de la page
        // Attendre que loadAndDisplayStep0Selections soit termin√©e avant de charger les OPM IDs
        loadAndDisplayStep0Selections().then(() => {
            // Initialiser la l√©gende Symbology
            initializeSymbologyLegend();
            
            // Attendre un peu pour que le DOM soit mis √† jour
            setTimeout(() => {
                loadOpmIdsFromSavedSelection();
            }, 100);
        }).catch(() => {
            // En cas d'erreur, charger quand m√™me les OPM IDs et la l√©gende
            initializeSymbologyLegend();
            loadOpmIdsFromSavedSelection();
        });
        
        // Fonction pour obtenir le titre d'un OPM ID
        function getOpmIdTitle(opmId) {
            // Chercher dans les donn√©es actuelles si disponible
            if (window.currentSelectionData && window.currentSelectionData.roles) {
                const role = window.currentSelectionData.roles.find(r => {
                    const roleOpmId = (r.opmId || r.opm_id || r.opm_code || r.dcwf_code || r.ncwf_id || '').toString();
                    const cleanRoleId = roleOpmId.match(/\d+/)?.[0] || roleOpmId;
                    const cleanOpmId = opmId.toString().match(/\d+/)?.[0] || opmId.toString();
                    return cleanRoleId === cleanOpmId;
                });
                
                if (role) {
                    return role.title || role.ncwf_work_role || role.dcwf_work_role || `OPM ID ${opmId}`;
                }
            }
            
            // Si pas trouv√©, retourner un titre par d√©faut
            return `OPM ID ${opmId}`;
        }
        
        // Fonction pour extraire les OPM IDs depuis #step0-selected-roles
        function getOpmIdsFromStep0Roles() {
            const step0Section = document.getElementById('step0-selected-roles');
            if (!step0Section || step0Section.style.display === 'none') {
                return null;
            }
            
            const roleCards = step0Section.querySelectorAll('.selected-role-card');
            if (roleCards.length === 0) {
                return null;
            }
            
            const roles = [];
            roleCards.forEach(card => {
                const opmIdElement = card.querySelector('.role-opm');
                if (opmIdElement) {
                    const opmIdText = opmIdElement.textContent;
                    const opmIdMatch = opmIdText.match(/OPM-ID:\s*(\d+)/);
                    if (opmIdMatch) {
                        const opmId = opmIdMatch[1];
                        const roleNameElement = card.querySelector('.role-name');
                        const roleElement = card.querySelector('.role-element');
                        
                        roles.push({
                            opmId: opmId,
                            opm_id: opmId,
                            title: roleNameElement ? roleNameElement.textContent.trim() : '',
                            ncwf_work_role: roleNameElement ? roleNameElement.textContent.trim() : '',
                            dcwf_work_role: roleNameElement ? roleNameElement.textContent.trim() : '',
                            dcwf_element: roleElement ? roleElement.textContent.trim() : '',
                            ncwf_element: roleElement ? roleElement.textContent.trim() : ''
                        });
                    }
                }
            });
            
            if (roles.length > 0) {
                console.log('OPM IDs extraits depuis #step0-selected-roles:', roles);
                return {
                    roles: roles,
                    fromStep0Roles: true,
                    timestamp: new Date().toISOString()
                };
            }
            
            return null;
        }
        
        // R√©cup√©rer les OPM IDs de la sauvegarde
        async function loadOpmIdsFromSavedSelection() {
            try {
                // Afficher un indicateur de chargement
                const opmIdsList = document.getElementById('opm-ids-list');
                opmIdsList.innerHTML = `
                    <div class="flex items-center justify-center p-4">
                        <svg class="animate-spin h-6 w-6 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Chargement des donn√©es...</span>
                    </div>
                `;
                
                // Initialiser serverStorage
                if (typeof initServerStorage === 'function') {
                    initServerStorage();
                    console.log('serverStorage initialis√©');
                } else {
                    console.warn('La fonction initServerStorage n\'est pas disponible');
                }
                
                // PRIORIT√â 1: V√©rifier si on a des OPM IDs dans #step0-selected-roles (apr√®s attributs-part-deux-opm-id)
                let rolesWithOpmIds = [];
                let dataSource = 'step0-selected-roles';
                const step0RolesSelection = getOpmIdsFromStep0Roles();
                
                if (step0RolesSelection && step0RolesSelection.roles && step0RolesSelection.roles.length > 0) {
                    console.log('Utilisation des OPM IDs depuis #step0-selected-roles');
                    window.currentSelectionData = step0RolesSelection;
                    rolesWithOpmIds = step0RolesSelection.roles.filter(role => role.opmId);
                }
                
                // PRIORIT√â 2: Si pas de r√¥les dans step0-selected-roles, utiliser la logique normale
                if (rolesWithOpmIds.length === 0) {
                    // V√©rifier si nous avons une s√©lection active pour l'√©tape 3
                    const activateStep3 = localStorage.getItem('activateStep3');
                    console.log('Activation √©tape 3:', activateStep3);
                    
                    // Essayer d'abord de r√©cup√©rer les donn√©es depuis serverStorage
                    let currentSelection;
                    dataSource = 'serverStorage';
                
                try {
                    console.log('Tentative de r√©cup√©ration depuis serverStorage...');
                    const serverData = await serverStorage.getItem('currentKsatSelection');
                    if (serverData) {
                        currentSelection = JSON.parse(serverData);
                        console.log('S√©lection r√©cup√©r√©e depuis serverStorage');
                    } else {
                        // Fallback √† localStorage si serverStorage ne contient pas les donn√©es
                        console.log('Aucune donn√©e dans serverStorage, tentative avec localStorage');
                        currentSelection = JSON.parse(localStorage.getItem('currentKsatSelection') || '{}');
                        dataSource = 'localStorage';
                        console.log('S√©lection r√©cup√©r√©e depuis localStorage (fallback)');
                    }
                } catch (error) {
                    // En cas d'erreur avec serverStorage, utiliser localStorage
                    console.error('Erreur avec serverStorage, utilisation de localStorage:', error);
                    currentSelection = JSON.parse(localStorage.getItem('currentKsatSelection') || '{}');
                    dataSource = 'localStorage';
                }
                
                console.log('Source des donn√©es:', dataSource);
                console.log('S√©lection courante:', currentSelection);
                
                // V√©rifier aussi si on a des donn√©es Step0
                let step0Data = null;
                try {
                    const step0DataStr = localStorage.getItem('step0_baseline_data');
                    if (step0DataStr) {
                        step0Data = JSON.parse(step0DataStr);
                    }
                } catch (e) {
                    console.error('Erreur lors de la lecture des donn√©es Step0:', e);
                }
                
                // Si on a des donn√©es Step0 et pas de s√©lection normale, utiliser Step0
                if ((!activateStep3 || !currentSelection || !currentSelection.roles) && step0Data && step0Data.selectedWorkRoles) {
                    // Convertir les work roles Step0 au format attendu
                    currentSelection = {
                        roles: step0Data.selectedWorkRoles.map(role => ({
                            opmId: role.opm_code || role.opm_id || role.opmId || role.dcwf_code || role.ncwf_id,
                            opm_id: role.opm_code || role.opm_id,
                            opmId: role.opm_code || role.opm_id || role.opmId || role.dcwf_code || role.ncwf_id,
                            title: role.ncwf_work_role || role.dcwf_work_role || role.title || '',
                            ncwf_work_role: role.ncwf_work_role,
                            dcwf_work_role: role.dcwf_work_role,
                            dcwf_element: role.dcwf_element,
                            ncwf_element: role.ncwf_element
                        })),
                        fromStep0: true,
                        timestamp: new Date().toISOString()
                    };
                    console.log('Donn√©es Step0 converties pour affichage:', currentSelection);
                }
                
                    // Stocker les donn√©es pour la fonction getOpmIdTitle
                    window.currentSelectionData = currentSelection;
                    
                    if ((activateStep3 === 'true' || step0Data) && currentSelection && currentSelection.roles) {
                        // Filtrer les r√¥les qui ont un opm_id
                        rolesWithOpmIds = currentSelection.roles.filter(role => role.opmId);
                    }
                }
                
                // Si on a des r√¥les (soit depuis step0-selected-roles, soit depuis la logique normale)
                if (rolesWithOpmIds.length > 0) {
                    
                    if (rolesWithOpmIds.length > 0) {
                        // Effacer le message de chargement
                        opmIdsList.innerHTML = '';
                        
                        // Mapping sp√©cifique des OPM IDs aux couleurs des colonnes dans compare_ksat.html
                        // Ces couleurs sont bas√©es sur les cat√©gories des r√¥les
                        const opmIdColors = {
                            // IT (Cyberspace) - Bleu
                            '411': '2, 125, 184',
                            '421': '2, 125, 184',
                            '431': '2, 125, 184',
                            '441': '2, 125, 184',
                            '451': '2, 125, 184',
                            '632': '2, 125, 184',
                            '641': '2, 125, 184',
                            '651': '2, 125, 184',
                            '661': '2, 125, 184',
                            '671': '2, 125, 184',
                            
                            // Cybersecurity - Vert
                            '212': '94, 151, 49',
                            '462': '94, 151, 49',
                            '511': '94, 151, 49',
                            '521': '94, 151, 49',
                            '531': '94, 151, 49',
                            '541': '94, 151, 49',
                            '611': '94, 151, 49',
                            '612': '94, 151, 49',
                            '622': '94, 151, 49',
                            '631': '94, 151, 49',
                            '652': '94, 151, 49',
                            '722': '94, 151, 49',
                            '723': '94, 151, 49',
                            
                            // Cyberspace Effects - Orange
                            '121': '255, 145, 3',
                            '122': '255, 145, 3',
                            '131': '255, 145, 3',
                            '132': '255, 145, 3',
                            '133': '255, 145, 3',
                            '322': '255, 145, 3',
                            '332': '255, 145, 3',
                            '341': '255, 145, 3',
                            '442': '255, 145, 3',
                            '443': '255, 145, 3',
                            '463': '255, 145, 3',
                            
                            // Intelligence (Cyberspace) - Jaune
                            '111': '255, 204, 2',
                            '112': '255, 204, 2',
                            '141': '255, 204, 2',
                            '151': '255, 204, 2',
                            '311': '255, 204, 2',
                            '312': '255, 204, 2',
                            '331': '255, 204, 2',
                            '333': '255, 204, 2',
                            
                            // Cyberspace Enablers - Mauve
                            '211': '153, 86, 206',
                            '221': '153, 86, 206',
                            '711': '153, 86, 206',
                            '712': '153, 86, 206',
                            '731': '153, 86, 206',
                            '732': '153, 86, 206',
                            '751': '153, 86, 206',
                            '752': '153, 86, 206',
                            '801': '153, 86, 206',
                            '802': '153, 86, 206',
                            '803': '153, 86, 206',
                            '804': '153, 86, 206',
                            '805': '153, 86, 206',
                            '901': '153, 86, 206',
                            
                            // Software Engineering - Rouge
                            '461': '214, 39, 40',
                            '621': '214, 39, 40',
                            '625': '214, 39, 40',
                            '626': '214, 39, 40',
                            '627': '214, 39, 40',
                            '628': '214, 39, 40',
                            '673': '214, 39, 40',
                            '806': '214, 39, 40',
                            
                            // Data/AI - Turquoise
                            '422': '23, 190, 207',
                            '423': '23, 190, 207',
                            '424': '23, 190, 207',
                            '623': '23, 190, 207',
                            '624': '23, 190, 207',
                            '653': '23, 190, 207',
                            '672': '23, 190, 207',
                            '733': '23, 190, 207',
                            '753': '23, 190, 207',
                            '902': '23, 190, 207',
                            '903': '23, 190, 207'
                        };
                        
                        // Cr√©er un mapping des OPM IDs aux r√¥les (prendre le premier r√¥le trouv√© pour chaque OPM ID)
                        const opmIdToRole = {};
                        
                        // Associer les r√¥les aux OPM IDs (prendre le premier r√¥le trouv√© pour chaque OPM ID)
                        rolesWithOpmIds.forEach(role => {
                            const opmId = role.opmId.toString().match(/\d+/)?.[0] || role.opmId;
                            
                            // Si nous n'avons pas encore de r√¥le pour cet OPM ID
                            if (!opmIdToRole[opmId]) {
                                opmIdToRole[opmId] = role;
                            }
                        });
                        
                        // Extraire uniquement les num√©ros d'OPM ID et √©liminer les doublons
                        const uniqueOpmIds = [...new Set(
                            rolesWithOpmIds.map(role => {
                                // Extraire uniquement les chiffres de l'OPM ID
                                const numericMatch = role.opmId.toString().match(/\d+/);
                                return numericMatch ? numericMatch[0] : role.opmId;
                            })
                        )];
                        
                        // Trier les OPM IDs num√©riquement
                        uniqueOpmIds.sort((a, b) => parseInt(a) - parseInt(b));
                        
                        // R√©cup√©rer le work role principal depuis localStorage
                        let primaryRoleOpmId = null;
                        try {
                            const step0DataStr = localStorage.getItem('step0_baseline_data');
                            if (step0DataStr) {
                                const step0Data = JSON.parse(step0DataStr);
                                if (step0Data.primaryRoleOpmId) {
                                    // Extraire uniquement les chiffres de l'OPM ID principal
                                    const numericMatch = step0Data.primaryRoleOpmId.toString().match(/\d+/);
                                    primaryRoleOpmId = numericMatch ? numericMatch[0] : step0Data.primaryRoleOpmId;
                                }
                            }
                        } catch (e) {
                            console.error('Erreur lors de la r√©cup√©ration du work role principal:', e);
                        }
                        
                        // NOTE: La l√©gende Symbology est maintenant g√©r√©e par initializeSymbologyLegend()
                        
                        // Cr√©er un tableau pour afficher les OPM IDs avec leurs graduations
                        const table = document.createElement('table');
                        table.className = 'w-full border-collapse mt-4 rounded-lg overflow-hidden shadow-sm';
                        table.style.borderRadius = '8px';
                        table.style.overflow = 'hidden';
                        table.style.border = '1px solid rgba(59, 130, 246, 0.2)';
                        
                        // Cr√©er le corps du tableau
                        const tbody = document.createElement('tbody');
                        tbody.className = 'bg-white divide-y divide-gray-200';
                        
                        // Ajouter une ligne d'en-t√™te avec les cases √† cocher "Tout s√©lectionner"
                        const headerRow = document.createElement('tr');
                        headerRow.className = 'border-b border-blue-100'; // Suppression du fond gris, juste une bordure subtile
                        
                        // Cellule pour la case √† cocher g√©n√©rale
                        const generalCell = document.createElement('td');
                        generalCell.className = 'px-2 py-2 text-center border-r border-blue-100';
                        generalCell.style.width = '40px';
                        
                        // Supprimer la cellule g√©n√©rale (plus n√©cessaire)
                        // generalCell est vide maintenant, on peut la supprimer ou la laisser vide
                        headerRow.appendChild(generalCell);
                        
                        // Cellule pour le libell√© "OPM ID"
                        const opmHeaderCell = document.createElement('td');
                        opmHeaderCell.className = 'px-2 py-2 text-left border-r border-blue-100';
                        opmHeaderCell.style.width = '80px';
                        
                        // Texte discret pour indiquer "Tout s√©lectionner" 
                        const selectAllText = document.createElement('span');
                        selectAllText.className = 'text-xs text-gray-500';
                        selectAllText.textContent = 'Tout s√©lectionner:';
                        opmHeaderCell.appendChild(selectAllText);
                        headerRow.appendChild(opmHeaderCell);
                        
                        // Cellule pour le titre
                        const titleHeaderCell = document.createElement('td');
                        titleHeaderCell.className = 'px-2 py-2 text-left border-r border-blue-100';
                        titleHeaderCell.style.width = '120px';
                        titleHeaderCell.textContent = 'Titre';
                        headerRow.appendChild(titleHeaderCell);
                        
                        // Cellule pour les cases "Tout s√©lectionner" des colonnes
                        const selectAllCell = document.createElement('td');
                        selectAllCell.className = 'px-2 py-2 border-r border-blue-100';
                        selectAllCell.style.width = '150px';
                        
                        // Conteneur pour les deux cases √† cocher "Tout s√©lectionner"
                        const selectAllContainer = document.createElement('div');
                        selectAllContainer.className = 'flex items-center space-x-6';
                        
                        // Conteneur pour la case de filtrage
                        const filterContainer = document.createElement('div');
                        filterContainer.className = 'flex items-center';
                        
                        // Case √† cocher "Tout s√©lectionner" pour le filtrage
                        const selectAllFilters = document.createElement('input');
                        selectAllFilters.type = 'checkbox';
                        selectAllFilters.className = 'select-all-filters';
                        selectAllFilters.title = "S√©lectionner tous les filtres";
                        selectAllFilters.style.width = '18px';
                        selectAllFilters.style.height = '18px';
                        selectAllFilters.style.cursor = 'pointer';
                        
                        // Label pour la case filtrage
                        const filterLabel = document.createElement('span');
                        filterLabel.className = 'ml-1 text-xs text-purple-600';
                        filterLabel.textContent = 'Filtrage';
                        
                        // Ajouter √† son conteneur
                        filterContainer.appendChild(selectAllFilters);
                        filterContainer.appendChild(filterLabel);
                        
                        // Ajouter la case √† cocher au conteneur principal
                        selectAllContainer.appendChild(filterContainer);
                        selectAllCell.appendChild(selectAllContainer);
                        headerRow.appendChild(selectAllCell);
                        
                        // Cellule d'en-t√™te pour les comp√©tences associ√©es
                        const competencesHeaderCell = document.createElement('td');
                        competencesHeaderCell.className = 'px-2 py-2 text-left';
                        competencesHeaderCell.textContent = 'Comp√©tences associ√©es';
                        headerRow.appendChild(competencesHeaderCell);
                        
                        // Ajouter la ligne d'en-t√™te au tableau
                        tbody.appendChild(headerRow);
                        
                        // Stocker l'√©tat de surbrillance pour chaque OPM ID
                        const opmHighlightState = {};
                        uniqueOpmIds.forEach(id => opmHighlightState[id] = false);
                        
                        // Ajouter une ligne pour chaque OPM ID
                        uniqueOpmIds.forEach(opmId => {
                            const role = opmIdToRole[opmId];
                            
                            // Utiliser la couleur sp√©cifique de compare_ksat.html si disponible
                            // Sinon, utiliser la couleur du r√¥le ou une couleur par d√©faut
                            const color = opmIdColors[opmId] || 
                                         (role && role.category_color ? role.category_color : '59, 130, 246');
                            
                            // Cr√©er une ligne pour cet OPM ID
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors';
                            row.dataset.opmId = opmId;
                            
                            // Ajouter une bordure inf√©rieure sauf pour la derni√®re ligne
                            row.style.borderBottom = '1px solid rgba(59, 130, 246, 0.1)';
                            
                            // Lors de la survole, mettre en √©vidence les cases √† cocher
                            row.addEventListener('mouseenter', function() {
                                const checkboxes = this.querySelectorAll('input[type="checkbox"]');
                                checkboxes.forEach(cb => {
                                    cb.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.2)';
                                });
                            });
                            
                            row.addEventListener('mouseleave', function() {
                                const checkboxes = this.querySelectorAll('input[type="checkbox"]');
                                checkboxes.forEach(cb => {
                                    cb.style.boxShadow = '';
                                });
                            });
                            
                            // Ajouter une cellule pour la case √† cocher de filtrage
                            const checkboxCell = document.createElement('td');
                            checkboxCell.className = 'px-2 py-1 text-center border-r border-blue-100';
                            checkboxCell.style.width = '40px';
                            
                            // Cr√©er la case √† cocher de filtrage
                            const filterCheckbox = document.createElement('input');
                            filterCheckbox.type = 'checkbox';
                            filterCheckbox.className = 'opm-filter-checkbox';
                            filterCheckbox.dataset.opmId = opmId;
                            filterCheckbox.setAttribute('id', `filter-opm-${opmId}`);
                            filterCheckbox.style.cursor = 'pointer';
                            filterCheckbox.style.width = '16px';
                            filterCheckbox.style.height = '16px';
                            filterCheckbox.title = "Filtrer les lignes pour n'afficher que celles-ci";
                            
                            // Ajouter un gestionnaire d'√©v√©nement pour la case √† cocher de filtrage
                            filterCheckbox.addEventListener('change', function() {
                                console.log(`Case de filtre chang√©e pour OPM ID ${opmId}: ${this.checked ? 'coch√©e' : 'd√©coch√©e'}`);
                                
                                // Sauvegarder l'√©tat dans localStorage
                                try {
                                    const filterStates = JSON.parse(localStorage.getItem('opmFilterStates') || '{}');
                                    filterStates[opmId] = this.checked;
                                    localStorage.setItem('opmFilterStates', JSON.stringify(filterStates));
                                } catch (e) {
                                    console.error('Erreur lors de la sauvegarde de l\'√©tat du filtre:', e);
                                }
                                
                                // Appliquer le filtrage
                                applySkillRowsFiltering();
                            });
                            
                            // Ajouter la case √† cocher √† la cellule
                            checkboxCell.appendChild(filterCheckbox);
                            row.appendChild(checkboxCell);
                            
                            // Cellule pour l'OPM ID avec sa couleur
                            const opmIdCell = document.createElement('td');
                            opmIdCell.className = 'px-2 py-1 border-r border-blue-100';
                            opmIdCell.style.width = '80px';
                            
                            // Afficher l'OPM ID avec sa couleur
                            const opmIdText = document.createElement('span');
                            opmIdText.className = 'font-semibold';
                            opmIdText.style.color = `rgba(${color}, 1)`;
                            opmIdText.textContent = opmId;
                            
                            // Ajouter une √©toile si c'est le work role principal
                            if (primaryRoleOpmId && opmId === primaryRoleOpmId) {
                                const starIcon = document.createElement('span');
                                starIcon.className = 'ml-1 text-amber-500';
                                starIcon.innerHTML = '‚òÖ';
                                starIcon.title = 'Primary Work Role';
                                starIcon.style.fontSize = '14px';
                                opmIdText.appendChild(starIcon);
                            }
                            
                            opmIdCell.appendChild(opmIdText);
                            row.appendChild(opmIdCell);
                            
                            // Cellule pour le titre du r√¥le
                            const titleCell = document.createElement('td');
                            titleCell.className = 'px-2 py-1 border-r border-blue-100';
                            titleCell.style.width = '120px';
                            
                            // Afficher le titre du r√¥le si disponible
                            if (role && (role.title || role.ncwf_work_role || role.dcwf_work_role)) {
                                titleCell.textContent = role.title || role.ncwf_work_role || role.dcwf_work_role;
                            } else {
                                titleCell.textContent = getOpmIdTitle(opmId);
                            }
                            row.appendChild(titleCell);
                            
                            // Cellule contenant les niveaux de graduation (1-7)
                            const graduationCell = document.createElement('td');
                            graduationCell.className = 'px-2 py-1 border-r border-blue-100';
                            graduationCell.style.width = '150px';
                            
                            // Cr√©er un conteneur flex pour les niveaux
                            const levelContainer = document.createElement('div');
                            levelContainer.className = 'flex flex-row items-center space-x-1';
                            
                            // Ajouter les 7 niveaux de graduation
                            for (let i = 1; i <= 7; i++) {
                                // Cr√©er un conteneur pour chaque niveau
                                const levelBox = document.createElement('div');
                                levelBox.className = 'flex flex-col items-center justify-center';
                                
                                // Cr√©er le cercle de niveau
                                const circle = document.createElement('div');
                                circle.className = 'w-5 h-5 rounded-full flex items-center justify-center';
                                // Stocker la couleur dans un data-attribute pour pouvoir la r√©cup√©rer plus tard
                                circle.dataset.opmColor = color;
                                // Utiliser la m√™me couleur que l'OPM ID affich√©, avec une opacit√© pour le fond
                                circle.style.backgroundColor = `rgba(${color}, 0.3)`;
                                circle.style.border = `2px solid rgba(${color}, 1)`;
                                
                                // Ajouter le num√©ro dans le cercle avec la m√™me couleur que l'OPM ID
                                const levelNumber = document.createElement('span');
                                levelNumber.className = 'text-xs font-medium';
                                levelNumber.style.color = `rgba(${color}, 1)`;
                                levelNumber.style.textShadow = '0 1px 2px rgba(255, 255, 255, 0.8)';
                                levelNumber.style.fontWeight = 'bold';
                                levelNumber.textContent = i;
                                circle.appendChild(levelNumber);
                                
                                levelBox.appendChild(circle);
                                levelContainer.appendChild(levelBox);
                            }
                            
                            graduationCell.appendChild(levelContainer);
                            row.appendChild(graduationCell);
                            
                            // Cellule pour les comp√©tences associ√©es
                            const competencesCell = document.createElement('td');
                            competencesCell.className = 'px-2 py-1 competences-cell';
                            competencesCell.dataset.opmId = opmId;
                            row.appendChild(competencesCell);
                            
                            tbody.appendChild(row);
                        });
                        
                        table.appendChild(tbody);
                        opmIdsList.appendChild(table);
                        
                        // NOTE: Ce code de tableau est obsol√®te - les badges sont maintenant g√©r√©s
                        // via updateRoleHighlightsAndBadges() dans les cards
                        
                        // Protection : s'assurer que les couleurs des cercles sont pr√©serv√©es apr√®s leur cr√©ation
                        // Fonction pour appliquer et pr√©server les couleurs des cercles
                        function preserveCircleColors() {
                            document.querySelectorAll('#opm-ids-list table tr[data-opm-id]').forEach(row => {
                                const opmId = row.dataset.opmId;
                                const opmIdText = row.querySelector('td:nth-child(2) span');
                                if (opmIdText) {
                                    // R√©cup√©rer la couleur depuis le span de l'OPM ID
                                    const computedColor = window.getComputedStyle(opmIdText).color;
                                    const rgbMatch = computedColor.match(/\d+/g);
                                    if (rgbMatch && rgbMatch.length >= 3) {
                                        const color = `${rgbMatch[0]}, ${rgbMatch[1]}, ${rgbMatch[2]}`;
                                        
                                        // Appliquer la couleur √† tous les cercles de cette ligne
                                        const levelCircles = row.querySelectorAll('td:nth-child(4) .flex.flex-row > div > div');
                                        levelCircles.forEach(circle => {
                                            // Toujours stocker et appliquer la couleur correcte
                                            circle.dataset.opmColor = color;
                                            circle.style.backgroundColor = `rgba(${color}, 0.3)`;
                                            circle.style.borderColor = `rgba(${color}, 1)`;
                                            circle.style.borderWidth = '2px';
                                            
                                            const textElement = circle.querySelector('span');
                                            if (textElement) {
                                                textElement.style.color = `rgba(${color}, 1)`;
                                                textElement.style.textShadow = '0 1px 2px rgba(255, 255, 255, 0.8)';
                                                textElement.style.fontWeight = 'bold';
                                            }
                                        });
                                    }
                                }
                            });
                        }
                        
                        // Appliquer imm√©diatement apr√®s la cr√©ation
                        preserveCircleColors();
                        
                        // R√©appliquer apr√®s un court d√©lai pour contrer toute modification ult√©rieure
                        setTimeout(preserveCircleColors, 100);
                        setTimeout(preserveCircleColors, 500);
                        setTimeout(preserveCircleColors, 1000);
                        
                        // Observer les changements de style sur les cercles pour les restaurer si n√©cessaire
                        const circleObserver = new MutationObserver((mutations) => {
                            mutations.forEach((mutation) => {
                                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                                    const circle = mutation.target;
                                    if (circle.classList && circle.classList.contains('rounded-full')) {
                                        const row = circle.closest('tr[data-opm-id]');
                                        if (row) {
                                            const opmId = row.dataset.opmId;
                                            const opmIdText = row.querySelector('td:nth-child(2) span');
                                            if (opmIdText) {
                                                const storedColor = circle.dataset.opmColor;
                                                if (storedColor) {
                                                    // V√©rifier si la couleur a √©t√© chang√©e en bleu par d√©faut
                                                    const currentBg = circle.style.backgroundColor;
                                                    if (currentBg && currentBg.includes('59, 130, 246')) {
                                                        // Restaurer la couleur correcte
                                                        circle.style.backgroundColor = `rgba(${storedColor}, 0.3)`;
                                                        circle.style.borderColor = `rgba(${storedColor}, 1)`;
                                                        
                                                        const textElement = circle.querySelector('span');
                                                        if (textElement) {
                                                            textElement.style.color = `rgba(${storedColor}, 1)`;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        });
                        
                        // Observer tous les cercles existants
                        setTimeout(() => {
                            document.querySelectorAll('#opm-ids-list table tr td:nth-child(4) .flex.flex-row > div > div').forEach(circle => {
                                circleObserver.observe(circle, { attributes: true, attributeFilter: ['style'] });
                            });
                        }, 200);
                        
                        // G√©rer la case "Tout s√©lectionner" pour le filtrage
                        const selectAllFiltersCheckbox = document.querySelector('.select-all-filters');
                        
                        if (selectAllFiltersCheckbox) {
                            // Fonction pour mettre √† jour l'√©tat des cases √† cocher individuelles
                            function updateCheckboxes(checkboxClass, checked) {
                                document.querySelectorAll(checkboxClass).forEach(checkbox => {
                                    if (checkbox.checked !== checked) {
                                        checkbox.checked = checked;
                                        // D√©clencher manuellement l'√©v√©nement change
                                        const event = new Event('change');
                                        checkbox.dispatchEvent(event);
                                    }
                                });
                            }
                            
                            // Fonction pour v√©rifier si tous les √©l√©ments d'une classe sont coch√©s ou non
                            function areAllChecked(checkboxClass) {
                                const checkboxes = document.querySelectorAll(checkboxClass);
                                if (checkboxes.length === 0) return false;
                                let allChecked = true;
                                checkboxes.forEach(checkbox => {
                                    if (!checkbox.checked) {
                                        allChecked = false;
                                    }
                                });
                                return allChecked;
                            }
                            
                            // Gestionnaire pour la case "Tout s√©lectionner" des filtres
                            selectAllFiltersCheckbox.addEventListener('change', function() {
                                updateCheckboxes('.opm-filter-checkbox', this.checked);
                            });
                            
                            // √âcouter les changements sur les cases individuelles pour mettre √† jour la case "Tout s√©lectionner"
                            document.querySelectorAll('.opm-filter-checkbox').forEach(checkbox => {
                                checkbox.addEventListener('change', function() {
                                    selectAllFiltersCheckbox.checked = areAllChecked('.opm-filter-checkbox');
                                });
                            });
                        }
                        
                        // Restaurer l'√©tat des cases de filtrage depuis localStorage
                        setTimeout(() => {
                            try {
                                const filterStates = JSON.parse(localStorage.getItem('opmFilterStates') || '{}');
                                
                                document.querySelectorAll('.opm-filter-checkbox').forEach(checkbox => {
                                    const opmId = checkbox.dataset.opmId;
                                    if (opmId in filterStates) {
                                        checkbox.checked = filterStates[opmId];
                                        console.log(`√âtat du filtre pour OPM ID ${opmId} restaur√©: ${checkbox.checked}`);
                                    }
                                });
                                
                                // Mettre √† jour la case "Tout s√©lectionner"
                                if (selectAllFiltersCheckbox) {
                                    selectAllFiltersCheckbox.checked = areAllChecked('.opm-filter-checkbox');
                                }
                                
                                // Appliquer le filtrage initial
                                applySkillRowsFiltering();
                            } catch (e) {
                                console.error('Erreur lors de la restauration des √©tats:', e);
                            }
                            
                            // Ajouter les badges de comp√©tences dans la colonne d√©di√©e
                            setTimeout(() => {
                                // Acc√©der √† la variable globale specialOpmConfigs
                                const specialConfigs = window.specialOpmConfigs || [];
                                console.log("Configurations sp√©ciales disponibles:", specialConfigs);
                                
                                                                        // D√©finir un mapping de couleurs pour chaque type de comp√©tence
                                        const competenceColors = {
                                    'ITSP': '#e11d48', 'ISCO': '#e11d48', 'IRMG': '#e11d48', 'STPL': '#e11d48',
                                            'ARCH': '#e11d48', 'INOV': '#e11d48', 'EMRG': '#e11d48', 'RSCH': '#e11d48',
                                            'SUST': '#e11d48', 'FMIT': '#e11d48', 'INVA': '#e11d48', 'BENM': '#e11d48',
                                            'BUDF': '#e11d48', 'FIAN': '#e11d48', 'COMG': '#e11d48', 'DEMM': '#e11d48',
                                            'MEAS': '#e11d48', 'SCTY': '#e11d48', 'INAS': '#e11d48', 'PEDP': '#e11d48',
                                            'VURE': '#e11d48', 'THIN': '#e11d48', 'GOVN': '#e11d48', 'BURM': '#e11d48',
                                            'AIDE': '#e11d48', 'AUDT': '#e11d48', 'QUMG': '#e11d48', 'QUAS': '#e11d48',
                                            'CNSL': '#e11d48', 'TECH': '#e11d48', 'METL': '#e11d48',
                                            
                                            // Cat√©gorie: Development and implementation (Jaune)
                                            'PROD': '#facc15', 'DLMG': '#facc15', 'SLEN': '#facc15', 'DESN': '#facc15',
                                            'SWDN': '#facc15', 'NTDS': '#facc15', 'IFDN': '#facc15', 'HWDE': '#facc15',
                                            'PROG': '#facc15', 'SINT': '#facc15', 'TEST': '#facc15', 'NFTS': '#facc15',
                                            'PRTS': '#facc15', 'PORT': '#facc15', 'RESD': '#facc15', 'SFEN': '#facc15',
                                            'SFAS': '#facc15', 'RFEN': '#facc15', 'ADEV': '#facc15', 'DATM': '#facc15',
                                            'DTAN': '#facc15', 'DBDS': '#facc15', 'DNAN': '#facc15', 'DATS': '#facc15',
                                            'MLNG': '#facc15', 'BINT': '#facc15', 'DENG': '#facc15', 'VISL': '#facc15',
                                            'URCH': '#facc15', 'CEXP': '#facc15', 'ACIN': '#facc15', 'UNAN': '#facc15',
                                            'HCEV': '#facc15', 'USEV': '#facc15', 'INCA': '#facc15', 'ICPM': '#facc15',
                                            'KNOW': '#facc15', 'GRON': '#facc15', 'SCMO': '#facc15', 'NUAN': '#facc15',
                                            'HPCC': '#facc15',
                                            
                                            // Cat√©gorie: Delivery and operation (Orange)
                                            'ITMG': '#ea580c', 'ASUP': '#ea580c', 'ITOP': '#ea580c', 'SYSP': '#ea580c',
                                            'NTAS': '#ea580c', 'HSIN': '#ea580c', 'CFMG': '#ea580c', 'RELM': '#ea580c',
                                            'DEPL': '#ea580c', 'STMG': '#ea580c', 'DCMA': '#ea580c', 'SLMO': '#ea580c',
                                            'SCMG': '#ea580c', 'AVMT': '#ea580c', 'COPL': '#ea580c', 'CPMG': '#ea580c',
                                            'USUP': '#ea580c', 'PBMG': '#ea580c', 'CHMG': '#ea580c', 'ASMG': '#ea580c',
                                            'SEAC': '#ea580c', 'SCAD': '#ea580c', 'IAMT': '#ea580c', 'VUAS': '#ea580c',
                                            'DGFS': '#ea580c', 'CRIM': '#ea580c', 'OCOP': '#ea580c', 'PENT': '#ea580c',
                                            'RMGT': '#ea580c', 'ANCC': '#ea580c', 'DBAD': '#ea580c',
                                            
                                            // Cat√©gorie: Change and transformation (Rose)
                                            'POMG': '#db2777', 'PGMG': '#db2777', 'PRMG': '#db2777', 'PROF': '#db2777',
                                            'BUSA': '#db2777', 'FEAS': '#db2777', 'REQM': '#db2777', 'BSMO': '#db2777',
                                            'BPTS': '#db2777', 'BPRE': '#db2777', 'OCDV': '#db2777', 'JADN': '#db2777',
                                            'ORDI': '#db2777', 'CIPM': '#db2777', 'OCEN': '#db2777',
                                            
                                            // Cat√©gorie: People and skills (Cyan)
                                            'PEMT': '#0891b2', 'EEXP': '#0891b2', 'OFCL': '#0891b2', 'PDSV': '#0891b2',
                                            'WFPL': '#0891b2', 'RESC': '#0891b2', 'ETMG': '#0891b2', 'TMCR': '#0891b2',
                                            'ETDL': '#0891b2', 'LEDA': '#0891b2', 'CSOP': '#0891b2', 'TEAC': '#0891b2',
                                            'SUBF': '#0891b2',
                                            
                                            // Cat√©gorie: Relationships and engagement (Vert)
                                            'SORC': '#16a34a', 'SUPP': '#16a34a', 'ITCM': '#16a34a', 'RLMT': '#16a34a',
                                            'CSMG': '#16a34a', 'ADMN': '#16a34a', 'BIDM': '#16a34a', 'SALE': '#16a34a',
                                            'SSUP': '#16a34a', 'MKTG': '#16a34a', 'MRCH': '#16a34a', 'BRMG': '#16a34a',
                                            'CELO': '#16a34a', 'MKCM': '#16a34a', 'DIGM': '#16a34a'
                                        };
                                
                                // Pour chaque OPM ID dans le tableau, mettre √† jour les comp√©tences associ√©es
                                document.querySelectorAll('#opm-ids-list tr[data-opm-id]').forEach(row => {
                                    const opmId = row.dataset.opmId;
                                    if (!opmId) return;
                                    
                                    // Trouver la cellule d√©di√©e aux comp√©tences (5√®me colonne)
                                    const competencesCell = row.querySelector('td.competences-cell');
                                    if (!competencesCell) return;
                                    
                                    // Supprimer l'ancien conteneur s'il existe (pour √©viter les doublons)
                                    const existingContainer = competencesCell.querySelector('.competence-container');
                                    if (existingContainer) {
                                        existingContainer.remove();
                                    }
                                    
                                    // Chercher d'abord dans les configurations sp√©ciales
                                    let competenceCodes = [];
                                    const specialConfig = specialConfigs.find(cfg => cfg.opmId === opmId);
                                    
                                    if (specialConfig && specialConfig.competences && specialConfig.competences.length > 0) {
                                        // Utiliser les comp√©tences d√©finies dans la configuration sp√©ciale
                                        competenceCodes = specialConfig.competences.map(comp => comp.code);
                                        console.log(`Comp√©tences pour OPM ID ${opmId} trouv√©es dans specialOpmConfigs:`, competenceCodes);
                                    } else {
                                        // Si on ne trouve pas dans les configurations sp√©ciales, chercher dans le DOM
                                        document.querySelectorAll('.level-box.filled[data-opm-id]').forEach(cell => {
                                            const cellOpmIds = cell.dataset.opmId ? cell.dataset.opmId.split(',') : [];
                                            if (cellOpmIds.includes(opmId)) {
                                                const row = cell.closest('.skill-row');
                                                if (row) {
                                                    const codeElement = row.querySelector('.skill-code');
                                                    if (codeElement && codeElement.textContent) {
                                                        const code = codeElement.textContent.trim();
                                                        if (!competenceCodes.includes(code)) {
                                                            competenceCodes.push(code);
                                                        }
                                                    }
                                                }
                                            }
                                        });
                                        console.log(`Comp√©tences pour OPM ID ${opmId} trouv√©es dans le DOM:`, competenceCodes);
                                    }
                                    
                                    // Ajout manuel pour certains OPM IDs qui pourraient manquer
                                    const manualMappings = {
                                        '111': ['VURE', 'THIN', 'SCAD'],
                                        '112': ['MEAS', 'SCTY', 'INAS', 'THIN'],
                                        '121': ['GOVN', 'METL'],
                                        '141': ['THIN', 'VISL', 'SCAD'],
                                        '151': ['KNOW', 'DATS', 'PENT'],
                                        '221': ['EMRG', 'TECH', 'RSCH'],
                                        '332': ['PENT', 'SCTY', 'PROG'],
                                        '421': ['DATS', 'DBAD', 'DENG'],
                                        '422': ['DATS', 'MLNG', 'DENG'],
                                        '431': ['KNOW', 'ICPM'],
                                        '443': ['KNOW', 'DATS', 'PENT'],
                                        '461': ['PROG', 'SWDN', 'TECH'],
                                        '511': ['DBAD', 'STMG'],
                                        '521': ['TECH', 'USUP'],
                                        '531': ['NTAS', 'NTDS'],
                                        '541': ['ITOP', 'COPL'],
                                        '611': ['IRMG', 'BURM', 'SCTY'],
                                        '621': ['SCTY', 'INAS', 'VUAS'],
                                        '622': ['VUAS', 'PENT'],
                                        '631': ['SCTY', 'VUAS', 'COPL', 'ARCH', 'DESN', 'TEST', 'PENT'],
                                        '661': ['VURE', 'RSCH', 'EMRG', 'TECH'],
                                        '722': ['SCTY', 'INAS'],
                                        '723': ['INAS', 'VUAS', 'SCAD'],
                                        '752': ['INAS', 'SCTY', 'OCDV', 'WFPL'],
                                        '901': ['SCTY', 'BURM', 'INAS'],
                                    };
                                    
                                    // Si on a d√©j√† trouv√© des comp√©tences, ne pas utiliser le mapping manuel
                                    if (manualMappings[opmId] && competenceCodes.length === 0) {
                                        competenceCodes = manualMappings[opmId];
                                        console.log(`Comp√©tences pour OPM ID ${opmId} ajout√©es manuellement:`, competenceCodes);
                                    }
                                    
                                    // Si on a des codes de comp√©tence, cr√©er les badges
                                    if (competenceCodes.length > 0) {
                                        const competenceContainer = document.createElement('div');
                                        competenceContainer.className = 'competence-container flex flex-wrap gap-2 items-center';
                                        
                                        // Fonction pour obtenir une couleur bas√©e sur le code
                                        function getColorForCode(code) {
                                            // Utiliser les couleurs d√©finies dans competenceColors
                                            return competenceColors[code] || '#6c757d'; // Gris par d√©faut
                                        }
                                        
                                        // Fonction pour obtenir une description pour un code
                                        function getDescriptionForCode(code) {
                                            const descriptions = {
                                                'SCTY': 'S√©curit√© des syst√®mes d\'information',
                                                'INAS': 'Assurance de l\'information',
                                                'VURE': 'Recherche de vuln√©rabilit√©s',
                                                'THIN': 'Renseignement sur les menaces',
                                                'BURM': 'Gestion des risques',
                                                'PROG': 'Programmation et d√©veloppement',
                                                'SWDN': 'Conception de logiciels',
                                                'ARCH': 'Architecture de solutions',
                                                'DATS': 'Science des donn√©es',
                                                'VISL': 'Visualisation de donn√©es',
                                                'DBAD': 'Administration de bases de donn√©es',
                                                'STMG': 'Gestion du stockage',
                                                'NTAS': 'Services r√©seau',
                                                'NTDS': 'Conception de r√©seau',
                                                'COPL': 'Planification de la continuit√©',
                                                'ITOP': 'Op√©rations informatiques',
                                                'TECH': 'Conseil technique',
                                                'USUP': 'Support utilisateur',
                                                'GOVN': 'Gouvernance',
                                                'METL': 'M√©thodes et outils',
                                                'KNOW': 'Gestion des connaissances',
                                                'OCDV': 'D√©veloppement des capacit√©s',
                                                'WFPL': 'Planification de la main-d\'≈ìuvre',
                                                'IRMG': 'Gestion des risques informationnels',
                                                'VUAS': '√âvaluation des vuln√©rabilit√©s',
                                                'PENT': 'Tests de p√©n√©tration',
                                                'SCAD': 'Op√©rations de s√©curit√©',
                                                'ICPM': 'Gestion des contenus informatifs',
                                                'DENG': 'Ing√©nierie des donn√©es',
                                                'MLNG': 'Apprentissage automatique',
                                                'EMRG': 'Technologies √©mergentes',
                                                'RSCH': 'Recherche',
                                                'DESN': 'Conception de syst√®mes',
                                                'TEST': 'Tests fonctionnels'
                                            };
                                            
                                            return descriptions[code] || '';
                                        }
                                        
                                        // Limite du nombre de badges √† afficher (pour √©viter de surcharger l'interface)
                                        const maxBadges = 8; // On peut en afficher plus maintenant qu'on a plus d'espace
                                        const displayCodes = competenceCodes.slice(0, maxBadges);
                                        
                                        // D√âSACTIV√â : Ne plus cr√©er les badges spans
                                        // displayCodes.forEach(code => {
                                        //     const badge = document.createElement('span');
                                        //     badge.className = 'inline-block text-white px-2.5 py-1 rounded-md mr-2';
                                        //     badge.style.backgroundColor = getColorForCode(code);
                                        //     badge.style.fontWeight = '600';
                                        //     badge.style.fontSize = '12px';
                                        //     badge.style.letterSpacing = '0.03em';
                                        //     badge.style.lineHeight = '1.3';
                                        //     badge.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
                                        //     badge.style.border = '1px solid rgba(255,255,255,0.2)';
                                        //     badge.textContent = code;
                                        //     
                                        //     const description = getDescriptionForCode(code);
                                        //     if (description) {
                                        //         badge.title = description;
                                        //         badge.style.cursor = 'help';
                                        //     }
                                        //     
                                        //     competenceContainer.appendChild(badge);
                                        // });
                                        // 
                                        // if (competenceCodes.length > maxBadges) {
                                        //     const moreBadge = document.createElement('span');
                                        //     moreBadge.className = 'inline-block text-white px-2.5 py-1 rounded-md';
                                        //     moreBadge.style.backgroundColor = '#6c757d';
                                        //     moreBadge.style.fontWeight = '600';
                                        //     moreBadge.style.fontSize = '12px';
                                        //     moreBadge.style.lineHeight = '1.3';
                                        //     moreBadge.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
                                        //     moreBadge.style.border = '1px solid rgba(255,255,255,0.2)';
                                        //     moreBadge.textContent = `+${competenceCodes.length - maxBadges}`;
                                        //     moreBadge.style.cursor = 'help';
                                        //     moreBadge.title = competenceCodes.join(', ');
                                        //     competenceContainer.appendChild(moreBadge);
                                        // }
                                        // 
                                        // competencesCell.appendChild(competenceContainer);
                                        
                                        // Nettoyer imm√©diatement tout texte "related:" qui pourrait appara√Ætre
                                        setTimeout(() => {
                                            const container = competencesCell.querySelector('.competence-container');
                                            if (container) {
                                                // Supprimer tous les spans contenant "related:"
                                                const allSpans = container.querySelectorAll('span');
                                                allSpans.forEach(span => {
                                                    if (span.textContent && span.textContent.trim() === 'related:') {
                                                        span.remove();
                                                    }
                                                });
                                                // Nettoyer le texte direct
                                                const walker = document.createTreeWalker(
                                                    container,
                                                    NodeFilter.SHOW_TEXT,
                                                    null,
                                                    false
                                                );
                                                let node;
                                                while (node = walker.nextNode()) {
                                                    if (node.textContent && node.textContent.includes('related:')) {
                                                        node.textContent = node.textContent.replace(/related:\s*/g, '').trim();
                                                    }
                                                }
                                            }
                                        }, 10);
                                    }
                                });
                            }, 500);
                        }, 100);
                    } else {
                        opmIdsList.innerHTML = `
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">
                                            Aucun OPM ID trouv√© dans la s√©lection.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    opmIdsList.innerHTML = `
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">
                                        Veuillez d'abord s√©lectionner une sauvegarde √† l'√©tape 2.
                                        <a href="{% url 'etape2_first_step' %}" class="font-medium underline text-blue-700 hover:text-blue-600">
                                            Aller √† l'√©tape 2
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des OPM IDs:', error);
                document.getElementById('opm-ids-list').innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700">
                                    Erreur lors du chargement des OPM IDs: ${error.message}
                                </p>
                                <p class="text-xs text-red-600 mt-1">
                                    Essayez de rafra√Æchir la page ou de retourner √† l'√©tape 2.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // --- G√âN√âRATEUR DYNAMIQUE DE GRILLE ---
        const gridContainer = document.getElementById('sfia-grid');

        function createSkillRow(skill) {
            // Cr√©er les cellules pour les niveaux 1 √† 7 (sans la cellule "X")
            let levelBoxesHtml = '';
            for (let i = 1; i <= 7; i++) {
                const isFilled = skill.levels.includes(i) ? 'filled' : '';
                levelBoxesHtml += `<div class="level-box ${isFilled}" data-skill-code="${skill.code}" data-level="${i}">${i}</div>`;
            }

            return `
                <div class="skill-row">
                    <div class="skill-name" data-skill-code="${skill.code}">${skill.name}</div>
                    <div class="skill-code" data-skill-code="${skill.code}">${skill.code}</div>
                    <div class="level-boxes">${levelBoxesHtml}</div>
                </div>
            `;
        }
        
        function createLevelHeader() {
            // Cr√©er les cellules pour les niveaux 1 √† 7 dans l'en-t√™te (sans la cellule "X")
            let levelNumbersHtml = '';
            for (let i = 1; i <= 7; i++) {
                levelNumbersHtml += `<div class="level-number">${i}</div>`;
            }
            return `
                 <div class="level-header">
                    <div class="flex-grow"></div>
                    ${levelNumbersHtml}
                </div>
            `;
        }

        sfiaData.forEach(category => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = `category-container ${category.cssClass}`;

            let subcategoriesHtml = '';
            category.subcategories.forEach(subcategory => {
                const skillsHtml = subcategory.skills.map(createSkillRow).join('');
                subcategoriesHtml += `
                    <div class="subcategory">
                        <div class="subcategory-header">${subcategory.name}</div>
                        ${skillsHtml}
                    </div>
                `;
            });

            categoryDiv.innerHTML = `
                <div class="category-header">${category.name}</div>
                ${createLevelHeader()}
                ${subcategoriesHtml}
            `;
            gridContainer.appendChild(categoryDiv);
        });
        
        // Configurer les tooltips apr√®s le rendu de la grille
        setupSkillTooltips();
        
        // --- LOGIQUE DE LA PAGE ---

        // Mobile menu
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

        // Dark Mode
        const darkModeToggle = document.getElementById('darkModeToggle');
        const moonIcon = document.getElementById('moonIcon');
        const sunIcon = document.getElementById('sunIcon');
        const isDarkMode = () => localStorage.getItem('darkMode') === 'true';

        const updateDarkMode = () => {
            if (isDarkMode()) {
                document.body.classList.add('dark-mode');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark-mode');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
        };

        darkModeToggle.addEventListener('click', () => {
            localStorage.setItem('darkMode', !isDarkMode());
            updateDarkMode();
        });

        // Initialiser le mode sombre en fonction de la pr√©f√©rence stock√©e
        updateDarkMode();

        // --- MODAL HANDLERS ---
        const completeButton = document.getElementById('complete-button');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');

        completeButton.addEventListener('click', () => {
            confirmationModal.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.add('opacity-50');
                modalContent.classList.add('opacity-100', 'scale-100');
                modalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);
        });

        function closeModal() {
            modalBackdrop.classList.remove('opacity-50');
            modalContent.classList.remove('opacity-100', 'scale-100');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                confirmationModal.classList.add('hidden');
            }, 300);
        }

        modalBackdrop.addEventListener('click', closeModal);
        modalCancel.addEventListener('click', closeModal);
        modalConfirm.addEventListener('click', () => {
            window.location.href = "/ksat/step2/"; // Retourner √† l'√©tape 2
        });
        
        // --- HANDLE OPM ID 901 SPECIAL BEHAVIOR ---
        function handleSpecialOpmBehavior() {
            // V√©rifier si l'OPM ID 901 ou 722 est pr√©sent
            const selectedRolesContainer = document.getElementById('selected-roles-container');
            const has901 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('901');
            const has722 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('722');
            const has723 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('723');
            const has752 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('752');
            const has661 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('661');
            const has622 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('622');
            const has631 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('631');
            const has461 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('461');
            const has511 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('511');
            const has521 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('521');
            const has531 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('531');
            const has541 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('541');
            const has141 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('141');
            const has121 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('121');
            const has111 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('111');
            const has112 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('112');
            const has443 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('443');
            const has151 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('151');
            const has331 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('331');
            const has332 = selectedRolesContainer && selectedRolesContainer.textContent && selectedRolesContainer.textContent.includes('332');
                const has132 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('132');
                const has333 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('333');
                const has334 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('334');
                const has131 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('131');
                const has321 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('321');
                const has221 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('221');
                const has211 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('211');
                const has212 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('212');
                const has651 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('651');
                const has652 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('652');
                const has621 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('621');
                const has641 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('641');
                const has671 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('671');
                const has632 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('632');
                const has411 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('411');
                const has451 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('451');
                const has441 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('441');
                const has803 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('803');
                const has801 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('801');
                const has802 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('802');
                const has804 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('804');
                const has312 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('312');
                const has421 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('421');
                const has422 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('422');
                const has612 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('612');
                const has805 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('805');
                const has731 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('731');
                const has732 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('732');
                const has751 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('751');
                const has711 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('711');
                const has712 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('712');
                const has311 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('311');
                const has431 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('431');
                const has611 = opmIdsList && opmIdsList.textContent && opmIdsList.textContent.includes('611');
            
            // Configuration des OPM IDs sp√©ciaux et leurs comportements - TOUJOURS isPresent: false par d√©faut
            window.specialOpmConfigs = [
                {
                    opmId: '901',
                    color: '153, 86, 206', // Mauve
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'SCTY', levels: [7], description: 'S√©curisation des syst√®mes d\'information et des donn√©es contre les menaces internes et externes.' },
                        { code: 'BURM', levels: [7], description: 'Identification, √©valuation et contr√¥le des risques au sein de l\'organisation.' },
                        { code: 'INAS', levels: [7], description: 'Protection des informations critiques et maintien de leur confidentialit√©, int√©grit√© et disponibilit√©.' }
                    ]
                },
                {
                    opmId: '722',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'SCTY', levels: [5, 6], description: 'S√©curisation des syst√®mes d\'information et des donn√©es contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [5, 6], description: 'Protection des informations critiques et maintien de leur confidentialit√©, int√©grit√© et disponibilit√©.' }
                    ]
                },
                {
                    opmId: '723',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'INAS', levels: [5, 6], description: 'Protection des informations critiques et maintien de leur confidentialit√©, int√©grit√© et disponibilit√©.' },
                        { code: 'VUAS', levels: [5, 6], description: '√âvaluation des syst√®mes et r√©seaux pour d√©tecter les vuln√©rabilit√©s et les faiblesses de s√©curit√©.' },
                        { code: 'SCAD', levels: [5, 6], description: 'Surveillance et gestion des op√©rations de s√©curit√© pour prot√©ger contre les menaces et incidents.' }
                    ]
                },
                {
                    opmId: '752',
                    color: '153, 86, 206', // Mauve (couleur des cyberspace enablers)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'INAS', levels: [6], description: 'Protection des informations critiques et maintien de leur confidentialit√©, int√©grit√© et disponibilit√©.' },
                        { code: 'SCTY', levels: [6], description: 'S√©curisation des syst√®mes d\'information et des donn√©es contre les menaces internes et externes.' },
                        { code: 'OCDV', levels: [6], description: 'D√©veloppement et am√©lioration des capacit√©s organisationnelles pour r√©pondre aux besoins actuels et futurs.' },
                        { code: 'WFPL', levels: [6], description: 'Planification strat√©gique de la main-d\'≈ìuvre pour r√©pondre aux besoins organisationnels.' }
                    ]
                },
                {
                    opmId: '661',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vuln√©rabilit√©s pour am√©liorer la s√©curit√© des syst√®mes.' },
                        { code: 'RSCH', levels: [3, 4, 5], description: 'Conduite de recherche formelle pour d√©velopper de nouvelles connaissances et technologies.' },
                        { code: 'EMRG', levels: [4, 5], description: 'Suivi des technologies √©mergentes pour identifier les opportunit√©s et les risques futurs.' },
                        { code: 'TECH', levels: [4, 5], description: 'Fourniture de conseils techniques sp√©cialis√©s pour soutenir les d√©cisions strat√©giques.' }
                    ]
                },
                {
                    opmId: '622',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'VUAS', levels: [3, 4, 5], description: '√âvaluation des syst√®mes et r√©seaux pour d√©tecter les vuln√©rabilit√©s et les faiblesses de s√©curit√©.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour √©valuer la s√©curit√© des syst√®mes et identifier les vuln√©rabilit√©s exploitables.' }
                    ]
                },
                {
                    opmId: '631',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'SCTY', levels: [3, 4, 5], description: 'S√©curisation des syst√®mes d\'information et des donn√©es contre les menaces internes et externes.' },
                        { code: 'VUAS', levels: [3, 4, 5], description: '√âvaluation des syst√®mes et r√©seaux pour d√©tecter les vuln√©rabilit√©s et les faiblesses de s√©curit√©.' },
                        { code: 'COPL', levels: [3, 4, 5], description: 'Planification et gestion de la continuit√© des services informatiques face aux incidents.' },
                        { code: 'ARCH', levels: [4, 5], description: 'Conception de solutions techniques r√©pondant aux exigences m√©tier et techniques.' },
                        { code: 'DESN', levels: [3, 4, 5], description: 'Conception de syst√®mes conformes aux sp√©cifications et adapt√©s aux besoins des utilisateurs.' },
                        { code: 'TEST', levels: [3, 4, 5], description: 'Conception et ex√©cution de tests fonctionnels pour v√©rifier la conformit√© des syst√®mes.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour √©valuer la s√©curit√© des syst√®mes et identifier les vuln√©rabilit√©s exploitables.' }
                    ]
                },
                {
                    opmId: '461',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'PROG', levels: [3, 4, 5], description: 'D√©veloppement de logiciels selon des sp√©cifications et standards √©tablis.' },
                        { code: 'SWDN', levels: [3, 4, 5], description: 'Conception d\'architectures logicielles adapt√©es aux besoins m√©tier et techniques.' },
                        { code: 'TECH', levels: [3, 4, 5], description: 'Fourniture de conseils techniques sp√©cialis√©s pour soutenir les d√©cisions et projets.' }
                    ]
                },
                {
                    opmId: '511',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'DBAD', levels: [2, 3, 4, 5], description: 'Administration des bases de donn√©es pour en assurer la disponibilit√© et la performance.' },
                        { code: 'STMG', levels: [2, 3, 4, 5], description: 'Gestion du stockage des donn√©es pour garantir leur s√©curit√© et accessibilit√©.' }
                    ]
                },
                {
                    opmId: '521',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'TECH', levels: [1, 2, 3, 4, 5], description: 'Fourniture de conseils techniques sp√©cialis√©s pour aider √† la r√©solution des probl√®mes.' },
                        { code: 'USUP', levels: [1, 2, 3, 4, 5], description: 'Support utilisateur pour r√©soudre les probl√®mes techniques et r√©pondre aux questions.' }
                    ]
                },
                {
                    opmId: '531',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'NTAS', levels: [2, 3, 4, 5], description: 'Configuration et maintenance des services r√©seau pour assurer leur disponibilit√©.' },
                        { code: 'NTDS', levels: [2, 3, 4, 5], description: 'Conception d\'architectures r√©seau adapt√©es aux besoins de l\'organisation.' }
                    ]
                },
                {
                    opmId: '541',
                    color: '94, 151, 49', // Vert (couleur des cybersecurity)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'ITOP', levels: [2, 3, 4, 5], description: 'Gestion des op√©rations informatiques pour garantir la qualit√© des services.' },
                        { code: 'COPL', levels: [2, 3, 4, 5], description: 'Planification de la continuit√© des services informatiques en cas d\'incident.' }
                    ]
                },
                {
                    opmId: '121',
                    color: '255, 145, 3', // Orange (couleur des cyberspace effects)
                    isPresent: false, // D√©sactiv√© par d√©faut, sera activ√© par la case √† cocher
                    competences: [
                        { code: 'GOVN', levels: [3, 4, 5], description: 'Mise en place des politiques et processus de gouvernance pour garantir l\'alignement strat√©gique.' },
                        { code: 'METL', levels: [3, 4, 5], description: 'D√©veloppement et application des m√©thodes et outils pour optimiser les processus de travail.' }
                    ]
                },
                {
                    opmId: '141',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has141,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et pr√©venir les attaques.' },
                        { code: 'VISL', levels: [3, 4, 5], description: 'Cr√©ation de repr√©sentations graphiques des donn√©es pour faciliter leur interpr√©tation et leur analyse.' },
                        { code: 'SCAD', levels: [3, 4, 5], description: 'Surveillance et gestion des op√©rations de s√©curit√© pour prot√©ger contre les menaces et incidents.' }
                    ]
                },
                {
                    opmId: '111',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has111,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et pr√©venir les attaques.' },
                        { code: 'SCAD', levels: [3, 4, 5], description: 'Surveillance et gestion des op√©rations de s√©curit√© pour prot√©ger contre les menaces et incidents.' },
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vuln√©rabilit√©s pour am√©liorer la s√©curit√© des syst√®mes.' }
                    ]
                },
                {
                    opmId: '112',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has112,
                    competences: [
                        { code: 'MEAS', levels: [4, 5], description: 'D√©finition et utilisation de m√©triques pour mesurer et am√©liorer la performance des syst√®mes.' },
                        { code: 'SCTY', levels: [4, 5], description: 'S√©curisation des syst√®mes d\'information et des donn√©es contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [4, 5], description: 'Protection des informations critiques et maintien de leur confidentialit√©, int√©grit√© et disponibilit√©.' },
                        { code: 'THIN', levels: [4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et pr√©venir les attaques.' }
                    ]
                },
                {
                    opmId: '443',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has443,
                    competences: [
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'DATS', levels: [3, 4, 5], description: 'Application de m√©thodes scientifiques et math√©matiques pour extraire des connaissances des donn√©es.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour √©valuer la s√©curit√© des syst√®mes et identifier les vuln√©rabilit√©s exploitables.' }
                    ]
                },
                {
                    opmId: '151',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has151,
                    competences: [
                        { code: 'TECH', levels: [4, 5], description: 'Fourniture de conseils techniques sp√©cialis√©s pour soutenir les d√©cisions strat√©giques.' },
                        { code: 'KNOW', levels: [4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'VUAS', levels: [4, 5], description: '√âvaluation des syst√®mes et r√©seaux pour d√©tecter les vuln√©rabilit√©s et les faiblesses de s√©curit√©.' },
                        { code: 'THIN', levels: [4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et pr√©venir les attaques.' }
                    ]
                },
                {
                    opmId: '331',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has331,
                    competences: [
                        { code: 'THIN', levels: [5, 6], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et pr√©venir les attaques.' },
                        { code: 'DEMM', levels: [5, 6], description: 'Gestion de la demande pour optimiser l\'allocation des ressources informatiques.' },
                        { code: 'ITSP', levels: [5, 6], description: 'Planification strat√©gique des technologies de l\'information pour soutenir les objectifs organisationnels.' }
                    ]
                },
                {
                    opmId: '332',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has332,
                    competences: [
                        { code: 'SCAD', levels: [5, 6], description: 'Surveillance et gestion des op√©rations de s√©curit√© pour prot√©ger contre les menaces et incidents.' },
                        { code: 'THIN', levels: [5, 6], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et pr√©venir les attaques.' },
                        { code: 'SUPP', levels: [5, 6], description: 'Gestion des relations avec les fournisseurs pour assurer la qualit√© des services et produits.' }
                    ]
                },
                {
                    opmId: '132',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has132,
                    competences: [
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'DATS', levels: [3, 4, 5], description: 'Application de m√©thodes scientifiques et math√©matiques pour extraire des connaissances des donn√©es.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour √©valuer la s√©curit√© des syst√®mes et identifier les vuln√©rabilit√©s exploitables.' }
                    ]
                },
                {
                    opmId: '333',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has333,
                    competences: [
                        { code: 'RLMT', levels: [5, 6], description: 'Gestion des relations avec les parties prenantes pour assurer leur engagement et satisfaction.' },
                        { code: 'SCTY', levels: [5, 6], description: 'S√©curisation des syst√®mes d\'information et des donn√©es contre les menaces internes et externes.' },
                        { code: 'KNOW', levels: [5, 6], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' }
                    ]
                },
                {
                    opmId: '334',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has334,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et pr√©venir les attaques.' },
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique num√©rique pour l\'investigation et la collecte de preuves √©lectroniques.' }
                    ]
                },
                {
                    opmId: '131',
                    color: '255, 145, 3', // Orange (couleur des Cyberspace Effects)
                    isPresent: has131,
                    competences: [
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vuln√©rabilit√©s pour am√©liorer la s√©curit√© des syst√®mes.' },
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et pr√©venir les attaques.' },
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' }
                    ]
                },
                {
                    opmId: '321',
                    color: '255, 204, 2', // Jaune (couleur des Intelligence Cyberspace)
                    isPresent: has321,
                    competences: [
                        { code: 'THIN', levels: [3, 4, 5], description: 'Collecte et analyse de renseignements sur les menaces pour anticiper et pr√©venir les attaques.' },
                        { code: 'KNOW', levels: [3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'VURE', levels: [3, 4, 5], description: 'Recherche et analyse des vuln√©rabilit√©s pour am√©liorer la s√©curit√© des syst√®mes.' }
                    ]
                },
                {
                    opmId: '221',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has221,
                    competences: [
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique num√©rique pour l\'investigation et la collecte de preuves √©lectroniques.' }
                    ]
                },
                {
                    opmId: '211',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has211,
                    competences: [
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique num√©rique pour l\'investigation et la collecte de preuves √©lectroniques.' }
                    ]
                },
                {
                    opmId: '212',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has212,
                    competences: [
                        { code: 'DGFS', levels: [3, 4, 5], description: 'Analyse forensique num√©rique pour l\'investigation et la collecte de preuves √©lectroniques.' },
                        { code: 'PENT', levels: [3, 4, 5], description: 'Tests d\'intrusion pour √©valuer la s√©curit√© des syst√®mes et identifier les vuln√©rabilit√©s exploitables.' },
                        { code: 'VUAS', levels: [3, 4, 5], description: '√âvaluation des syst√®mes et r√©seaux pour d√©tecter les vuln√©rabilit√©s et les faiblesses de s√©curit√©.' }
                    ]
                },
                {
                    opmId: '651',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has651,
                    competences: [
                        { code: 'STPL', levels: [5, 6], description: 'Planification strat√©gique pour d√©finir les orientations futures et les objectifs √† long terme.' },
                        { code: 'REQM', levels: [5, 6], description: 'D√©finition et gestion des exigences pour garantir que les solutions r√©pondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '652',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has652,
                    competences: [
                        { code: 'SCTY', levels: [4, 5, 6], description: 'S√©curisation des syst√®mes d\'information et des donn√©es contre les menaces internes et externes.' },
                        { code: 'STPL', levels: [5, 6], description: 'Planification strat√©gique pour d√©finir les orientations futures et les objectifs √† long terme.' },
                        { code: 'ARCH', levels: [4, 5, 6], description: 'Conception de solutions techniques r√©pondant aux exigences m√©tier et techniques.' },
                        { code: 'REQM', levels: [4, 5, 6], description: 'D√©finition et gestion des exigences pour garantir que les solutions r√©pondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '621',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: has621,
                    competences: [
                        { code: 'PROG', levels: [2, 3, 4, 5], description: 'D√©veloppement de logiciels √† l\'aide de langages de programmation et d\'outils appropri√©s.' },
                        { code: 'TEST', levels: [2, 3, 4, 5], description: 'Conception et ex√©cution de tests fonctionnels pour v√©rifier la conformit√© des syst√®mes.' },
                        { code: 'PORT', levels: [3, 4, 5], description: 'Configuration logicielle pour adapter les applications aux environnements sp√©cifiques.' },
                        { code: 'RESD', levels: [2, 3, 4, 5], description: 'D√©veloppement de syst√®mes embarqu√©s et temps r√©el avec des contraintes mat√©rielles.' },
                        { code: 'SINT', levels: [2, 3, 4, 5], description: 'Int√©gration de composants syst√®me pour cr√©er des solutions fonctionnelles compl√®tes.' }
                    ]
                },
                {
                    opmId: '641',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has641,
                    competences: [
                        { code: 'REQM', levels: [3, 4, 5], description: 'D√©finition et gestion des exigences pour garantir que les solutions r√©pondent aux besoins des parties prenantes.' },
                        { code: 'UNAN', levels: [3, 4, 5], description: 'Analyse de l\'exp√©rience utilisateur pour comprendre les besoins et les comportements des utilisateurs.' },
                        { code: 'ARCH', levels: [4, 5], description: 'Conception de solutions techniques r√©pondant aux exigences m√©tier et techniques.' }
                    ]
                },
                {
                    opmId: '671',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has671,
                    competences: [
                        { code: 'TEST', levels: [3, 4], description: 'Conception et ex√©cution de tests fonctionnels pour v√©rifier la conformit√© des syst√®mes.' },
                        { code: 'QUAS', levels: [3, 4], description: 'Assurance qualit√© pour garantir que les produits et services r√©pondent aux normes d√©finies.' },
                        { code: 'PENT', levels: [3, 4], description: 'Tests d\'intrusion pour √©valuer la s√©curit√© des syst√®mes et identifier les vuln√©rabilit√©s exploitables.' },
                        { code: 'USEV', levels: [3, 4], description: '√âvaluation de l\'exp√©rience utilisateur pour mesurer la satisfaction et l\'efficacit√© des interfaces.' }
                    ]
                },
                {
                    opmId: '632',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has632,
                    competences: [
                        { code: 'ARCH', levels: [4, 5], description: 'Conception de solutions techniques r√©pondant aux exigences m√©tier et techniques.' },
                        { code: 'RESD', levels: [3, 4, 5], description: 'D√©veloppement de syst√®mes informatiques selon les sp√©cifications de conception.' },
                        { code: 'DESN', levels: [3, 4, 5], description: 'Conception de syst√®mes conformes aux sp√©cifications et adapt√©s aux besoins des utilisateurs.' },
                        { code: 'HWDE', levels: [3, 4, 5], description: 'Conception de mat√©riel informatique r√©pondant aux exigences m√©tier et techniques.' },
                        { code: 'NTDS', levels: [3, 4, 5], description: 'Conception de r√©seaux informatiques r√©pondant aux exigences m√©tier et techniques.' },
                        { code: 'SWDN', levels: [3, 4, 5], description: 'Conception de logiciels informatiques r√©pondant aux exigences m√©tier et techniques.' },
                        { code: 'TEST', levels: [3, 4, 5], description: 'Conception et ex√©cution de tests fonctionnels pour v√©rifier la conformit√© des syst√®mes.' }
                    ]
                },
                {
                    opmId: '411',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has411,
                    competences: [
                        { code: 'PBMG', levels: [3, 4], description: 'Gestion des probl√®mes pour minimiser les perturbations et restaurer les services rapidement.' },
                        { code: 'SCAD', levels: [2, 3, 4], description: 'Surveillance et gestion des op√©rations de s√©curit√© pour prot√©ger contre les menaces et incidents.' },
                        { code: 'VUAS', levels: [2, 3, 4], description: '√âvaluation des syst√®mes et r√©seaux pour d√©tecter les vuln√©rabilit√©s et les faiblesses de s√©curit√©.' },
                        { code: 'SYSP', levels: [3, 4], description: 'Programmation syst√®me pour d√©velopper et maintenir des composants logiciels de bas niveau.' },
                        { code: 'ITOP', levels: [2, 3, 4], description: 'Gestion et exploitation des infrastructures informatiques, assurant leur disponibilit√© et leur performance.' },
                        { code: 'HSIN', levels: [2, 3, 4], description: 'Installation, migration et d√©sinstallation des syst√®mes mat√©riels et logiciels.' },
                        { code: 'NTAS', levels: [2, 3, 4], description: 'Support et maintenance des infrastructures r√©seau pour assurer leur disponibilit√© et leur performance.' }
                    ]
                },
                {
                    opmId: '451',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has451,
                    competences: [
                        { code: 'SCAD', levels: [1, 2, 3, 4], description: 'Surveillance et gestion des op√©rations de s√©curit√© pour prot√©ger contre les menaces et incidents.' },
                        { code: 'ITOP', levels: [1, 2, 3, 4], description: 'Gestion et exploitation des infrastructures informatiques, assurant leur disponibilit√© et leur performance.' },
                        { code: 'HSIN', levels: [1, 2, 3, 4], description: 'Installation, migration et d√©sinstallation des syst√®mes mat√©riels et logiciels.' },
                        { code: 'SYSP', levels: [3, 4], description: 'Programmation syst√®me pour d√©velopper et maintenir des composants logiciels de bas niveau.' },
                        { code: 'TEST', levels: [1, 2, 3, 4], description: 'Conception et ex√©cution de tests fonctionnels pour v√©rifier la conformit√© des syst√®mes.' },
                        { code: 'PBMG', levels: [3, 4], description: 'Gestion des probl√®mes pour minimiser les perturbations et restaurer les services rapidement.' }
                    ]
                },
                {
                    opmId: '441',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has441,
                    competences: [
                        { code: 'SYSP', levels: [3, 4], description: 'Programmation syst√®me pour d√©velopper et maintenir des composants logiciels de bas niveau.' },
                        { code: 'NTAS', levels: [2, 3, 4], description: 'Support et maintenance des infrastructures r√©seau pour assurer leur disponibilit√© et leur performance.' },
                        { code: 'HSIN', levels: [2, 3, 4], description: 'Installation, migration et d√©sinstallation des syst√®mes mat√©riels et logiciels.' },
                        { code: 'TEST', levels: [2, 3, 4], description: 'Conception et ex√©cution de tests fonctionnels pour v√©rifier la conformit√© des syst√®mes.' }
                    ]
                },
                {
                    opmId: '803',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has803,
                    competences: [
                        { code: 'SLMO', levels: [3, 4, 5], description: 'Gestion des niveaux de service pour optimiser la disponibilit√© et la performance des services.' },
                        { code: 'BUSA', levels: [3, 4, 5], description: 'Analyse des situations d\'affaires pour identifier les opportunit√©s et les menaces.' },
                        { code: 'FEAS', levels: [3, 4, 5], description: 'Am√©lioration des processus m√©tier pour r√©pondre aux besoins organisationnels.' },
                        { code: 'REQM', levels: [3, 4, 5], description: 'D√©finition et gestion des exigences pour garantir que les solutions r√©pondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '801',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has801,
                    competences: [
                        { code: 'PGMG', levels: [6], description: 'Gestion de programme pour coordonner et superviser un ensemble de projets li√©s.' },
                        { code: 'QUMG', levels: [6], description: 'Gestion de la qualit√© pour garantir que les produits et services r√©pondent aux normes d√©finies.' },
                        { code: 'RLMT', levels: [6], description: 'Gestion des relations pour maintenir des partenariats efficaces avec les parties prenantes.' },
                        { code: 'BENM', levels: [6], description: 'Gestion des b√©n√©fices pour maximiser la valeur des investissements.' },
                        { code: 'CIPM', levels: [6], description: 'Gestion de l\'am√©lioration continue pour optimiser les processus et les performances.' },
                        { code: 'SUPP', levels: [6], description: 'Gestion des fournisseurs pour optimiser la valeur des relations avec les prestataires externes.' }
                    ]
                },
                {
                    opmId: '802',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has802,
                    competences: [
                        { code: 'PRMG', levels: [4, 5, 6], description: 'Gestion de programme pour coordonner et superviser un ensemble de projets li√©s.' },
                        { code: 'SLMO', levels: [4, 5, 6], description: 'Gestion des niveaux de service pour optimiser la disponibilit√© et la performance des services.' },
                        { code: 'REQM', levels: [4, 5, 6], description: 'D√©finition et gestion des exigences pour garantir que les solutions r√©pondent aux besoins des parties prenantes.' },
                        { code: 'QUMG', levels: [4, 5, 6], description: 'Gestion de la qualit√© pour garantir que les produits et services r√©pondent aux normes d√©finies.' }
                    ]
                },
                {
                    opmId: '804',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has804,
                    competences: [
                        { code: 'POMG', levels: [5, 6], description: 'Gestion de portefeuille pour optimiser les investissements et les performances.' },
                        { code: 'INVA', levels: [5, 6], description: '√âvaluation et s√©lection des investissements pour maximiser la valeur.' },
                        { code: 'RLMT', levels: [5, 6], description: 'Gestion des relations pour maintenir des partenariats efficaces avec les parties prenantes.' }
                    ]
                },
                {
                    opmId: '312',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has312,
                    competences: [
                        { code: 'DEMM', levels: [5, 6], description: 'Suivi des technologies √©mergentes pour identifier les opportunit√©s et les risques futurs.' },
                        { code: 'REQM', levels: [5, 6], description: 'D√©finition et gestion des exigences pour garantir que les solutions r√©pondent aux besoins des parties prenantes.' }
                    ]
                },
                {
                    opmId: '421',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has421,
                    competences: [
                        { code: 'DBAD', levels: [2, 3, 4, 5], description: 'Gestion des bases de donn√©es pour assurer la s√©curit√© et la conformit√©.' },
                        { code: 'STMG', levels: [3, 4, 5], description: 'Gestion du stockage pour optimiser l\'utilisation des ressources et assurer la disponibilit√© des donn√©es.' }
                    ]
                },
                {
                    opmId: '422',
                    color: '23, 190, 207', // Turquoise (couleur des Data/AI)
                    isPresent: has422,
                    competences: [
                        { code: 'DENG', levels: [2, 3, 4, 5], description: 'Ing√©nierie des donn√©es pour concevoir et d√©velopper des architectures de traitement de donn√©es.' },
                        { code: 'DTAN', levels: [2, 3, 4, 5], description: 'Analyse de donn√©es pour extraire des informations utiles et soutenir la prise de d√©cision.' },
                        { code: 'REQM', levels: [2, 3, 4, 5], description: 'D√©finition et gestion des exigences pour garantir que les solutions r√©pondent aux besoins des parties prenantes.' },
                        { code: 'DATS', levels: [2, 3, 4, 5], description: 'Science des donn√©es pour appliquer des m√©thodes scientifiques et statistiques avanc√©es aux donn√©es.' },
                        { code: 'BINT', levels: [2, 3, 4, 5], description: 'Intelligence d\'affaires pour transformer les donn√©es en informations strat√©giques pour l\'organisation.' }
                    ]
                },
                {
                    opmId: '612',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has612,
                    competences: [
                        { code: 'SCTY', levels: [3, 4, 5], description: 'S√©curisation des syst√®mes d\'information et des donn√©es contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [3, 4, 5], description: 'Protection des informations critiques et maintien de leur confidentialit√©, int√©grit√© et disponibilit√©.' },
                        { code: 'AUDT', levels: [3, 4, 5], description: 'Gestion des processus d\'audit pour assurer la conformit√© aux normes et r√©glementations.' },
                        { code: 'BURM', levels: [3, 4, 5], description: 'Gestion des risques d\'affaires pour identifier et g√©rer les menaces potentielles.' }
                    ]
                },
                {
                    opmId: '805',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has805,
                    competences: [
                        { code: 'AUDT', levels: [3, 4, 5], description: 'Gestion des processus d\'audit pour assurer la conformit√© aux normes et r√©glementations.' },
                        { code: 'INAS', levels: [3, 4, 5], description: 'Protection des informations critiques et maintien de leur confidentialit√©, int√©grit√© et disponibilit√©.' },
                        { code: 'BURM', levels: [3, 4, 5], description: 'Identification, √©valuation et contr√¥le des risques au sein de l\'organisation.' },
                        { code: 'QUAS', levels: [3, 4, 5], description: 'Assurance qualit√© pour garantir que les produits et services r√©pondent aux normes d√©finies.' }
                    ]
                },
                {
                    opmId: '731',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: has731,
                    competences: [
                        { code: 'TECH', levels: [4, 5], description: 'Fourniture de conseils techniques sp√©cialis√©s pour soutenir les d√©cisions strat√©giques.' },
                        { code: 'SCTY', levels: [4, 5], description: 'S√©curisation des syst√®mes d\'information et des donn√©es contre les menaces internes et externes.' },
                        { code: 'INAS', levels: [4, 5], description: 'Protection des informations critiques et maintien de leur confidentialit√©, int√©grit√© et disponibilit√©.' }
                    ]
                },
                {
                    opmId: '732',
                    color: '94, 151, 49', // Vert (couleur des Cybersecurity)
                    isPresent: has732,
                    competences: [
                        { code: 'PEDP', levels: [5, 6], description: 'D√©veloppement des personnes pour am√©liorer les comp√©tences et les performances de l\'√©quipe.' }
                    ]
                },
                {
                    opmId: '751',
                    color: '153, 86, 206', // Mauve (couleur des cyberspace enablers)
                    isPresent: has751,
                    competences: [
                        { code: 'WFPL', levels: [4, 5, 6], description: 'Planification strat√©gique de la main-d\'≈ìuvre pour r√©pondre aux besoins organisationnels.' },
                        { code: 'PDSV', levels: [4, 5, 6], description: 'Conception de services pour cr√©er des solutions adapt√©es aux besoins des utilisateurs.' },
                        { code: 'ETMG', levels: [4, 5, 6], description: 'Architecture d\'entreprise pour aligner les syst√®mes d\'information sur la strat√©gie organisationnelle.' },
                        { code: 'ORDI', levels: [4, 5, 6], description: 'Conception et impl√©mentation organisationnelle pour optimiser la structure et les processus.' }
                    ]
                },
                {
                    opmId: '711',
                    color: '2, 125, 184', // Bleu (couleur des IT Cyberspace)
                    isPresent: has711,
                    competences: [
                        { code: 'TMCR', levels: [4, 5], description: 'Cr√©ation d\'√©quipes efficaces pour atteindre les objectifs organisationnels.' },
                        { code: 'SUBF', levels: [4, 5], description: 'Gestion des fournisseurs pour optimiser la valeur des relations avec les prestataires externes.' },
                        { code: 'INCA', levels: [4, 5], description: 'Cr√©ation et promotion de l\'innovation pour d√©velopper de nouvelles solutions et approches.' }
                    ]
                },
                {
                    opmId: '712',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has712,
                    competences: [
                        { code: 'ETDL', levels: [3, 4, 5], description: 'Formation et d√©veloppement des √©quipes pour assurer la qualit√© et la coh√©rence des services.' },
                        { code: 'TEAC', levels: [3, 4, 5], description: 'Enseignement et formation des √©quipes pour am√©liorer les comp√©tences et les performances.' },
                        { code: 'TMCR', levels: [3, 4, 5], description: 'Gestion des ressources humaines pour optimiser les comp√©tences et les performances.' },
                        { code: 'INCA', levels: [3, 4, 5], description: 'Cr√©ation et promotion de l\'innovation pour d√©velopper de nouvelles solutions et approches.' }
                    ]
                },
                {
                    opmId: '311',
                    color: '214, 39, 40', // Rouge (couleur des Software Engineering)
                    isPresent: has311,
                    competences: [
                        { code: 'KNOW', levels: [5, 6], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'OCDV', levels: [5, 6], description: 'D√©veloppement et am√©lioration des capacit√©s organisationnelles pour r√©pondre aux besoins actuels et futurs.' },
                        { code: 'BPRE', levels: [5, 6], description: 'Am√©lioration des processus d\'affaires pour optimiser l\'allocation des ressources et les performances.' }
                    ]
                },
                {
                    opmId: '431',
                    color: '2, 125, 184', // Turquoise (couleur des Data/AI)
                    isPresent: has431,
                    competences: [
                        { code: 'KNOW', levels: [2, 3, 4, 5], description: 'Gestion des connaissances pour capturer, partager et exploiter le savoir collectif de l\'organisation.' },
                        { code: 'ICPM', levels: [2, 3, 4, 5], description: 'Gestion des contenus informatifs pour assurer la qualit√© et la coh√©rence des informations.' }
                    ]
                },
                {
                    opmId: '611',
                    color: '153, 86, 206', // Mauve (couleur des Cyberspace Enablers)
                    isPresent: has611,
                    competences: [
                        { code: 'IRMG', levels: [6, 7], description: 'Gestion des risques li√©s √† l\'information pour prot√©ger les actifs informationnels critiques.' },
                        { code: 'BURM', levels: [6, 7], description: 'Gestion des risques d\'affaires au niveau strat√©gique pour assurer la r√©silience organisationnelle.' },
                        { code: 'SCTY', levels: [6, 7], description: 'S√©curisation des syst√®mes d\'information et des donn√©es au niveau de direction et de gouvernance.' }
                    ]
                }
            ];
            
            // Fonctions simplifi√©es pour la gestion du tooltip
            let tooltipTimeout;
            
            function showTooltipNextToElement(element, tooltipContent) {
                clearTimeout(tooltipTimeout);
                
                const tooltip = document.getElementById('custom-tooltip');
                if (!tooltip) return;
                
                // Mettre √† jour le contenu
                tooltip.innerHTML = tooltipContent;
                
                // Positionner le tooltip
                const rect = element.getBoundingClientRect();
                const offsetX = 15;
                const offsetY = 5;
                
                // Position initiale (√† droite de l'√©l√©ment)
                let left = rect.right + offsetX;
                let top = rect.top + offsetY;
                
                // Appliquer les positions
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
                
                // Rendre visible
                tooltip.classList.add('visible');
                
                // V√©rifier si le tooltip d√©passe √† droite
                tooltipTimeout = setTimeout(() => {
                    const tooltipRect = tooltip.getBoundingClientRect();
                    
                    if (tooltipRect.right > window.innerWidth) {
                        // Repositionner √† gauche de l'√©l√©ment
                        left = rect.left - tooltipRect.width - offsetX;
                        tooltip.style.left = left + 'px';
                    }
                    
                    // Si le tooltip d√©passe en bas
                    if (tooltipRect.bottom > window.innerHeight) {
                        // Repositionner au-dessus de l'√©l√©ment
                        top = rect.top - tooltipRect.height - offsetY;
                        tooltip.style.top = top + 'px';
                    }
                }, 0);
            }
            
            function hideTooltip() {
                const tooltip = document.getElementById('custom-tooltip');
                if (tooltip) {
                    tooltip.classList.remove('visible');
                }
                clearTimeout(tooltipTimeout);
            }
            
            // Repositionner le tooltip lors du d√©filement
            window.addEventListener('scroll', () => {
                hideTooltip();
            });
            
            // Masquer le tooltip lors du redimensionnement de la fen√™tre
            window.addEventListener('resize', () => {
                hideTooltip();
            });
            
            // Traiter chaque configuration d'OPM ID sp√©ciale
            specialOpmConfigs.forEach(config => {
                if (config.isPresent) {
                    console.log(`OPM ID ${config.opmId} detected, applying special behavior`);
                    
                    // S√©lectionner automatiquement les cellules pour cet OPM ID dans la table des OPM IDs
                    const opmRows = document.querySelectorAll('#opm-ids-list table tr');
                    opmRows.forEach(row => {
                        const opmIdText = row.querySelector('td:nth-child(2) span'); // Ajust√© pour la nouvelle structure avec case √† cocher
                        if (opmIdText && opmIdText.textContent === config.opmId) {
                            // Acc√©der aux cercles de niveau dans la cellule des niveaux
                            const levelCircles = row.querySelectorAll('td:nth-child(4) .flex.flex-row > div > div');
                            
                            // D√©terminer les niveaux √† mettre en surbrillance bas√©s sur l'OPM ID
                            const levelsToHighlight = getLevelsForOpmId(config.opmId);
                            
                            levelsToHighlight.forEach(level => {
                                const levelIndex = level; // Utiliser directement le niveau sans conversion
                                if (levelIndex >= 0 && levelIndex < levelCircles.length) {
                                    const circle = levelCircles[levelIndex];
                                    if (circle) {
                                        circle.style.backgroundColor = `rgba(${config.color}, 0.8)`;
                                        circle.style.transform = 'scale(1.2)';
                                        circle.style.boxShadow = `0 0 5px rgba(${config.color.split(',')[0]}, ${config.color.split(',')[1]}, ${config.color.split(',')[2]}, 0.7)`;
                                        circle.style.borderColor = `rgba(${config.color}, 1)`;
                                        circle.style.borderWidth = '2px';
                                        circle.style.transition = 'all 0.3s ease';
                                    }
                                }
                            });
                        }
                    });
                    
                    // 2. Mettre en surbrillance les cellules des comp√©tences sp√©cifiques
                    const targetSkillRows = document.querySelectorAll('.skill-row');
                    targetSkillRows.forEach(row => {
                        const codeElement = row.querySelector('.skill-code');
                        
                        // V√©rifier si cette comp√©tence est dans la liste des comp√©tences sp√©ciales pour cet OPM ID
                        const competenceConfig = config.competences.find(comp => 
                            codeElement && comp.code === codeElement.textContent.trim()
                        );
                        
                        if (competenceConfig) {
                            const skillCode = codeElement.textContent.trim();
                            const skillName = row.querySelector('.skill-name').textContent.trim();
                            console.log(`Activation de la surbrillance pour comp√©tence: ${skillCode} (OPM ID: ${config.opmId})`);
                            
                            // Obtenir les level-box pour cette comp√©tence
                            const levelBoxes = row.querySelectorAll('.level-boxes .level-box');
                            
                            // Parcourir chaque niveau sp√©cifi√© dans la configuration
                            competenceConfig.levels.forEach(level => {
                                // L'index correspond au niveau - 1 (niveau 1 = index 0, niveau 2 = index 1, etc.)
                                const levelIndex = parseInt(level) - 1;
                                if (levelIndex >= 0 && levelIndex < levelBoxes.length) {
                                    const levelBox = levelBoxes[levelIndex];
                                    
                                    // V√©rifier si ce level-box a la classe 'filled'
                                    if (levelBox.classList.contains('filled')) {
                                        // V√©rifier si la cellule a d√©j√† des attributs OPM ID
                                        let currentOpmIds = levelBox.dataset.opmId ? levelBox.dataset.opmId.split(',') : [];
                                        
                                        // Ajouter cet OPM ID s'il n'est pas d√©j√† pr√©sent
                                        if (!currentOpmIds.includes(config.opmId)) {
                                            currentOpmIds.push(config.opmId);
                                            levelBox.dataset.opmId = currentOpmIds.join(',');
                                        }
                                        
                                        // Ajouter une animation de clignotement
                                        levelBox.style.animation = 'blink-animation 1.5s infinite';
                                        
                                        // Appliquer les styles de surbrillance avec fusion des couleurs
                                        if (currentOpmIds.length > 1) {
                                            // Cr√©er un d√©grad√© avec toutes les couleurs des OPM IDs actifs
                                            let gradientColors = [];
                                            let boxShadowColors = [];
                                            
                                            currentOpmIds.forEach((id, index) => {
                                                const opmConfig = specialOpmConfigs.find(cfg => cfg.opmId === id);
                                                if (opmConfig) {
                                                    // Calculer la position du gradient pour cette couleur
                                                    const position = Math.round((index / (currentOpmIds.length - 1)) * 100);
                                                    gradientColors.push(`rgba(${opmConfig.color}, 0.8) ${position}%`);
                                                    boxShadowColors.push(`rgba(${opmConfig.color}, 0.5)`);
                                                }
                                            });
                                            
                                            // Appliquer un d√©grad√© multi-couleurs
                                            if (gradientColors.length > 1) {
                                                levelBox.style.background = `linear-gradient(135deg, ${gradientColors.join(', ')})`;
                                                // Utiliser la premi√®re couleur pour l'ombre
                                                levelBox.style.boxShadow = `0 0 8px ${boxShadowColors[0]}`;
                                            } else {
                                                // Fallback si une seule couleur est disponible
                                                levelBox.style.background = `linear-gradient(135deg, rgb(${config.color}), rgba(${config.color}, 0.8))`;
                                                levelBox.style.boxShadow = `0 0 8px rgba(${config.color}, 0.9)`;
                                            }
                                        } else {
                                            // Style standard pour une seule couleur
                                            levelBox.style.boxShadow = `0 0 8px rgba(${config.color}, 0.9)`;
                                            levelBox.style.background = `linear-gradient(135deg, rgb(${config.color}), rgba(${config.color}, 0.8))`;
                                        }
                                        
                                        levelBox.style.cursor = 'default';
                                        
                                        // Supprimer les gestionnaires d'√©v√©nements existants pour √©viter les doublons
                                        if (levelBox._mouseEnterHandler) {
                                            levelBox.removeEventListener('mouseenter', levelBox._mouseEnterHandler);
                                        }
                                        if (levelBox._mouseLeaveHandler) {
                                            levelBox.removeEventListener('mouseleave', levelBox._mouseLeaveHandler);
                                        }
                                        
                                        // Stocker les informations n√©cessaires au tooltip
                                        levelBox.dataset.skillName = skillName;
                                        levelBox.dataset.skillCode = skillCode;
                                        levelBox.dataset.level = level;
                                        levelBox.dataset.description = competenceConfig.description || "Comp√©tence requise pour ce r√¥le";
                                        
                                        // Cr√©er de nouveaux gestionnaires d'√©v√©nements
                                        const mouseEnterHandler = () => {
                                            // R√©cup√©rer tous les OPM IDs associ√©s √† cette cellule
                                            const cellOpmIds = levelBox.dataset.opmId ? levelBox.dataset.opmId.split(',') : [];
                                            
                                            // Construire les badges pour chaque OPM ID
                                            let opmIdBadges = '';
                                            cellOpmIds.forEach(id => {
                                                const opmConfig = specialOpmConfigs.find(cfg => cfg.opmId === id);
                                                if (opmConfig) {
                                                    opmIdBadges += `<span class="tooltip-badge" style="background-color: rgba(${opmConfig.color}, 0.8);">OPM ID: ${id}</span>`;
                                                }
                                            });
                                            
                                            // Construire le contenu du tooltip
                                            let tooltipContent = `
                                                <div class="tooltip-title">${levelBox.dataset.skillName} (${levelBox.dataset.skillCode})</div>
                                                <div class="tooltip-badges">
                                                    ${opmIdBadges}
                                                    <span class="tooltip-badge">Niveau: ${levelBox.dataset.level}</span>
                                                </div>
                                                <div class="tooltip-info">
                                                    <strong>Description:</strong> ${levelBox.dataset.description}
                                                </div>
                                            `;
                                            
                                            // Afficher le tooltip √† c√¥t√© de la cellule
                                            showTooltipNextToElement(levelBox, tooltipContent);
                                        };
                                        
                                        const mouseLeaveHandler = () => {
                                            hideTooltip();
                                        };
                                        
                                        // Stocker les r√©f√©rences aux gestionnaires
                                        levelBox._mouseEnterHandler = mouseEnterHandler;
                                        levelBox._mouseLeaveHandler = mouseLeaveHandler;
                                        
                                        // Ajouter les nouveaux gestionnaires d'√©v√©nements
                                        levelBox.addEventListener('mouseenter', mouseEnterHandler);
                                        levelBox.addEventListener('mouseleave', mouseLeaveHandler);
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            // Ne pas appliquer automatiquement les surbrillances - attendez que les cases √† cocher soient utilis√©es
            // Nous ne modifierons que l'√©tat interne pour le moment
            specialOpmConfigs.forEach(config => {
                config.isPresent = false; // D√©sactiver par d√©faut, sera activ√© par les cases √† cocher
            });

            // R√©initialiser toutes les surbrillances existantes pour s'assurer que rien n'est allum√© au chargement
            document.querySelectorAll('.level-box').forEach(box => {
                box.style.animation = '';
                box.style.boxShadow = '';
                box.style.background = '';
                box.removeAttribute('data-opm-id');
            });

            // D√âSACTIV√â : Ne plus r√©initialiser les cercles ici pour pr√©server leurs couleurs
            // Les cercles sont cr√©√©s avec la bonne couleur et doivent la conserver
            // R√©initialiser tous les cercles de niveaux dans le tableau des OPM IDs
            // document.querySelectorAll('#opm-ids-list table tr td:nth-child(4) .flex.flex-row > div > div').forEach(circle => {
            //     // R√©cup√©rer la couleur stock√©e dans le data-attribute, ou depuis le span de l'OPM ID
            //     let color = circle.dataset.opmColor;
            //     if (!color) {
            //         const row = circle.closest('tr');
            //         const opmIdText = row ? row.querySelector('td:nth-child(2) span') : null;
            //         if (opmIdText) {
            //             const computedColor = window.getComputedStyle(opmIdText).color;
            //             const rgbMatch = computedColor.match(/\d+/g);
            //             if (rgbMatch && rgbMatch.length >= 3) {
            //                 color = `${rgbMatch[0]}, ${rgbMatch[1]}, ${rgbMatch[2]}`;
            //                 circle.dataset.opmColor = color; // Stocker pour la prochaine fois
            //             }
            //         }
            //     }
            //     
            //     if (color) {
            //         circle.style.backgroundColor = `rgba(${color}, 0.3)`;
            //         circle.style.transform = 'scale(1)';
            //         circle.style.boxShadow = 'none';
            //         circle.style.borderColor = `rgba(${color}, 1)`;
            //         circle.style.borderWidth = '2px';
            //         
            //         // R√©initialiser le texte avec la m√™me couleur
            //         const textElement = circle.querySelector('span');
            //         if (textElement) {
            //             textElement.style.color = `rgba(${color}, 1)`;
            //             textElement.style.textShadow = '0 1px 2px rgba(255, 255, 255, 0.8)';
            //             textElement.style.fontWeight = 'bold';
            //         }
            //     }
            // });
            
            // Mettre √† jour l'√©chelle du haut
            updateTopScale();
        }
        
        // Fonction pour r√©initialiser les surbrillances pour un OPM ID sp√©cifique
        function resetHighlightsForOpmId(opmId) {
            console.log(`R√©initialisation des surbrillances pour OPM ID ${opmId}`);
            
            // R√©initialiser les cercles de niveaux dans le tableau des OPM IDs
            const opmRows = document.querySelectorAll('#opm-ids-list table tr');
            opmRows.forEach(row => {
                const opmIdText = row.querySelector('td:nth-child(2) span');
                if (opmIdText && opmIdText.textContent === opmId) {
                    // R√©cup√©rer la couleur depuis le data-attribute ou depuis le span
                    const levelCircles = row.querySelectorAll('td:nth-child(4) .flex.flex-row > div > div');
                    let color = null;
                    
                    // Essayer de r√©cup√©rer la couleur depuis un cercle existant
                    if (levelCircles.length > 0 && levelCircles[0].dataset.opmColor) {
                        color = levelCircles[0].dataset.opmColor;
                    } else {
                        // Sinon, r√©cup√©rer depuis le span de l'OPM ID
                        const computedColor = window.getComputedStyle(opmIdText).color;
                        const rgbMatch = computedColor.match(/\d+/g);
                        if (rgbMatch && rgbMatch.length >= 3) {
                            color = `${rgbMatch[0]}, ${rgbMatch[1]}, ${rgbMatch[2]}`;
                        }
                    }
                    
                    if (color) {
                        levelCircles.forEach(circle => {
                            if (circle) {
                                circle.dataset.opmColor = color; // Stocker la couleur
                                circle.style.backgroundColor = `rgba(${color}, 0.3)`;
                                circle.style.transform = 'scale(1)';
                                circle.style.boxShadow = 'none';
                                circle.style.borderColor = `rgba(${color}, 1)`;
                                circle.style.borderWidth = '2px';
                                
                                // R√©initialiser le texte avec la m√™me couleur
                                const textElement = circle.querySelector('span');
                                if (textElement) {
                                    textElement.style.color = `rgba(${color}, 1)`;
                                    textElement.style.textShadow = '0 1px 2px rgba(255, 255, 255, 0.8)';
                                    textElement.style.fontWeight = 'bold';
                                }
                            }
                        });
                    }
                }
            });
            
            // Trouver toutes les cellules qui contiennent cet OPM ID
            const levelBoxes = document.querySelectorAll('.level-box.filled');
            levelBoxes.forEach(box => {
                // V√©rifier si cette cellule a des OPM IDs associ√©s
                if (box.dataset.opmId) {
                    const opmIds = box.dataset.opmId.split(',');
                    
                    // Si cette cellule contient l'OPM ID √† r√©initialiser
                    if (opmIds.includes(opmId)) {
                        // Retirer cet OPM ID de la liste
                        const updatedOpmIds = opmIds.filter(id => id !== opmId);
                        
                        // Si plus aucun OPM ID n'est associ√©, r√©initialiser compl√®tement la cellule
                        if (updatedOpmIds.length === 0) {
                            box.style.animation = '';
                            box.style.boxShadow = '';
                            box.style.background = '';
                            box.removeAttribute('data-opm-id');
                        } else {
                            // Sinon, mettre √† jour la liste des OPM IDs
                            box.dataset.opmId = updatedOpmIds.join(',');
                            
                            // Filtrer pour ne garder que les OPM IDs actifs (cases coch√©es)
                            const activeOpmIds = updatedOpmIds.filter(id => {
                                const config = window.specialOpmConfigs.find(cfg => cfg.opmId === id);
                                return config && config.isPresent;
                            });
                            
                            // Appliquer un d√©grad√© avec les couleurs des OPM IDs restants actifs
                            if (activeOpmIds.length > 0) {
                                // Cr√©er un d√©grad√© avec toutes les couleurs des OPM IDs actifs restants
                                let gradientColors = [];
                                let boxShadowColors = [];
                                
                                activeOpmIds.forEach((id, index) => {
                                    const opmConfig = specialOpmConfigs.find(cfg => cfg.opmId === id);
                                    if (opmConfig && opmConfig.isPresent) {
                                        // Calculer la position du gradient pour cette couleur
                                        const position = Math.round((index / Math.max(1, activeOpmIds.length - 1)) * 100);
                                        gradientColors.push(`rgba(${opmConfig.color}, 0.8) ${position}%`);
                                        boxShadowColors.push(`rgba(${opmConfig.color}, 0.5)`);
                                    }
                                });
                                
                                // Appliquer un d√©grad√© multi-couleurs
                                if (gradientColors.length > 1) {
                                    box.style.background = `linear-gradient(135deg, ${gradientColors.join(', ')})`;
                                    // Utiliser la premi√®re couleur pour l'ombre
                                    box.style.boxShadow = `0 0 8px ${boxShadowColors[0]}`;
                                } else if (gradientColors.length === 1) {
                                    // S'il ne reste qu'une seule couleur
                                    const lastOpmId = activeOpmIds[0];
                                    const activeConfig = specialOpmConfigs.find(cfg => cfg.opmId === lastOpmId);
                                    if (activeConfig) {
                                        box.style.background = `linear-gradient(135deg, rgb(${activeConfig.color}), rgba(${activeConfig.color}, 0.8))`;
                                        box.style.boxShadow = `0 0 8px rgba(${activeConfig.color}, 0.9)`;
                                    }
                                } else {
                                    // Aucun OPM ID actif restant
                                    box.style.animation = '';
                                    box.style.boxShadow = '';
                                    box.style.background = '';
                                }
                            } else {
                                // Aucun OPM ID actif restant
                                box.style.animation = '';
                                box.style.boxShadow = '';
                                box.style.background = '';
                            }
                        }
                    }
                }
            });
            
            // Mettre √† jour l'√©chelle du haut
            updateTopScale();
        }
        
        // Fonction auxiliaire pour obtenir les niveaux √† mettre en surbrillance pour un OPM ID
        function getLevelsForOpmId(opmId) {
            switch(opmId) {
                case '901': return [7];
                case '722': return [5, 6];
                case '723': return [5, 6];
                case '752': return [6];
                case '661': return [3, 4, 5];
                case '622': return [3, 4, 5];
                case '631': return [3, 4, 5];
                case '461': return [3, 4, 5];
                case '511': return [2, 3, 4, 5];
                case '521': return [1, 2, 3, 4, 5];
                case '531': return [2, 3, 4, 5];
                case '541': return [2, 3, 4, 5];
                case '121': return [3, 4, 5];
                case '141': return [3, 4, 5];
                case '111': return [3, 4, 5];
                case '112': return [4, 5];
                case '443': return [3, 4, 5];
                case '151': return [4, 5];
                case '331': return [5, 6];
                case '332': return [5, 6];
                case '132': return [3, 4, 5];
                case '333': return [5, 6];
                case '334': return [3, 4, 5];
                case '131': return [3, 4, 5];
                case '321': return [3, 4, 5];
                case '221': return [3, 4, 5];
                case '211': return [3, 4, 5];
                case '212': return [3, 4, 5];
                case '651': return [5, 6];
                case '652': return [4, 5, 6];
                case '621': return [2, 3, 4, 5];
                case '641': return [3, 4, 5];
                case '671': return [3, 4];
                case '632': return [3, 4, 5];
                case '411': return [2, 3, 4];
                case '451': return [1, 2, 3, 4];
                case '441': return [2, 3, 4];
                case '803': return [3, 4, 5];
                case '801': return [6];
                case '802': return [4, 5, 6];
                case '804': return [5, 6];
                case '312': return [5, 6];
                case '421': return [2, 3, 4, 5];
                case '422': return [2, 3, 4, 5];
                case '612': return [3, 4, 5];
                case '805': return [3, 4, 5];
                case '731': return [4, 5];
                case '732': return [4, 5, 6];
                case '751': return [4, 5, 6];
                case '711': return [4, 5];
                case '712': return [3, 4, 5];
                case '311': return [5, 6];
                case '431': return [2, 3, 4, 5];
                case '611': return [6, 7];
                default: return [5, 6];
            }
        }
        
        // Fonction auxiliaire pour obtenir la couleur d'un OPM ID
        function getOpmIdColor(opmId) {
            // Ce mapping est bas√© sur les couleurs d√©finies plus haut dans le code
            const opmIdColors = {
                // IT (Cyberspace) - Bleu
                '411': '2, 125, 184',
                '421': '2, 125, 184',
                '431': '2, 125, 184',
                '441': '2, 125, 184',
                '451': '2, 125, 184',
                '632': '2, 125, 184',
                '641': '2, 125, 184',
                '651': '2, 125, 184',
                '661': '2, 125, 184',
                '671': '2, 125, 184',
                
                // Cybersecurity - Vert
                '212': '94, 151, 49',
                '462': '94, 151, 49',
                '511': '94, 151, 49',
                '521': '94, 151, 49',
                '531': '94, 151, 49',
                '541': '94, 151, 49',
                '611': '94, 151, 49',
                '612': '94, 151, 49',
                '622': '94, 151, 49',
                '631': '94, 151, 49',
                '652': '94, 151, 49',
                '722': '94, 151, 49',
                '723': '94, 151, 49',
                
                // Cyberspace Effects - Orange
                '121': '255, 145, 3',
                '122': '255, 145, 3',
                '131': '255, 145, 3',
                '132': '255, 145, 3',
                '133': '255, 145, 3',
                '322': '255, 145, 3',
                '332': '255, 145, 3',
                '341': '255, 145, 3',
                '442': '255, 145, 3',
                '443': '255, 145, 3',
                '463': '255, 145, 3',
                
                // Intelligence (Cyberspace) - Jaune
                '111': '255, 204, 2',
                '112': '255, 204, 2',
                '141': '255, 204, 2',
                '151': '255, 204, 2',
                '311': '255, 204, 2',
                '312': '255, 204, 2',
                '331': '255, 204, 2',
                '333': '255, 204, 2',
                
                // Cyberspace Enablers - Mauve
                '211': '153, 86, 206',
                '221': '153, 86, 206',
                '711': '153, 86, 206',
                '712': '153, 86, 206',
                '731': '153, 86, 206',
                '732': '153, 86, 206',
                '751': '153, 86, 206',
                '752': '153, 86, 206',
                '801': '153, 86, 206',
                '802': '153, 86, 206',
                '803': '153, 86, 206',
                '804': '153, 86, 206',
                '805': '153, 86, 206',
                '901': '153, 86, 206',
                
                // Software Engineering - Rouge
                '461': '214, 39, 40',
                '621': '214, 39, 40',
                '625': '214, 39, 40',
                '626': '214, 39, 40',
                '627': '214, 39, 40',
                '628': '214, 39, 40',
                '673': '214, 39, 40',
                '806': '214, 39, 40',
                
                // Data/AI - Turquoise
                '422': '23, 190, 207',
                '423': '23, 190, 207',
                '424': '23, 190, 207',
                '623': '23, 190, 207',
                '624': '23, 190, 207',
                '653': '23, 190, 207',
                '672': '23, 190, 207',
                '733': '23, 190, 207',
                '753': '23, 190, 207',
                '902': '23, 190, 207',
                '903': '23, 190, 207'
            };
            
            return opmIdColors[opmId] || '59, 130, 246'; // Couleur par d√©faut si non trouv√©e
        }
        
        // Fonction pour synchroniser l'√©chelle du haut avec les niveaux s√©lectionn√©s
        function updateTopScale() {
            // R√©cup√©rer tous les OPM IDs actifs (avec cases coch√©es)
            const activeOpmIds = [];
            document.querySelectorAll('.opm-checkbox:checked').forEach(checkbox => {
                activeOpmIds.push(checkbox.dataset.opmId);
            });
            
            // Calculer les niveaux √† mettre en surbrillance dans l'√©chelle du haut
            const levelsToHighlight = new Set();
            activeOpmIds.forEach(opmId => {
                const levels = getLevelsForOpmId(opmId);
                levels.forEach(level => levelsToHighlight.add(level));
            });
            
            // Mettre √† jour l'√©chelle du haut (ligne "Total")
            const totalRow = document.querySelector('#opm-ids-list table tr:last-child');
            if (totalRow) {
                const levelCircles = totalRow.querySelectorAll('td:nth-child(4) .flex.flex-row > div > div');
                levelCircles.forEach((circle, index) => {
                    const level = index + 1; // Les cercles sont index√©s √† partir de 0, mais les niveaux commencent √† 1
                    if (levelsToHighlight.has(level)) {
                        // Mettre en surbrillance le cercle
                        circle.style.backgroundColor = 'rgba(59, 130, 246, 0.8)';
                        circle.style.transform = 'scale(1.2)';
                        circle.style.boxShadow = '0 0 5px rgba(59, 130, 246, 0.7)';
                        circle.style.borderColor = 'rgba(59, 130, 246, 1)';
                        circle.style.borderWidth = '2px';
                        circle.style.transition = 'all 0.3s ease';
                    } else {
                        // R√©initialiser le cercle
                        circle.style.backgroundColor = 'rgba(59, 130, 246, 0.25)';
                        circle.style.transform = 'scale(1)';
                        circle.style.boxShadow = 'none';
                        circle.style.borderColor = 'rgba(59, 130, 246, 0.7)';
                        circle.style.borderWidth = '1px';
                    }
                });
            }
        }
        
        // Ajouter une animation de clignotement
        const styleElement = document.createElement('style');
        styleElement.textContent = `
            @keyframes blink-animation {
                0% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.6; transform: scale(1.15); }
                100% { opacity: 1; transform: scale(1); }
            }
        `;
        document.head.appendChild(styleElement);
        
        // Ex√©cuter une fois que les OPM IDs ont √©t√© charg√©s
        // On utilise un MutationObserver pour d√©tecter quand le contenu du opm-ids-list est modifi√©
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' && mutation.target.id === 'opm-ids-list') {
                    // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
                    // handleSpecialOpmBehavior();
                    
                    // D√âSACTIV√â : Les messages informatifs sur la surbrillance ont √©t√© supprim√©s
                    // const opmIdsContainer = document.getElementById('opm-ids-container');
                    // if (opmIdsContainer) {
                    //     // Supprimer d'abord tous les messages d'information existants
                    //     const existingInfoMessages = opmIdsContainer.querySelectorAll('.info-message');
                    //     existingInfoMessages.forEach(msg => msg.remove());
                    //     
                    //     // Ajouter un seul message d'information, seulement s'il n'existe pas d√©j√†
                    //     if (opmIdsContainer.querySelector('.info-message') === null) {
                    //         const infoMessage = document.createElement('div');
                    //         infoMessage.className = 'text-sm text-blue-600 mt-4 p-3 bg-blue-50 rounded-md border border-blue-200 info-message';
                    //         infoMessage.innerHTML = `
                    //             <p><svg class="inline-block h-5 w-5 mr-1 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    //                 <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
                    //             </svg>Cochez les cases √† c√¥t√© des OPM IDs pour activer leur mise en surbrillance dans le tableau.</p>
                    //         `;
                    //         opmIdsContainer.appendChild(infoMessage);
                    //     }
                    // }
                }
            });
        });
        
        // Observer les changements dans l'√©l√©ment opm-ids-list
        const opmIdsList = document.getElementById('opm-ids-list');
        if (opmIdsList) {
            observer.observe(opmIdsList, { childList: true });
            
            // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
            // setTimeout(handleSpecialOpmBehavior, 1000);
        }

        // Charger les OPM IDs au chargement de la page
        // loadOpmIdsFromSavedSelection() est maintenant appel√©e apr√®s loadAndDisplayStep0Selections()

        // Au lieu d'appliquer imm√©diatement les surbrillances, nous allons d√©sormais
        // v√©rifier si les cases √† cocher correspondantes sont coch√©es.
        // Cette fonction sera appel√©e chaque fois qu'une case √† cocher change d'√©tat.
        window.updateOpmHighlights = function(opmId, isChecked) {
            // Cr√©er le tooltip s'il n'existe pas
            if (!document.getElementById('custom-tooltip')) {
                const tooltip = document.createElement('div');
                tooltip.id = 'custom-tooltip';
                document.body.appendChild(tooltip);
            }
            
            // Fonction pour ajouter des tooltips √† une cellule
            function setupTooltip(cell, skillName, skillCode, level, description) {
                // Stocker les informations n√©cessaires au tooltip
                cell.dataset.skillName = skillName;
                cell.dataset.skillCode = skillCode;
                cell.dataset.level = level;
                cell.dataset.description = description || "Comp√©tence requise pour ce r√¥le";
                
                // Ajouter des gestionnaires d'√©v√©nements directs
                cell.onmouseenter = function() {
                    const tooltip = document.getElementById('custom-tooltip');
                    if (!tooltip) return;
                    
                    // R√©cup√©rer tous les OPM IDs associ√©s √† cette cellule
                    const cellOpmIds = this.dataset.opmId ? this.dataset.opmId.split(',') : [];
                    if (cellOpmIds.length === 0) return;
                    
                    // Construire les badges pour chaque OPM ID
                    let opmIdBadges = '';
                    cellOpmIds.forEach(id => {
                        const opmConfig = specialOpmConfigs.find(cfg => cfg.opmId === id);
                        if (opmConfig && opmConfig.isPresent) {
                            opmIdBadges += `<span class="tooltip-badge" style="background-color: rgba(${opmConfig.color}, 0.8);">OPM ID: ${id}</span>`;
                        }
                    });
                    
                    if (opmIdBadges === '') return; // Ne pas afficher le tooltip s'il n'y a pas d'OPM IDs actifs
                    
                    // Construire le contenu du tooltip
                    const tooltipContent = `
                        <div class="tooltip-title">${this.dataset.skillName} (${this.dataset.skillCode})</div>
                        <div class="tooltip-badges">
                            ${opmIdBadges}
                            <span class="tooltip-badge">Niveau: ${this.dataset.level}</span>
                        </div>
                        <div class="tooltip-info">
                            <strong>Description:</strong> ${this.dataset.description}
                        </div>
                    `;
                    
                    // Afficher le tooltip
                    tooltip.innerHTML = tooltipContent;
                    tooltip.classList.add('visible');
                    
                    // Positionner le tooltip
                    const rect = this.getBoundingClientRect();
                    tooltip.style.left = (rect.right + 15) + 'px';
                    tooltip.style.top = rect.top + 'px';
                    
                    // V√©rifier si le tooltip d√©passe √† droite
                    setTimeout(() => {
                        const tooltipRect = tooltip.getBoundingClientRect();
                        if (tooltipRect.right > window.innerWidth) {
                            tooltip.style.left = (rect.left - tooltipRect.width - 15) + 'px';
                        }
                    }, 0);
                };
                
                cell.onmouseleave = function() {
                    const tooltip = document.getElementById('custom-tooltip');
                    if (tooltip) {
                        tooltip.classList.remove('visible');
                    }
                };
            }
            
            // Trouver la configuration pour cet OPM ID
            const config = specialOpmConfigs.find(cfg => cfg.opmId === opmId);
            if (!config) return;
            
            // Mise √† jour de l'√©tat de pr√©sence bas√© sur la case √† cocher
            config.isPresent = isChecked;
            
            // V√©rifier si la case √† cocher est coch√©e
            const checkbox = document.querySelector(`.opm-checkbox[data-opm-id="${opmId}"]`);
            if (checkbox && !checkbox.checked) {
                // Si la case n'est pas coch√©e, r√©initialiser les surbrillances pour cet OPM ID
                resetHighlightsForOpmId(opmId);
                return; // Sortir de la fonction sans appliquer de nouvelles surbrillances
            }
            
            // Si la case est coch√©e, ne pas r√©initialiser d'abord pour √©viter le clignotement
            // Appliquer directement les nouvelles surbrillances
            if (isChecked) {
                // 1. Mettre en surbrillance les cercles de niveaux dans le tableau des OPM IDs
                const opmRows = document.querySelectorAll('#opm-ids-list table tr');
                opmRows.forEach(row => {
                    const opmIdText = row.querySelector('td:nth-child(2) span'); // Ajust√© pour la nouvelle structure avec case √† cocher
                    if (opmIdText && opmIdText.textContent === opmId) {
                        // Acc√©der aux cercles de niveau dans la cellule des niveaux
                        const levelCircles = row.querySelectorAll('td:nth-child(4) .flex.flex-row > div > div');
                        
                        // D√©terminer les niveaux √† mettre en surbrillance bas√©s sur l'OPM ID
                        const levelsToHighlight = getLevelsForOpmId(opmId);
                        
                        levelsToHighlight.forEach(level => {
                            const levelIndex = level; // Utiliser directement le niveau sans conversion
                            if (levelIndex >= 0 && levelIndex < levelCircles.length) {
                                const circle = levelCircles[levelIndex];
                                if (circle) {
                                    circle.style.backgroundColor = `rgba(${config.color}, 0.8)`;
                                    circle.style.transform = 'scale(1.2)';
                                    circle.style.boxShadow = `0 0 5px rgba(${config.color.split(',')[0]}, ${config.color.split(',')[1]}, ${config.color.split(',')[2]}, 0.7)`;
                                    circle.style.borderColor = `rgba(${config.color}, 1)`;
                                    circle.style.borderWidth = '2px';
                                    circle.style.transition = 'all 0.3s ease';
                                }
                            }
                        });
                    }
                });
                
                // 2. Mettre en surbrillance les cellules des comp√©tences sp√©cifiques
                const targetSkillRows = document.querySelectorAll('.skill-row');
                targetSkillRows.forEach(row => {
                    const codeElement = row.querySelector('.skill-code');
                    
                    // V√©rifier si cette comp√©tence est dans la liste des comp√©tences sp√©ciales pour cet OPM ID
                    if (codeElement) {
                        const competenceConfig = config.competences.find(comp => 
                            comp.code === codeElement.textContent.trim()
                        );
                        
                        if (competenceConfig) {
                            const skillCode = codeElement.textContent.trim();
                            const skillName = row.querySelector('.skill-name').textContent.trim();
                            
                            // Obtenir les level-box pour cette comp√©tence
                            const levelBoxes = row.querySelectorAll('.level-boxes .level-box');
                            
                            // Parcourir chaque niveau sp√©cifi√© dans la configuration
                            competenceConfig.levels.forEach(level => {
                                // L'index correspond au niveau - 1 (niveau 1 = index 0, niveau 2 = index 1, etc.)
                                const levelIndex = parseInt(level) - 1;
                                if (levelIndex >= 0 && levelIndex < levelBoxes.length) {
                                    const levelBox = levelBoxes[levelIndex];
                                    
                                    // V√©rifier si ce level-box a la classe 'filled'
                                    if (levelBox.classList.contains('filled')) {
                                        // V√©rifier si la cellule a d√©j√† des attributs OPM ID
                                        let currentOpmIds = levelBox.dataset.opmId ? levelBox.dataset.opmId.split(',') : [];
                                        
                                        // Ajouter cet OPM ID s'il n'est pas d√©j√† pr√©sent
                                        if (!currentOpmIds.includes(opmId)) {
                                            currentOpmIds.push(opmId);
                                            levelBox.dataset.opmId = currentOpmIds.join(',');
                                        }
                                        
                                        // Ajouter une animation de clignotement si elle n'existe pas d√©j√†
                                        if (!levelBox.style.animation || levelBox.style.animation === '') {
                                            levelBox.style.animation = 'blink-animation 1.5s infinite';
                                        }
                                        
                                        // Filtrer pour ne garder que les OPM IDs actifs
                                        const activeOpmIds = currentOpmIds.filter(id => {
                                            const cfg = specialOpmConfigs.find(c => c.opmId === id);
                                            return cfg && cfg.isPresent;
                                        });
                                        
                                        // Appliquer les styles de surbrillance avec fusion des couleurs
                                        if (activeOpmIds.length > 1) {
                                            // Cr√©er un d√©grad√© avec toutes les couleurs des OPM IDs actifs
                                            let gradientColors = [];
                                            let boxShadowColors = [];
                                            
                                            activeOpmIds.forEach((id, index) => {
                                                const opmConfig = specialOpmConfigs.find(cfg => cfg.opmId === id);
                                                if (opmConfig && opmConfig.isPresent) {
                                                    // Calculer la position du gradient pour cette couleur
                                                    const position = Math.round((index / (activeOpmIds.length - 1)) * 100);
                                                    gradientColors.push(`rgba(${opmConfig.color}, 0.8) ${position}%`);
                                                    boxShadowColors.push(`rgba(${opmConfig.color}, 0.5)`);
                                                }
                                            });
                                            
                                            // Appliquer un d√©grad√© multi-couleurs
                                            if (gradientColors.length > 1) {
                                                levelBox.style.background = `linear-gradient(135deg, ${gradientColors.join(', ')})`;
                                                // Utiliser la premi√®re couleur pour l'ombre
                                                levelBox.style.boxShadow = `0 0 8px ${boxShadowColors[0]}`;
                                            } else if (gradientColors.length === 1) {
                                                // Fallback si une seule couleur est disponible
                                                levelBox.style.background = `linear-gradient(135deg, rgb(${config.color}), rgba(${config.color}, 0.8))`;
                                                levelBox.style.boxShadow = `0 0 8px rgba(${config.color}, 0.9)`;
                                            }
                                        } else if (activeOpmIds.length === 1) {
                                            // Style standard pour une seule couleur
                                            levelBox.style.boxShadow = `0 0 8px rgba(${config.color}, 0.9)`;
                                            levelBox.style.background = `linear-gradient(135deg, rgb(${config.color}), rgba(${config.color}, 0.8))`;
                                        }
                                        
                                        // Configurer le tooltip pour cette cellule
                                        setupTooltip(levelBox, skillName, skillCode, level, competenceConfig.description);
                                    }
                                }
                            });
                        }
                    }
                });
            }
            
            // Mettre √† jour l'√©chelle du haut
            updateTopScale();
        }

        window.addEventListener('load', function() {
            // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
            // handleSpecialOpmBehavior();
            
            // R√©cup√©rer les √©tats des cases √† cocher depuis localStorage
            let checkboxStates = {};
            try {
                checkboxStates = JSON.parse(localStorage.getItem('opmCheckboxStates') || '{}');
                console.log('√âtats des cases √† cocher r√©cup√©r√©s:', checkboxStates);
            } catch (e) {
                console.error('Erreur lors de la r√©cup√©ration des √©tats des cases √† cocher:', e);
            }
            
            // Appliquer les √©tats des cases √† cocher et les surbrillances correspondantes
            document.querySelectorAll('.opm-checkbox').forEach(checkbox => {
                const opmId = checkbox.dataset.opmId;
                
                // Appliquer l'√©tat sauvegard√© s'il existe, sinon cocher par d√©faut
                if (opmId in checkboxStates) {
                    checkbox.checked = checkboxStates[opmId];
                } else {
                    checkbox.checked = true; // Par d√©faut, toutes les cases sont coch√©es
                    
                    // Sauvegarder l'√©tat par d√©faut
                    try {
                        checkboxStates[opmId] = true;
                        localStorage.setItem('opmCheckboxStates', JSON.stringify(checkboxStates));
                    } catch (e) {
                        console.error('Erreur lors de la sauvegarde de l\'√©tat par d√©faut:', e);
                    }
                }
                
                // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
                // if (window.specialOpmConfigs) {
                //     const config = window.specialOpmConfigs.find(cfg => cfg.opmId === opmId);
                //     if (config) {
                //         config.isPresent = checkbox.checked;
                //     }
                // }
                
                // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
                // if (checkbox.checked && window.updateOpmHighlights) {
                //     window.updateOpmHighlights(opmId, true);
                // }
            });
            
            // D√âSACTIV√â : Les messages informatifs sur la surbrillance ont √©t√© supprim√©s
            // document.querySelectorAll('.info-message').forEach(msg => msg.remove());
            // 
            // const opmIdsContainer = document.getElementById('opm-ids-container');
            // if (opmIdsContainer) {
            //     const infoMessage = document.createElement('div');
            //     infoMessage.className = 'text-sm text-blue-600 mt-4 p-3 bg-blue-50 rounded-md border border-blue-200 info-message';
            //     infoMessage.innerHTML = `
            //         <p><svg class="inline-block h-5 w-5 mr-1 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            //             <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
            //         </svg>Cochez ou d√©cochez les cases pour afficher ou masquer les surbrillances des OPM IDs.</p>
            //     `;
            //     opmIdsContainer.appendChild(infoMessage);
            // }
            
            // console.log('Initialisation termin√©e: les surbrillances ont √©t√© appliqu√©es selon les √©tats sauvegard√©s');
            
            // Mettre √† jour l'√©chelle du haut apr√®s l'initialisation
            updateTopScale();
            
            // Configurer les tooltips apr√®s un court d√©lai pour s'assurer que les modifications DOM sont appliqu√©es
            setTimeout(() => {
                if (typeof setupAllTooltips === 'function') {
                    setupAllTooltips();
                }
            }, 500);
        });

        // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
        // function reapplyAllActiveHighlights() {
        //     // R√©appliquer sans log pour √©viter de polluer la console
        //     document.querySelectorAll('.opm-checkbox').forEach(checkbox => {
        //         if (checkbox.checked) {
        //             const opmId = checkbox.dataset.opmId;
        //             if (opmId && window.updateOpmHighlights) {
        //                 window.updateOpmHighlights(opmId, true);
        //             }
        //         }
        //     });
        // }
        
        // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
        // setInterval(reapplyAllActiveHighlights, 200);
        
        // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
        // Protection contre la d√©sactivation des surbrillances
        // Observer les changements sur les cellules pour d√©tecter les r√©initialisations non d√©sir√©es
        const highlightObserver = null; // D√âSACTIV√â
        // const highlightObserver = new MutationObserver(function(mutations) {
        //     mutations.forEach(function(mutation) {
        //         if (mutation.type === 'attributes' && 
        //            (mutation.attributeName === 'style' || mutation.attributeName === 'data-opm-id')) {
        //             const target = mutation.target;
        //             if (target.classList.contains('level-box') && target.classList.contains('filled')) {
        //                 // V√©rifier si la cellule a des OPM IDs associ√©s
        //                 const opmIds = target.dataset.opmId ? target.dataset.opmId.split(',') : [];
        //                 if (opmIds.length > 0) {
        //                     // V√©rifier si au moins un OPM ID a sa case √† cocher activ√©e
        //                     const hasActiveOpmId = opmIds.some(id => {
        //                         const checkbox = document.querySelector(`.opm-checkbox[data-opm-id="${id}"]`);
        //                         return checkbox && checkbox.checked;
        //                     });
        //                     
        //                     if (hasActiveOpmId && 
        //                        (!target.style.background || !target.style.boxShadow || 
        //                         target.style.background === '' || target.style.boxShadow === '')) {
        //                         // R√©appliquer imm√©diatement la surbrillance
        //                         reapplyAllActiveHighlights();
        //                     }
        //                 }
        //             }
        //         }
        //     });
        // });
        
        // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
        // Observer les changements sur toutes les cellules
        // document.querySelectorAll('.level-box.filled').forEach(box => {
        //     highlightObserver.observe(box, { 
        //         attributes: true, 
        //         attributeFilter: ['style', 'data-opm-id'] 
        //     });
        // });
    });

    // Fonction pour appliquer le filtrage des lignes de comp√©tences bas√© sur les OPM IDs s√©lectionn√©s
    function applySkillRowsFiltering() {
        console.log('Application du filtrage des lignes de comp√©tences...');
        
        // Si le mode Full View est actif (wizard ou non), afficher tout sans filtrage
        if (wizardFullViewMode) {
            console.log('Mode Full View actif, affichage de tous les skills');
            document.querySelectorAll('.category-container, .subcategory, .skill-row').forEach(element => {
                if (element.style.display === 'none') {
                    element.style.display = '';
                }
            });
            return;
        }
        
        // R√©cup√©rer les OPM IDs √† filtrer
        const selectedOpmIds = [];
        
        // Si le wizard est actif (en Focus Mode), utiliser uniquement l'OPM-ID en cours
        if (wizardActive && currentWizardOpmId) {
            selectedOpmIds.push(currentWizardOpmId);
            console.log('Mode wizard Focus actif, filtrage sur OPM-ID:', currentWizardOpmId);
        } else {
            // Sinon, r√©cup√©rer tous les OPM-IDs des cards o√π Primary ou Secondary est coch√©
            document.querySelectorAll('.selected-role-card').forEach(card => {
                const opmId = card.dataset.opmCode;
                const primaryCheckbox = card.querySelector('.role-primary-checkbox');
                const secondaryCheckbox = card.querySelector('.role-secondary-checkbox');
                
                if ((primaryCheckbox && primaryCheckbox.checked) || 
                    (secondaryCheckbox && secondaryCheckbox.checked)) {
                    selectedOpmIds.push(opmId);
                }
            });
            console.log('Mode normal, OPM IDs s√©lectionn√©s:', selectedOpmIds);
        }
        
        // Si aucun OPM ID n'est s√©lectionn√©, afficher toutes les lignes
        if (selectedOpmIds.length === 0) {
            document.querySelectorAll('.category-container, .subcategory, .skill-row').forEach(element => {
                if (element.style.display === 'none') {
                    element.style.display = '';
                }
            });
            console.log('Aucun OPM ID s√©lectionn√©, toutes les lignes sont affich√©es');
            return;
        }
        
        // Lire en temps r√©el les codes de comp√©tences depuis les badges dans les cards
        const selectedCompetenceCodes = new Set();
        
        console.log(`=== D√âBUT EXTRACTION DES CODES DE COMP√âTENCES ===`);
        console.log(`OPM IDs √† traiter:`, selectedOpmIds);
        
        selectedOpmIds.forEach(opmId => {
            console.log(`\n--- Traitement OPM ID: ${opmId} ---`);
            const roleCard = document.querySelector(`.selected-role-card[data-opm-code="${opmId}"]`);
            if (!roleCard) {
                console.log(`Card pour OPM ${opmId} non trouv√©e`);
                return;
            }
            
            const competencesContainer = roleCard.querySelector(`.role-competences[data-opm-id="${opmId}"]`);
            if (!competencesContainer) {
                console.log(`Conteneur comp√©tences non trouv√© pour OPM ${opmId}`);
                return;
            }
            
            console.log(`Contenu HTML du conteneur pour OPM ${opmId}:`, competencesContainer.innerHTML);
            
            // Lire directement tous les spans dans le conteneur de comp√©tences
            const competenceContainer = competencesContainer.querySelector('.competence-container');
            if (competenceContainer) {
                // R√©cup√©rer tous les badges (spans avec le code de comp√©tence)
                const badges = competenceContainer.querySelectorAll('span.inline-block');
                console.log(`Nombre de badges trouv√©s pour OPM ${opmId}:`, badges.length);
                
                badges.forEach((badge, index) => {
                    console.log(`Badge ${index} pour OPM ${opmId}:`, badge.outerHTML);
                    
                    // Extraire le code de comp√©tence depuis le badge
                    // Le format peut √™tre : <span class="inline">markers</span> CODE ou juste CODE
                    let code = '';
                    const inlineSpan = badge.querySelector('span.inline');
                    
                    if (inlineSpan) {
                        // Si il y a un span.inline, le code est apr√®s le span
                        // Le textContent complet est "markers CODE", on doit extraire juste "CODE"
                        const fullText = badge.textContent.trim();
                        const markerText = inlineSpan.textContent.trim();
                        // Extraire le texte apr√®s les markers
                        code = fullText.substring(fullText.indexOf(markerText) + markerText.length).trim();
                        console.log(`Badge avec marker - fullText: "${fullText}", markerText: "${markerText}", code extrait: "${code}"`);
                    } else {
                        // Sinon, le code est directement dans le textContent
                        code = badge.textContent.trim();
                        console.log(`Badge sans marker - code extrait: "${code}"`);
                    }
                    
                    // Nettoyer le code et extraire uniquement les lettres majuscules (code de comp√©tence)
                    // Les codes de comp√©tence sont g√©n√©ralement 2-5 lettres majuscules
                    const codeMatch = code.match(/[A-Z]{2,5}/);
                    if (codeMatch) {
                        const finalCode = codeMatch[0];
                        selectedCompetenceCodes.add(finalCode);
                        console.log(`‚úì Code de comp√©tence ajout√©: ${finalCode}`);
                    } else {
                        console.log(`‚úó Aucun code valide extrait de: "${code}"`);
                    }
                });
            } else {
                console.log(`Pas de .competence-container trouv√© pour OPM ${opmId}`);
            }
        });
        
        console.log(`\n=== CODES DE COMP√âTENCES EXTRAITS ===`);
        console.log(`Total:`, Array.from(selectedCompetenceCodes));
        
        console.log('Codes de comp√©tences lus depuis les spans dans "Comp√©tences associ√©es":', Array.from(selectedCompetenceCodes));
        
        // Garder trace des lignes de comp√©tences, sous-cat√©gories et cat√©gories qui ont des comp√©tences visibles
        const visibleSkillRows = new Set();
        const visibleSubcategories = new Set();
        const visibleCategories = new Set();
        
        // Premi√®re passe : identifier les lignes de comp√©tences qui correspondent aux codes de comp√©tences lus depuis les spans
        // C'est la m√©thode principale de filtrage - bas√©e sur les codes r√©els pr√©sents dans la colonne "Comp√©tences associ√©es"
        if (selectedCompetenceCodes.size > 0) {
            document.querySelectorAll('.skill-row').forEach(skillRow => {
                // Trouver le code de comp√©tence dans cette ligne (g√©n√©ralement dans .skill-code)
                const skillCodeElement = skillRow.querySelector('.skill-code');
                if (skillCodeElement) {
                    const skillCode = skillCodeElement.textContent.trim().toUpperCase();
                    if (selectedCompetenceCodes.has(skillCode)) {
                        visibleSkillRows.add(skillRow);
                        console.log(`Ligne de comp√©tence visible trouv√©e pour le code: ${skillCode}`);
                    }
                }
            });
        }
        
        // Deuxi√®me passe : identifier aussi les lignes de comp√©tences qui contiennent des OPM IDs s√©lectionn√©s
        // (pour maintenir la compatibilit√© avec le filtrage par OPM ID)
        document.querySelectorAll('.level-box.filled[data-role-opm-id]').forEach(box => {
            const boxOpmIds = box.dataset.roleOpmId ? box.dataset.roleOpmId.split(',').map(id => id.trim()) : [];
            
            // Si au moins un des OPM IDs de cette cellule est dans la liste des OPM IDs s√©lectionn√©s
            if (boxOpmIds.some(id => selectedOpmIds.includes(id))) {
                // Trouver la ligne de comp√©tence parente
                const skillRow = box.closest('.skill-row');
                if (skillRow) {
                    visibleSkillRows.add(skillRow);
                }
            }
        });
        
        // Deuxi√®me passe : pour chaque ligne de comp√©tence visible, d√©terminer sa sous-cat√©gorie et cat√©gorie
        visibleSkillRows.forEach(skillRow => {
            // Trouver la sous-cat√©gorie parente
            const subcategory = skillRow.closest('.subcategory');
            if (subcategory) {
                visibleSubcategories.add(subcategory);
                
                // Trouver la cat√©gorie parente
                const category = subcategory.closest('.category-container');
                if (category) {
                    visibleCategories.add(category);
                }
            }
        });
        
        // Troisi√®me passe : masquer toutes les lignes de comp√©tences, puis afficher uniquement celles qui sont visibles
        document.querySelectorAll('.skill-row').forEach(row => {
            row.style.display = visibleSkillRows.has(row) ? '' : 'none';
        });
        
        // Quatri√®me passe : masquer toutes les sous-cat√©gories, puis afficher uniquement celles qui sont visibles
        document.querySelectorAll('.subcategory').forEach(subcategory => {
            subcategory.style.display = visibleSubcategories.has(subcategory) ? '' : 'none';
        });
        
        // Cinqui√®me passe : masquer toutes les cat√©gories, puis afficher uniquement celles qui sont visibles
        document.querySelectorAll('.category-container').forEach(category => {
            category.style.display = visibleCategories.has(category) ? '' : 'none';
        });
        
        console.log('Filtrage des lignes termin√©');
    }

    window.addEventListener('load', function() {
        // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
        // handleSpecialOpmBehavior();
        
        // R√©cup√©rer les √©tats des cases √† cocher depuis localStorage
        let checkboxStates = {};
        try {
            checkboxStates = JSON.parse(localStorage.getItem('opmCheckboxStates') || '{}');
            console.log('√âtats des cases √† cocher r√©cup√©r√©s:', checkboxStates);
        } catch (e) {
            console.error('Erreur lors de la r√©cup√©ration des √©tats des cases √† cocher:', e);
        }
        
        // Appliquer les √©tats des cases √† cocher et les surbrillances correspondantes
        document.querySelectorAll('.opm-checkbox').forEach(checkbox => {
            const opmId = checkbox.dataset.opmId;
            
            // Appliquer l'√©tat sauvegard√© s'il existe, sinon cocher par d√©faut
            if (opmId in checkboxStates) {
                checkbox.checked = checkboxStates[opmId];
            } else {
                checkbox.checked = true; // Par d√©faut, toutes les cases sont coch√©es
                
                // Sauvegarder l'√©tat par d√©faut
                try {
                    checkboxStates[opmId] = true;
                    localStorage.setItem('opmCheckboxStates', JSON.stringify(checkboxStates));
                } catch (e) {
                    console.error('Erreur lors de la sauvegarde de l\'√©tat par d√©faut:', e);
                }
            }
            
            // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
            // if (window.specialOpmConfigs) {
            //     const config = window.specialOpmConfigs.find(cfg => cfg.opmId === opmId);
            //     if (config) {
            //         config.isPresent = checkbox.checked;
            //     }
            // }
            
            // D√âSACTIV√â : La fonctionnalit√© de surbrillance a √©t√© d√©sactiv√©e
            // if (checkbox.checked && window.updateOpmHighlights) {
            //     window.updateOpmHighlights(opmId, true);
            // }
        });
        
        // D√âSACTIV√â : Les messages informatifs sur la surbrillance ont √©t√© supprim√©s
        // document.querySelectorAll('.info-message').forEach(msg => msg.remove());
        // 
        // const opmIdsContainer = document.getElementById('opm-ids-container');
        // if (opmIdsContainer) {
        //     const infoMessage = document.createElement('div');
        //     infoMessage.className = 'text-sm text-blue-600 mt-4 p-3 bg-blue-50 rounded-md border border-blue-200 info-message';
        //     infoMessage.innerHTML = `
        //         <p><svg class="inline-block h-5 w-5 mr-1 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        //             <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
        //         </svg>Cochez ou d√©cochez les cases pour afficher ou masquer les surbrillances des OPM IDs.</p>
        //     `;
        //     opmIdsContainer.appendChild(infoMessage);
        // }
        // 
        // console.log('Initialisation termin√©e: les surbrillances ont √©t√© appliqu√©es selon les √©tats sauvegard√©s');
        
        // Configurer les tooltips apr√®s un court d√©lai pour s'assurer que les modifications DOM sont appliqu√©es
        setTimeout(() => {
            if (typeof setupAllTooltips === 'function') {
                setupAllTooltips();
            }
        }, 500);
    });
    </script>
    
    <!-- Script pour le wizard de s√©lection de niveaux -->
    <script>
        // Variables globales pour le wizard
        let wizardActive = false;
        let wizardOpmIds = [];
        let currentWizardIndex = 0;
        let currentWizardOpmId = null; // OPM-ID actuellement affich√© dans le wizard
        let wizardFullViewMode = false; // false = Focus Mode (filtr√©), true = Full View (tout afficher)
        let levelSelections = {}; // Structure: { opmId: { skillCode: level } }
        let opmAverages = {}; // Structure: { opmId: averageLevel }
        
        // Fonction pour d√©marrer le wizard
        function startLevelSelectionWizard() {
            console.log('D√©marrage du wizard de s√©lection de niveaux');
            
            // R√©cup√©rer tous les OPM IDs depuis les cards
            const roleCards = document.querySelectorAll('.selected-role-card[data-opm-code]');
            wizardOpmIds = Array.from(roleCards).map(card => card.dataset.opmCode);
            
            console.log('OPM IDs trouv√©s:', wizardOpmIds);
            
            if (wizardOpmIds.length === 0) {
                alert('No OPM IDs found. Please ensure work roles are loaded.');
                return;
            }
            
            // R√©initialiser compl√®tement les s√©lections (nouveau d√©marrage = table rase)
            levelSelections = {};
            opmAverages = {};
            wizardOpmIds.forEach(opmId => {
                levelSelections[opmId] = {};
                opmAverages[opmId] = 0;
                // R√©initialiser l'√©chelle de graduation dans la card
                updateMainGraduationScale(opmId, 0);
            });
            
            // Pr√©s√©lectionner DAAN √† 5 (plage 2‚Äì7) pour les r√¥les qui ont cette comp√©tence
            wizardOpmIds.forEach(opmId => {
                const roleCard = document.querySelector(`.selected-role-card[data-opm-code="${opmId}"]`);
                if (!roleCard) return;
                const competencesContainer = roleCard.querySelector(`.role-competences[data-opm-id="${opmId}"]`);
                if (!competencesContainer) return;
                const badges = competencesContainer.querySelectorAll('.competence-container span.inline-block');
                badges.forEach(badge => {
                    const inlineSpan = badge.querySelector('span.inline');
                    let code = '';
                    if (inlineSpan) {
                        const fullText = badge.textContent.trim();
                        const markerText = inlineSpan.textContent.trim();
                        code = fullText.substring(fullText.indexOf(markerText) + markerText.length).trim();
                    } else {
                        code = badge.textContent.trim();
                    }
                    const codeMatch = code.match(/[A-Z]{2,5}/);
                    if (codeMatch && codeMatch[0] === 'DAAN') {
                        levelSelections[opmId]['DAAN'] = '5';
                    }
                });
            });
            
            // Activer le wizard
            wizardActive = true;
            currentWizardIndex = 0;
            wizardFullViewMode = false; // D√©marrer en Focus Mode par d√©faut
            
            // R√©initialiser le toggle au d√©marrage
            const viewToggle = document.getElementById('wizard-view-toggle');
            const viewLabel = document.getElementById('wizard-view-label');
            if (viewToggle) viewToggle.checked = false;
            if (viewLabel) viewLabel.textContent = 'Focus';
            
            // Afficher les contr√¥les du wizard et masquer le bouton Start
            document.getElementById('wizard-controls').style.display = 'block';
            document.getElementById('start-level-selection-btn').style.display = 'none';
            
            // Activer le mode wizard sur la grille
            document.getElementById('sfia-grid').classList.add('wizard-active');
            
            // Initialiser la jauge OPM-ID
            updateWizardOpmScale();
            
            // Charger le premier OPM ID
            loadWizardOpmId(currentWizardIndex);
        }
        
        // Fonction pour mettre √† jour la jauge OPM-ID
        function updateWizardOpmScale() {
            const scaleContainer = document.getElementById('wizard-opm-scale');
            if (!scaleContainer) return;
            
            // Vider le conteneur
            scaleContainer.innerHTML = '';
            
            // Cr√©er un √©l√©ment pour chaque OPM-ID
            wizardOpmIds.forEach((opmId, idx) => {
                const opmItem = document.createElement('div');
                opmItem.className = 'wizard-opm-item';
                opmItem.textContent = opmId;
                opmItem.setAttribute('data-opm-id', opmId);
                
                // Marquer comme actif si c'est l'OPM-ID en cours
                if (idx === currentWizardIndex) {
                    opmItem.classList.add('active');
                }
                // Marquer comme compl√©t√© si c'est un OPM-ID pr√©c√©dent
                else if (idx < currentWizardIndex) {
                    opmItem.classList.add('completed');
                }
                
                scaleContainer.appendChild(opmItem);
            });
        }
        
        // Fonction pour charger un OPM ID dans le wizard
        function loadWizardOpmId(index) {
            if (index < 0 || index >= wizardOpmIds.length) {
                console.error('Index OPM ID invalide:', index);
                return;
            }
            
            const opmId = wizardOpmIds[index];
            console.log(`Chargement de l'OPM ID ${opmId} (${index + 1}/${wizardOpmIds.length})`);
            
            // D√©finir l'OPM-ID actuel du wizard
            currentWizardOpmId = opmId;
            
            // Mettre √† jour le texte du bouton Next
            const btnText = document.getElementById('wizard-btn-text');
            if (index === wizardOpmIds.length - 1) {
                btnText.textContent = 'Complete';
            } else {
                btnText.textContent = 'Next';
            }
            
            // Mettre √† jour la jauge OPM-ID
            updateWizardOpmScale();
            
            // Afficher/masquer le bouton Previous
            const prevBtn = document.getElementById('wizard-prev-btn');
            if (prevBtn) {
                if (index > 0) {
                    prevBtn.style.display = 'flex';
                } else {
                    prevBtn.style.display = 'none';
                }
            }
            
            // Surbrillancer la card de l'OPM-ID en cours
            document.querySelectorAll('.selected-role-card').forEach(card => {
                card.style.outline = '';
                card.style.transform = '';
            });
            
            const currentCard = document.querySelector(`.selected-role-card[data-opm-code="${opmId}"]`);
            if (currentCard) {
                currentCard.style.outline = '4px solid #6366f1';
                currentCard.style.transform = 'scale(1.05)';
                currentCard.style.transition = 'all 0.3s ease';
                currentCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            // Appliquer le filtrage pour afficher uniquement les skills de cet OPM ID
            applySkillRowsFiltering();
            
            // R√âINITIALISER VISUELLEMENT TOUS LES SKILLS (pas les donn√©es, juste l'affichage)
            document.querySelectorAll('.skill-row').forEach(row => {
                row.classList.remove('has-level-selected');
                const codeElement = row.querySelector('.skill-code');
                if (codeElement) {
                    codeElement.classList.remove('has-level-selected');
                }
                row.querySelectorAll('.level-box').forEach(box => {
                    box.classList.remove('selected');
                });
            });
            
            // Restaurer les s√©lections visuelles pour cet OPM ID sp√©cifique
            restoreLevelSelections(opmId);
            
            // Calculer et afficher la moyenne actuelle (qui met aussi √† jour l'√©chelle)
            updateAverageDisplay(opmId);
            
            // Activer les clics sur les level-boxes
            activateLevelBoxClicks();
            
            // Reconfigurer les tooltips apr√®s activation du wizard
            setupSkillTooltips();
        }
        
        // Fonction pour activer les clics sur les level-boxes
        function activateLevelBoxClicks() {
            // Retirer les anciens gestionnaires d'√©v√©nements
            document.querySelectorAll('.level-box').forEach(box => {
                const newBox = box.cloneNode(true);
                box.parentNode.replaceChild(newBox, box);
            });
            
            // Ajouter les nouveaux gestionnaires
            document.querySelectorAll('.level-box').forEach(box => {
                box.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    if (!wizardActive) return;
                    
                    const skillRow = this.closest('.skill-row');
                    if (!skillRow) return;
                    
                    const skillCodeElement = skillRow.querySelector('.skill-code');
                    if (!skillCodeElement) return;
                    
                    const skillCode = skillCodeElement.textContent.trim().replace('‚úì', '').trim();
                    const level = this.textContent.trim();
                    const currentOpmId = wizardOpmIds[currentWizardIndex];
                    
                    console.log(`Clic sur level ${level} pour skill ${skillCode} (OPM ID: ${currentOpmId})`);
                    
                    // Retirer la s√©lection de tous les level-boxes de cette ligne
                    skillRow.querySelectorAll('.level-box').forEach(lb => {
                        lb.classList.remove('selected');
                    });
                    
                    // V√©rifier si on clique sur le m√™me niveau d√©j√† s√©lectionn√© (pour d√©s√©lectionner)
                    if (levelSelections[currentOpmId][skillCode] === level) {
                        // D√©s√©lectionner
                        delete levelSelections[currentOpmId][skillCode];
                        skillRow.classList.remove('has-level-selected');
                        skillCodeElement.classList.remove('has-level-selected');
                    } else {
                        // S√©lectionner ce niveau
                        this.classList.add('selected');
                        levelSelections[currentOpmId][skillCode] = level;
                        skillRow.classList.add('has-level-selected');
                        skillCodeElement.classList.add('has-level-selected');
                    }
                    
                    // Mettre √† jour la moyenne
                    updateAverageDisplay(currentOpmId);
                    
                    // Ne pas sauvegarder automatiquement - sera fait uniquement √† la fin
                });
            });
        }
        
        // Fonction pour restaurer les s√©lections de niveaux pour un OPM ID
        function restoreLevelSelections(opmId) {
            if (!levelSelections[opmId]) return;
            
            Object.keys(levelSelections[opmId]).forEach(skillCode => {
                const level = levelSelections[opmId][skillCode];
                
                // Trouver la ligne de skill correspondante
                const skillRows = document.querySelectorAll('.skill-row');
                skillRows.forEach(row => {
                    const codeElement = row.querySelector('.skill-code');
                    if (codeElement && codeElement.textContent.trim().replace('‚úì', '').trim() === skillCode) {
                        // Trouver la level-box correspondante
                        const levelBoxes = row.querySelectorAll('.level-box');
                        levelBoxes.forEach(box => {
                            if (box.textContent.trim() === level) {
                                box.classList.add('selected');
                            }
                        });
                        
                        // Ajouter le marqueur visuel
                        row.classList.add('has-level-selected');
                        codeElement.classList.add('has-level-selected');
                    }
                });
            });
        }
        
        // Fonction pour calculer et afficher la moyenne
        function updateAverageDisplay(opmId) {
            const selections = levelSelections[opmId] || {};
            const selectedSkillCodes = Object.keys(selections);
            const levels = Object.values(selections).map(l => parseInt(l)).filter(l => !isNaN(l));
            
            // Calculer la moyenne
            let average = 0;
            if (levels.length > 0) {
                const sum = levels.reduce((a, b) => a + b, 0);
                average = Math.round(sum / levels.length);
            }
            
            opmAverages[opmId] = average;
            
            // Obtenir les skills propos√©s depuis les badges dans la card
            const roleCard = document.querySelector(`.selected-role-card[data-opm-code="${opmId}"]`);
            const proposedSkillCodes = new Set();
            
            if (roleCard) {
                const competencesContainer = roleCard.querySelector(`.role-competences[data-opm-id="${opmId}"]`);
                if (competencesContainer) {
                    const badges = competencesContainer.querySelectorAll('.competence-container span.inline-block');
                    badges.forEach(badge => {
                        // Extraire le code du badge (m√™me logique que dans applySkillRowsFiltering)
                        const inlineSpan = badge.querySelector('span.inline');
                        let code = '';
                        
                        if (inlineSpan) {
                            const fullText = badge.textContent.trim();
                            const markerText = inlineSpan.textContent.trim();
                            code = fullText.substring(fullText.indexOf(markerText) + markerText.length).trim();
                        } else {
                            code = badge.textContent.trim();
                        }
                        
                        const codeMatch = code.match(/[A-Z]{2,5}/);
                        if (codeMatch) {
                            proposedSkillCodes.add(codeMatch[0]);
                        }
                    });
                }
            }
            
            // Calculer le nombre de skills s√©lectionn√©s qui ne sont pas propos√©s
            const otherSkills = selectedSkillCodes.filter(code => !proposedSkillCodes.has(code));
            
            // Mettre √† jour l'affichage de l'OPM-ID en cours
            const wizardOpmIdDisplay = document.getElementById('wizard-current-opm-id');
            if (wizardOpmIdDisplay) {
                wizardOpmIdDisplay.textContent = opmId;
            }
            
            // Mettre √† jour le nombre de skills propos√©s
            const proposedCountDisplay = document.getElementById('wizard-proposed-count');
            if (proposedCountDisplay) {
                proposedCountDisplay.textContent = proposedSkillCodes.size;
            }
            
            // Mettre √† jour le nombre de skills s√©lectionn√©s
            const selectedCountDisplay = document.getElementById('wizard-selected-count');
            if (selectedCountDisplay) {
                selectedCountDisplay.textContent = selectedSkillCodes.length;
            }
            
            // Mettre √† jour le nombre de skills "autres" (s√©lectionn√©s mais pas propos√©s)
            const otherCountDisplay = document.getElementById('wizard-other-count');
            if (otherCountDisplay) {
                otherCountDisplay.textContent = otherSkills.length;
            }
            
            // Mettre √† jour l'√©chelle principale (cellules rondes) dans la card en temps r√©el
            updateMainGraduationScale(opmId, average);
        }
        
        // Fonction pour mettre √† jour l'√©chelle principale de graduation
        function updateMainGraduationScale(opmId, level) {
            const roleCard = document.querySelector(`.selected-role-card[data-opm-code="${opmId}"]`);
            if (!roleCard) return;
            
            // Trouver le conteneur de graduation dans la card
            const graduationContainer = roleCard.querySelector(`.role-graduation[data-opm-id="${opmId}"]`);
            if (!graduationContainer) return;
            
            // Trouver tous les cercles de niveau
            const circles = graduationContainer.querySelectorAll('.graduation-circle');
            
            // R√©initialiser tous les cercles
            circles.forEach((circle) => {
                circle.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                circle.style.color = 'rgba(255, 255, 255, 0.7)';
                circle.style.boxShadow = '';
                circle.style.transform = '';
            });
            
            // Surbrillancer uniquement le cercle correspondant au niveau moyen
            if (level > 0 && level <= circles.length) {
                const targetCircle = circles[level - 1];
                if (targetCircle) {
                    targetCircle.style.backgroundColor = '#6366f1';
                    targetCircle.style.color = 'white';
                    targetCircle.style.boxShadow = '0 0 15px rgba(99, 102, 241, 0.8)';
                    targetCircle.style.transform = 'scale(1.15)';
                    targetCircle.style.transition = 'all 0.3s ease';
                }
            }
        }
        
        // Fonction pour sauvegarder les s√©lections dans localStorage
        function saveLevelSelections() {
            try {
                // Load existing data to merge (don't overwrite data from summary_mil.html)
                const existingData = localStorage.getItem('wizardLevelSelections');
                let mergedSelections = {};
                
                if (existingData) {
                    try {
                        mergedSelections = JSON.parse(existingData);
                        console.log('Existing wizardLevelSelections found, merging...');
                    } catch (e) {
                        console.error('Error parsing existing wizardLevelSelections:', e);
                        mergedSelections = {};
                    }
                }
                
                // Merge: for each OPM-ID, combine skills (SFIA skills from this page)
                // We need to preserve military skills from summary_mil.html
                // SFIA skills are typically 4-letter codes, but we should check against military data if available
                Object.entries(levelSelections).forEach(([opmId, skills]) => {
                    if (!mergedSelections[opmId]) {
                        mergedSelections[opmId] = {};
                    }
                    // Add SFIA skills from this page (preserve military skills from summary_mil.html)
                    Object.entries(skills).forEach(([skillCode, level]) => {
                        // SFIA skills are typically 4-letter codes
                        // Only add if it's not a military skill (preserve military skills from summary_mil.html)
                        // For now, we'll add all 4-letter codes as SFIA skills
                        // The source detection in project_recap will determine the correct source
                        if (skillCode.length === 4) {
                            mergedSelections[opmId][skillCode] = level;
                        }
                    });
                });
                
                localStorage.setItem('wizardLevelSelections', JSON.stringify(mergedSelections));
                localStorage.setItem('wizardOpmAverages', JSON.stringify(opmAverages));
                console.log('Merged wizardLevelSelections saved:', mergedSelections);
            } catch (e) {
                console.error('Erreur lors de la sauvegarde des s√©lections:', e);
            }
        }
        
        // Fonction pour charger les s√©lections depuis localStorage
        function loadLevelSelections() {
            try {
                const savedSelections = localStorage.getItem('wizardLevelSelections');
                const savedAverages = localStorage.getItem('wizardOpmAverages');
                
                if (savedSelections) {
                    levelSelections = JSON.parse(savedSelections);
                }
                if (savedAverages) {
                    opmAverages = JSON.parse(savedAverages);
                }
            } catch (e) {
                console.error('Erreur lors du chargement des s√©lections:', e);
            }
        }
        
        // Fonction pour passer √† l'OPM ID suivant ou terminer
        function nextWizardStep() {
            const currentOpmId = wizardOpmIds[currentWizardIndex];
            
            // V√©rifier si c'est le dernier OPM ID
            if (currentWizardIndex === wizardOpmIds.length - 1) {
                // Terminer le wizard et rediriger vers summary_mil.html
                completeWizard();
            } else {
                // Passer √† l'OPM ID suivant
                currentWizardIndex++;
                loadWizardOpmId(currentWizardIndex);
            }
        }
        
        // Fonction pour revenir √† l'OPM ID pr√©c√©dent
        function previousWizardStep() {
            if (currentWizardIndex > 0) {
                // Revenir √† l'OPM ID pr√©c√©dent
                currentWizardIndex--;
                loadWizardOpmId(currentWizardIndex);
            }
        }
        
        // Fonction pour terminer le wizard et afficher le r√©capitulatif
        function completeWizard() {
            console.log('Pr√©paration du r√©capitulatif du wizard...');
            
            // Calculer les statistiques
            const totalSkillsSelected = Object.values(levelSelections).reduce((total, opmSelections) => {
                return total + Object.keys(opmSelections).length;
            }, 0);
            
            // G√©n√©rer le contenu du r√©capitulatif
            let summaryHTML = `
                <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                    <div class="text-center mb-3">
                        <div class="text-3xl font-bold text-indigo-600">${totalSkillsSelected}</div>
                        <div class="text-sm text-gray-600">Total Skills Selected</div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-blue-600">${wizardOpmIds.length}</div>
                            <div class="text-xs text-gray-600">OPM-IDs Processed</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-600">${Object.values(opmAverages).filter(avg => avg > 0).length}</div>
                            <div class="text-xs text-gray-600">With Averages</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-purple-600">${Math.round(Object.values(opmAverages).filter(avg => avg > 0).reduce((sum, avg) => sum + avg, 0) / Math.max(1, Object.values(opmAverages).filter(avg => avg > 0).length))}</div>
                            <div class="text-xs text-gray-600">Overall Average</div>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3 max-h-96 overflow-y-auto">
            `;
            
            // Ajouter les d√©tails pour chaque OPM-ID
            wizardOpmIds.forEach(opmId => {
                const selections = levelSelections[opmId] || {};
                const skillCount = Object.keys(selections).length;
                const average = opmAverages[opmId] || 0;
                
                // Obtenir le nom du r√¥le
                const roleCard = document.querySelector(`.selected-role-card[data-opm-code="${opmId}"]`);
                let roleName = 'Unknown Role';
                if (roleCard) {
                    const roleNameElement = roleCard.querySelector('.role-name');
                    if (roleNameElement) {
                        roleName = roleNameElement.textContent.trim();
                    }
                }
                
                summaryHTML += `
                    <div class="border border-indigo-200 rounded-lg p-3 bg-white">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <span class="font-bold text-indigo-900">OPM-ID ${opmId}</span>
                                <div class="text-xs text-gray-600">${roleName}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-indigo-600">${average > 0 ? average + '/7' : 'N/A'}</div>
                                <div class="text-xs text-gray-500">${skillCount} skills</div>
                            </div>
                        </div>
                        ${skillCount > 0 ? `
                            <div class="text-xs text-gray-600">
                                <strong>Selected skills:</strong> ${Object.keys(selections).join(', ')}
                            </div>
                        ` : '<div class="text-xs text-gray-500 italic">No skills selected</div>'}
                    </div>
                `;
            });
            
            summaryHTML += `</div>`;
            
            // Afficher le modal
            document.getElementById('wizard-summary-content').innerHTML = summaryHTML;
            document.getElementById('wizard-summary-modal').classList.remove('hidden');
        }
        
        // Fonction pour confirmer et sauvegarder
        function confirmAndSaveWizard() {
            console.log('Sauvegarde et redirection...');
            
            // Sauvegarder toutes les donn√©es finales
            saveLevelSelections();
            
            // Sauvegarder un flag indiquant que le wizard est termin√©
            localStorage.setItem('wizardCompleted', 'true');
            
            // Pr√©parer un r√©sum√© des s√©lections
            const summary = {
                opmIds: wizardOpmIds,
                levelSelections: levelSelections,
                opmAverages: opmAverages,
                completedAt: new Date().toISOString()
            };
            
            // Sauvegarder le r√©sum√©
            localStorage.setItem('wizardSummary', JSON.stringify(summary));
            
            console.log('Donn√©es sauvegard√©es:', summary);
            
            // Rediriger vers summary_mil.html
            window.location.href = "{% url 'summary_mil' %}";
        }
        
        // Fonction pour fermer le modal et revenir au wizard
        function cancelWizardSummary() {
            document.getElementById('wizard-summary-modal').classList.add('hidden');
        }
        
        // Fonction pour quitter le wizard
        function exitWizard() {
            if (confirm('Are you sure you want to exit the wizard? All progress will be lost.')) {
                wizardActive = false;
                currentWizardOpmId = null;
                wizardFullViewMode = false; // R√©initialiser le mode Full View
                
                // R√©initialiser toutes les s√©lections (rien n'est sauvegard√©)
                levelSelections = {};
                opmAverages = {};
                wizardOpmIds.forEach(opmId => {
                    levelSelections[opmId] = {};
                    // R√©initialiser l'√©chelle de graduation dans la card
                    updateMainGraduationScale(opmId, 0);
                });
                
                // R√©initialiser le toggle
                const viewToggle = document.getElementById('wizard-view-toggle');
                const viewLabel = document.getElementById('wizard-view-label');
                if (viewToggle) viewToggle.checked = false;
                if (viewLabel) viewLabel.textContent = 'Focus';
                
                // Masquer les contr√¥les du wizard
                document.getElementById('wizard-controls').style.display = 'none';
                document.getElementById('start-level-selection-btn').style.display = 'block';
                
                // D√©sactiver le mode wizard
                document.getElementById('sfia-grid').classList.remove('wizard-active');
                
                // Retirer la surbrillance de la card
                document.querySelectorAll('.selected-role-card').forEach(card => {
                    card.style.outline = '';
                    card.style.transform = '';
                });
                
                // Restaurer l'affichage normal en appliquant le filtrage bas√© sur les checkboxes
                applySkillRowsFiltering();
                
                // Nettoyer les s√©lections visuelles
                document.querySelectorAll('.level-box.selected').forEach(box => {
                    box.classList.remove('selected');
                });
                document.querySelectorAll('.skill-row').forEach(row => {
                    row.classList.remove('has-level-selected');
                    const codeElement = row.querySelector('.skill-code');
                    if (codeElement) {
                        codeElement.classList.remove('has-level-selected');
                    }
                });
            }
        }
        
        // Initialisation des √©v√©nements du wizard
        document.addEventListener('DOMContentLoaded', function() {
            // Ne pas charger les s√©lections au d√©marrage - tout reset √† chaque rafra√Æchissement
            // loadLevelSelections(); // D√âSACTIV√â
            
            // Bouton Start Level Selection
            const startBtn = document.getElementById('start-level-selection-btn');
            if (startBtn) {
                startBtn.addEventListener('click', startLevelSelectionWizard);
            }
            
            // Bouton Next/Complete
            const nextBtn = document.getElementById('wizard-next-btn');
            if (nextBtn) {
                nextBtn.addEventListener('click', nextWizardStep);
            }
            
            // Bouton Previous
            const prevBtn = document.getElementById('wizard-prev-btn');
            if (prevBtn) {
                prevBtn.addEventListener('click', previousWizardStep);
            }
            
            // Bouton Exit Wizard
            const exitBtn = document.getElementById('wizard-exit-btn');
            if (exitBtn) {
                exitBtn.addEventListener('click', exitWizard);
            }
            
            // Toggle View Mode (Focus / Full View)
            const viewToggle = document.getElementById('wizard-view-toggle');
            const viewLabel = document.getElementById('wizard-view-label');
            if (viewToggle && viewLabel) {
                viewToggle.addEventListener('change', function() {
                    wizardFullViewMode = this.checked;
                    
                    // Mettre √† jour le label
                    if (wizardFullViewMode) {
                        viewLabel.textContent = 'Full';
                        console.log('Bascul√© en Full View Mode - tous les skills visibles');
                    } else {
                        viewLabel.textContent = 'Focus';
                        console.log('Bascul√© en Focus Mode - filtrage actif');
                    }
                    
                    // R√©appliquer le filtrage (ou l'absence de filtrage)
                    applySkillRowsFiltering();
                });
            }
            
            // Boutons du modal de r√©capitulatif
            const summaryCancel = document.getElementById('wizard-summary-cancel');
            if (summaryCancel) {
                summaryCancel.addEventListener('click', cancelWizardSummary);
            }
            
            const summaryConfirm = document.getElementById('wizard-summary-confirm');
            if (summaryConfirm) {
                summaryConfirm.addEventListener('click', confirmAndSaveWizard);
            }
            
            // Fermer le modal en cliquant sur le backdrop
            const summaryBackdrop = document.getElementById('wizard-summary-backdrop');
            if (summaryBackdrop) {
                summaryBackdrop.addEventListener('click', cancelWizardSummary);
            }
        });
    </script>
    
    <!-- √âl√©ment tooltip qui sera utilis√© pour afficher les informations au survol -->
    <div id="custom-tooltip"></div>
    
    <script>
        // Script d'initialisation du tooltip
        document.addEventListener('DOMContentLoaded', function() {
            // S'assurer que le tooltip existe
            let tooltip = document.getElementById('custom-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'custom-tooltip';
                document.body.appendChild(tooltip);
            }
            
            // Fonction pour configurer les tooltips pour toutes les cellules avec un data-opm-id
            function setupAllTooltips() {
                console.log("Configuration des tooltips pour toutes les cellules...");
                
                // R√©cup√©rer les √©tats des cases √† cocher depuis localStorage
                let checkboxStates = {};
                try {
                    checkboxStates = JSON.parse(localStorage.getItem('opmCheckboxStates') || '{}');
                } catch (e) {
                    console.error('Erreur lors de la r√©cup√©ration des √©tats des cases √† cocher:', e);
                }
                
                // Ajouter des gestionnaires d'√©v√©nements √† toutes les cellules qui ont un OPM ID
                document.querySelectorAll('.level-box.filled[data-opm-id]').forEach(box => {
                    box.onmouseenter = function() {
                        const cellOpmIds = this.dataset.opmId.split(',');
                        let opmIdBadges = '';
                        
                        cellOpmIds.forEach(id => {
                            // V√©rifier si l'OPM ID est actif (case √† cocher coch√©e)
                            const isActive = id in checkboxStates ? checkboxStates[id] : true;
                            
                            if (isActive) {
                                const opmConfig = window.specialOpmConfigs.find(cfg => cfg.opmId === id);
                                const color = opmConfig ? opmConfig.color : getOpmIdColor(id);
                                opmIdBadges += `<span class="tooltip-badge" style="background-color: rgba(${color}, 0.8);">OPM ID: ${id}</span>`;
                            }
                        });
                        
                        // Ne pas afficher le tooltip si aucun OPM ID n'est actif
                        if (opmIdBadges === '') return;
                        
                        const tooltipContent = `
                            <div class="tooltip-title">${this.dataset.skillName || 'Comp√©tence'} (${this.dataset.skillCode || 'Code'})</div>
                            <div class="tooltip-badges">
                                ${opmIdBadges}
                                <span class="tooltip-badge">Niveau: ${this.dataset.level || '?'}</span>
                            </div>
                            <div class="tooltip-info">
                                <strong>Description:</strong> ${this.dataset.description || 'Comp√©tence requise pour ce r√¥le'}
                            </div>
                        `;
                        
                        tooltip.innerHTML = tooltipContent;
                        tooltip.classList.add('visible');
                        
                        const rect = this.getBoundingClientRect();
                        tooltip.style.left = (rect.right + 15) + 'px';
                        tooltip.style.top = rect.top + 'px';
                        
                        // V√©rifier si le tooltip d√©passe √† droite
                        setTimeout(() => {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            if (tooltipRect.right > window.innerWidth) {
                                tooltip.style.left = (rect.left - tooltipRect.width - 15) + 'px';
                            }
                        }, 0);
                    };
                    
                    box.onmouseleave = function() {
                        tooltip.classList.remove('visible');
                    };
                });
            }
            
            // Configurer les tooltips imm√©diatement
            setupAllTooltips();
            
            // Configurer les tooltips apr√®s chaque changement de checkboxes Primary/Secondary
            document.querySelectorAll('.role-primary-checkbox, .role-secondary-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // Attendre que les modifications DOM soient appliqu√©es
                    setTimeout(setupAllTooltips, 100);
                });
            });
            
            // Observer les changements dans le DOM pour reconfigurer les tooltips
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-opm-id') {
                        setupAllTooltips();
                    }
                });
            });
            
            // Observer les changements d'attributs data-opm-id sur toutes les cellules
            document.querySelectorAll('.level-box.filled').forEach(box => {
                observer.observe(box, { attributes: true });
            });
        });
    </script>

</body>
</html>

